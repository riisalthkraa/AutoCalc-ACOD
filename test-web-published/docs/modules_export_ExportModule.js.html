

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> modules/export/ExportModule.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule.html">DashboardModule</a></li><li><a href="module-DataCache.html">DataCache</a></li><li><a href="module-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule.html">FECModule</a></li><li><a href="module-FollowUpModule.html">FollowUpModule</a></li><li><a href="module-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-KeyboardShortcutsModule.html">KeyboardShortcutsModule</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-MLService.html">MLService</a></li><li><a href="module-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-NotificationSystem.html">NotificationSystem</a></li><li><a href="module-NotificationSystemV2.html">NotificationSystemV2</a></li><li><a href="module-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-TourModule.html">TourModule</a></li><li><a href="module-UtilitiesModule.html">UtilitiesModule</a></li><li><a href="module-calculations.html">calculations</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-formatters.html">formatters</a></li><li><a href="module-helpers.html">helpers</a></li></ul><h3>Classes</h3><ul><li><a href="BaseModule.html">BaseModule</a></li><li><a href="BulkActionsManager.html">BulkActionsManager</a></li><li><a href="CacheKeys.html">CacheKeys</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="LoadingStateManager.html">LoadingStateManager</a></li><li><a href="ModalHelper.html">ModalHelper</a></li><li><a href="PaginationManager.html">PaginationManager</a></li><li><a href="ServerValidator.html">ServerValidator</a></li><li><a href="StateManager.html">StateManager</a></li><li><a href="TabRefreshManager.html">TabRefreshManager</a></li><li><a href="UndoRedoManager.html">UndoRedoManager</a></li><li><a href="module-AboutModule-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule-DashboardModule.html">DashboardModule</a></li><li><a href="module-ExportModule-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule-FECModule.html">FECModule</a></li><li><a href="module-ImportModule-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-Logger-Logger.html">Logger</a></li><li><a href="module-Logger-ModuleLogger.html">ModuleLogger</a></li><li><a href="module-MaterialsModule-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-PDFModule-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-UtilitiesModule-UtilitiesModule.html">UtilitiesModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#emitSync">emitSync</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#validateBeforeAddToQuote">validateBeforeAddToQuote</a></li><li><a href="global.html#validateBeforeExport">validateBeforeExport</a></li><li><a href="global.html#validateBeforeSaveMaterial">validateBeforeSaveMaterial</a></li><li><a href="global.html#validateBeforeSendEmail">validateBeforeSendEmail</a></li><li><a href="global.html#validateHeaderConfig">validateHeaderConfig</a></li><li><a href="global.html#validatePasswordChange">validatePasswordChange</a></li><li><a href="global.html#validateSMTPConfig">validateSMTPConfig</a></li><li><a href="global.html#waitFor">waitFor</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>modules/export/ExportModule.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * ========================================
 * EXPORT MODULE - Export de données
 * ========================================
 *
 * Module d'exportation de données vers fichiers externes (Excel, CSV).
 * Permet d'exporter les catalogues de matériaux, fournisseurs, clients,
 * devis et factures pour backup, partage ou migration.
 *
 * Formats supportés :
 * - **Excel (.xlsx)** : Format Microsoft Excel moderne
 * - **CSV (.csv)** : Fichier texte séparé par virgules
 *
 * @module ExportModule
 * @extends BaseModule
 * @version 1.0.0
 */

import BaseModule from '../../core/BaseModule.js';
import NotificationSystem from '../../shared/ui/NotificationSystem.js';

class ExportModule extends BaseModule {
  /**
   * Constructeur du module d'export
   * @param {StateManager} state - Gestionnaire d'état global
   * @param {EventBus} eventBus - Bus d'événements
   */
  constructor(state, eventBus) {
    super('export', state, eventBus);

    /**
     * Types de données exportables
     * @type {string[]}
     */
    this.exportTypes = ['materiaux', 'fournisseurs', 'clients', 'devis', 'factures'];
  }

  /**
   * Initialisation du module
   */
  async init() {
    this.log('Initialisation du module Export');
    this.bindEvents();
    this.log('Module Export initialisé');
  }

  /**
   * Bind des événements
   */
  bindEvents() {
    // Boutons d'export dans les différents onglets
    document.addEventListener('click', (e) => {
      // Export Matériaux
      if (e.target.closest('#btn-export-materials')) {
        this.exportMaterials('xlsx');
      }
      if (e.target.closest('#btn-export-materials-csv')) {
        this.exportMaterials('csv');
      }

      // Export Fournisseurs
      if (e.target.closest('#btn-export-suppliers')) {
        this.exportSuppliers('xlsx');
      }
      if (e.target.closest('#btn-export-suppliers-csv')) {
        this.exportSuppliers('csv');
      }

      // Export Clients
      if (e.target.closest('#btn-export-clients')) {
        this.exportClients('xlsx');
      }
      if (e.target.closest('#btn-export-clients-csv')) {
        this.exportClients('csv');
      }

      // Export Devis
      if (e.target.closest('#btn-export-quotes')) {
        this.exportQuotes('xlsx');
      }

      // Export Factures
      if (e.target.closest('#btn-export-invoices')) {
        this.exportInvoices('xlsx');
      }
    });
  }

  /**
   * Export des matériaux
   * @param {string} format - 'xlsx' ou 'csv'
   */
  async exportMaterials(format = 'xlsx') {
    try {
      this.log(`Export matériaux en ${format}`);

      const result = await window.electronAPI.invoke('get-materials');
      const materials = result.materials || result || [];

      if (!materials || materials.length === 0) {
        NotificationSystem.warning('Aucun matériau à exporter');
        return;
      }

      const data = materials.map(m => ({
        'Nom': m.name || '',
        'Référence': m.reference || '',
        'Type': m.type || '',
        'Unité': m.unit || '',
        'Prix HT': m.priceHT || 0,
        'Prix TTC': m.priceTTC || 0,
        'TVA (%)': m.tva || 20,
        'Marge (%)': m.margin || 0,
        'Fournisseur': m.supplier || '',
        'Stock': m.stock || 0,
        'Code-barres': m.barcode || ''
      }));

      const filename = `materiaux_${this.getDateString()}`;
      await this.exportData(data, filename, format);

      NotificationSystem.success(`${materials.length} matériaux exportés en ${format.toUpperCase()}`);
    } catch (error) {
      this.log('Erreur export matériaux:', error);
      NotificationSystem.error('Erreur lors de l\'export des matériaux');
    }
  }

  /**
   * Export des fournisseurs
   * @param {string} format - 'xlsx' ou 'csv'
   */
  async exportSuppliers(format = 'xlsx') {
    try {
      this.log(`Export fournisseurs en ${format}`);

      const result = await window.electronAPI.invoke('get-suppliers');
      const suppliers = result.suppliers || result || [];

      if (!suppliers || suppliers.length === 0) {
        NotificationSystem.warning('Aucun fournisseur à exporter');
        return;
      }

      const data = suppliers.map(s => ({
        'Nom': s.name || '',
        'Contact': s.contact || '',
        'Email': s.email || '',
        'Téléphone': s.phone || '',
        'Adresse': s.address || '',
        'Type': s.type || '',
        'SIRET': s.siret || '',
        'Délai livraison (j)': s.deliveryDelay || 0
      }));

      const filename = `fournisseurs_${this.getDateString()}`;
      await this.exportData(data, filename, format);

      NotificationSystem.success(`${suppliers.length} fournisseurs exportés en ${format.toUpperCase()}`);
    } catch (error) {
      this.log('Erreur export fournisseurs:', error);
      NotificationSystem.error('Erreur lors de l\'export des fournisseurs');
    }
  }

  /**
   * Export des clients
   * @param {string} format - 'xlsx' ou 'csv'
   */
  async exportClients(format = 'xlsx') {
    try {
      this.log(`Export clients en ${format}`);

      const result = await window.electronAPI.invoke('get-clients');
      const clients = result.clients || result || [];

      if (!clients || clients.length === 0) {
        NotificationSystem.warning('Aucun client à exporter');
        return;
      }

      const data = clients.map(c => ({
        'Nom': c.name || '',
        'Contact': c.contact || '',
        'Email': c.email || '',
        'Téléphone': c.phone || '',
        'Adresse': c.address || '',
        'Type': c.type || '',
        'SIRET': c.siret || ''
      }));

      const filename = `clients_${this.getDateString()}`;
      await this.exportData(data, filename, format);

      NotificationSystem.success(`${clients.length} clients exportés en ${format.toUpperCase()}`);
    } catch (error) {
      this.log('Erreur export clients:', error);
      NotificationSystem.error('Erreur lors de l\'export des clients');
    }
  }

  /**
   * Export des devis
   * @param {string} format - 'xlsx' ou 'csv'
   */
  async exportQuotes(format = 'xlsx') {
    try {
      this.log(`Export devis en ${format}`);

      const quotes = await window.electronAPI.invoke('list-saved-quotes') || [];

      if (!quotes || quotes.length === 0) {
        NotificationSystem.warning('Aucun devis à exporter');
        return;
      }

      const data = quotes.map(q => ({
        'Numéro': q.id || '',
        'Client': q.clientName || '',
        'Date': q.date || '',
        'Validité': q.validity || '',
        'Statut': q.status || '',
        'Total HT': q.totalHT || 0,
        'Total TVA': q.totalTVA || 0,
        'Total TTC': q.totalTTC || 0,
        'Nb articles': (q.items || []).length
      }));

      const filename = `devis_${this.getDateString()}`;
      await this.exportData(data, filename, format);

      NotificationSystem.success(`${quotes.length} devis exportés en ${format.toUpperCase()}`);
    } catch (error) {
      this.log('Erreur export devis:', error);
      NotificationSystem.error('Erreur lors de l\'export des devis');
    }
  }

  /**
   * Export des factures
   * @param {string} format - 'xlsx' ou 'csv'
   */
  async exportInvoices(format = 'xlsx') {
    try {
      this.log(`Export factures en ${format}`);

      const invoices = await window.electronAPI.invoke('list-invoices') || [];

      if (!invoices || invoices.length === 0) {
        NotificationSystem.warning('Aucune facture à exporter');
        return;
      }

      const data = invoices.map(inv => ({
        'Numéro': inv.id || '',
        'Client': inv.clientName || '',
        'Date émission': inv.dateEmission || '',
        'Date échéance': inv.dateEcheance || '',
        'Statut': inv.status || '',
        'Total HT': inv.totalHT || 0,
        'Total TVA': inv.totalTVA || 0,
        'Total TTC': inv.totalTTC || 0,
        'Date paiement': inv.paymentDate || '',
        'Méthode paiement': inv.paymentMethod || ''
      }));

      const filename = `factures_${this.getDateString()}`;
      await this.exportData(data, filename, format);

      NotificationSystem.success(`${invoices.length} factures exportées en ${format.toUpperCase()}`);
    } catch (error) {
      this.log('Erreur export factures:', error);
      NotificationSystem.error('Erreur lors de l\'export des factures');
    }
  }

  /**
   * Export générique des données
   * @param {Array&lt;Object>} data - Données à exporter
   * @param {string} filename - Nom du fichier (sans extension)
   * @param {string} format - 'xlsx' ou 'csv'
   */
  async exportData(data, filename, format) {
    // Utiliser l'API Electron pour l'export
    const result = await window.electronAPI.invoke('export-to-file', {
      data,
      filename,
      format
    });

    if (!result.success) {
      throw new Error(result.error || 'Erreur lors de l\'export');
    }

    return result;
  }

  /**
   * Génère une chaîne de date pour le nom de fichier
   * @returns {string}
   */
  getDateString() {
    const now = new Date();
    return `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
  }

  /**
   * Méthodes publiques exposées pour appel externe
   */
  getPublicMethods() {
    return {
      exportMaterials: (format) => this.exportMaterials(format),
      exportSuppliers: (format) => this.exportSuppliers(format),
      exportClients: (format) => this.exportClients(format),
      exportQuotes: (format) => this.exportQuotes(format),
      exportInvoices: (format) => this.exportInvoices(format)
    };
  }
}

export default ExportModule;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
