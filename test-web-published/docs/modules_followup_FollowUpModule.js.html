

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> modules/followup/FollowUpModule.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule.html">DashboardModule</a></li><li><a href="module-DataCache.html">DataCache</a></li><li><a href="module-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule.html">FECModule</a></li><li><a href="module-FollowUpModule.html">FollowUpModule</a></li><li><a href="module-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-KeyboardShortcutsModule.html">KeyboardShortcutsModule</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-MLService.html">MLService</a></li><li><a href="module-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-NotificationSystem.html">NotificationSystem</a></li><li><a href="module-NotificationSystemV2.html">NotificationSystemV2</a></li><li><a href="module-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-TourModule.html">TourModule</a></li><li><a href="module-UtilitiesModule.html">UtilitiesModule</a></li><li><a href="module-calculations.html">calculations</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-formatters.html">formatters</a></li><li><a href="module-helpers.html">helpers</a></li></ul><h3>Classes</h3><ul><li><a href="BaseModule.html">BaseModule</a></li><li><a href="BulkActionsManager.html">BulkActionsManager</a></li><li><a href="CacheKeys.html">CacheKeys</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="LoadingStateManager.html">LoadingStateManager</a></li><li><a href="ModalHelper.html">ModalHelper</a></li><li><a href="PaginationManager.html">PaginationManager</a></li><li><a href="ServerValidator.html">ServerValidator</a></li><li><a href="StateManager.html">StateManager</a></li><li><a href="TabRefreshManager.html">TabRefreshManager</a></li><li><a href="UndoRedoManager.html">UndoRedoManager</a></li><li><a href="module-AboutModule-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule-DashboardModule.html">DashboardModule</a></li><li><a href="module-ExportModule-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule-FECModule.html">FECModule</a></li><li><a href="module-ImportModule-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-Logger-Logger.html">Logger</a></li><li><a href="module-Logger-ModuleLogger.html">ModuleLogger</a></li><li><a href="module-MaterialsModule-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-PDFModule-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-UtilitiesModule-UtilitiesModule.html">UtilitiesModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#emitSync">emitSync</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#validateBeforeAddToQuote">validateBeforeAddToQuote</a></li><li><a href="global.html#validateBeforeExport">validateBeforeExport</a></li><li><a href="global.html#validateBeforeSaveMaterial">validateBeforeSaveMaterial</a></li><li><a href="global.html#validateBeforeSendEmail">validateBeforeSendEmail</a></li><li><a href="global.html#validateHeaderConfig">validateHeaderConfig</a></li><li><a href="global.html#validatePasswordChange">validatePasswordChange</a></li><li><a href="global.html#validateSMTPConfig">validateSMTPConfig</a></li><li><a href="global.html#waitFor">waitFor</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>modules/followup/FollowUpModule.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * ========================================
 * FOLLOWUP MODULE - Relances automatiques
 * ========================================
 *
 * Module de gestion des relances automatiques pour AutoCalc OptiDevis.
 * Permet le suivi automatis√© des devis en attente et des factures impay√©es
 * avec syst√®me de relance multi-niveaux et templates personnalisables.
 *
 * Architecture :
 * - **Relances Devis** : 3 niveaux (7j, 14j, 30j apr√®s cr√©ation)
 * - **Relances Factures** : 3 niveaux (√©ch√©ance, +15j, +30j)
 * - **Templates Email** : Personnalisables par niveau et type
 * - **Historique** : Tra√ßabilit√© compl√®te des relances
 * - **Statistiques** : Taux de conversion apr√®s relance
 *
 * Workflow Relance Devis :
 * 1. Devis cr√©√© ‚Üí Programmation relance J+7
 * 2. J+7 : Si toujours "en_attente" ‚Üí Email niveau 1 (rappel amical)
 * 3. J+14 : Si toujours "en_attente" ‚Üí Email niveau 2 (offre limit√©e)
 * 4. J+30 : Si toujours "en_attente" ‚Üí Email niveau 3 (derni√®re chance)
 * 5. Devis accept√©/refus√© ‚Üí Annulation relances programm√©es
 *
 * Workflow Relance Factures :
 * 1. Facture √©chue ‚Üí Email rappel de paiement
 * 2. √âch√©ance +15j ‚Üí Email mise en demeure amiable
 * 3. √âch√©ance +30j ‚Üí Email avant contentieux
 * 4. Facture pay√©e ‚Üí Arr√™t des relances
 *
 * Int√©grations :
 * - QuotesModule : Lecture des devis en attente
 * - InvoicesModule : Lecture des factures impay√©es
 * - ConfigModule : Templates et param√®tres SMTP
 * - NotificationSystem : Alertes utilisateur
 *
 * @module FollowUpModule
 * @extends BaseModule
 * @version 1.0.0
 */

import BaseModule from '../../core/BaseModule.js';
import NotificationSystem from '../../shared/ui/NotificationSystem.js';
import { TextFormatter } from '../../shared/utils/formatters.js';
import mlService from '../../shared/services/MLService.js';

class FollowUpModule extends BaseModule {
  constructor(state, eventBus) {
    super('followup', state, eventBus);

    // Configuration des d√©lais de relance (en jours)
    this.config = {
      quotes: {
        level1: 7,   // Premier rappel apr√®s 7 jours
        level2: 14,  // Deuxi√®me rappel apr√®s 14 jours
        level3: 30   // Dernier rappel apr√®s 30 jours
      },
      invoices: {
        level1: 0,   // √Ä l'√©ch√©ance
        level2: 15,  // 15 jours apr√®s √©ch√©ance
        level3: 30   // 30 jours apr√®s √©ch√©ance
      }
    };

    // Historique des relances
    this.followUpHistory = this.loadHistory();

    // File d'attente des relances √† envoyer
    this.pendingFollowUps = [];

    // Templates d'email par d√©faut
    this.emailTemplates = this.loadTemplates();

    this.log('FollowUpModule v1.0 - Initialization');
  }

  /**
   * Initialise le module de relance
   */
  async init() {
    this.log('Initializing FollowUpModule...');

    // Exposer les fonctions au scope global
    this.exposeToGlobal();

    // √âcouter les √©v√©nements
    this.attachEventListeners();

    // V√©rifier les relances en attente au d√©marrage
    this.checkPendingFollowUps();

    // Programmer la v√©rification automatique toutes les heures
    this.scheduleAutomaticCheck();

    this.log('‚úì FollowUpModule initialized');
  }

  /**
   * Expose les fonctions au scope global pour compatibilit√©
   */
  exposeToGlobal() {
    window.followUpModule = this;
    window.checkFollowUps = () => this.checkPendingFollowUps();
    window.viewFollowUpHistory = () => this.viewHistory();
    window.configureFollowUp = () => this.openConfiguration();

    // Mettre √† jour le dashboard au chargement de l'onglet Configuration
    const configTab = document.getElementById('config-tab');
    if (configTab) {
      configTab.addEventListener('shown.bs.tab', () => {
        this.updateDashboard();
      });
    }
  }

  /**
   * Attache les event listeners
   */
  attachEventListeners() {
    // √âcouter les changements de statut
    this.events.on('quotes:status-changed', (data) => {
      this.handleQuoteStatusChange(data);
    });

    this.events.on('invoices:paid', (data) => {
      this.handleInvoicePaid(data);
    });

    // √âcouter les nouvelles cr√©ations
    this.events.on('quotes:created', (quote) => {
      this.scheduleQuoteFollowUp(quote);
    });

    this.events.on('invoices:created', (invoice) => {
      this.scheduleInvoiceFollowUp(invoice);
    });
  }

  /**
   * V√©rifie les relances en attente
   */
  async checkPendingFollowUps() {
    this.log('Checking pending follow-ups...');

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // V√©rifier les devis
    await this.checkQuoteFollowUps(today);

    // V√©rifier les factures
    await this.checkInvoiceFollowUps(today);

    // Afficher le r√©sum√©
    this.displayFollowUpSummary();
  }

  /**
   * V√©rifie les relances de devis
   */
  async checkQuoteFollowUps(today) {
    try {
      // R√©cup√©rer tous les devis
      const quotes = await window.api.invoke('get-quotes', {
        authToken: window.authToken || window.sessionToken
      });

      const pendingQuotes = quotes.filter(q => q.status === 'en_attente');

      pendingQuotes.forEach(quote => {
        const createdDate = new Date(quote.createdAt);
        const daysSinceCreation = Math.floor((today - createdDate) / (1000 * 60 * 60 * 24));

        // D√©terminer le niveau de relance n√©cessaire
        const level = this.getFollowUpLevel(daysSinceCreation, 'quotes');

        if (level > 0 &amp;&amp; !this.hasBeenFollowedUp(quote.id, level, 'quote')) {
          this.pendingFollowUps.push({
            type: 'quote',
            id: quote.id,
            data: quote,
            level: level,
            daysPending: daysSinceCreation
          });
        }
      });
    } catch (error) {
      this.log('Error checking quote follow-ups:', error);
    }
  }

  /**
   * V√©rifie les relances de factures
   */
  async checkInvoiceFollowUps(today) {
    try {
      // R√©cup√©rer toutes les factures
      const invoices = await window.api.invoke('get-invoices', {
        authToken: window.authToken || window.sessionToken
      });

      const unpaidInvoices = invoices.filter(i =>
        i.status === 'envoy√©e' || i.status === 'en_retard'
      );

      unpaidInvoices.forEach(invoice => {
        const dueDate = new Date(invoice.dueDate || invoice.invoiceDate);
        const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));

        if (daysOverdue >= 0) {
          const level = this.getFollowUpLevel(daysOverdue, 'invoices');

          if (level > 0 &amp;&amp; !this.hasBeenFollowedUp(invoice.id, level, 'invoice')) {
            this.pendingFollowUps.push({
              type: 'invoice',
              id: invoice.id,
              data: invoice,
              level: level,
              daysOverdue: daysOverdue
            });
          }
        }
      });
    } catch (error) {
      this.log('Error checking invoice follow-ups:', error);
    }
  }

  /**
   * D√©termine le niveau de relance appropri√©
   */
  getFollowUpLevel(days, type) {
    const config = this.config[type];

    if (days >= config.level3) return 3;
    if (days >= config.level2) return 2;
    if (days >= config.level1) return 1;
    return 0;
  }

  /**
   * V√©rifie si une relance a d√©j√† √©t√© envoy√©e
   */
  hasBeenFollowedUp(id, level, type) {
    return this.followUpHistory.some(h =>
      h.targetId === id &amp;&amp;
      h.level === level &amp;&amp;
      h.type === type &amp;&amp;
      h.status === 'sent'
    );
  }

  /**
   * Envoie une relance
   */
  async sendFollowUp(followUp) {
    try {
      const template = this.getTemplate(followUp.type, followUp.level);
      const emailData = this.prepareEmailData(followUp, template);

      // V√©rifier que l'adresse email existe
      if (!emailData.to || emailData.to === 'client@example.com') {
        this.log('Email client non d√©fini pour:', followUp.data.number);
        NotificationSystem.show('Email client non d√©fini', 'warning');
        return false;
      }

      // Envoyer via IPC au processus principal (nodemailer)
      const result = await window.api.sendReminderEmail({
        ...emailData,
        documentNumber: followUp.data.number
      });

      if (!result.success) {
        throw new Error(result.message || '√âchec de l\'envoi');
      }

      // Enregistrer dans l'historique
      this.addToHistory({
        targetId: followUp.id,
        type: followUp.type,
        level: followUp.level,
        status: 'sent',
        date: new Date().toISOString(),
        recipient: followUp.data.client?.email || emailData.to,
        documentNumber: followUp.data.number
      });

      // Notification
      NotificationSystem.show(
        `Relance niveau ${followUp.level} envoy√©e pour ${followUp.type === 'quote' ? 'devis' : 'facture'} ${followUp.data.number}`,
        'success'
      );

      return true;
    } catch (error) {
      this.log('Error sending follow-up:', error);
      NotificationSystem.show(`Erreur lors de l'envoi de la relance: ${error.message}`, 'error');

      // Enregistrer l'√©chec dans l'historique
      this.addToHistory({
        targetId: followUp.id,
        type: followUp.type,
        level: followUp.level,
        status: 'failed',
        date: new Date().toISOString(),
        recipient: followUp.data.client?.email || 'unknown',
        documentNumber: followUp.data.number,
        error: error.message
      });

      return false;
    }
  }

  /**
   * Pr√©pare les donn√©es pour l'email
   */
  prepareEmailData(followUp, template) {
    const client = followUp.data.client || {};
    const variables = {
      clientName: client.name || 'Client',
      documentNumber: followUp.data.number || 'N/A',
      amount: followUp.data.totalTTC || 0,
      daysCount: followUp.daysPending || followUp.daysOverdue || 0,
      date: new Date(followUp.data.createdAt || followUp.data.invoiceDate).toLocaleDateString('fr-FR')
    };

    // Remplacer les variables dans le template
    let subject = template.subject;
    let body = template.body;

    Object.keys(variables).forEach(key => {
      const regex = new RegExp(`{{${key}}}`, 'g');
      subject = subject.replace(regex, variables[key]);
      body = body.replace(regex, variables[key]);
    });

    return {
      to: client.email,
      subject: subject,
      body: body,
      type: followUp.type,
      level: followUp.level
    };
  }

  /**
   * Affiche le r√©sum√© des relances
   */
  displayFollowUpSummary() {
    const quoteFollowUps = this.pendingFollowUps.filter(f => f.type === 'quote');
    const invoiceFollowUps = this.pendingFollowUps.filter(f => f.type === 'invoice');

    // Mettre √† jour l'UI
    const summaryEl = document.getElementById('followup-summary');
    if (summaryEl) {
      summaryEl.innerHTML = `
        &lt;div class="alert alert-info">
          &lt;h6>üìä Relances en attente&lt;/h6>
          &lt;p>
            Devis : &lt;strong>${quoteFollowUps.length}&lt;/strong> relances&lt;br>
            Factures : &lt;strong>${invoiceFollowUps.length}&lt;/strong> relances
          &lt;/p>
          ${this.pendingFollowUps.length > 0 ?
            '&lt;button class="btn btn-primary btn-sm" onclick="followUpModule.sendAllPending()">Envoyer toutes les relances&lt;/button>' :
            '&lt;span class="text-success">‚úì Aucune relance en attente&lt;/span>'
          }
        &lt;/div>
      `;
    }

    // Badge sur l'onglet
    const badge = document.getElementById('followup-badge');
    if (badge) {
      badge.textContent = this.pendingFollowUps.length || '';
      badge.style.display = this.pendingFollowUps.length > 0 ? 'inline-block' : 'none';
    }
  }

  /**
   * Envoie toutes les relances en attente
   */
  async sendAllPending() {
    const total = this.pendingFollowUps.length;
    let sent = 0;

    for (const followUp of this.pendingFollowUps) {
      if (await this.sendFollowUp(followUp)) {
        sent++;
      }
    }

    // Vider la file d'attente
    this.pendingFollowUps = [];

    // Rafra√Æchir l'affichage
    this.displayFollowUpSummary();

    // Notification
    NotificationSystem.show(
      `${sent}/${total} relances envoy√©es avec succ√®s`,
      sent === total ? 'success' : 'warning'
    );
  }

  /**
   * Programme une v√©rification automatique
   */
  scheduleAutomaticCheck() {
    // V√©rifier toutes les heures
    setInterval(() => {
      this.checkPendingFollowUps();
    }, 60 * 60 * 1000);
  }

  /**
   * Charge les templates d'email
   */
  loadTemplates() {
    const saved = localStorage.getItem('followup_templates');
    if (saved) {
      return JSON.parse(saved);
    }

    // Templates par d√©faut
    return {
      quote: {
        level1: {
          subject: 'Rappel - Devis {{documentNumber}} en attente',
          body: `Bonjour {{clientName}},\n\nNous vous rappelons que le devis {{documentNumber}} du {{date}} d'un montant de {{amount}}‚Ç¨ est toujours en attente de validation.\n\nN'h√©sitez pas √† nous contacter pour toute question.\n\nCordialement,\nL'√©quipe AutoCalc`
        },
        level2: {
          subject: 'Offre limit√©e - Devis {{documentNumber}}',
          body: `Bonjour {{clientName}},\n\nVotre devis {{documentNumber}} est en attente depuis {{daysCount}} jours.\n\nPour vous d√©cider, nous vous offrons une remise de 5% valable jusqu'√† la fin du mois.\n\nCordialement,\nL'√©quipe AutoCalc`
        },
        level3: {
          subject: 'Derni√®re chance - Devis {{documentNumber}}',
          body: `Bonjour {{clientName}},\n\nVotre devis {{documentNumber}} expire bient√¥t apr√®s {{daysCount}} jours d'attente.\n\nSans r√©ponse de votre part sous 7 jours, nous consid√©rerons que vous n'√™tes plus int√©ress√©.\n\nCordialement,\nL'√©quipe AutoCalc`
        }
      },
      invoice: {
        level1: {
          subject: 'Rappel de paiement - Facture {{documentNumber}}',
          body: `Bonjour {{clientName}},\n\nNous vous rappelons que la facture {{documentNumber}} d'un montant de {{amount}}‚Ç¨ est arriv√©e √† √©ch√©ance.\n\nMerci de proc√©der au r√®glement dans les meilleurs d√©lais.\n\nCordialement,\nL'√©quipe AutoCalc`
        },
        level2: {
          subject: 'Mise en demeure amiable - Facture {{documentNumber}}',
          body: `Bonjour {{clientName}},\n\nMalgr√© nos relances, la facture {{documentNumber}} de {{amount}}‚Ç¨ reste impay√©e depuis {{daysCount}} jours.\n\nNous vous mettons en demeure de r√©gulariser votre situation sous 8 jours.\n\nCordialement,\nL'√©quipe AutoCalc`
        },
        level3: {
          subject: 'Avant contentieux - Facture {{documentNumber}}',
          body: `Bonjour {{clientName}},\n\nLa facture {{documentNumber}} de {{amount}}‚Ç¨ est impay√©e depuis {{daysCount}} jours.\n\nSans r√©glement sous 48h, nous transmettrons votre dossier √† notre service contentieux.\n\nCordialement,\nL'√©quipe AutoCalc`
        }
      }
    };
  }

  /**
   * R√©cup√®re un template sp√©cifique
   */
  getTemplate(type, level) {
    return this.emailTemplates[type][`level${level}`] || {
      subject: `Relance niveau ${level}`,
      body: 'Contenu de relance par d√©faut'
    };
  }

  /**
   * Charge l'historique des relances
   */
  loadHistory() {
    const saved = localStorage.getItem('followup_history');
    return saved ? JSON.parse(saved) : [];
  }

  /**
   * Ajoute une entr√©e √† l'historique
   */
  addToHistory(entry) {
    this.followUpHistory.push(entry);
    localStorage.setItem('followup_history', JSON.stringify(this.followUpHistory));
  }

  /**
   * Affiche l'historique des relances
   */
  viewHistory() {
    const modal = new bootstrap.Modal(document.getElementById('followupHistoryModal'));
    const tbody = document.getElementById('followup-history-tbody');

    if (tbody) {
      tbody.innerHTML = this.followUpHistory
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 100)
        .map(h => {
          const safeTargetId = TextFormatter.escapeHtml(h.targetId);
          const safeRecipient = TextFormatter.escapeHtml(h.recipient);
          return `
          &lt;tr>
            &lt;td>${new Date(h.date).toLocaleDateString('fr-FR')}&lt;/td>
            &lt;td>&lt;span class="badge bg-${h.type === 'quote' ? 'primary' : 'warning'}">${h.type === 'quote' ? 'Devis' : 'Facture'}&lt;/span>&lt;/td>
            &lt;td>${safeTargetId}&lt;/td>
            &lt;td>Niveau ${h.level}&lt;/td>
            &lt;td>${safeRecipient}&lt;/td>
            &lt;td>&lt;span class="badge bg-${h.status === 'sent' ? 'success' : 'secondary'}">${h.status === 'sent' ? 'Envoy√©e' : 'En attente'}&lt;/span>&lt;/td>
          &lt;/tr>
        `;
        }).join('');
    }

    modal.show();
  }

  /**
   * Ouvre la configuration des relances
   */
  openConfiguration() {
    const modal = new bootstrap.Modal(document.getElementById('followupConfigModal'));

    // Charger les valeurs actuelles
    document.getElementById('quote-level1-days').value = this.config.quotes.level1;
    document.getElementById('quote-level2-days').value = this.config.quotes.level2;
    document.getElementById('quote-level3-days').value = this.config.quotes.level3;
    document.getElementById('invoice-level1-days').value = this.config.invoices.level1;
    document.getElementById('invoice-level2-days').value = this.config.invoices.level2;
    document.getElementById('invoice-level3-days').value = this.config.invoices.level3;

    modal.show();
  }

  /**
   * Sauvegarde la configuration
   */
  saveConfiguration() {
    this.config.quotes.level1 = parseInt(document.getElementById('quote-level1-days').value);
    this.config.quotes.level2 = parseInt(document.getElementById('quote-level2-days').value);
    this.config.quotes.level3 = parseInt(document.getElementById('quote-level3-days').value);
    this.config.invoices.level1 = parseInt(document.getElementById('invoice-level1-days').value);
    this.config.invoices.level2 = parseInt(document.getElementById('invoice-level2-days').value);
    this.config.invoices.level3 = parseInt(document.getElementById('invoice-level3-days').value);

    localStorage.setItem('followup_config', JSON.stringify(this.config));
    NotificationSystem.show('Configuration sauvegard√©e', 'success');

    // Fermer la modal
    bootstrap.Modal.getInstance(document.getElementById('followupConfigModal')).hide();
  }

  /**
   * Obtient les statistiques de relance
   */
  getStatistics() {
    const stats = {
      totalSent: this.followUpHistory.length,
      quotesRelances: this.followUpHistory.filter(h => h.type === 'quote').length,
      invoicesRelances: this.followUpHistory.filter(h => h.type === 'invoice').length,
      level1: this.followUpHistory.filter(h => h.level === 1).length,
      level2: this.followUpHistory.filter(h => h.level === 2).length,
      level3: this.followUpHistory.filter(h => h.level === 3).length,
      last30Days: this.followUpHistory.filter(h => {
        const date = new Date(h.date);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        return date > thirtyDaysAgo;
      }).length
    };

    return stats;
  }

  /**
   * Affiche la modal de configuration
   */
  showSettings() {
    const modal = document.getElementById('followUpModal');
    if (!modal) {
      NotificationSystem.error('Modal de configuration introuvable');
      return;
    }

    // Charger les valeurs actuelles
    document.getElementById('followup-quotes-level1').value = this.config.quotes.level1;
    document.getElementById('followup-quotes-level2').value = this.config.quotes.level2;
    document.getElementById('followup-quotes-level3').value = this.config.quotes.level3;
    document.getElementById('followup-invoices-level1').value = this.config.invoices.level1;
    document.getElementById('followup-invoices-level2').value = this.config.invoices.level2;
    document.getElementById('followup-invoices-level3').value = this.config.invoices.level3;

    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
  }

  /**
   * Sauvegarde les param√®tres de relance
   */
  saveSettings() {
    this.config.quotes.level1 = parseInt(document.getElementById('followup-quotes-level1').value);
    this.config.quotes.level2 = parseInt(document.getElementById('followup-quotes-level2').value);
    this.config.quotes.level3 = parseInt(document.getElementById('followup-quotes-level3').value);
    this.config.invoices.level1 = parseInt(document.getElementById('followup-invoices-level1').value);
    this.config.invoices.level2 = parseInt(document.getElementById('followup-invoices-level2').value);
    this.config.invoices.level3 = parseInt(document.getElementById('followup-invoices-level3').value);

    localStorage.setItem('followup_config', JSON.stringify(this.config));

    NotificationSystem.success('Configuration des relances sauvegard√©e');

    // Fermer la modal
    bootstrap.Modal.getInstance(document.getElementById('followUpModal')).hide();
  }

  /**
   * Lance une v√©rification manuelle
   */
  checkNow() {
    NotificationSystem.info('V√©rification des relances en cours...');
    this.checkPendingFollowUps();
    this.updateDashboard();
  }

  /**
   * Met √† jour le dashboard avec les statistiques
   */
  updateDashboard() {
    // Compter les devis en attente de relance
    const quotes = window.appState?.get('quotes') || [];
    const quotesToFollow = quotes.filter(q => q.status === 'en_attente');

    // Compter les factures impay√©es
    const invoices = window.appState?.get('invoices') || [];
    const unpaidInvoices = invoices.filter(inv => !inv.isPaid);

    // Statistiques des relances envoy√©es
    const stats = this.getStatistics();

    // Mettre √† jour l'interface
    const quotesCountEl = document.getElementById('followup-quotes-count');
    const quotesDetailEl = document.getElementById('followup-quotes-detail');
    const invoicesCountEl = document.getElementById('followup-invoices-count');
    const invoicesDetailEl = document.getElementById('followup-invoices-detail');
    const sentCountEl = document.getElementById('followup-sent-count');
    const lastCheckEl = document.getElementById('followup-last-check');

    if (quotesCountEl) quotesCountEl.textContent = quotesToFollow.length;
    if (quotesDetailEl) {
      if (quotesToFollow.length === 0) {
        quotesDetailEl.textContent = 'Aucun devis en attente';
      } else {
        quotesDetailEl.textContent = `${quotesToFollow.length} devis n√©cessitent une relance`;
      }
    }

    if (invoicesCountEl) invoicesCountEl.textContent = unpaidInvoices.length;
    if (invoicesDetailEl) {
      if (unpaidInvoices.length === 0) {
        invoicesDetailEl.textContent = 'Aucune facture en retard';
      } else {
        invoicesDetailEl.textContent = `${unpaidInvoices.length} factures impay√©es`;
      }
    }

    if (sentCountEl) sentCountEl.textContent = stats.totalSent;
    if (lastCheckEl) {
      const lastCheck = localStorage.getItem('followup_last_check');
      if (lastCheck) {
        const date = new Date(lastCheck);
        lastCheckEl.textContent = `Derni√®re v√©rification : ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
      } else {
        lastCheckEl.textContent = 'Derni√®re v√©rification : jamais';
      }
    }

    // Sauvegarder la date de v√©rification
    localStorage.setItem('followup_last_check', new Date().toISOString());

    // Afficher recommandations ML
    this.displayMLRecommendations();
  }

  /**
   * Affiche les recommandations ML de clients √† relancer.
   *
   * Utilise MLService pour obtenir une liste prioris√©e de clients
   * inactifs avec scoring bas√© sur:
   * - Nombre de jours depuis derni√®re activit√©
   * - Revenus historiques totaux
   * - Nombre de devis pass√©s
   *
   * Utilise algorithme de scoring ML (si actif) ou calcul simple (fallback).
   *
   * @returns {Promise&lt;void>}
   * @private
   */
  async displayMLRecommendations() {
    try {
      // R√©cup√©rer recommandations via MLService (auto-fallback)
      const recommendations = await mlService.recommendFollowup();

      const container = document.getElementById('ml-recommendations-container');
      if (!container) return; // Container n'existe pas dans le HTML

      // Si pas de recommandations
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = `
          &lt;div class="alert alert-info">
            &lt;i class="fas fa-info-circle">&lt;/i> Aucun client √† relancer pour le moment
          &lt;/div>
        `;
        return;
      }

      // Cr√©er header
      let html = `
        &lt;div class="card mb-3">
          &lt;div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            &lt;h6 class="mb-0">
              &lt;i class="fas fa-brain">&lt;/i> Clients √† Relancer (Recommandations ML)
            &lt;/h6>
            &lt;small>Bas√© sur l'historique d'activit√© et les revenus&lt;/small>
          &lt;/div>
          &lt;div class="card-body p-0">
      `;

      // Ajouter chaque recommandation
      recommendations.forEach((rec, index) => {
        const priorityClass = this.getPriorityClass(rec.priority_score);
        const priorityLabel = this.getPriorityLabel(rec.priority_score);

        html += `
          &lt;div class="border-bottom p-3 ${index % 2 === 0 ? 'bg-light' : ''}">
            &lt;div class="d-flex justify-content-between align-items-start mb-2">
              &lt;div>
                &lt;span class="badge ${priorityClass} me-2">
                  #${index + 1} - Priorit√© ${rec.priority_score.toFixed(1)} (${priorityLabel})
                &lt;/span>
                &lt;strong>${TextFormatter.escapeHtml(rec.client_name)}&lt;/strong>
              &lt;/div>
            &lt;/div>
            &lt;div class="small text-muted mb-2">
              &lt;div class="row g-2">
                &lt;div class="col-md-4">
                  &lt;i class="fas fa-calendar-times text-danger">&lt;/i>
                  &lt;strong>Inactif depuis :&lt;/strong> ${rec.days_since_last} jours
                &lt;/div>
                &lt;div class="col-md-4">
                  &lt;i class="fas fa-euro-sign text-success">&lt;/i>
                  &lt;strong>Revenus :&lt;/strong> ${rec.total_value.toFixed(2)} ‚Ç¨
                &lt;/div>
                &lt;div class="col-md-4">
                  &lt;i class="fas fa-file-invoice">&lt;/i>
                  &lt;strong>Devis :&lt;/strong> ${rec.quotes_count}
                &lt;/div>
              &lt;/div>
            &lt;/div>
            &lt;div class="alert alert-warning mb-2 py-1 px-2 small">
              &lt;i class="fas fa-info-circle">&lt;/i> ${TextFormatter.escapeHtml(rec.reason)}
            &lt;/div>
            &lt;div class="d-flex gap-2">
              &lt;button class="btn btn-sm btn-secondary" onclick="followUpModule.viewClient(${rec.client_id})">
                &lt;i class="fas fa-eye">&lt;/i> Voir Client
              &lt;/button>
              &lt;button class="btn btn-sm btn-primary" onclick="followUpModule.createFollowUpForClient(${rec.client_id})">
                &lt;i class="fas fa-paper-plane">&lt;/i> Cr√©er Relance
              &lt;/button>
            &lt;/div>
          &lt;/div>
        `;
      });

      html += `
          &lt;/div>
        &lt;/div>
      `;

      container.innerHTML = html;

    } catch (error) {
      this.error('Erreur recommandations ML:', error);
      // Ne pas afficher d'erreur √† l'utilisateur (feature optionnelle)
    }
  }

  /**
   * Retourne la classe CSS pour le badge de priorit√©.
   *
   * @param {number} score - Score de priorit√©
   * @returns {string} Classe CSS Bootstrap
   * @private
   */
  getPriorityClass(score) {
    if (score >= 4) return 'bg-danger';
    if (score >= 2) return 'bg-warning text-dark';
    return 'bg-success';
  }

  /**
   * Retourne le label de priorit√©.
   *
   * @param {number} score - Score de priorit√©
   * @returns {string} Label
   * @private
   */
  getPriorityLabel(score) {
    if (score >= 4) return '√âLEV√âE';
    if (score >= 2) return 'MOYENNE';
    return 'BASSE';
  }

  /**
   * Affiche les d√©tails d'un client.
   *
   * @param {number} clientId - ID du client
   * @public
   */
  viewClient(clientId) {
    // Rediriger vers l'onglet clients avec le client s√©lectionn√©
    const clientsTab = document.querySelector('[data-bs-target="#clients"]');
    if (clientsTab) {
      clientsTab.click();
      // Attendre que l'onglet soit charg√© puis filtrer/s√©lectionner le client
      setTimeout(() => {
        this.events.emit('clients:select', { id: clientId });
      }, 300);
    }
  }

  /**
   * Cr√©e une relance pour un client sp√©cifique.
   *
   * @param {number} clientId - ID du client
   * @public
   */
  createFollowUpForClient(clientId) {
    // R√©cup√©rer les infos du client
    const clients = window.appState?.get('clients') || [];
    const client = clients.find(c => c.id === clientId);

    if (!client) {
      NotificationSystem.error('Client introuvable');
      return;
    }

    // Cr√©er une relance personnalis√©e
    NotificationSystem.info(
      `Cr√©ation de relance pour ${client.name}`,
      'Fonctionnalit√© en d√©veloppement'
    );

    // TODO: Impl√©menter la cr√©ation de relance personnalis√©e
    // - Ouvrir modal de composition email
    // - Pr√©-remplir avec template
    // - Envoyer et sauvegarder dans historique
  }

  /**
   * Nettoie le module
   */
  destroy() {
    this.pendingFollowUps = [];
    super.destroy();
  }
}

export default FollowUpModule;</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
