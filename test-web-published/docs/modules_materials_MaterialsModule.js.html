

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> modules/materials/MaterialsModule.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule.html">DashboardModule</a></li><li><a href="module-DataCache.html">DataCache</a></li><li><a href="module-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule.html">FECModule</a></li><li><a href="module-FollowUpModule.html">FollowUpModule</a></li><li><a href="module-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-KeyboardShortcutsModule.html">KeyboardShortcutsModule</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-MLService.html">MLService</a></li><li><a href="module-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-NotificationSystem.html">NotificationSystem</a></li><li><a href="module-NotificationSystemV2.html">NotificationSystemV2</a></li><li><a href="module-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-TourModule.html">TourModule</a></li><li><a href="module-UtilitiesModule.html">UtilitiesModule</a></li><li><a href="module-calculations.html">calculations</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-formatters.html">formatters</a></li><li><a href="module-helpers.html">helpers</a></li></ul><h3>Classes</h3><ul><li><a href="BaseModule.html">BaseModule</a></li><li><a href="BulkActionsManager.html">BulkActionsManager</a></li><li><a href="CacheKeys.html">CacheKeys</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="LoadingStateManager.html">LoadingStateManager</a></li><li><a href="ModalHelper.html">ModalHelper</a></li><li><a href="PaginationManager.html">PaginationManager</a></li><li><a href="ServerValidator.html">ServerValidator</a></li><li><a href="StateManager.html">StateManager</a></li><li><a href="TabRefreshManager.html">TabRefreshManager</a></li><li><a href="UndoRedoManager.html">UndoRedoManager</a></li><li><a href="module-AboutModule-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule-DashboardModule.html">DashboardModule</a></li><li><a href="module-ExportModule-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule-FECModule.html">FECModule</a></li><li><a href="module-ImportModule-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-Logger-Logger.html">Logger</a></li><li><a href="module-Logger-ModuleLogger.html">ModuleLogger</a></li><li><a href="module-MaterialsModule-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-PDFModule-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-UtilitiesModule-UtilitiesModule.html">UtilitiesModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#emitSync">emitSync</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#validateBeforeAddToQuote">validateBeforeAddToQuote</a></li><li><a href="global.html#validateBeforeExport">validateBeforeExport</a></li><li><a href="global.html#validateBeforeSaveMaterial">validateBeforeSaveMaterial</a></li><li><a href="global.html#validateBeforeSendEmail">validateBeforeSendEmail</a></li><li><a href="global.html#validateHeaderConfig">validateHeaderConfig</a></li><li><a href="global.html#validatePasswordChange">validatePasswordChange</a></li><li><a href="global.html#validateSMTPConfig">validateSMTPConfig</a></li><li><a href="global.html#waitFor">waitFor</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>modules/materials/MaterialsModule.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * ========================================
 * MATERIALS MODULE - Gestion des mat√©riaux
 * ========================================
 *
 * Module de gestion compl√®te du catalogue de mat√©riaux pour l'application AutoCalc OptiDevis.
 * G√®re tous les aspects li√©s aux mat√©riaux : chargement, affichage, recherche, filtrage,
 * CRUD (Create, Read, Update, Delete), et s√©lection pour devis.
 *
 * Architecture :
 * Le module fonctionne sur deux onglets distincts avec des r√¥les diff√©rents :
 *
 * 1. **Onglet Recherche** (tous les utilisateurs) :
 *    - Recherche rapide de mat√©riaux par nom, r√©f√©rence, type
 *    - Filtrage par cat√©gorie avec compteur
 *    - S√©lection de mat√©riaux pour les ajouter au devis en cours
 *    - Interface simplifi√©e optimis√©e pour la recherche
 *
 * 2. **Onglet Catalogue** (mode Admin uniquement) :
 *    - Tableau complet des mat√©riaux avec toutes les colonnes
 *    - Ajout, √©dition, suppression de mat√©riaux
 *    - Filtrage avanc√© (recherche texte + type + fournisseur)
 *    - Gestion compl√®te du catalogue
 *
 * Workflow principal - Ajout d'un mat√©riau :
 * 1. Utilisateur clique sur "Ajouter un mat√©riau" (onglet Catalogue)
 * 2. Modal s'ouvre avec formulaire vide
 * 3. Utilisateur remplit les champs (nom, type, prix TTC, TVA, etc.)
 * 4. Calcul automatique HT ‚Üê TTC et TVA
 * 5. Utilisateur clique "Enregistrer"
 * 6. Validation des champs obligatoires (nom, type)
 * 7. Appel IPC 'addMaterial' avec sessionToken
 * 8. Invalidation du cache + rechargement
 * 9. Rafra√Æchissement de la table + notification succ√®s
 *
 * Workflow principal - √âdition d'un mat√©riau :
 * 1. Utilisateur clique sur bouton "Modifier" d'un mat√©riau
 * 2. Modal s'ouvre avec formulaire pr√©rempli
 * 3. Utilisateur modifie les champs souhait√©s
 * 4. Utilisateur clique "Enregistrer"
 * 5. Appel IPC 'updateMaterial' avec sessionToken
 * 6. Invalidation du cache + rechargement
 * 7. Rafra√Æchissement de la table + notification succ√®s
 *
 * Workflow principal - Suppression d'un mat√©riau :
 * 1. Utilisateur clique sur bouton "Supprimer" d'un mat√©riau
 * 2. Modal de confirmation s'affiche
 * 3. Utilisateur confirme la suppression
 * 4. Appel IPC 'deleteMaterial' avec sessionToken
 * 5. Invalidation du cache + rechargement
 * 6. Rafra√Æchissement de la table + notification succ√®s
 *
 * Workflow principal - S√©lection pour devis :
 * 1. Utilisateur recherche un mat√©riau dans l'onglet Recherche
 * 2. R√©sultats affich√©s en temps r√©el avec filtrage
 * 3. Utilisateur clique sur "S√©lectionner" sur un mat√©riau
 * 4. Mat√©riau stock√© dans state.selectedMaterial + window.selectedMaterial
 * 5. Affichage mis √† jour dans le tableau de bord Vendeur
 * 6. QuoteBuilderModule peut utiliser ce mat√©riau pour calculer le devis
 *
 * Syst√®me de cache :
 * - Cache DataCache de 5 minutes pour les mat√©riaux
 * - Invalidation automatique lors de tout changement (ajout/modif/suppression)
 * - Protection contre l'√©crasement : si backend retourne [], on garde les mat√©riaux existants
 *
 * Syst√®me de filtrage :
 * - Recherche texte : nom, r√©f√©rence, type
 * - Filtre par type : dropdown avec compteur par cat√©gorie
 * - Filtre par fournisseur : activ√© depuis SuppliersModule (filterBySupplier)
 * - Filtres cumulatifs (ET logique)
 *
 * Calcul automatique des prix :
 * - L'utilisateur saisit le prix TTC et la TVA
 * - Le prix HT est calcul√© automatiquement : HT = TTC / (1 + TVA/100)
 * - Lors de l'affichage : TTC = HT * (1 + TVA/100)
 *
 * Compatibilit√© avec legacy code :
 * - Expos√© via window.materials pour quick-add.js et autre ancien code
 * - Synchronisation bidirectionnelle : window.materials ‚Üî this.materials ‚Üî state.materials
 * - Support de window.selectedMaterial pour compatibilit√©
 * - Fonctions expos√©es au scope global via exposeToGlobal()
 *
 * √âv√©nements √©mis :
 * - 'materials:initialized' - Module initialis√©
 * - 'materials:loaded' - Mat√©riaux charg√©s depuis backend/cache
 * - 'materials:added' - Mat√©riau ajout√©
 * - 'materials:updated' - Mat√©riau modifi√©
 * - 'materials:deleted' - Mat√©riau supprim√©
 * - 'materials:selected' - Mat√©riau s√©lectionn√© pour devis
 *
 * √âv√©nements √©cout√©s :
 * - 'suppliers:loaded' - Rafra√Æchir la liste des fournisseurs
 * - 'suppliers:updated' - Rafra√Æchir la liste des fournisseurs
 *
 * Canaux IPC utilis√©s :
 * - 'get-materials' - R√©cup√©rer tous les mat√©riaux
 * - 'addMaterial' - Ajouter un nouveau mat√©riau (n√©cessite sessionToken)
 * - 'updateMaterial' - Modifier un mat√©riau existant (n√©cessite sessionToken)
 * - 'deleteMaterial' - Supprimer un mat√©riau (n√©cessite sessionToken)
 *
 * Int√©grations :
 * - SuppliersModule : Liste des fournisseurs pour le select + filtrage
 * - QuoteBuilderModule : Mat√©riau s√©lectionn√© pour calcul de devis
 * - QuickAddModule : Ajout rapide de mat√©riaux (via window.materials)
 * - ScannerModule : Recherche par code-barres
 * - Dashboard Vendeur : Affichage du mat√©riau s√©lectionn√©
 *
 * @module MaterialsModule
 * @extends BaseModule
 * @version 2.0.0
 * @author AutoCalc OptiDevis
 */

import BaseModule from '../../core/BaseModule.js';
import NotificationSystem from '../../shared/ui/NotificationSystem.js';
import DataCache from '../../shared/ui/DataCache.js';
import ModalHelper from '../../shared/ui/ModalHelper.js';
import CacheKeys from '../../shared/cache/CacheKeys.js';
import LoadingStateManager from '../../shared/ui/LoadingStateManager.js';
import BulkActionsManager from '../../shared/bulk/BulkActionsManager.js';
import { TextFormatter } from '../../shared/utils/formatters.js';
import mlService from '../../shared/services/MLService.js';

class MaterialsModule extends BaseModule {
  /**
   * Cr√©e une instance du module Materials.
   *
   * @param {StateManager} state - Gestionnaire d'√©tat global
   * @param {EventBus} eventBus - Bus d'√©v√©nements pour communication inter-modules
   */
  constructor(state, eventBus) {
    super('materials', state, eventBus);

    /**
     * Cache local des mat√©riaux charg√©s depuis le backend.
     * Synchronis√© avec window.materials pour compatibilit√© legacy.
     *
     * @type {Array&lt;Object>}
     * @private
     * @property {number} id - ID unique du mat√©riau
     * @property {string} name - Nom du mat√©riau
     * @property {string} reference - R√©f√©rence (optionnel)
     * @property {string} type - Cat√©gorie/type du mat√©riau
     * @property {string} unit - Unit√© de mesure (m¬≤, m¬≥, kg, pi√®ce, etc.)
     * @property {number} price - Prix unitaire HT
     * @property {number} tva - Taux de TVA (en %)
     * @property {number} coverage - Rendement/couverture (m¬≤ par unit√©)
     * @property {number} piecesPerM2 - Nombre de pi√®ces par m¬≤
     * @property {number} density - Densit√© du mat√©riau
     * @property {number} unitWeight - Poids unitaire
     * @property {number} stock - Quantit√© en stock
     * @property {string} barcode - Code-barres (optionnel)
     * @property {number} purchaseCost - Co√ªt d'achat (optionnel)
     * @property {string} supplier - Nom du fournisseur (optionnel)
     */
    this.materials = [];

    /**
     * Mat√©riaux filtr√©s selon les crit√®res de recherche actuels.
     * Utilis√© pour l'affichage des r√©sultats de recherche dans l'onglet Recherche.
     *
     * @type {Array&lt;Object>}
     * @private
     */
    this.filteredMaterials = [];

    /**
     * Indicateur du mode d'√©dition du formulaire.
     * - false : Mode ajout (nouveau mat√©riau)
     * - true : Mode √©dition (modification d'un mat√©riau existant)
     *
     * @type {boolean}
     * @private
     */
    this.editMode = false;

    /**
     * ID du mat√©riau en attente de suppression.
     * Stock√© lors de la demande de confirmation (askDeleteMaterial)
     * et utilis√© lors de la confirmation finale (deleteMaterial).
     *
     * @type {number|null}
     * @private
     */
    this.materialToDeleteId = null;

    /**
     * Instance du modal Bootstrap de confirmation de suppression.
     *
     * @type {bootstrap.Modal|null}
     * @private
     */
    this.deleteModal = null;

    /**
     * Instance du modal Bootstrap du formulaire d'ajout/√©dition.
     *
     * @type {bootstrap.Modal|null}
     * @private
     */
    this.formModal = null;

    /**
     * Flag pour √©viter d'attacher les listeners de l'onglet Catalogue plusieurs fois.
     * Les listeners sont attach√©s de mani√®re lazy au premier affichage de l'onglet.
     *
     * @type {boolean}
     * @private
     */
    this.catalogueListenersAttached = false;

    /**
     * Nom du fournisseur utilis√© pour filtrer les mat√©riaux.
     * - null : Aucun filtre fournisseur actif
     * - string : Filtrer uniquement les mat√©riaux de ce fournisseur
     *
     * Activ√© via filterBySupplier() (g√©n√©ralement appel√© depuis SuppliersModule)
     * et d√©sactiv√© via clearSupplierFilter().
     *
     * @type {string|null}
     * @private
     */
    this.currentSupplierFilter = null;

    /**
     * Configuration de pagination pour le tableau des mat√©riaux.
     * @type {Object}
     * @private
     */
    this.pagination = {
      currentPage: 1,
      itemsPerPage: 25,
      totalItems: 0,
      totalPages: 0
    };

    /**
     * Gestionnaire des op√©rations bulk (s√©lection multiple).
     * @type {BulkActionsManager|null}
     * @private
     */
    this.bulkActions = null;
  }

  /**
   * Initialise le module Materials.
   *
   * Workflow d'initialisation :
   * 1. Charger les mat√©riaux depuis le backend (ou cache)
   * 2. Populer les filtres de type (onglets Recherche et Catalogue)
   * 3. Populer la table des mat√©riaux (onglet Catalogue)
   * 4. Attacher les event listeners (recherche, filtres, boutons)
   * 5. Exposer les fonctions au scope global (compatibilit√© legacy)
   * 6. Initialiser les modals Bootstrap (suppression, formulaire)
   * 7. Initialiser le calcul automatique HT/TTC
   * 8. √âcouter les mises √† jour des fournisseurs
   * 9. Populer la liste des fournisseurs dans le formulaire
   * 10. √âmettre l'√©v√©nement 'materials:initialized'
   *
   * @async
   * @returns {Promise&lt;void>}
   *
   * @example
   * const materialsModule = new MaterialsModule(state, eventBus);
   * await materialsModule.init();
   * // ‚Üí Mat√©riaux charg√©s et interface pr√™te
   */
  async init() {
    this.log('Initializing Materials Module...');
    console.log('üîÑ MaterialsModule v2.0 - Direct load (legacy removed)');

    // Charger les mat√©riaux directement depuis le backend
    await this.loadMaterials();
    console.log('üîç [DEBUG] Materials loaded, now populating UI...');

    // Populer les filtres et le tableau apr√®s chargement
    console.log('üîç [DEBUG] Calling populateTypeFilter...');
    this.populateTypeFilter();
    console.log('üîç [DEBUG] Calling populateSearchTypeFilter...');
    this.populateSearchTypeFilter();
    console.log('üîç [DEBUG] Calling populateMaterialsTable...');
    this.populateMaterialsTable();

    // Attacher les event listeners
    this.attachEventListeners();

    // Exposer les fonctions au scope global (compatibilit√©)
    this.exposeToGlobal({
      loadMaterials: this.loadMaterials,
      populateMaterialsTable: this.populateMaterialsTable,
      selectMaterial: this.selectMaterial, // R√©activ√© pour compatibilit√©
      addMaterial: this.addMaterial,
      saveMaterial: this.saveMaterial,
      editMaterial: this.editMaterial,
      deleteMaterial: this.deleteMaterial,
      askDeleteMaterial: this.askDeleteMaterial,
      clearMaterialForm: this.clearMaterialForm,
      updateSelectedMaterialDisplay: this.updateSelectedMaterialDisplay, // R√©activ√© pour compatibilit√©
      loadMaterialsIntoTable: this.loadMaterialsIntoTable,
      populateTypeFilter: this.populateTypeFilter,
      populateSearchTypeFilter: this.populateSearchTypeFilter,
      applyMaterialFilters: this.applyMaterialFilters,
      filterBySupplier: this.filterBySupplier,
      clearSupplierFilter: this.clearSupplierFilter,
      viewMaterialDetails: this.viewMaterialDetails,
      changePage: this.changePage,
      goToPage: this.goToPage,
      debouncedSearchMaterial: this.filterMaterialsForSearch, // Expose search function
      filterMaterialsForSearch: this.filterMaterialsForSearch // Expose both names for compatibility
    });

    // Exposer l'instance du module pour les m√©thodes de pagination
    window.materialsModule = this;

    // Initialiser le modal de suppression
    console.log('üîç [DEBUG] Initializing delete modal...');
    const deleteModalElement = this.getElement('#deleteMaterialModal');
    console.log('üîç [DEBUG] deleteModalElement:', !!deleteModalElement);
    console.log('üîç [DEBUG] bootstrap defined:', typeof bootstrap !== 'undefined');

    if (deleteModalElement &amp;&amp; typeof bootstrap !== 'undefined') {
      this.deleteModal = new bootstrap.Modal(deleteModalElement);
      console.log('‚úÖ [DEBUG] Delete modal initialized successfully');
      this.log('Delete modal initialized');
    } else {
      console.error('‚ùå [DEBUG] Delete modal NOT initialized! Element:', !!deleteModalElement, ', Bootstrap:', typeof bootstrap !== 'undefined');
      this.warn('Delete modal element not found or Bootstrap not loaded');
    }

    // Initialiser le modal du formulaire
    const formModalElement = this.getElement('#materialFormModal');
    if (formModalElement &amp;&amp; typeof bootstrap !== 'undefined') {
      this.formModal = new bootstrap.Modal(formModalElement);
      this.log('Form modal initialized');
    } else {
      this.warn('Form modal element not found or Bootstrap not loaded');
    }

    // Initialiser le calcul automatique HT/TTC
    this.initPriceCalculation();

    // √âcouter les mises √† jour des fournisseurs pour rafra√Æchir la liste
    this.events.on('suppliers:loaded', () => {
      this.populateSuppliersDatalist();
    });

    this.events.on('suppliers:updated', () => {
      this.populateSuppliersDatalist();
    });

    // Peupler la liste des fournisseurs
    this.populateSuppliersDatalist();

    // Initialiser bulk actions
    this.bulkActions = new BulkActionsManager({
      moduleName: 'materials',
      tableId: 'materials-table-body',
      checkboxClass: 'material-bulk-checkbox',
      selectAllId: 'materials-select-all',
      bulkActionsId: 'materials-bulk-actions',
      undoRedoManager: window.undoRedoManager,
      onDeleteCallback: this.bulkDeleteMaterials.bind(this),
      onExportCallback: this.bulkExportMaterials.bind(this)
    });

    // üÜï Enregistrer l'onglet Catalogue pour auto-refresh
    this.registerTabRefresh();

    // üÜï Enregistrer les commandes Command Palette (quand pr√™t)
    if (window.CommandPalette) {
      this.registerCommands();
    } else {
      // Attendre que Command Palette soit pr√™t
      this.events.on('commandpalette:ready', () => {
        this.registerCommands();
      });
    }

    this.log('Materials Module initialized successfully');
    this.emitEvent('initialized');
  }

  /**
   * üÜï Enregistre l'onglet Catalogue pour auto-refresh automatique.
   * Appel√© une fois lors de l'initialisation du module.
   *
   * @private
   * @returns {void}
   */
  registerTabRefresh() {
    // V√©rifier que TabRefreshManager est disponible
    if (!window.TabRefreshManager) {
      this.warn('TabRefreshManager not available - tab auto-refresh disabled');
      return;
    }

    // Onglet "Catalogue"
    window.TabRefreshManager.registerTab('admin-tab', async (force) => {
      this.log('üîÑ Auto-refreshing Catalogue...');
      await this.loadMaterials();
      this.populateMaterialsTable();
    }, {
      ttl: 60000, // 60 secondes (catalogue change moins souvent)
      label: 'Catalogue'
    });

    this.log('‚úÖ Tab auto-refresh registered');
  }

  /**
   * üÜï Enregistre les commandes Command Palette pour le module Materials.
   * Permet d'acc√©der aux fonctions mat√©riaux via Ctrl+K.
   *
   * @private
   * @returns {void}
   */
  registerCommands() {
    if (!window.CommandPalette) {
      this.warn('CommandPalette not available - commands registration skipped');
      return;
    }

    // Cr√©er un mat√©riau
    window.CommandPalette.registerCommand('materials-create', {
      label: '‚ú® Cr√©er un nouveau mat√©riau',
      keywords: ['cr√©er', 'nouveau', 'mat√©riau', 'material', 'produit', 'article', 'ajouter'],
      category: 'Catalogue',
      icon: '‚ú®',
      priority: 15,
      condition: (ctx) => ctx.isAdmin === true, // üîê Admin seulement
      action: async () => {
        document.getElementById('admin-tab')?.click();
        await new Promise(r => setTimeout(r, 150));
        this.addMaterial();
      }
    });

    // Rechercher un mat√©riau (accessible en mode Vendeur)
    window.CommandPalette.registerCommand('materials-search', {
      label: 'üîç Rechercher un mat√©riau',
      keywords: ['rechercher', 'chercher', 'trouver', 'mat√©riau', 'material', 'search'],
      category: 'Catalogue',
      icon: 'üîç',
      priority: 12,
      // Pas de condition = accessible √† tous
      action: () => {
        document.getElementById('search-tab')?.click();
        setTimeout(() => document.getElementById('searchMaterialInput')?.focus(), 150);
      }
    });

    // Importer catalogue
    window.CommandPalette.registerCommand('materials-import', {
      label: 'üì• Importer un catalogue',
      keywords: ['importer', 'import', 'catalogue', 'excel', 'csv', 'upload'],
      category: 'Catalogue',
      icon: 'üì•',
      priority: 8,
      condition: (ctx) => ctx.isAdmin === true, // üîê Admin seulement
      action: () => {
        window.NotificationSystem?.info('Import catalogue : Utilisez l\'onglet Configuration > Import');
      }
    });

    // Exporter catalogue
    window.CommandPalette.registerCommand('materials-export', {
      label: 'üì§ Exporter le catalogue',
      keywords: ['exporter', 'export', 'catalogue', 'excel', 'csv', 't√©l√©charger'],
      category: 'Catalogue',
      icon: 'üì§',
      priority: 8,
      condition: (ctx) => ctx.isAdmin === true, // üîê Admin seulement
      action: async () => {
        if (typeof window.exportMaterialsToExcel === 'function') {
          await window.exportMaterialsToExcel();
        } else {
          window.NotificationSystem?.warning('Fonction d\'export non disponible');
        }
      }
    });

    this.log('‚úÖ Command Palette commands registered');
  }

  /**
   * Attache tous les event listeners du module.
   *
   * Listeners attach√©s :
   * - Onglet Recherche : champ de recherche, filtre de type, bouton recherche
   * - Scanner : boutons de d√©marrage et arr√™t du scanner de code-barres
   * - Onglet Catalogue : ouverture de l'onglet (lazy loading des listeners)
   *
   * Note : Les listeners sp√©cifiques √† l'onglet Catalogue sont attach√©s s√©par√©ment
   * dans attachCatalogueListeners() au premier affichage de l'onglet (optimisation).
   *
   * @private
   * @returns {void}
   */
  attachEventListeners() {
    // Filtre de recherche dans l'onglet Recherche (disponible au d√©marrage)
    // Debouncing 300ms pour √©viter filtrage excessif √† chaque touche
    const materialSearchInput = this.getElement('#material-search-input');
    if (materialSearchInput) {
      let debounceTimer;
      materialSearchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          this.filterMaterialsForSearch();
        }, 300);
      });
    }

    const searchTypeFilter = this.getElement('#search-type-filter');
    if (searchTypeFilter) {
      searchTypeFilter.addEventListener('change', () => {
        this.filterMaterialsForSearch();
      });
    }

    // Bouton de recherche dans l'onglet Recherche (search-btn)
    const searchBtn = this.getElement('#search-btn');
    if (searchBtn) {
      searchBtn.addEventListener('click', () => {
        const searchInput = this.getElement('#search-input');
        if (!searchInput || !searchInput.value.trim()) {
          window.forceShowAll = true;
          if (typeof window.debouncedSearchMaterial === 'function') {
            window.debouncedSearchMaterial();
          }
          if (window.materials) {
            NotificationSystem.info(`${window.materials.length} mat√©riaux affich√©s`, 2000);
          }
        } else {
          if (typeof window.debouncedSearchMaterial === 'function') {
            window.debouncedSearchMaterial();
          }
        }
      });
    }

    // Input de recherche g√©n√©rale (search-input)
    const searchInput = this.getElement('#search-input');
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        if (typeof window.debouncedSearchMaterial === 'function') {
          window.debouncedSearchMaterial();
        }
      });

      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          if (!searchInput.value.trim()) {
            window.forceShowAll = true;
          }
          if (typeof window.debouncedSearchMaterial === 'function') {
            window.debouncedSearchMaterial();
          }
        }
      });
    }

    // Scanner de code-barres
    const scanBarcodeBtn = this.getElement('#scan-barcode-btn');
    if (scanBarcodeBtn) {
      scanBarcodeBtn.addEventListener('click', () => {
        if (typeof window.startScanner === 'function') {
          window.startScanner();
        }
      });
    }

    const closeScannerBtn = this.getElement('#close-scanner');
    if (closeScannerBtn) {
      closeScannerBtn.addEventListener('click', () => {
        if (typeof window.stopScanner === 'function') {
          window.stopScanner();
        }
      });
    }

    // √âcouter l'√©v√©nement d'ouverture de l'onglet Catalogue pour attacher les listeners et populer la table
    const adminTab = this.getElement('#admin-tab');
    if (adminTab) {
      adminTab.addEventListener('shown.bs.tab', () => {
        console.log('üìë [DEBUG] Catalogue tab shown - populating table...');
        this.attachCatalogueListeners();
        this.populateMaterialsTable(); // Populer la table quand l'onglet est visible
      });
    }

    this.log('Event listeners attached');
  }

  /**
   * Initialise le calcul automatique HT/TTC dans le formulaire mat√©riau.
   *
   * Lorsque l'utilisateur modifie le prix TTC ou la TVA, le prix HT est recalcul√©
   * automatiquement selon la formule : HT = TTC / (1 + TVA/100)
   *
   * Exemples de calculs :
   * - TTC: 120‚Ç¨, TVA: 20% ‚Üí HT = 120 / 1.20 = 100‚Ç¨
   * - TTC: 550‚Ç¨, TVA: 10% ‚Üí HT = 550 / 1.10 = 500‚Ç¨
   *
   * @private
   * @returns {void}
   */
  initPriceCalculation() {
    const priceTTCInput = this.getElement('#material-price-ttc');
    const tvaInput = this.getElement('#material-tva');
    const priceHTInput = this.getElement('#material-price');

    if (!priceTTCInput || !tvaInput || !priceHTInput) return;

    // Fonction pour calculer le HT √† partir du TTC
    const calculateHT = () => {
      const ttc = parseFloat(priceTTCInput.value) || 0;
      const tva = parseFloat(tvaInput.value) || 20;
      const ht = ttc / (1 + tva / 100);
      priceHTInput.value = ht.toFixed(2);
    };

    // √âcouter les changements sur TTC et TVA
    priceTTCInput.addEventListener('input', calculateHT);
    tvaInput.addEventListener('input', calculateHT);

    this.log('Price calculation initialized');
  }

  /**
   * Attache les listeners sp√©cifiques √† l'onglet Catalogue.
   *
   * Cette m√©thode est appel√©e lors du premier affichage de l'onglet Catalogue
   * (optimisation pour √©viter d'attacher des listeners sur des √©l√©ments non visibles).
   *
   * Listeners attach√©s :
   * - Bouton "Ajouter un mat√©riau"
   * - Bouton "Enregistrer" du formulaire
   * - Bouton "Confirmer la suppression"
   * - Bouton "Annuler" du formulaire
   * - Bouton "Ajouter un fournisseur" depuis le formulaire mat√©riau
   * - Champ de recherche dans le catalogue
   * - Filtre par type dans le catalogue
   *
   * @private
   * @returns {void}
   */
  attachCatalogueListeners() {
    // Ne les attacher qu'une seule fois
    if (this.catalogueListenersAttached) return;

    // Boutons de gestion des mat√©riaux
    this.addDOMListener('#add-material-btn', 'click', () => {
      this.addMaterial();
    });

    this.addDOMListener('#save-material-btn', 'click', () => {
      this.saveMaterial();
    });

    this.addDOMListener('#confirmDeleteMaterialBtn', 'click', () => {
      if (this.materialToDeleteId) {
        this.deleteMaterial(this.materialToDeleteId);
      }
    });

    this.addDOMListener('#cancel-material-btn', 'click', () => {
      this.clearMaterialForm();
    });

    // Bouton pour ajouter un fournisseur depuis le formulaire mat√©riau
    this.addDOMListener('#add-supplier-from-material-btn', 'click', () => {
      // Ouvrir le formulaire d'ajout de fournisseur
      if (typeof window.addSupplier === 'function') {
        window.addSupplier();
      } else {
        this.warn('Fonction addSupplier non disponible');
      }
    });

    // Filtres de recherche de l'onglet Catalogue
    // Debouncing 300ms pour optimiser les performances avec grands catalogues
    const searchInput = this.getElement('#search-materials');
    if (searchInput) {
      let debounceTimer;
      searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          this.applyMaterialFilters();
        }, 300);
      });
    }

    const typeFilter = this.getElement('#filter-type');
    if (typeFilter) {
      typeFilter.addEventListener('change', () => {
        this.applyMaterialFilters();
      });
    }

    // Pagination - S√©lecteur items par page
    const itemsPerPageSelect = this.getElement('#materials-items-per-page');
    if (itemsPerPageSelect) {
      itemsPerPageSelect.addEventListener('change', (e) => {
        this.pagination.itemsPerPage = parseInt(e.target.value);
        this.pagination.currentPage = 1; // Reset to first page
        this.applyMaterialFilters();
      });
    }

    this.catalogueListenersAttached = true;
    this.log('Catalogue listeners attached');
  }

  /**
   * Attends que l'ancien code (app-old.js) ait charg√© les mat√©riaux.
   *
   * **DEPRECATED - Legacy compatibility only**
   * Cette m√©thode est conserv√©e pour compatibilit√© avec app-old.js.
   * Elle sera supprim√©e quand app-old.js sera compl√®tement retir√©.
   *
   * Workflow :
   * 1. V√©rifier toutes les 50ms si window.materials est d√©fini et non vide
   * 2. Si trouv√© : copier dans this.materials et state.materials, populer les filtres, retourner
   * 3. Si non trouv√© apr√®s 5 secondes : charger nous-m√™mes via loadMaterials()
   *
   * @async
   * @private
   * @deprecated Sera supprim√© lors du retrait complet de app-old.js
   * @returns {Promise&lt;void>}
   */
  async waitForLegacyMaterialsLoad() {
    const maxWait = 5000; // 5 secondes max
    const checkInterval = 50; // V√©rifier toutes les 50ms
    let waited = 0;

    while (waited &lt; maxWait) {
      if (window.materials &amp;&amp; window.materials.length > 0) {
        this.log(`‚úÖ Using materials already loaded by legacy code: ${window.materials.length} items`);
        this.materials = window.materials;
        this.state.set('materials', window.materials);

        // Populer les filtres
        this.populateTypeFilter();
        this.populateSearchTypeFilter();

        this.emitEvent('loaded', this.materials);
        return;
      }

      // Attendre un peu avant de rev√©rifier
      await new Promise(resolve => setTimeout(resolve, checkInterval));
      waited += checkInterval;
    }

    // Si apr√®s 5 secondes les mat√©riaux ne sont toujours pas charg√©s, charger nous-m√™mes
    this.warn('Legacy materials not loaded after 5s, loading ourselves...');
    await this.loadMaterials();
  }

  /**
   * Charge les mat√©riaux depuis le backend ou le cache.
   *
   * Workflow :
   * 1. V√©rifier le cache DataCache (validit√© : 5 minutes)
   * 2. Si cache valide : charger depuis cache, exposer √† window.materials, √©mettre event
   * 3. Si cache invalide/expir√© : appeler IPC 'get-materials'
   * 4. Parser la r√©ponse (peut √™tre tableau direct ou {data: [...]} ou {materials: [...]})
   * 5. **Protection critique** : si backend retourne [], mais mat√©riaux d√©j√† charg√©s ‚Üí GARDER les existants
   * 6. Sinon : stocker dans this.materials + state.materials + window.materials
   * 7. Mettre en cache (si non vide)
   * 8. √âmettre √©v√©nement 'materials:loaded'
   * 9. Populer les filtres de type
   *
   * Protection contre l'√©crasement accidentel :
   * Si le backend retourne un tableau vide mais que des mat√©riaux sont d√©j√† charg√©s
   * (dans window.materials ou this.materials), on conserve les mat√©riaux existants
   * au lieu de les √©craser. Ceci √©vite la perte de donn√©es en cas d'erreur backend temporaire.
   *
   * @async
   * @returns {Promise&lt;void>}
   *
   * @fires materials:loaded - √âmis quand les mat√©riaux sont charg√©s avec succ√®s
   *
   * @example
   * await materialsModule.loadMaterials();
   * // ‚Üí Mat√©riaux charg√©s depuis cache ou backend
   * // ‚Üí window.materials, this.materials, state.materials sont synchronis√©s
   */
  async loadMaterials() {
    try {
      console.log('üîÑ loadMaterials() called');
      console.log('üîÑ Current window.materials:', window.materials?.length || 'undefined');
      console.log('üîÑ Current this.materials:', this.materials?.length || 'undefined');

      // V√©rifier le cache
      const cached = DataCache.get('materials');
      if (cached &amp;&amp; cached.length > 0) {
        this.materials = cached;
        this.state.set('materials', cached);

        // Exposer au scope global pour compatibilit√© avec quick-add.js
        window.materials = cached;

        console.log(`‚úÖ Materials loaded from cache: ${cached.length} items`);
        this.emitEvent('loaded', this.materials);
        return;
      }

      // üÜï Afficher skeleton screen pendant le chargement
      LoadingStateManager.showSkeleton('#materials-table-body', 'table', 8);

      // Charger depuis le backend
      console.log('üåê Calling backend API get-materials...');
      const response = await this.invoke('get-materials');
      console.log('üåê Backend response:', response);

      // G√©rer le cas o√π la r√©ponse est un objet ou un tableau direct
      // Le backend peut retourner: {success: true, data: [...]} OU {materials: [...]} OU directement [...]
      const materials = Array.isArray(response)
        ? response
        : (response.data || response.materials || []);
      console.log(`üåê Parsed materials: ${materials.length} items`);

      // üõ°Ô∏è PROTECTION CRITIQUE: Ne PAS √©craser avec un tableau vide si des mat√©riaux existent d√©j√†
      if (materials.length === 0 &amp;&amp; (window.materials?.length > 0 || this.materials?.length > 0)) {
        console.warn('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Backend returned 0 materials but we already have materials loaded!');
        console.warn('‚ö†Ô∏è Keeping existing materials instead of overwriting with empty array');
        console.warn(`‚ö†Ô∏è window.materials: ${window.materials?.length || 0}, this.materials: ${this.materials?.length || 0}`);

        // Garder les mat√©riaux existants
        const existingMaterials = window.materials || this.materials;

        NotificationSystem.warning('Les mat√©riaux existants ont √©t√© conserv√©s (erreur de rechargement)');
        this.emitEvent('loaded', existingMaterials);
        return;
      }

      // Si on arrive ici, soit materials.length > 0, soit aucun mat√©riau n'existait avant
      this.materials = materials;
      this.state.set('materials', materials);

      // Exposer au scope global pour compatibilit√© avec quick-add.js
      window.materials = materials;

      // Mettre en cache SEULEMENT si on a des mat√©riaux
      if (materials.length > 0) {
        DataCache.set('materials', materials, 5 * 60 * 1000); // 5 min
      }

      console.log(`‚úÖ Loaded ${materials.length} materials from backend`);
      this.emitEvent('loaded', materials);

      // üÜï Cacher le skeleton screen
      LoadingStateManager.hideSkeleton('#materials-table-body');

      // Populer les filtres
      this.populateTypeFilter();
      this.populateSearchTypeFilter();

    } catch (error) {
      console.error('‚ùå Error loading materials:', error);
      this.error('Error loading materials:', error);

      // üÜï Afficher √©tat d'erreur avec bouton retry
      LoadingStateManager.showErrorState(
        '#materials-table-body',
        'Impossible de charger les mat√©riaux',
        () => this.loadMaterials()
      );

      NotificationSystem.error('Erreur lors du chargement des mat√©riaux');
    }
  }

  /**
   * Populate la table des mat√©riaux dans l'onglet Catalogue avec pagination.
   *
   * Affiche tous les mat√©riaux ou un sous-ensemble filtr√© dans le tableau HTML.
   * Les mat√©riaux sont tri√©s par ID num√©rique croissant pour un affichage coh√©rent.
   * Applique la pagination si activ√©e.
   *
   * Colonnes affich√©es :
   * ID, Nom, Prix TTC, Rendement, Stock, Code-barres, Type, Fournisseur,
   * Densit√©, Pi√®ces/m¬≤, Unit√©, TVA, Actions (Modifier/Supprimer)
   *
   * @param {Array&lt;Object>|null} [filteredMaterials=null] - Mat√©riaux filtr√©s √† afficher.
   *                                                         Si null, affiche tous les mat√©riaux.
   * @returns {void}
   *
   * @example
   * // Afficher tous les mat√©riaux
   * materialsModule.populateMaterialsTable();
   *
   * @example
   * // Afficher uniquement les mat√©riaux filtr√©s
   * const filtered = materials.filter(m => m.type === 'Carrelage');
   * materialsModule.populateMaterialsTable(filtered);
   */
  populateMaterialsTable(filteredMaterials = null) {
    console.log('üîç [DEBUG] populateMaterialsTable() called');

    const materialsSource = window.materials || this.materials;
    const materialsToShow = filteredMaterials || materialsSource;
    const tbody = this.getElement('#materials-table-body');

    console.log('üîç [DEBUG] materialsSource length:', materialsSource?.length);
    console.log('üîç [DEBUG] materialsToShow length:', materialsToShow?.length);
    console.log('üîç [DEBUG] tbody element found:', !!tbody);

    if (!tbody) {
      // Le tableau n'est pas pr√©sent dans tous les contextes (normal en mode admin sur d'autres onglets)
      console.log('‚ö†Ô∏è [DEBUG] tbody not found - exiting populateMaterialsTable');
      return;
    }

    if (materialsToShow.length === 0) {
      console.log('‚ö†Ô∏è [DEBUG] No materials to show - setting empty message');
      tbody.innerHTML = '&lt;tr>&lt;td colspan="5" class="text-center">Aucun mat√©riau trouv√©&lt;/td>&lt;/tr>';
      this.updatePaginationControls(0, []);
      return;
    }

    // Trier les mat√©riaux par ID num√©rique
    const sortedMaterials = [...materialsToShow].sort((a, b) => {
      const idA = parseInt(a.id) || 0;
      const idB = parseInt(b.id) || 0;
      return idA - idB;
    });

    // Mettre √† jour les infos de pagination
    this.pagination.totalItems = sortedMaterials.length;
    this.pagination.totalPages = Math.ceil(sortedMaterials.length / this.pagination.itemsPerPage);

    // S'assurer que currentPage est dans les limites
    if (this.pagination.currentPage > this.pagination.totalPages) {
      this.pagination.currentPage = this.pagination.totalPages || 1;
    }

    // Calculer les indices de d√©but et fin pour la page actuelle
    const startIndex = (this.pagination.currentPage - 1) * this.pagination.itemsPerPage;
    const endIndex = startIndex + this.pagination.itemsPerPage;
    const paginatedMaterials = sortedMaterials.slice(startIndex, endIndex);

    console.log('‚úÖ [DEBUG] Generating HTML for', paginatedMaterials.length, 'materials (page', this.pagination.currentPage, 'of', this.pagination.totalPages, ')');
    tbody.innerHTML = paginatedMaterials.map(material => {
      const priceHT = typeof material.price === 'number' ? material.price : 0;
      const tvaValue = material.tva || (material.tvaRate * 100) || 20;
      const priceTTC = priceHT * (1 + tvaValue / 100);
      const stock = TextFormatter.escapeHtml(material.stock ?? '-');
      const type = TextFormatter.escapeHtml(material.type ?? '-');
      const name = TextFormatter.escapeHtml(material.name ?? '-');

      return `
        &lt;tr data-id="${material.id}">
          &lt;td class="text-center">
            &lt;input type="checkbox"
                   class="form-check-input material-bulk-checkbox"
                   data-id="${material.id}">
          &lt;/td>
          &lt;td>&lt;strong>${name}&lt;/strong>&lt;/td>
          &lt;td>${priceTTC.toFixed(2)} ‚Ç¨&lt;/td>
          &lt;td>${stock}&lt;/td>
          &lt;td>${type}&lt;/td>
          &lt;td>
            &lt;div class="btn-icon-group">
              &lt;button onclick="viewMaterialDetails(${material.id})" class="btn btn-sm btn-info btn-icon" data-bs-toggle="tooltip" title="Voir d√©tails">&lt;i class="fas fa-info-circle">&lt;/i>&lt;/button>
              &lt;button onclick="editMaterial(${material.id})" class="btn btn-sm btn-primary btn-icon" data-bs-toggle="tooltip" title="Modifier">&lt;i class="fas fa-edit">&lt;/i>&lt;/button>
              &lt;button class="btn btn-sm btn-danger btn-icon" onclick="askDeleteMaterial(${material.id})" data-bs-toggle="tooltip" title="Supprimer">&lt;i class="fas fa-trash-alt">&lt;/i>&lt;/button>
            &lt;/div>
          &lt;/td>
        &lt;/tr>
      `;
    }).join('');

    console.log('‚úÖ [DEBUG] HTML generated and set to tbody. Total rows:', paginatedMaterials.length);
    this.log(`Populated table with ${paginatedMaterials.length}/${sortedMaterials.length} materials (page ${this.pagination.currentPage}/${this.pagination.totalPages})`);

    // Mettre √† jour les contr√¥les de pagination
    this.updatePaginationControls(sortedMaterials.length, paginatedMaterials);

    // Initialiser les bulk actions
    if (this.bulkActions) {
      this.bulkActions.initialize();
    }
  }

  /**
   * Charge les mat√©riaux dans la table (callback onglet).
   *
   * M√©thode de convenance qui combine le chargement des mat√©riaux
   * et la population de la table en une seule op√©ration.
   * Utilis√©e comme callback lors de l'ouverture de l'onglet Catalogue.
   *
   * @async
   * @returns {Promise&lt;void>}
   */
  async loadMaterialsIntoTable() {
    await this.loadMaterials();
    this.populateMaterialsTable();
  }

  /**
   * Populate le filtre de type dans l'onglet Catalogue.
   *
   * G√©n√®re dynamiquement les options du select de filtrage par type,
   * avec un compteur du nombre de mat√©riaux par type.
   *
   * Format des options : "Type (nombre)" (ex: "Carrelage (42)")
   * Les types sont tri√©s alphab√©tiquement.
   *
   * @private
   * @returns {void}
   *
   * @example
   * // Apr√®s chargement des mat√©riaux
   * this.populateTypeFilter();
   * // ‚Üí Select contient: "Tous les types", "Carrelage (42)", "Peinture (18)", etc.
   */
  populateTypeFilter() {
    const typeFilter = this.getElement('#filter-type');
    if (!typeFilter) return;

    const materialsSource = window.materials || this.materials;

    // Compter les mat√©riaux par type
    const typeCount = {};
    materialsSource.forEach(m => {
      const type = m.type || 'Non cat√©goris√©';
      typeCount[type] = (typeCount[type] || 0) + 1;
    });

    const types = Object.keys(typeCount).sort();

    typeFilter.innerHTML = '&lt;option value="">Tous les types&lt;/option>' +
      types.map(type => `&lt;option value="${type}">${type} (${typeCount[type]})&lt;/option>`).join('');
  }

  /**
   * Populate le filtre de type dans l'onglet Recherche.
   *
   * G√©n√®re dynamiquement les options du select de filtrage par type,
   * avec un compteur du nombre de mat√©riaux par type.
   * Identique √† populateTypeFilter() mais pour l'onglet Recherche.
   *
   * Format des options : "Type (nombre)" (ex: "Carrelage (42)")
   * Les types sont tri√©s alphab√©tiquement.
   *
   * @private
   * @returns {void}
   */
  populateSearchTypeFilter() {
    const typeFilter = this.getElement('#search-type-filter');
    if (!typeFilter) {
      this.log('‚ö†Ô∏è search-type-filter element not found (normal if not on Recherche tab)');
      return;
    }

    const materialsSource = window.materials || this.materials;

    // Compter le nombre de mat√©riaux par type
    const typeCount = {};
    materialsSource.forEach(material => {
      const type = material.type || 'Non cat√©goris√©';
      typeCount[type] = (typeCount[type] || 0) + 1;
    });

    // Trier les types alphab√©tiquement
    const sortedTypes = Object.keys(typeCount).sort();

    // G√©n√©rer les options avec compteur
    typeFilter.innerHTML = '&lt;option value="">Toutes les cat√©gories&lt;/option>' +
      sortedTypes.map(type => `&lt;option value="${type}">${type} (${typeCount[type]})&lt;/option>`).join('');

    this.log(`‚úÖ Filtre par cat√©gorie (Recherche) rafra√Æchi: ${sortedTypes.length} types`);
  }

  /**
   * Applique les filtres sur les mat√©riaux dans l'onglet Catalogue.
   *
   * Filtres cumulatifs appliqu√©s (logique ET) :
   * 1. Recherche textuelle : nom, r√©f√©rence, type (insensible √† la casse)
   * 2. Filtre par type : cat√©gorie exacte
   * 3. Filtre par fournisseur : nom exact (si this.currentSupplierFilter est d√©fini)
   *
   * Appelle populateMaterialsTable() avec les mat√©riaux filtr√©s.
   * Loggue le nombre de r√©sultats trouv√©s.
   *
   * @returns {void}
   *
   * @example
   * // Utilisateur tape "carrelage" dans la recherche et s√©lectionne type "Sol"
   * this.applyMaterialFilters();
   * // ‚Üí Affiche uniquement les mat√©riaux de type "Sol" contenant "carrelage"
   */
  applyMaterialFilters() {
    const searchText = this.getValue('#search-materials')?.toLowerCase() || '';
    const selectedType = this.getValue('#filter-type') || '';

    const materialsSource = window.materials || this.materials;
    const filtered = materialsSource.filter(material => {
      const matchesSearch = !searchText ||
        material.name?.toLowerCase().includes(searchText) ||
        material.reference?.toLowerCase().includes(searchText) ||
        material.type?.toLowerCase().includes(searchText);

      const matchesType = !selectedType || material.type === selectedType;

      // Filtre par fournisseur (si actif)
      const matchesSupplier = !this.currentSupplierFilter || material.supplier === this.currentSupplierFilter;

      return matchesSearch &amp;&amp; matchesType &amp;&amp; matchesSupplier;
    });

    this.populateMaterialsTable(filtered);
    this.log(`Filtered: ${filtered.length}/${materialsSource.length} materials`);
  }

  /**
   * Filtre les mat√©riaux par fournisseur.
   *
   * Cette m√©thode est g√©n√©ralement appel√©e depuis le SuppliersModule
   * lorsque l'utilisateur clique sur "Voir les mat√©riaux" d'un fournisseur.
   *
   * Workflow :
   * 1. D√©finir this.currentSupplierFilter = supplierName
   * 2. R√©initialiser les autres filtres (recherche, type)
   * 3. Appliquer les filtres (applyMaterialFilters)
   * 4. Afficher un indicateur visuel du filtre actif
   *
   * @param {string} supplierName - Nom du fournisseur √† filtrer (ou null pour r√©initialiser)
   * @returns {void}
   *
   * @example
   * // Depuis SuppliersModule
   * materialsModule.filterBySupplier('Leroy Merlin');
   * // ‚Üí Affiche uniquement les mat√©riaux du fournisseur "Leroy Merlin"
   */
  filterBySupplier(supplierName) {
    this.log(`Filtering materials by supplier: ${supplierName || 'NONE'}`);

    // D√©finir le filtre actif
    this.currentSupplierFilter = supplierName;

    // R√©initialiser les autres filtres pour voir tous les mat√©riaux du fournisseur
    this.setValue('#search-materials', '');
    this.setValue('#filter-type', '');

    // Appliquer les filtres
    this.applyMaterialFilters();

    // Afficher un indicateur visuel du filtre actif
    this.updateSupplierFilterIndicator(supplierName);
  }

  /**
   * Met √† jour l'indicateur visuel du filtre fournisseur actif.
   *
   * Affiche une alerte Bootstrap en haut de l'onglet Catalogue pour indiquer
   * qu'un filtre fournisseur est actif, avec un bouton pour le supprimer.
   *
   * @param {string|null} supplierName - Nom du fournisseur filtr√©, ou null pour masquer l'indicateur
   * @private
   * @returns {void}
   *
   * @example
   * this.updateSupplierFilterIndicator('Leroy Merlin');
   * // ‚Üí Affiche "Filtre actif : Fournisseur 'Leroy Merlin'" avec bouton de fermeture
   *
   * this.updateSupplierFilterIndicator(null);
   * // ‚Üí Masque l'indicateur
   */
  updateSupplierFilterIndicator(supplierName) {
    const container = this.getElement('#supplier-filter-container');
    if (!container) return;

    if (supplierName) {
      // Afficher l'indicateur
      container.innerHTML = `
        &lt;div class="alert alert-info alert-dismissible fade show mb-0 d-flex align-items-center" role="alert" style="position: relative; clear: both; width: 100%;">
          &lt;i class="fas fa-filter me-2">&lt;/i>
          &lt;strong>Filtre actif :&lt;/strong>&amp;nbsp;Fournisseur "${supplierName}"
          &lt;button type="button" class="btn-close ms-auto" onclick="window.clearSupplierFilter()" aria-label="Fermer">&lt;/button>
        &lt;/div>
      `;
    } else {
      // Effacer l'indicateur
      container.innerHTML = '';
    }
  }

  /**
   * R√©initialise le filtre par fournisseur.
   *
   * Supprime le filtre fournisseur actif, masque l'indicateur visuel,
   * et r√©applique les autres filtres.
   *
   * @returns {void}
   *
   * @example
   * materialsModule.clearSupplierFilter();
   * // ‚Üí Affiche √† nouveau tous les mat√©riaux (selon autres filtres actifs)
   */
  clearSupplierFilter() {
    this.log('Clearing supplier filter');
    this.currentSupplierFilter = null;
    this.updateSupplierFilterIndicator(null);
    this.applyMaterialFilters();
  }

  /**
   * Filtre les mat√©riaux pour la recherche dans l'onglet Recherche.
   *
   * Applique les crit√®res de recherche et affiche les r√©sultats en temps r√©el.
   *
   * Filtres appliqu√©s :
   * - Recherche textuelle : nom, r√©f√©rence, type (insensible √† la casse)
   * - Filtre par type : cat√©gorie exacte
   *
   * Les r√©sultats sont stock√©s dans this.filteredMaterials et affich√©s
   * via displaySearchResults().
   *
   * @private
   * @returns {void}
   */
  async filterMaterialsForSearch() {
    const searchText = this.getValue('#search-input')?.toLowerCase() || '';
    const selectedType = this.getValue('#search-type-filter') || '';

    const materialsSource = window.materials || this.materials;
    const filtered = materialsSource.filter(material => {
      const matchesSearch = !searchText ||
        material.name?.toLowerCase().includes(searchText) ||
        material.reference?.toLowerCase().includes(searchText) ||
        material.type?.toLowerCase().includes(searchText);

      const matchesType = !selectedType || material.type === selectedType;

      return matchesSearch &amp;&amp; matchesType;
    });

    this.filteredMaterials = filtered;
    this.displaySearchResults(filtered);

    // Suggestions ML intelligentes (si recherche active)
    if (searchText &amp;&amp; searchText.length >= 3) {
      await this.displayMLSuggestions(searchText);
    }
  }

  /**
   * Affiche les r√©sultats de recherche dans l'onglet Recherche.
   *
   * G√©n√®re des cartes HTML pour chaque mat√©riau trouv√©, tri√©es par ID num√©rique.
   * Chaque carte affiche :
   * - Nom et r√©f√©rence
   * - Prix TTC calcul√©
   * - Type
   * - Stock
   * - Bouton "S√©lectionner"
   *
   * @param {Array&lt;Object>} materials - Mat√©riaux √† afficher
   * @private
   * @returns {void}
   *
   * @example
   * const filtered = materials.filter(m => m.name.includes('carrelage'));
   * this.displaySearchResults(filtered);
   * // ‚Üí Affiche les cartes de mat√©riaux contenant "carrelage"
   */
  displaySearchResults(materials) {
    const resultsContainer = this.getElement('#search-results');
    if (!resultsContainer) return;

    if (materials.length === 0) {
      resultsContainer.innerHTML = '&lt;p class="text-muted">Aucun mat√©riau trouv√©&lt;/p>';
      return;
    }

    // R√©cup√©rer le terme de recherche pour tri par pertinence
    const searchText = this.getValue('#search-input')?.toLowerCase() || '';

    // Trier les mat√©riaux par pertinence puis par ID
    const sortedMaterials = [...materials].sort((a, b) => {
      if (!searchText) {
        // Pas de recherche : tri par ID
        return (parseInt(a.id) || 0) - (parseInt(b.id) || 0);
      }

      // Calculer score de pertinence pour chaque mat√©riau
      const getRelevanceScore = (material) => {
        const name = (material.name || '').toLowerCase();
        const reference = (material.reference || '').toLowerCase();
        const type = (material.type || '').toLowerCase();

        // Correspondance exacte dans le nom = 1000 points
        if (name === searchText) return 1000;

        // Nom commence par le terme de recherche = 500 points
        if (name.startsWith(searchText)) return 500;

        // Nom contient le terme de recherche = 300 points
        if (name.includes(searchText)) return 300;

        // R√©f√©rence contient le terme = 200 points
        if (reference.includes(searchText)) return 200;

        // Type contient le terme = 100 points
        if (type.includes(searchText)) return 100;

        return 0;
      };

      const scoreA = getRelevanceScore(a);
      const scoreB = getRelevanceScore(b);

      // Trier par score d√©croissant, puis par ID si √©galit√©
      if (scoreB !== scoreA) {
        return scoreB - scoreA;
      }
      return (parseInt(a.id) || 0) - (parseInt(b.id) || 0);
    });

    resultsContainer.innerHTML = sortedMaterials.map(material => {
      // Calculer le Prix TTC comme dans le backup
      const priceTTC = (material.price || 0) * (1 + (material.tva || 20) / 100);
      const name = TextFormatter.escapeHtml(material.name);
      const reference = TextFormatter.escapeHtml(material.reference || '-');
      const type = TextFormatter.escapeHtml(material.type || '-');
      const stock = material.stock !== undefined ? material.stock : 'N/A';

      return `
        &lt;div class="mb-2 p-2 border rounded" style="cursor: pointer;">
          &lt;strong>${name}&lt;/strong> (R√©f: ${reference})&lt;br>
          Prix TTC: ${priceTTC.toFixed(2)} ‚Ç¨&lt;br>
          Type: ${type}&lt;br>
          Stock: ${stock}&lt;br>
          &lt;button class="btn btn-primary btn-sm mt-2" onclick="selectMaterial(${material.id})">S√©lectionner&lt;/button>
        &lt;/div>
      `;
    }).join('');
  }

  /**
   * Affiche les suggestions ML intelligentes bas√©es sur la recherche.
   *
   * Cette m√©thode utilise le MLService pour obtenir des suggestions
   * de mat√©riaux similaires via algorithme TF-IDF (si serveur ML actif)
   * ou recherche textuelle simple (fallback JavaScript).
   *
   * Les suggestions sont affich√©es en haut des r√©sultats avec un badge "ML"
   * et un pourcentage de pertinence.
   *
   * @param {string} searchQuery - Terme de recherche
   * @returns {Promise&lt;void>}
   * @private
   *
   * @example
   * await this.displayMLSuggestions('b√©ton');
   * // ‚Üí Affiche suggestions intelligentes pour "b√©ton"
   */
  async displayMLSuggestions(searchQuery) {
    try {
      // R√©cup√©rer suggestions via MLService (auto-fallback si ML indisponible)
      const suggestions = await mlService.suggestMaterials(searchQuery, 5);

      if (!suggestions || suggestions.length === 0) {
        return; // Pas de suggestions, ne rien afficher
      }

      const resultsContainer = this.getElement('#search-results');
      if (!resultsContainer) return;

      // Cr√©er section suggestions ML
      const mlContainer = document.createElement('div');
      mlContainer.id = 'ml-suggestions-container';
      mlContainer.className = 'mb-3 p-3 border rounded bg-gradient-to-r from-purple-50 to-indigo-50';
      mlContainer.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      mlContainer.style.color = 'white';
      mlContainer.style.borderRadius = '8px';
      mlContainer.style.marginBottom = '16px';

      const header = document.createElement('div');
      header.className = 'mb-2';
      header.innerHTML = `
        &lt;strong>
          &lt;i class="fas fa-brain">&lt;/i> Suggestions Intelligentes ML
        &lt;/strong>
        &lt;small class="ms-2" style="opacity: 0.9;">Bas√© sur votre recherche&lt;/small>
      `;
      mlContainer.appendChild(header);

      // Ajouter chaque suggestion
      suggestions.forEach(material => {
        const priceTTC = (material.price || 0) * (1 + (material.tva || 20) / 100);
        const name = TextFormatter.escapeHtml(material.name);
        const reference = TextFormatter.escapeHtml(material.reference || '-');
        const type = TextFormatter.escapeHtml(material.type || '-');
        const similarity = Math.round((material.similarity || 0) * 100);

        const suggestionCard = document.createElement('div');
        suggestionCard.className = 'mt-2 p-2 rounded';
        suggestionCard.style.background = 'rgba(255, 255, 255, 0.2)';
        suggestionCard.style.cursor = 'pointer';
        suggestionCard.style.transition = 'background 0.2s';
        suggestionCard.onmouseover = () => suggestionCard.style.background = 'rgba(255, 255, 255, 0.3)';
        suggestionCard.onmouseout = () => suggestionCard.style.background = 'rgba(255, 255, 255, 0.2)';

        suggestionCard.innerHTML = `
          &lt;div class="d-flex justify-content-between align-items-start">
            &lt;div>
              &lt;strong>${name}&lt;/strong> &lt;small>(R√©f: ${reference})&lt;/small>&lt;br>
              &lt;small>Prix TTC: ${priceTTC.toFixed(2)} ‚Ç¨ | Type: ${type}&lt;/small>
            &lt;/div>
            &lt;span class="badge bg-light text-dark ms-2">${similarity}% pertinent&lt;/span>
          &lt;/div>
          &lt;button class="btn btn-light btn-sm mt-2" onclick="selectMaterial(${material.id})">
            &lt;i class="fas fa-check">&lt;/i> S√©lectionner
          &lt;/button>
        `;

        mlContainer.appendChild(suggestionCard);
      });

      // Supprimer ancien container ML s'il existe
      const oldML = resultsContainer.querySelector('#ml-suggestions-container');
      if (oldML) oldML.remove();

      // Ins√©rer en premier (avant r√©sultats normaux)
      resultsContainer.insertBefore(mlContainer, resultsContainer.firstChild);

    } catch (error) {
      this.error('Erreur suggestions ML:', error);
      // Ne pas afficher d'erreur √† l'utilisateur (feature optionnelle)
    }
  }

  /**
   * S√©lectionne un mat√©riau pour l'ajouter au devis.
   *
   * Workflow :
   * 1. Trouver le mat√©riau par ID dans window.materials ou this.materials
   * 2. V√©rifier que les mat√©riaux sont charg√©s (sinon afficher erreur + recharger)
   * 3. Stocker le mat√©riau dans state.selectedMaterial + window.selectedMaterial
   * 4. Tracker la recherche pour analytics (si window.trackMaterialSearch existe)
   * 5. Rafra√Æchir le dashboard Vendeur si on est sur l'onglet Accueil
   * 6. Nettoyer les champs de recherche
   * 7. Mettre √† jour l'affichage du mat√©riau s√©lectionn√©
   * 8. Mettre √† jour l'aper√ßu du calcul (via window.updateCalculationPreview)
   * 9. √âmettre √©v√©nement 'materials:selected'
   * 10. Afficher une notification de succ√®s
   *
   * @param {number|string} id - ID du mat√©riau √† s√©lectionner
   * @returns {void}
   *
   * @fires materials:selected - √âmis quand un mat√©riau est s√©lectionn√© avec succ√®s
   *
   * @example
   * // Depuis l'onglet Recherche
   * materialsModule.selectMaterial(42);
   * // ‚Üí Mat√©riau #42 s√©lectionn√©, affich√© dans le dashboard, pr√™t pour calcul devis
   */
  selectMaterial(id) {
    this.log('üéØ S√©lection du mat√©riau ID:', id);

    // En mode hybride, lire depuis window.materials pour compatibilit√©
    // V√©rifier que le tableau contient des √©l√©ments
    const materialsSource = (window.materials &amp;&amp; window.materials.length > 0)
      ? window.materials
      : this.materials;

    // Si aucun mat√©riau n'est charg√©, afficher un message d'attente
    if (!materialsSource || materialsSource.length === 0) {
      this.warn('Materials not loaded yet, please wait...');
      NotificationSystem.warning('Chargement des mat√©riaux en cours, veuillez patienter...');
      // Tenter de recharger
      setTimeout(() => this.loadMaterials(), 100);
      return;
    }

    const material = materialsSource.find(m => String(m.id) === String(id));

    if (!material) {
      this.error(`‚ùå Mat√©riau non trouv√© pour ID: ${id}. Mat√©riaux disponibles: ${materialsSource.length}`);
      this.error(`IDs disponibles: ${materialsSource.map(m => m.id).slice(0, 10).join(', ')}...`);
      NotificationSystem.error('Mat√©riau introuvable');
      return;
    }

    // Stocker le mat√©riau s√©lectionn√© dans le state global
    this.state.set('selectedMaterial', material);

    // Mettre √† jour window.selectedMaterial pour compatibilit√©
    window.selectedMaterial = material;

    // Tracker la recherche pour analytics (via ancien code)
    if (typeof window.trackMaterialSearch === 'function') {
      window.trackMaterialSearch(material);
    }

    // Rafra√Æchir le dashboard Vendeur si on est sur l'onglet Accueil
    const accueilTab = this.getElement('#accueil');
    if (accueilTab &amp;&amp; accueilTab.classList.contains('active')) {
      setTimeout(() => {
        if (typeof window.loadVendeurDashboard === 'function') {
          window.loadVendeurDashboard();
        }
      }, 100);
    }

    // Nettoyer les champs de recherche
    const searchInput = this.getElement('#search-input');
    const searchResults = this.getElement('#search-results');
    if (searchInput) searchInput.value = '';
    if (searchResults) searchResults.innerHTML = '';

    // Mettre √† jour l'affichage
    this.updateSelectedMaterialDisplay();

    // Mettre √† jour l'aper√ßu du calcul (via QuoteBuilderModule)
    if (typeof window.updateCalculationPreview === 'function') {
      window.updateCalculationPreview();
    }

    this.log(`‚úÖ Mat√©riau s√©lectionn√©: ${material.name}`);
    this.emitEvent('selected', material);

    // Afficher une notification
    NotificationSystem.success(`${material.name} s√©lectionn√©`);
  }

  /**
   * Met √† jour l'affichage du mat√©riau s√©lectionn√© dans le dashboard Vendeur.
   *
   * Affiche les informations du mat√©riau actuellement s√©lectionn√© :
   * - Nom
   * - R√©f√©rence
   * - Unit√©
   * - Prix unitaire HT
   * - TVA
   * - Prix unitaire TTC (calcul√©)
   *
   * Si aucun mat√©riau n'est s√©lectionn√©, affiche "Aucun".
   *
   * @returns {void}
   *
   * @example
   * // Apr√®s s√©lection d'un mat√©riau
   * this.updateSelectedMaterialDisplay();
   * // ‚Üí Affiche "Mat√©riau s√©lectionn√© : Carrelage XYZ | R√©f : 12345 | ..."
   */
  updateSelectedMaterialDisplay() {
    const material = this.state.get('selectedMaterial') || window.selectedMaterial;
    const display = this.getElement('#selected-material-display');

    if (!display) return;

    if (!material) {
      display.innerHTML = '&lt;strong>Mat√©riau s√©lectionn√© :&lt;/strong> Aucun';
      return;
    }

    // Calculer le prix TTC
    const priceHT = material.price || 0;
    const tvaRate = (material.tva || 20) / 100;
    const priceTTC = priceHT * (1 + tvaRate);

    const name = TextFormatter.escapeHtml(material.name);
    const reference = TextFormatter.escapeHtml(material.reference || '-');
    const unit = TextFormatter.escapeHtml(material.unit || '-');

    display.innerHTML = `
      &lt;strong>Mat√©riau s√©lectionn√© :&lt;/strong> ${name}&lt;br>
      &lt;strong>R√©f :&lt;/strong> ${reference} |
      &lt;strong>Unit√© :&lt;/strong> ${unit} |
      &lt;strong>Prix unitaire HT :&lt;/strong> ${priceHT.toFixed(2)} ‚Ç¨ |
      &lt;strong>TVA :&lt;/strong> ${material.tva || 20}% |
      &lt;strong>Prix unitaire TTC :&lt;/strong> ${priceTTC.toFixed(2)} ‚Ç¨
    `;
  }

  /**
   * Pr√©pare le formulaire pour ajouter un nouveau mat√©riau.
   *
   * Workflow :
   * 1. Nettoyer le formulaire (clearMaterialForm)
   * 2. Passer en mode ajout (editMode = false)
   * 3. Changer le titre du modal ‚Üí "Ajouter un mat√©riau"
   * 4. Afficher le modal Bootstrap
   * 5. Focus sur le champ "Nom" apr√®s 500ms
   *
   * @returns {void}
   *
   * @example
   * // Utilisateur clique sur "Ajouter un mat√©riau" (onglet Catalogue)
   * materialsModule.addMaterial();
   * // ‚Üí Modal s'ouvre avec formulaire vide
   */
  addMaterial() {
    this.clearMaterialForm();
    this.editMode = false;
    this.state.set('materialEditMode', false);

    // Changer le titre du modal
    const formTitle = this.getElement('#material-form-title');
    if (formTitle) {
      formTitle.innerHTML = '&lt;i class="fas fa-plus">&lt;/i> Ajouter un mat√©riau';
    }

    // Afficher le modal
    if (this.formModal) {
      ModalHelper.show('materialFormModal');
    }

    // Focus sur le premier champ apr√®s l'ouverture du modal
    setTimeout(() => {
      const nameInput = this.getElement('#material-name');
      if (nameInput) {
        nameInput.focus();
      }
    }, 500);

    this.log('Add material form opened');
  }

  /**
   * Charge un mat√©riau existant dans le formulaire pour √©dition.
   *
   * Workflow :
   * 1. Trouver le mat√©riau par ID dans window.materials ou this.materials
   * 2. Si non trouv√© : erreur + notification
   * 3. Passer en mode √©dition (editMode = true)
   * 4. Changer le titre du modal ‚Üí "Modifier le mat√©riau"
   * 5. Remplir tous les champs du formulaire avec les valeurs existantes
   * 6. Calculer le prix TTC √† partir du HT pour l'affichage
   * 7. Afficher le modal Bootstrap
   *
   * Note : L'ID est stock√© dans un champ cach√© (#material-id) pour
   * identifier le mat√©riau lors de la sauvegarde.
   *
   * @param {number|string} id - ID du mat√©riau √† √©diter
   * @returns {void}
   *
   * @example
   * // Utilisateur clique sur "Modifier" d'un mat√©riau
   * materialsModule.editMaterial(42);
   * // ‚Üí Modal s'ouvre avec formulaire pr√©rempli du mat√©riau #42
   */
  editMaterial(id) {
    console.log('üîçüîçüîç EDIT MATERIAL CALLED - ID:', id, 'type:', typeof id);
    console.log('window.materials:', window.materials?.length || 'undefined');
    console.log('this.materials:', this.materials?.length || 'undefined');

    const materialsSource = window.materials || this.materials;
    console.log('üîç materialsSource chosen:', materialsSource?.length, 'items');
    console.log('üîç materialsSource is array?', Array.isArray(materialsSource));
    console.log('üîç materialsSource value:', materialsSource);

    if (materialsSource &amp;&amp; materialsSource.length > 0) {
      console.log('üîç First 3 materials:', materialsSource.slice(0, 3).map(m => ({ id: m.id, type: typeof m.id, name: m.name })));
    } else {
      console.log('‚ùå materialsSource is EMPTY or UNDEFINED!');
    }

    const material = materialsSource?.find(m => String(m.id) === String(id));

    if (!material) {
      console.error('‚ùå‚ùå‚ùå MATERIAL NOT FOUND FOR ID:', id);
      console.error('Available IDs:', materialsSource?.map(m => m.id).join(', ') || 'NONE');
      this.error('‚ùå Mat√©riau introuvable pour ID:', id);
      this.error('IDs disponibles:', materialsSource?.map(m => m.id).join(', '));
      NotificationSystem.error('Mat√©riau introuvable');
      return;
    }

    this.editMode = true;
    this.state.set('materialEditMode', true);

    // Changer le titre du modal
    const formTitle = this.getElement('#material-form-title');
    if (formTitle) {
      formTitle.innerHTML = '&lt;i class="fas fa-edit">&lt;/i> Modifier le mat√©riau';
    }

    // Remplir le formulaire
    console.log('üîß Remplissage du formulaire avec:', material);
    this.setValue('#material-id', material.id); // ID (cach√©)
    this.setValue('#material-reference', material.reference || ''); // Optionnel
    this.setValue('#material-name', material.name || '');
    console.log('üîß Nom d√©fini:', material.name, '- V√©rif √©l√©ment:', document.getElementById('material-name')?.value);
    this.setValue('#material-type', material.type || '');
    console.log('üîß Type d√©fini:', material.type, '- V√©rif √©l√©ment:', document.getElementById('material-type')?.value);
    this.setValue('#material-unit', material.unit || '');
    this.setValue('#material-supplier', material.supplier || ''); // Nouveau champ fournisseur

    // Calculer le TTC √† partir du HT pour l'affichage
    const priceHT = material.price || 0;
    const tvaValue = material.tva || 20;
    const priceTTC = priceHT * (1 + tvaValue / 100);

    this.setValue('#material-price', priceHT);
    this.setValue('#material-price-ttc', priceTTC.toFixed(2));
    this.setValue('#material-tva', tvaValue);
    this.setValue('#material-coverage', material.coverage || 0);
    this.setValue('#material-piecesPerM2', material.piecesPerM2 || 0);
    this.setValue('#material-density', material.density || 0);
    this.setValue('#material-unitWeight', material.unitWeight || 0);
    this.setValue('#material-stock', material.stock || 0);
    this.setValue('#material-barcode', material.barcode || '');
    this.setValue('#material-purchase-cost', material.purchaseCost || 0);
    console.log('‚úÖ Formulaire rempli compl√®tement');

    // Afficher le modal
    if (this.formModal) {
      ModalHelper.show('materialFormModal');
    }

    this.log('Editing material:', material.name);
  }

  /**
   * Sauvegarde un mat√©riau (ajout ou modification).
   *
   * Workflow :
   * 1. R√©cup√©rer toutes les valeurs du formulaire
   * 2. Valider les champs obligatoires (nom, type)
   * 3. Si √©chec validation : afficher erreur, arr√™ter
   * 4. R√©cup√©rer le sessionToken pour autorisation
   * 5. Si editMode = true :
   *    - Appeler IPC 'updateMaterial' avec sessionToken + donn√©es
   *    - Si succ√®s : notification + √©v√©nement 'materials:updated'
   * 6. Si editMode = false :
   *    - Appeler IPC 'addMaterial' avec sessionToken + donn√©es
   *    - Si succ√®s : notification + √©v√©nement 'materials:added'
   * 7. Invalider le cache DataCache
   * 8. Recharger les mat√©riaux depuis le backend
   * 9. Rafra√Æchir la table
   * 10. Nettoyer et fermer le formulaire
   *
   * En cas d'erreur : afficher notification d'erreur, garder le modal ouvert.
   *
   * @async
   * @returns {Promise&lt;void>}
   *
   * @fires materials:added - √âmis quand un mat√©riau est ajout√© avec succ√®s
   * @fires materials:updated - √âmis quand un mat√©riau est modifi√© avec succ√®s
   *
   * @example
   * // Utilisateur remplit le formulaire et clique "Enregistrer"
   * await materialsModule.saveMaterial();
   * // ‚Üí Mat√©riau sauvegard√©, table rafra√Æchie, modal ferm√©
   */
  async saveMaterial() {
    // üÜï R√©cup√©rer le bouton pour le loading state
    const saveButton = document.getElementById('save-material-btn');

    try {
      // R√©cup√©rer les valeurs du formulaire
      const materialData = {
        reference: this.getValue('#material-reference') || '', // Optionnel
        name: this.getValue('#material-name'),
        type: this.getValue('#material-type'),
        unit: this.getValue('#material-unit'),
        price: parseFloat(this.getValue('#material-price') || 0),
        tva: parseFloat(this.getValue('#material-tva') || 20),
        coverage: parseFloat(this.getValue('#material-coverage') || 0),
        piecesPerM2: parseFloat(this.getValue('#material-piecesPerM2') || 0),
        density: parseFloat(this.getValue('#material-density') || 0),
        unitWeight: parseFloat(this.getValue('#material-unitWeight') || 0),
        stock: parseFloat(this.getValue('#material-stock') || 0),
        barcode: this.getValue('#material-barcode') || '',
        purchaseCost: parseFloat(this.getValue('#material-purchase-cost') || 0),
        supplier: this.getValue('#material-supplier') || '' // Nouveau champ fournisseur
      };

      // Validation
      if (!materialData.name || !materialData.type) {
        NotificationSystem.error('Nom et type sont requis');
        return;
      }

      // üÜï Activer le loading state sur le bouton
      LoadingStateManager.buttonLoading(saveButton, true, 'Enregistrement...');

      const sessionToken = this.getSessionToken();

      if (this.editMode) {
        // Modification
        const id = this.getValue('#material-id');
        materialData.id = id;

        // üîÑ Sauvegarder l'ancien √©tat pour Undo/Redo
        const oldMaterial = this.materials.find(m => m.id == id);
        const oldMaterialCopy = oldMaterial ? { ...oldMaterial } : null;

        const result = await this.invokeAPI('updateMaterial', sessionToken, materialData);

        if (result.success) {
          NotificationSystem.success('Mat√©riau modifi√© avec succ√®s');
          this.emitEvent('updated', materialData);

          // üîÑ Enregistrer l'action Undo/Redo
          if (window.UndoRedoManager &amp;&amp; oldMaterialCopy) {
            window.UndoRedoManager.record({
              type: 'MATERIAL_UPDATE',
              description: `Modification mat√©riau "${materialData.name}"`,
              undo: async () => {
                // Restaurer l'ancien √©tat
                await this.invokeAPI('updateMaterial', sessionToken, oldMaterialCopy);
                CacheKeys.invalidate(CacheKeys.MATERIALS);
                await this.loadMaterials();
                this.populateMaterialsTable();
              },
              redo: async () => {
                // R√©appliquer la modification
                await this.invokeAPI('updateMaterial', sessionToken, materialData);
                CacheKeys.invalidate(CacheKeys.MATERIALS);
                await this.loadMaterials();
                this.populateMaterialsTable();
              }
            });
          }
        } else {
          throw new Error(result.message || 'Erreur lors de la modification');
        }
      } else {
        // Ajout
        const result = await this.invokeAPI('addMaterial', sessionToken, materialData);

        if (result.success) {
          NotificationSystem.success('Mat√©riau ajout√© avec succ√®s');
          this.emitEvent('added', materialData);

          // üîÑ Enregistrer l'action Undo/Redo
          if (window.UndoRedoManager &amp;&amp; result.material) {
            const newMaterialId = result.material.id || result.id;
            window.UndoRedoManager.record({
              type: 'MATERIAL_CREATE',
              description: `Cr√©ation mat√©riau "${materialData.name}"`,
              undo: async () => {
                // Supprimer le mat√©riau cr√©√©
                await this.invokeAPI('deleteMaterial', sessionToken, newMaterialId);
                CacheKeys.invalidate(CacheKeys.MATERIALS);
                await this.loadMaterials();
                this.populateMaterialsTable();
              },
              redo: async () => {
                // Recr√©er le mat√©riau
                await this.invokeAPI('addMaterial', sessionToken, materialData);
                CacheKeys.invalidate(CacheKeys.MATERIALS);
                await this.loadMaterials();
                this.populateMaterialsTable();
              }
            });
          }
        } else {
          throw new Error(result.message || 'Erreur lors de l\'ajout');
        }
      }

      // Recharger les mat√©riaux
      CacheKeys.invalidate(CacheKeys.MATERIALS);
      await this.loadMaterials();

      // Rafra√Æchir la table
      this.populateMaterialsTable();

      // Nettoyer le formulaire
      this.clearMaterialForm();

      // üÜï D√©sactiver le loading state
      LoadingStateManager.buttonLoading(saveButton, false);

    } catch (error) {
      this.error('Error saving material:', error);
      NotificationSystem.error(error.message || 'Erreur lors de la sauvegarde');

      // üÜï D√©sactiver le loading state en cas d'erreur
      if (saveButton) {
        LoadingStateManager.buttonLoading(saveButton, false);
      }
    }
  }

  /**
   * Demande confirmation pour supprimer un mat√©riau.
   *
   * Workflow :
   * 1. Trouver le mat√©riau par ID
   * 2. Si non trouv√© : erreur + notification
   * 3. Stocker l'ID dans this.materialToDeleteId (utilis√© lors de la confirmation)
   * 4. Mettre √† jour le message du modal de confirmation avec le nom du mat√©riau
   * 5. Afficher le modal Bootstrap de confirmation
   *
   * L'utilisateur peut ensuite confirmer (‚Üí deleteMaterial) ou annuler.
   *
   * @param {number|string} id - ID du mat√©riau √† supprimer
   * @returns {void}
   *
   * @example
   * // Utilisateur clique sur "Supprimer" d'un mat√©riau
   * materialsModule.askDeleteMaterial(42);
   * // ‚Üí Modal de confirmation s'affiche : "√ätes-vous s√ªr de vouloir supprimer 'Carrelage XYZ' ?"
   */
  askDeleteMaterial(id) {
    const materialsSource = window.materials || this.materials;
    const material = materialsSource.find(m => String(m.id) === String(id));

    if (!material) {
      NotificationSystem.error('Mat√©riau introuvable');
      return;
    }

    this.materialToDeleteId = id;
    this.state.set('materialToDeleteId', id);

    // Mettre √† jour le message du modal
    const deleteMessage = this.getElement('#deleteMaterialMessage');
    if (deleteMessage) {
      deleteMessage.textContent = `√ätes-vous s√ªr de vouloir supprimer "${material.name}" ?`;
    }

    // Afficher le modal
    if (this.deleteModal) {
      ModalHelper.show('deleteMaterialModal');
    }

    this.log('Delete confirmation requested for:', material.name);
  }

  /**
   * Supprime un mat√©riau apr√®s confirmation.
   *
   * Workflow :
   * 1. Valider l'ID (doit √™tre non null/undefined)
   * 2. R√©cup√©rer le sessionToken pour autorisation
   * 3. Appeler IPC 'deleteMaterial' avec sessionToken + ID
   * 4. Si succ√®s :
   *    - Notification de succ√®s
   *    - √âmettre √©v√©nement 'materials:deleted'
   *    - Fermer le modal de confirmation
   *    - Invalider le cache DataCache
   *    - Recharger les mat√©riaux depuis le backend
   *    - Rafra√Æchir la table
   *    - R√©initialiser this.materialToDeleteId
   * 5. Si √©chec : afficher notification d'erreur
   *
   * @async
   * @param {number|string} id - ID du mat√©riau √† supprimer
   * @returns {Promise&lt;void>}
   *
   * @fires materials:deleted - √âmis quand un mat√©riau est supprim√© avec succ√®s
   *
   * @example
   * // Utilisateur confirme la suppression
   * await materialsModule.deleteMaterial(42);
   * // ‚Üí Mat√©riau #42 supprim√©, table rafra√Æchie, modal ferm√©
   */
  async deleteMaterial(id) {
    try {
      // Validation de l'ID
      if (!id || id === null || id === undefined) {
        this.error('deleteMaterial called with invalid ID:', id);
        NotificationSystem.error('Erreur: ID de mat√©riau invalide');
        return;
      }

      // üîÑ Sauvegarder le mat√©riau pour Undo/Redo
      const materialToDelete = this.materials.find(m => m.id == id);
      const materialCopy = materialToDelete ? { ...materialToDelete } : null;

      const sessionToken = this.getSessionToken();

      const result = await this.invokeAPI('deleteMaterial', sessionToken, id);

      if (result.success) {
        NotificationSystem.success('Mat√©riau supprim√© avec succ√®s');
        this.emitEvent('deleted', id);

        // üîÑ Enregistrer l'action Undo/Redo
        if (window.UndoRedoManager &amp;&amp; materialCopy) {
          window.UndoRedoManager.record({
            type: 'MATERIAL_DELETE',
            description: `Suppression mat√©riau "${materialCopy.name}"`,
            undo: async () => {
              // Restaurer le mat√©riau
              await this.invokeAPI('addMaterial', sessionToken, materialCopy);
              CacheKeys.invalidate(CacheKeys.MATERIALS);
              await this.loadMaterials();
              this.populateMaterialsTable();
            },
            redo: async () => {
              // Resupprimer le mat√©riau
              await this.invokeAPI('deleteMaterial', sessionToken, id);
              CacheKeys.invalidate(CacheKeys.MATERIALS);
              await this.loadMaterials();
              this.populateMaterialsTable();
            }
          });
        }

        // Fermer le modal
        if (this.deleteModal) {
          ModalHelper.hide('deleteMaterialModal');
        }

        // Recharger les mat√©riaux
        CacheKeys.invalidate(CacheKeys.MATERIALS);
        await this.loadMaterials();

        // Rafra√Æchir la table
        this.populateMaterialsTable();

        this.materialToDeleteId = null;
      } else {
        throw new Error(result.message || 'Erreur lors de la suppression');
      }
    } catch (error) {
      this.error('Error deleting material:', error);
      NotificationSystem.error(error.message || 'Erreur lors de la suppression');
    }
  }

  /**
   * Nettoie le formulaire mat√©riau et le ferme.
   *
   * Workflow :
   * 1. R√©initialiser tous les champs du formulaire (vider les valeurs)
   * 2. Garder la TVA √† 20% par d√©faut
   * 3. Passer en mode ajout (editMode = false)
   * 4. Fermer le modal Bootstrap
   * 5. R√©initialiser le titre ‚Üí "Ajouter un mat√©riau"
   *
   * @returns {void}
   *
   * @example
   * // Utilisateur clique "Annuler" ou apr√®s sauvegarde r√©ussie
   * materialsModule.clearMaterialForm();
   * // ‚Üí Formulaire vid√© et ferm√©
   */
  clearMaterialForm() {
    this.setValue('#material-id', ''); // ID (cach√©)
    this.setValue('#material-reference', ''); // Optionnel
    this.setValue('#material-name', '');
    this.setValue('#material-type', '');
    this.setValue('#material-unit', '');
    this.setValue('#material-supplier', ''); // Nouveau champ fournisseur
    this.setValue('#material-price', '');
    this.setValue('#material-price-ttc', '');
    this.setValue('#material-tva', 20); // Garder 20 par d√©faut
    this.setValue('#material-coverage', '');
    this.setValue('#material-piecesPerM2', '');
    this.setValue('#material-density', '');
    this.setValue('#material-unitWeight', '');
    this.setValue('#material-stock', '');
    this.setValue('#material-barcode', '');
    this.setValue('#material-purchase-cost', '');

    this.editMode = false;
    this.state.set('materialEditMode', false);

    // Fermer le modal
    if (this.formModal) {
      ModalHelper.hide('materialFormModal');
    }

    // R√©initialiser le titre
    const formTitle = this.getElement('#material-form-title');
    if (formTitle) {
      formTitle.innerHTML = '&lt;i class="fas fa-plus">&lt;/i> Ajouter un mat√©riau';
    }

    this.log('Material form cleared');
  }

  /**
   * Populate le select des fournisseurs dans le formulaire mat√©riau.
   *
   * R√©cup√®re la liste des fournisseurs depuis window.suppliers ou state.suppliers,
   * g√©n√®re les options du select HTML, et les trie alphab√©tiquement.
   *
   * Si aucun fournisseur n'est disponible, affiche "Aucun fournisseur".
   * Pr√©serve la valeur actuellement s√©lectionn√©e si elle existe toujours.
   *
   * Cette m√©thode est appel√©e :
   * - Lors de l'initialisation du module
   * - Lors de l'√©v√©nement 'suppliers:loaded'
   * - Lors de l'√©v√©nement 'suppliers:updated'
   *
   * @returns {void}
   *
   * @example
   * // Apr√®s chargement des fournisseurs
   * this.populateSuppliersDatalist();
   * // ‚Üí Select contient "Aucun fournisseur", "Fournisseur A", "Fournisseur B", ...
   */
  populateSuppliersDatalist() {
    const selectElement = this.getElement('#material-supplier');
    if (!selectElement) {
      this.log('‚ö†Ô∏è Select fournisseurs non trouv√©');
      return;
    }

    // R√©cup√©rer la liste des fournisseurs depuis window.suppliers ou le state
    const suppliers = window.suppliers || this.state.get('suppliers') || [];

    // V√©rifier que suppliers est bien un tableau
    if (!Array.isArray(suppliers)) {
      this.log('‚ö†Ô∏è suppliers n\'est pas un tableau');
      selectElement.innerHTML = '&lt;option value="">Aucun fournisseur&lt;/option>';
      return;
    }

    if (suppliers.length === 0) {
      this.log('‚ÑπÔ∏è Aucun fournisseur disponible');
      selectElement.innerHTML = '&lt;option value="">Aucun fournisseur&lt;/option>';
      return;
    }

    // Sauvegarder la valeur actuelle si elle existe
    const currentValue = selectElement.value;

    // G√©n√©rer les options
    selectElement.innerHTML = '&lt;option value="">Aucun fournisseur&lt;/option>' +
      suppliers
        .sort((a, b) => a.name.localeCompare(b.name))
        .map(supplier => `&lt;option value="${supplier.name}">${supplier.name}&lt;/option>`)
        .join('');

    // Restaurer la valeur si elle existe toujours
    if (currentValue &amp;&amp; suppliers.some(s => s.name === currentValue)) {
      selectElement.value = currentValue;
    }

    this.log(`‚úÖ Select fournisseurs mis √† jour avec ${suppliers.length} fournisseurs`);
  }

  /**
   * Affiche les d√©tails complets d'un mat√©riau dans un modal.
   *
   * Workflow :
   * 1. Chercher le mat√©riau par ID dans la liste
   * 2. Si non trouv√© : afficher erreur, arr√™ter
   * 3. Calculer le prix TTC depuis le prix HT et la TVA
   * 4. Remplir tous les champs du modal de d√©tails
   * 5. Afficher le modal 'materialDetailsModal'
   *
   * @public
   * @param {number|string} id - ID du mat√©riau
   * @returns {void}
   *
   * @example
   * // Utilisateur clique sur "Voir d√©tails" pour le mat√©riau #5
   * viewMaterialDetails(5);
   * // ‚Üí Modal affich√© avec toutes les informations du mat√©riau
   */
  viewMaterialDetails(id) {
    this.log(`Viewing details for material ID: ${id}`);

    // Chercher le mat√©riau
    const materialsSource = window.materials || this.materials || [];
    const material = materialsSource.find(m => String(m.id) === String(id));

    if (!material) {
      this.error('Mat√©riau introuvable pour ID:', id);
      NotificationSystem.error('Mat√©riau introuvable');
      return;
    }

    // Calculer le prix TTC
    const priceHT = typeof material.price === 'number' ? material.price : 0;
    const tvaValue = material.tva || (material.tvaRate * 100) || 20;
    const priceTTC = priceHT * (1 + tvaValue / 100);

    // Remplir tous les champs du modal
    this.setTextContent('#detail-material-id', material.id ?? '-');
    this.setTextContent('#detail-material-name', material.name ?? '-');
    this.setTextContent('#detail-material-price-ht', priceHT > 0 ? `${priceHT.toFixed(2)} ‚Ç¨` : '-');
    this.setTextContent('#detail-material-tva', tvaValue > 0 ? `${tvaValue}%` : '-');
    this.setTextContent('#detail-material-price-ttc', priceTTC > 0 ? `${priceTTC.toFixed(2)} ‚Ç¨` : '-');
    this.setTextContent('#detail-material-stock', material.stock ?? '-');
    this.setTextContent('#detail-material-unit', material.unit ?? '-');
    this.setTextContent('#detail-material-type', material.type ?? '-');
    this.setTextContent('#detail-material-supplier', material.supplier ?? '-');
    this.setTextContent('#detail-material-coverage', material.coverage ?? '-');
    this.setTextContent('#detail-material-density', material.density ?? '-');
    this.setTextContent('#detail-material-pieces', material.piecesPerM2 ?? '-');
    this.setTextContent('#detail-material-barcode', material.barcode ?? '-');

    // Afficher le modal
    ModalHelper.show('materialDetailsModal');
    this.log('Material details modal displayed for:', material.name);
  }

  /**
   * D√©finit le contenu textuel d'un √©l√©ment (helper).
   * @private
   */
  setTextContent(selector, value) {
    const element = this.getElement(selector);
    if (element) {
      element.textContent = value;
    } else {
      this.warn(`Element not found: ${selector}`);
    }
  }

  /**
   * Change de page dans la pagination.
   * @param {number} direction - Direction: -1 pour pr√©c√©dent, 1 pour suivant
   * @private
   */
  changePage(direction) {
    const newPage = this.pagination.currentPage + direction;
    if (newPage >= 1 &amp;&amp; newPage &lt;= this.pagination.totalPages) {
      this.pagination.currentPage = newPage;
      this.applyMaterialFilters();
    }
  }

  /**
   * Va √† une page sp√©cifique.
   * @param {number} pageNumber - Num√©ro de page (1-indexed)
   * @private
   */
  goToPage(pageNumber) {
    if (pageNumber >= 1 &amp;&amp; pageNumber &lt;= this.pagination.totalPages) {
      this.pagination.currentPage = pageNumber;
      this.applyMaterialFilters();
    }
  }

  /**
   * Met √† jour les contr√¥les de pagination (info et boutons).
   * @param {number} totalItems - Nombre total d'items
   * @param {Array} displayedItems - Items affich√©s sur la page actuelle
   * @private
   */
  updatePaginationControls(totalItems, displayedItems) {
    // Mettre √† jour l'info de pagination
    const paginationInfo = this.getElement('#materials-pagination-info');
    if (paginationInfo) {
      if (totalItems === 0) {
        paginationInfo.textContent = 'Aucun mat√©riau';
      } else {
        const startIndex = (this.pagination.currentPage - 1) * this.pagination.itemsPerPage + 1;
        const endIndex = startIndex + displayedItems.length - 1;
        paginationInfo.textContent = `Affichage ${startIndex}-${endIndex} sur ${totalItems} mat√©riaux`;
      }
    }

    // Mettre √† jour les boutons de pagination
    const paginationControls = this.getElement('#materials-pagination-controls');
    if (paginationControls &amp;&amp; totalItems > 0) {
      const prevDisabled = this.pagination.currentPage === 1 ? 'disabled' : '';
      const nextDisabled = this.pagination.currentPage === this.pagination.totalPages ? 'disabled' : '';

      // G√©n√©rer les num√©ros de page (max 5 pages visibles)
      const pageNumbers = this.generatePageNumbers();

      paginationControls.innerHTML = `
        &lt;button class="btn btn-sm btn-outline-primary" ${prevDisabled} onclick="window.materialsModule.changePage(-1)">
          &lt;i class="fas fa-chevron-left">&lt;/i> Pr√©c√©dent
        &lt;/button>
        ${pageNumbers.map(page => {
          if (page === '...') {
            return '&lt;span class="mx-1">...&lt;/span>';
          }
          const active = page === this.pagination.currentPage ? 'btn-primary' : 'btn-outline-primary';
          return `&lt;button class="btn btn-sm ${active}" onclick="window.materialsModule.goToPage(${page})">${page}&lt;/button>`;
        }).join('')}
        &lt;button class="btn btn-sm btn-outline-primary" ${nextDisabled} onclick="window.materialsModule.changePage(1)">
          Suivant &lt;i class="fas fa-chevron-right">&lt;/i>
        &lt;/button>
      `;
    } else if (paginationControls) {
      paginationControls.innerHTML = '';
    }
  }

  /**
   * G√©n√®re les num√©ros de page √† afficher (max 5 pages visibles avec ellipses).
   * @returns {Array} - Array de num√©ros de page et ellipses
   * @private
   */
  generatePageNumbers() {
    const pages = [];
    const total = this.pagination.totalPages;
    const current = this.pagination.currentPage;

    if (total &lt;= 7) {
      // Afficher toutes les pages si &lt;= 7
      for (let i = 1; i &lt;= total; i++) {
        pages.push(i);
      }
    } else {
      // Toujours afficher la premi√®re page
      pages.push(1);

      if (current > 3) {
        pages.push('...');
      }

      // Pages autour de la page actuelle
      const start = Math.max(2, current - 1);
      const end = Math.min(total - 1, current + 1);

      for (let i = start; i &lt;= end; i++) {
        pages.push(i);
      }

      if (current &lt; total - 2) {
        pages.push('...');
      }

      // Toujours afficher la derni√®re page
      pages.push(total);
    }

    return pages;
  }

  /**
   * Suppression group√©e de mat√©riaux
   *
   * @param {Array&lt;string|number>} materialIds - IDs des mat√©riaux √† supprimer
   * @returns {Promise&lt;Object>} Objet contenant les mat√©riaux supprim√©s et les callbacks undo/redo
   */
  async bulkDeleteMaterials(materialIds) {
    const deletedMaterials = [];

    for (const id of materialIds) {
      const material = this.materials.find(m => m.id === parseInt(id));
      if (material) {
        deletedMaterials.push({...material});
        await window.ipcRenderer.invoke('deleteMaterial', {
          sessionToken: this.sessionToken,
          id: parseInt(id)
        });
      }
    }

    DataCache.invalidate(CacheKeys.MATERIALS);
    await this.loadMaterials();
    this.applyMaterialsFilters();

    return {
      deletedMaterials,
      undoCallback: async () => {
        // Logique d'annulation (r√©ins√©rer les mat√©riaux)
        for (const mat of deletedMaterials) {
          await window.ipcRenderer.invoke('addMaterial', {
            sessionToken: this.sessionToken,
            ...mat
          });
        }
        DataCache.invalidate(CacheKeys.MATERIALS);
        await this.loadMaterials();
        this.applyMaterialsFilters();
      },
      redoCallback: async () => {
        // Logique de refaire (re-supprimer)
        await this.bulkDeleteMaterials(materialIds);
      }
    };
  }

  /**
   * Exportation group√©e de mat√©riaux
   *
   * @param {Array&lt;string|number>} materialIds - IDs des mat√©riaux √† exporter
   * @returns {Promise&lt;void>}
   */
  async bulkExportMaterials(materialIds) {
    const materialsToExport = this.materials.filter(m =>
      materialIds.includes(m.id.toString())
    );

    const csvContent = this.generateCSV(materialsToExport);
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `materials_export_${Date.now()}.csv`;
    link.click();
  }

  /**
   * G√©n√®re un CSV depuis un tableau de mat√©riaux
   *
   * @param {Array&lt;Object>} materials - Mat√©riaux √† exporter
   * @returns {string} Contenu CSV
   */
  generateCSV(materials) {
    if (!materials || !Array.isArray(materials) || materials.length === 0) {
      return 'ID;Nom;R√©f√©rence;Type;Prix TTC;TVA;Unit√©;Fournisseur';
    }

    const headers = ['ID', 'Nom', 'R√©f√©rence', 'Type', 'Prix TTC', 'TVA', 'Unit√©', 'Fournisseur'];
    const rows = materials.map(m => [
      m.id,
      m.name,
      m.reference || '',
      m.type,
      m.price?.toFixed(2) || '0.00',
      m.tva || '20',
      m.unit || 'pi√®ce',
      m.supplier || ''
    ]);

    return [headers, ...rows].map(row => row.join(';')).join('\n');
  }
}

export default MaterialsModule;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
