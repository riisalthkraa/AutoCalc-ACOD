

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> modules/dashboard/DashboardModule.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule.html">DashboardModule</a></li><li><a href="module-DataCache.html">DataCache</a></li><li><a href="module-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule.html">FECModule</a></li><li><a href="module-FollowUpModule.html">FollowUpModule</a></li><li><a href="module-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-KeyboardShortcutsModule.html">KeyboardShortcutsModule</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-MLService.html">MLService</a></li><li><a href="module-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-NotificationSystem.html">NotificationSystem</a></li><li><a href="module-NotificationSystemV2.html">NotificationSystemV2</a></li><li><a href="module-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-TourModule.html">TourModule</a></li><li><a href="module-UtilitiesModule.html">UtilitiesModule</a></li><li><a href="module-calculations.html">calculations</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-formatters.html">formatters</a></li><li><a href="module-helpers.html">helpers</a></li></ul><h3>Classes</h3><ul><li><a href="BaseModule.html">BaseModule</a></li><li><a href="BulkActionsManager.html">BulkActionsManager</a></li><li><a href="CacheKeys.html">CacheKeys</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="LoadingStateManager.html">LoadingStateManager</a></li><li><a href="ModalHelper.html">ModalHelper</a></li><li><a href="PaginationManager.html">PaginationManager</a></li><li><a href="ServerValidator.html">ServerValidator</a></li><li><a href="StateManager.html">StateManager</a></li><li><a href="TabRefreshManager.html">TabRefreshManager</a></li><li><a href="UndoRedoManager.html">UndoRedoManager</a></li><li><a href="module-AboutModule-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule-DashboardModule.html">DashboardModule</a></li><li><a href="module-ExportModule-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule-FECModule.html">FECModule</a></li><li><a href="module-ImportModule-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-Logger-Logger.html">Logger</a></li><li><a href="module-Logger-ModuleLogger.html">ModuleLogger</a></li><li><a href="module-MaterialsModule-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-PDFModule-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-UtilitiesModule-UtilitiesModule.html">UtilitiesModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#emitSync">emitSync</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#validateBeforeAddToQuote">validateBeforeAddToQuote</a></li><li><a href="global.html#validateBeforeExport">validateBeforeExport</a></li><li><a href="global.html#validateBeforeSaveMaterial">validateBeforeSaveMaterial</a></li><li><a href="global.html#validateBeforeSendEmail">validateBeforeSendEmail</a></li><li><a href="global.html#validateHeaderConfig">validateHeaderConfig</a></li><li><a href="global.html#validatePasswordChange">validatePasswordChange</a></li><li><a href="global.html#validateSMTPConfig">validateSMTPConfig</a></li><li><a href="global.html#waitFor">waitFor</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>modules/dashboard/DashboardModule.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * ========================================
 * DASHBOARD MODULE - Tableaux de bord et analytics
 * ========================================
 *
 * Module de gestion des tableaux de bord pour l'application AutoCalc OptiDevis.
 * Fournit deux dashboards distincts selon le mode utilisateur (Admin/Vendeur)
 * avec KPIs, graphiques Chart.js et analytics avancÃ©s.
 *
 * Architecture :
 * Le module gÃ¨re deux dashboards distincts avec des fonctionnalitÃ©s adaptÃ©es au rÃ´le :
 * - **Dashboard Vendeur** : Vue simplifiÃ©e avec KPIs essentiels et top 10 articles
 * - **Dashboard Admin** : Vue complÃ¨te avec analytics avancÃ©s et graphiques dÃ©taillÃ©s
 *
 * ==========================================
 * DASHBOARD VENDEUR (Onglet "Accueil")
 * ==========================================
 *
 * FonctionnalitÃ©s :
 * - KPI 1 : Devis en attente (avec pastille rouge animÃ©e si > 0)
 * - KPI 2 : Devis crÃ©Ã©s cette semaine
 * - KPI 3 : Recherches matÃ©riaux effectuÃ©es aujourd'hui
 * - Top 10 : Articles les plus recherchÃ©s cette semaine (avec bouton sÃ©lection rapide)
 *
 * DonnÃ©es utilisÃ©es :
 * - Devis (list-saved-quotes) pour KPIs 1 et 2
 * - Historique de recherche localStorage pour KPIs 3 et Top 10
 *
 * ==========================================
 * DASHBOARD ADMIN (Onglet "Tableau de bord")
 * ==========================================
 *
 * KPIs Admin (4 indicateurs) :
 * 1. **CA du mois** : Chiffre d'affaires du mois en cours (factures payÃ©es uniquement)
 * 2. **Devis en attente** : Nombre de devis au statut "en_attente" (avec badge rouge)
 * 3. **Factures en retard** : Factures Ã©chues ou dont la dueDate est dÃ©passÃ©e (avec badge rouge)
 * 4. **Taux de conversion** : % devis acceptÃ©s/facturÃ©s sur total devis
 *
 * Graphiques Chart.js (4 graphiques) :
 * 1. **RÃ©partition des devis** (Doughnut) : Distribution par statut avec pourcentages
 * 2. **Ã‰volution du CA** (Line) : CA sur les 6 derniers mois (factures payÃ©es)
 * 3. **Top 20 Produits** (Bar horizontal) : Produits les plus vendus du mois par CA
 * 4. **Performance CatÃ©gories** (Doughnut) : RÃ©partition du CA par type de matÃ©riau
 *
 * Analytics avancÃ©s :
 * - **Tendances produits** : Comparaison mois actuel vs mois prÃ©cÃ©dent
 * - **DÃ©tection automatique** : Produits en hausse (>+5%), en baisse (&lt;-5%), nouveaux, disparus
 * - **Recommandations intelligentes** : Suggestions d'actions selon les tendances
 * - **Seuils de variation** : Hausse forte (>50%), moyenne (>20%), faible (>5%)
 *
 * ==========================================
 * TRACKING &amp; ANALYTICS
 * ==========================================
 *
 * Historique de recherche :
 * - Enregistre chaque recherche de matÃ©riau (id, nom, type, prix, timestamp)
 * - Stockage localStorage (clÃ©: 'materialSearchHistory')
 * - Utilisation : KPI "Recherches aujourd'hui" + Top 10 articles
 *
 * Analyse des donnÃ©es :
 * - AgrÃ©gation par produit et catÃ©gorie
 * - Calcul des quantitÃ©s vendues et CA par produit
 * - Comparaison temporelle (mois actuel vs prÃ©cÃ©dent)
 * - GÃ©nÃ©ration automatique de tendances et recommandations
 *
 * ==========================================
 * GESTION DES GRAPHIQUES CHART.JS
 * ==========================================
 *
 * Lifecycle des graphiques :
 * 1. **Destruction** des anciens graphiques (Ã©vite les fuites mÃ©moire)
 * 2. **CrÃ©ation** avec nouvelle configuration
 * 3. **Stockage** dans this.adminDashboardCharts pour accÃ¨s ultÃ©rieur
 *
 * Plugins personnalisÃ©s :
 * - **percentagePlugin** : Affiche % sur graphiques doughnut (si >= 3%)
 * - **revenueValuesPlugin** : Affiche valeurs â‚¬ sur graphique ligne CA
 * - **topProductsValuesPlugin** : Affiche valeurs â‚¬ sur graphique barres
 * - **categoryPercentagePlugin** : Affiche % sur graphique catÃ©gories
 *
 * Optimisations :
 * - clearRect() sur canvas si donnÃ©es vides (Ã©vite affichage vide)
 * - Limitation Top 20 produits et Top 5 tendances
 * - Truncation noms produits > 30 caractÃ¨res
 * - Animation pulse sur badges de notification
 *
 * ==========================================
 * SOURCES DE DONNÃ‰ES
 * ==========================================
 *
 * IPC Channels utilisÃ©s :
 * - **list-saved-quotes** : Liste tous les devis (tous statuts)
 * - **list-invoices** : Liste toutes les factures (tous statuts)
 *
 * LocalStorage :
 * - **materialSearchHistory** : Historique des recherches de matÃ©riaux
 *
 * Filtres appliquÃ©s :
 * - Devis : Seuls "acceptÃ©" et "facturÃ©" comptent dans les ventes
 * - Factures : Seules "payÃ©e" comptent dans le CA
 * - Recherches : FiltrÃ©es par jour (aujourd'hui) ou semaine (7 derniers jours)
 *
 * ==========================================
 * SYNCHRONISATION AVEC SCOPE GLOBAL
 * ==========================================
 *
 * Variables synchronisÃ©es :
 * - window.materialSearchHistory â†” this.materialSearchHistory
 * - window.adminDashboardCharts â†” this.adminDashboardCharts
 *
 * Fonctions exposÃ©es (compatibilitÃ© legacy) :
 * - trackMaterialSearch, loadVendeurDashboard, loadAdminDashboard
 * - updateVendeurPendingQuotes, updateVendeurQuotesWeek, updateVendeurSearchesToday
 * - updateVendeurTopMaterials, updateAdminKPIs, updateAdminCharts
 * - createQuotesStatusChart, createRevenueChart, createTopProductsChart
 * - createCategoriesChart, analyzeProductData, displayTrendingProducts
 * - generateRecommendation
 *
 * ==========================================
 * INTÃ‰GRATIONS
 * ==========================================
 *
 * - **MaterialsModule** : Tracking des recherches via trackMaterialSearch()
 * - **QuotesModule** : DonnÃ©es pour KPIs et analytics
 * - **InvoicesModule** : DonnÃ©es pour CA et analytics
 * - **Chart.js** : BibliothÃ¨que de graphiques (v3+)
 * - **Bootstrap 5.3.3** : Badges, animations, mise en page
 *
 * @module DashboardModule
 * @extends BaseModule
 * @version 2.0.0
 * @author AutoCalc OptiDevis
 */

import BaseModule from '../../core/BaseModule.js';
import { TextFormatter, CurrencyFormatter } from '../../shared/utils/formatters.js';

class DashboardModule extends BaseModule {
  /**
   * CrÃ©e une instance du module Dashboard.
   *
   * @param {StateManager} state - Gestionnaire d'Ã©tat global
   * @param {EventBus} eventBus - Bus d'Ã©vÃ©nements pour communication inter-modules
   */
  constructor(state, eventBus) {
    super('dashboard', state, eventBus);

    /**
     * Historique des recherches de matÃ©riaux pour analytics.
     * UtilisÃ© pour le KPI "Recherches aujourd'hui" et le Top 10 articles du dashboard vendeur.
     * ChargÃ© depuis localStorage au dÃ©marrage.
     *
     * @type {Array&lt;Object>}
     * @private
     * @property {string} materialId - ID du matÃ©riau recherchÃ©
     * @property {string} materialName - Nom du matÃ©riau
     * @property {string} materialType - Type/catÃ©gorie du matÃ©riau
     * @property {number} materialPrice - Prix du matÃ©riau
     * @property {number} timestamp - Timestamp de la recherche (Date.now())
     */
    this.materialSearchHistory = [];

    /**
     * Instances des graphiques Chart.js pour le dashboard admin.
     * Stockage nÃ©cessaire pour destruction lors des mises Ã  jour (Ã©vite fuites mÃ©moire).
     *
     * @type {Object}
     * @private
     * @property {Chart|undefined} quotesStatus - Graphique doughnut rÃ©partition devis par statut
     * @property {Chart|undefined} revenue - Graphique ligne Ã©volution CA sur 6 mois
     * @property {Chart|undefined} topProducts - Graphique barres Top 20 produits du mois
     * @property {Chart|undefined} categories - Graphique doughnut performance par catÃ©gorie
     */
    this.adminDashboardCharts = {};

    this.log('DashboardModule instantiated');
  }

  /**
   * Initialise le module Dashboard.
   *
   * Effectue les opÃ©rations suivantes :
   * - Charge l'historique de recherche depuis localStorage
   * - Expose toutes les fonctions au scope global pour compatibilitÃ© legacy
   * - Configure les getters/setters pour synchroniser les propriÃ©tÃ©s avec window.*
   *
   * @async
   * @returns {Promise&lt;void>}
   * @throws {Error} Si une erreur survient pendant l'initialisation
   *
   * @example
   * const module = new DashboardModule(stateManager, eventBus);
   * await module.init();
   */
  async init() {
    try {
      this.log('Initializing DashboardModule...');

      // Charger l'historique depuis localStorage
      this.loadSearchHistory();

      // Exposer les fonctions au scope global
      this.exposeToGlobal({
        // Tracking
        trackMaterialSearch: this.trackMaterialSearch,

        // Vendeur Dashboard
        loadVendeurDashboard: this.loadVendeurDashboard,
        updateVendeurPendingQuotes: this.updateVendeurPendingQuotes,
        updateVendeurQuotesWeek: this.updateVendeurQuotesWeek,
        updateVendeurSearchesToday: this.updateVendeurSearchesToday,
        updateVendeurTopMaterials: this.updateVendeurTopMaterials,

        // Admin Dashboard
        loadAdminDashboard: this.loadAdminDashboard,
        updateAdminKPIs: this.updateAdminKPIs,
        updateAdminCharts: this.updateAdminCharts,
        createQuotesStatusChart: this.createQuotesStatusChart,
        createRevenueChart: this.createRevenueChart,
        createTopProductsChart: this.createTopProductsChart,
        createCategoriesChart: this.createCategoriesChart,
        analyzeProductData: this.analyzeProductData,
        displayTrendingProducts: this.displayTrendingProducts,
        generateRecommendation: this.generateRecommendation
      });

      // Exposer les variables au scope global
      this.syncGlobalVariables();

      // ðŸ†• Enregistrer les onglets dashboard pour auto-refresh
      this.registerTabRefresh();

      this.initialized = true;
      this.log('DashboardModule initialized successfully');

    } catch (error) {
      this.error('Error initializing DashboardModule:', error);
      throw error;
    }
  }

  /**
   * ðŸ†• Enregistre les onglets dashboard pour auto-refresh automatique.
   * AppelÃ© une fois lors de l'initialisation du module.
   *
   * @private
   * @returns {void}
   */
  registerTabRefresh() {
    // VÃ©rifier que TabRefreshManager est disponible
    if (!window.TabRefreshManager) {
      this.warn('TabRefreshManager not available - tab auto-refresh disabled');
      return;
    }

    // Onglet "Accueil" (Dashboard Vendeur)
    window.TabRefreshManager.registerTab('accueil-tab', async (force) => {
      this.log('ðŸ”„ Auto-refreshing Vendeur Dashboard...');
      await this.loadVendeurDashboard();
    }, {
      ttl: 30000, // 30 secondes
      label: 'Dashboard Vendeur'
    });

    // Onglet "Tableau de bord" (Dashboard Admin)
    window.TabRefreshManager.registerTab('dashboard-tab', async (force) => {
      this.log('ðŸ”„ Auto-refreshing Admin Dashboard...');
      await this.loadAdminDashboard();
    }, {
      ttl: 30000, // 30 secondes
      label: 'Dashboard Admin'
    });

    this.log('âœ… Tab auto-refresh registered');
  }

  // ==========================================
  // HISTORIQUE DE RECHERCHE (ANALYTICS)
  // ==========================================

  /**
   * Charge l'historique des recherches de matÃ©riaux depuis localStorage.
   *
   * Tente de parser le JSON stockÃ© dans localStorage['materialSearchHistory'].
   * Si le parsing Ã©choue ou si aucune donnÃ©e n'existe, initialise un tableau vide.
   * AppelÃ© automatiquement par init().
   *
   * @private
   * @returns {void}
   *
   * @example
   * // AppelÃ© automatiquement au dÃ©marrage
   * this.loadSearchHistory();
   * // â†’ this.materialSearchHistory contient l'historique ou [] si vide
   */
  loadSearchHistory() {
    try {
      const saved = localStorage.getItem('materialSearchHistory');
      if (saved) {
        this.materialSearchHistory = JSON.parse(saved);
        this.log(`Search history loaded: ${this.materialSearchHistory.length} items`);
      }
    } catch (e) {
      this.warn('Error loading search history:', e);
    }
  }

  /**
   * Enregistre une recherche de matÃ©riau dans l'historique pour analytics.
   *
   * CrÃ©e un enregistrement de recherche avec timestamp et sauvegarde dans localStorage.
   * Si l'utilisateur est en mode Vendeur et sur l'onglet dashboard, rafraÃ®chit automatiquement
   * les KPIs pour reflÃ©ter la nouvelle recherche.
   *
   * AppelÃ© automatiquement par MaterialsModule lors de chaque sÃ©lection de matÃ©riau.
   *
   * @public
   * @param {Object} material - MatÃ©riau recherchÃ©
   * @param {string} material.id - ID unique du matÃ©riau
   * @param {string} material.name - Nom du matÃ©riau
   * @param {string} [material.type] - Type/catÃ©gorie du matÃ©riau (dÃ©faut: "Non catÃ©gorisÃ©")
   * @param {number} material.price - Prix du matÃ©riau
   * @returns {void}
   *
   * @example
   * // AppelÃ© par MaterialsModule lors de la sÃ©lection
   * this.trackMaterialSearch({
   *   id: "mat_123",
   *   name: "Parpaing 20x20",
   *   type: "MaÃ§onnerie",
   *   price: 2.50
   * });
   * // â†’ Enregistrement ajoutÃ© Ã  l'historique + sauvegarde localStorage
   * // â†’ Dashboard vendeur rafraÃ®chi si affichÃ©
   */
  trackMaterialSearch = (material) => {
    if (!material || !material.id) return;

    const searchRecord = {
      materialId: material.id,
      materialName: material.name,
      materialType: material.type || 'Non catÃ©gorisÃ©',
      materialPrice: material.price,
      timestamp: Date.now()
    };

    this.materialSearchHistory.push(searchRecord);

    // Sauvegarder dans localStorage
    try {
      localStorage.setItem('materialSearchHistory', JSON.stringify(this.materialSearchHistory));
    } catch (e) {
      this.warn('Error saving search history:', e);
    }

    // Mettre Ã  jour le dashboard si on est en mode Vendeur
    if (window.isGuestMode &amp;&amp; window.currentTab === 'dashboard') {
      this.loadVendeurDashboard();
    }
  }

  // ==========================================
  // DASHBOARD VENDEUR (ONGLET ACCUEIL)
  // ==========================================

  /**
   * Charge et affiche le dashboard complet pour les utilisateurs Vendeur/Conseil.
   *
   * RafraÃ®chit tous les KPIs et le Top 10 des articles :
   * 1. Devis en attente (avec pastille rouge animÃ©e si > 0)
   * 2. Devis crÃ©Ã©s cette semaine
   * 3. Recherches effectuÃ©es aujourd'hui
   * 4. Top 10 articles les plus recherchÃ©s (7 derniers jours)
   *
   * Charge l'historique depuis localStorage si vide avant de calculer les KPIs.
   * AppelÃ© lors de l'ouverture de l'onglet "Accueil" en mode Vendeur.
   *
   * @public
   * @async
   * @returns {Promise&lt;void>}
   *
   * @example
   * // Utilisateur vendeur ouvre l'onglet "Accueil"
   * await this.loadVendeurDashboard();
   * // â†’ Tous les KPIs sont rafraÃ®chis
   * // â†’ Top 10 articles affichÃ© avec boutons "SÃ©lectionner"
   */
  loadVendeurDashboard = async () => {
    try {
      this.log('Loading Vendeur Dashboard...');

      // Charger l'historique depuis localStorage si vide
      if (this.materialSearchHistory.length === 0) {
        this.loadSearchHistory();
      }

      // KPI 1: Devis en attente
      await this.updateVendeurPendingQuotes();

      // KPI 2: Devis crÃ©Ã©s cette semaine
      await this.updateVendeurQuotesWeek();

      // KPI 3: Recherches aujourd'hui
      this.updateVendeurSearchesToday();

      // Top 10 Articles
      this.updateVendeurTopMaterials();

      this.log('Vendeur Dashboard loaded');
    } catch (error) {
      this.error('Error loading Vendeur Dashboard:', error);
    }
  }

  /**
   * Met Ã  jour le KPI "Devis en attente" du dashboard vendeur.
   *
   * RÃ©cupÃ¨re tous les devis via IPC, filtre ceux avec status "en_attente",
   * affiche le compte et gÃ¨re la pastille rouge animÃ©e (pulse) si > 0.
   *
   * Ã‰lÃ©ments DOM mis Ã  jour :
   * - #vendeur-quotes-pending : Nombre de devis en attente
   * - #vendeur-pending-badge : Pastille rouge avec animation pulse
   *
   * @public
   * @async
   * @returns {Promise&lt;void>}
   *
   * @example
   * await this.updateVendeurPendingQuotes();
   * // â†’ #vendeur-quotes-pending affiche "3"
   * // â†’ Pastille rouge visible et animÃ©e si count > 0
   */
  updateVendeurPendingQuotes = async () => {
    try {
      const result = await window.electron.invoke('list-saved-quotes');
      if (!result.success) return;

      const quotes = result.quotes || [];
      const pendingQuotes = quotes.filter(q => q.status === 'en_attente');
      const count = pendingQuotes.length;

      const kpiElement = document.getElementById('vendeur-quotes-pending');
      const badgeElement = document.getElementById('vendeur-pending-badge');

      if (kpiElement) {
        kpiElement.textContent = count;
      }

      // Afficher/masquer la pastille rouge
      if (badgeElement) {
        if (count > 0) {
          badgeElement.style.display = 'inline-block';
          badgeElement.innerHTML = `&lt;span class="visually-hidden">${count} devis en attente&lt;/span>`;

          // Animation pulse
          badgeElement.style.animation = 'pulse 2s infinite';
        } else {
          badgeElement.style.display = 'none';
        }
      }

    } catch (error) {
      this.error('Error updating vendeur pending quotes:', error);
    }
  }

  /**
   * Met Ã  jour le KPI "Devis crÃ©Ã©s cette semaine" du dashboard vendeur.
   *
   * RÃ©cupÃ¨re tous les devis via IPC, filtre ceux crÃ©Ã©s dans les 7 derniers jours,
   * et affiche le compte.
   *
   * Calcul : Date de crÃ©ation > (Date actuelle - 7 jours)
   *
   * @public
   * @async
   * @returns {Promise&lt;void>}
   *
   * @example
   * await this.updateVendeurQuotesWeek();
   * // â†’ #vendeur-quotes-week affiche "12"
   */
  updateVendeurQuotesWeek = async () => {
    try {
      const result = await window.electron.invoke('list-saved-quotes');
      if (!result.success) return;

      const quotes = result.quotes || [];
      const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
      const quotesThisWeek = quotes.filter(q => new Date(q.createdAt).getTime() > weekAgo);

      const kpiElement = document.getElementById('vendeur-quotes-week');
      if (kpiElement) {
        kpiElement.textContent = quotesThisWeek.length;
      }

    } catch (error) {
      this.error('Error updating vendeur quotes week:', error);
    }
  }

  /**
   * Met Ã  jour le KPI "Recherches aujourd'hui" du dashboard vendeur.
   *
   * Filtre l'historique de recherche (this.materialSearchHistory) pour ne garder
   * que les recherches effectuÃ©es aujourd'hui (mÃªme jour calendaire) et affiche le compte.
   *
   * Utilise setHours(0,0,0,0) pour comparaison par jour sans l'heure.
   *
   * @public
   * @returns {void}
   *
   * @example
   * this.updateVendeurSearchesToday();
   * // â†’ #vendeur-searches-today affiche "27"
   */
  updateVendeurSearchesToday = () => {
    const today = new Date().setHours(0, 0, 0, 0);
    const searchesToday = this.materialSearchHistory.filter(s =>
      new Date(s.timestamp).setHours(0, 0, 0, 0) === today
    );

    const kpiElement = document.getElementById('vendeur-searches-today');
    if (kpiElement) {
      kpiElement.textContent = searchesToday.length;
    }
  }

  /**
   * Met Ã  jour le tableau "Top 10 Articles" du dashboard vendeur.
   *
   * Algorithme :
   * 1. Filtre l'historique pour garder les recherches des 7 derniers jours
   * 2. Compte les occurrences par matÃ©riau (materialId)
   * 3. Trie par nombre de recherches (dÃ©croissant)
   * 4. Prend le top 10
   * 5. GÃ©nÃ¨re le HTML du tableau avec boutons "SÃ©lectionner"
   *
   * Affiche "Aucune donnÃ©e disponible" si aucune recherche cette semaine.
   *
   * Colonnes du tableau :
   * - Rang (1-10)
   * - Nom du matÃ©riau
   * - CatÃ©gorie (badge gris)
   * - Nombre de recherches (badge bleu)
   * - Prix unitaire
   * - Bouton "SÃ©lectionner" (appelle selectMaterial(id))
   *
   * @public
   * @returns {void}
   *
   * @example
   * this.updateVendeurTopMaterials();
   * // â†’ Tableau #vendeur-top-materials rempli avec top 10
   */
  updateVendeurTopMaterials = () => {
    const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
    const searchesThisWeek = this.materialSearchHistory.filter(s => s.timestamp > weekAgo);

    // Compter les occurrences par matÃ©riau
    const materialCount = {};
    searchesThisWeek.forEach(search => {
      if (!materialCount[search.materialId]) {
        materialCount[search.materialId] = {
          id: search.materialId,
          name: search.materialName,
          type: search.materialType,
          price: search.materialPrice,
          count: 0
        };
      }
      materialCount[search.materialId].count++;
    });

    // Trier par nombre de recherches (dÃ©croissant) et prendre le top 10
    const top10 = Object.values(materialCount)
      .sort((a, b) => b.count - a.count)
      .slice(0, 10);

    // Afficher dans le tableau
    const tbody = document.getElementById('vendeur-top-materials');
    if (!tbody) return;

    if (top10.length === 0) {
      tbody.innerHTML = `
        &lt;tr>
          &lt;td colspan="6" class="text-center text-muted">
            Aucune donnÃ©e disponible. Commencez Ã  rechercher des articles !
          &lt;/td>
        &lt;/tr>
      `;
      return;
    }

    tbody.innerHTML = top10.map((item, index) => `
      &lt;tr>
        &lt;td>&lt;strong>${index + 1}&lt;/strong>&lt;/td>
        &lt;td>${TextFormatter.escapeHtml(item.name)}&lt;/td>
        &lt;td>&lt;span class="badge bg-secondary">${TextFormatter.escapeHtml(item.type)}&lt;/span>&lt;/td>
        &lt;td>&lt;span class="badge bg-primary">${item.count} recherche${item.count > 1 ? 's' : ''}&lt;/span>&lt;/td>
        &lt;td>&lt;strong>${item.price.toFixed(2)} â‚¬&lt;/strong>&lt;/td>
        &lt;td>
          &lt;button class="btn btn-sm btn-success" onclick="selectMaterial(${item.id})">
            SÃ©lectionner
          &lt;/button>
        &lt;/td>
      &lt;/tr>
    `).join('');
  }

  // ==========================================
  // DASHBOARD ADMIN (ONGLET TABLEAU DE BORD)
  // ==========================================

  /**
   * Charge et affiche le dashboard complet pour les administrateurs.
   *
   * Effectue les opÃ©rations suivantes :
   * 1. RÃ©cupÃ¨re tous les devis (IPC list-saved-quotes)
   * 2. RÃ©cupÃ¨re toutes les factures (IPC list-invoices)
   * 3. Calcule et affiche les 4 KPIs admin
   * 4. CrÃ©e/met Ã  jour les 4 graphiques Chart.js
   *
   * AppelÃ© lors de l'ouverture de l'onglet "Tableau de bord" en mode Admin.
   *
   * @public
   * @async
   * @returns {Promise&lt;void>}
   *
   * @example
   * // Admin ouvre l'onglet "Tableau de bord"
   * await this.loadAdminDashboard();
   * // â†’ 4 KPIs affichÃ©s
   * // â†’ 4 graphiques Chart.js crÃ©Ã©s avec donnÃ©es
   */
  loadAdminDashboard = async () => {
    try {
      this.log('Loading Admin Dashboard...');

      // Charger les donnÃ©es
      const quotesResult = await window.electron.invoke('list-saved-quotes');
      const invoicesResult = await window.electron.invoke('list-invoices');

      if (!quotesResult.success || !invoicesResult.success) {
        this.error('Error loading dashboard data');
        return;
      }

      const quotes = quotesResult.quotes || [];
      const invoices = invoicesResult.invoices || [];

      // Calculer les KPIs
      await this.updateAdminKPIs(quotes, invoices);

      // CrÃ©er/mettre Ã  jour les graphiques
      await this.updateAdminCharts(quotes, invoices);

      this.log('Admin Dashboard loaded');

    } catch (error) {
      this.error('Error loading Admin Dashboard:', error);
    }
  }

  /**
   * Met Ã  jour les 4 KPIs du dashboard administrateur.
   *
   * KPIs calculÃ©s :
   * 1. **CA du mois** : Somme des totaux TTC des factures payÃ©es du mois en cours
   * 2. **Devis en attente** : Nombre de devis avec status "en_attente" (avec badge rouge)
   * 3. **Factures en retard** : Factures avec status "Ã©chue" OU dueDate dÃ©passÃ©e (avec badge rouge)
   * 4. **Taux de conversion** : % de devis acceptÃ©s ou facturÃ©s / total devis
   *
   * Ã‰lÃ©ments DOM mis Ã  jour :
   * - #kpi-ca-month : CA du mois (â‚¬)
   * - #kpi-quotes-pending : Nombre de devis en attente
   * - #admin-pending-badge : Badge rouge (visible si > 0)
   * - #kpi-invoices-overdue : Nombre de factures en retard
   * - #admin-overdue-badge : Badge rouge (visible si > 0)
   * - #kpi-conversion-rate : Taux de conversion (%)
   *
   * @public
   * @async
   * @param {Array&lt;Object>} quotes - Liste complÃ¨te des devis
   * @param {Array&lt;Object>} invoices - Liste complÃ¨te des factures
   * @returns {Promise&lt;void>}
   *
   * @example
   * const quotes = await IPC('list-saved-quotes');
   * const invoices = await IPC('list-invoices');
   * await this.updateAdminKPIs(quotes, invoices);
   * // â†’ 4 KPIs affichÃ©s avec badges conditionnels
   */
  updateAdminKPIs = async (quotes, invoices) => {
    try {
      // KPI 1: CA du mois (factures payÃ©es du mois actuel)
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      const paidInvoicesThisMonth = invoices.filter(inv => {
        if (inv.status !== 'payÃ©e') return false;
        const paymentDate = inv.paymentDate ? new Date(inv.paymentDate) : null;
        if (!paymentDate) return false;
        return paymentDate.getMonth() === currentMonth &amp;&amp; paymentDate.getFullYear() === currentYear;
      });

      const caMonth = paidInvoicesThisMonth.reduce((sum, inv) => sum + (inv.totals?.totalTTC || 0), 0);
      const kpiCaMonth = document.getElementById('kpi-ca-month');
      if (kpiCaMonth) {
        kpiCaMonth.textContent = `${caMonth.toFixed(2)} â‚¬`;
      }

      // KPI 2: Devis en attente
      const pendingQuotes = quotes.filter(q => q.status === 'en_attente');
      const kpiQuotesPending = document.getElementById('kpi-quotes-pending');
      if (kpiQuotesPending) {
        kpiQuotesPending.textContent = pendingQuotes.length;
      }

      // Afficher/masquer le badge de devis en attente
      const adminPendingBadge = document.getElementById('admin-pending-badge');
      if (adminPendingBadge) {
        adminPendingBadge.style.display = pendingQuotes.length > 0 ? 'block' : 'none';
      }

      // KPI 3: Factures en retard (status Ã©chue OU dueDate dÃ©passÃ©e)
      const overdueInvoices = invoices.filter(inv => {
        if (inv.status === 'payÃ©e' || inv.status === 'annulÃ©e') return false;
        if (inv.status === 'Ã©chue') return true;
        const dueDate = inv.dueDate ? new Date(inv.dueDate) : null;
        if (!dueDate) return false;
        return dueDate &lt; now;
      });

      const kpiInvoicesOverdue = document.getElementById('kpi-invoices-overdue');
      if (kpiInvoicesOverdue) {
        kpiInvoicesOverdue.textContent = overdueInvoices.length;
      }

      // Afficher/masquer le badge de factures en retard
      const adminOverdueBadge = document.getElementById('admin-overdue-badge');
      if (adminOverdueBadge) {
        adminOverdueBadge.style.display = overdueInvoices.length > 0 ? 'block' : 'none';
      }

      // KPI 4: Taux de conversion (devis acceptÃ©s ou facturÃ©s / total devis)
      const totalQuotes = quotes.length;
      const convertedQuotes = quotes.filter(q => ['acceptÃ©', 'facturÃ©'].includes(q.status));
      const conversionRate = totalQuotes > 0 ? (convertedQuotes.length / totalQuotes) * 100 : 0;

      const kpiConversionRate = document.getElementById('kpi-conversion-rate');
      if (kpiConversionRate) {
        kpiConversionRate.textContent = `${conversionRate.toFixed(1)}%`;
      }

      this.log('Admin KPIs updated:', {
        caMonth: caMonth.toFixed(2),
        pendingQuotes: pendingQuotes.length,
        overdueInvoices: overdueInvoices.length,
        conversionRate: conversionRate.toFixed(1)
      });

    } catch (error) {
      this.error('Error updating Admin KPIs:', error);
    }
  }

  /**
   * Met Ã  jour les 4 graphiques Chart.js du dashboard administrateur.
   *
   * Lifecycle :
   * 1. DÃ©truit les anciens graphiques (Ã©vite fuites mÃ©moire)
   * 2. CrÃ©e les 4 nouveaux graphiques :
   *    - RÃ©partition des devis par statut (Doughnut)
   *    - Ã‰volution du CA sur 6 mois (Line)
   *    - Top 20 produits du mois (Bar horizontal)
   *    - Performance par catÃ©gorie (Doughnut)
   * 3. Analyse les tendances et affiche les recommandations
   *
   * Canvas utilisÃ©s :
   * - #chart-quotes-status
   * - #chart-revenue
   * - #chart-top-products
   * - #chart-categories
   *
   * @public
   * @async
   * @param {Array&lt;Object>} quotes - Liste complÃ¨te des devis
   * @param {Array&lt;Object>} invoices - Liste complÃ¨te des factures
   * @returns {Promise&lt;void>}
   *
   * @example
   * await this.updateAdminCharts(quotes, invoices);
   * // â†’ 4 graphiques crÃ©Ã©s avec plugins personnalisÃ©s
   * // â†’ Tendances produits affichÃ©es avec recommandations
   */
  updateAdminCharts = async (quotes, invoices) => {
    try {
      // DÃ©truire les anciens graphiques s'ils existent
      if (this.adminDashboardCharts.quotesStatus) {
        this.adminDashboardCharts.quotesStatus.destroy();
      }
      if (this.adminDashboardCharts.revenue) {
        this.adminDashboardCharts.revenue.destroy();
      }
      if (this.adminDashboardCharts.topProducts) {
        this.adminDashboardCharts.topProducts.destroy();
      }
      if (this.adminDashboardCharts.categories) {
        this.adminDashboardCharts.categories.destroy();
      }

      // Graphique 1: RÃ©partition des devis par statut (Pie/Doughnut chart)
      this.createQuotesStatusChart(quotes);

      // Graphique 2: Ã‰volution du CA sur 6 mois (Line chart)
      this.createRevenueChart(invoices);

      // Analyser les donnÃ©es produits
      const { currentData, previousData, categoryData } = this.analyzeProductData(quotes, invoices);

      // Graphique 3: Top 20 produits du mois
      this.createTopProductsChart(currentData);

      // Graphique 4: Performance par catÃ©gorie
      this.createCategoriesChart(categoryData);

      // Afficher les tendances avec recommandations
      this.displayTrendingProducts(currentData, previousData);

      // Analyse des clients
      await this.displayTopClients();

      this.log('Admin Charts and analyses updated');

    } catch (error) {
      this.error('Error updating Admin Charts:', error);
    }
  }

  /**
   * CrÃ©e le graphique Doughnut de rÃ©partition des devis par statut.
   *
   * Affiche la distribution des devis selon les 6 statuts possibles :
   * - Brouillon (gris) - en_attente (jaune) - validÃ© (bleu)
   * - acceptÃ© (vert foncÃ©) - facturÃ© (vert clair) - refusÃ© (rouge)
   *
   * FonctionnalitÃ©s :
   * - Plugin personnalisÃ© affichant les pourcentages sur les segments (si >= 3%)
   * - LÃ©gende en bas avec couleurs
   * - Tooltip avec dÃ©tails (nombre + pourcentage)
   * - Doughnut (centre vide)
   *
   * @public
   * @param {Array&lt;Object>} quotes - Liste complÃ¨te des devis
   * @returns {void}
   *
   * @example
   * this.createQuotesStatusChart(quotes);
   * // â†’ Graphique doughnut crÃ©Ã© sur #chart-quotes-status
   * // â†’ StockÃ© dans this.adminDashboardCharts.quotesStatus
   */
  createQuotesStatusChart = (quotes) => {
    const canvas = document.getElementById('chart-quotes-status');
    if (!canvas) return;

    // Compter les devis par statut
    const statusCount = {
      'brouillon': 0,
      'en_attente': 0,
      'validÃ©': 0,
      'acceptÃ©': 0,
      'facturÃ©': 0,
      'refusÃ©': 0
    };

    quotes.forEach(q => {
      const status = q.status || 'brouillon';
      if (statusCount.hasOwnProperty(status)) {
        statusCount[status]++;
      }
    });

    // Couleurs pour chaque statut
    const colors = {
      'brouillon': '#6c757d',
      'en_attente': '#ffc107',
      'validÃ©': '#0d6efd',
      'acceptÃ©': '#198754',
      'facturÃ©': '#28a745',
      'refusÃ©': '#dc3545'
    };

    const labels = {
      'brouillon': 'Brouillon',
      'en_attente': 'En attente',
      'validÃ©': 'ValidÃ©',
      'acceptÃ©': 'AcceptÃ©',
      'facturÃ©': 'FacturÃ©',
      'refusÃ©': 'RefusÃ©'
    };

    const data = Object.keys(statusCount).map(status => statusCount[status]);
    const backgroundColors = Object.keys(statusCount).map(status => colors[status]);
    const chartLabels = Object.keys(statusCount).map(status => labels[status]);

    // Plugin personnalisÃ© pour afficher les pourcentages sur le graphique
    const percentagePlugin = {
      id: 'percentageLabels',
      afterDatasetDraw(chart) {
        const { ctx, data } = chart;
        const dataset = data.datasets[0];
        const total = dataset.data.reduce((a, b) => a + b, 0);

        if (total === 0) return;

        chart.getDatasetMeta(0).data.forEach((arc, index) => {
          const value = dataset.data[index];
          const percentage = ((value / total) * 100).toFixed(1);

          // Ne pas afficher si le pourcentage est trop petit
          if (percentage &lt; 3) return;

          // Position du texte (centre de l'arc)
          const { x, y } = arc.tooltipPosition();

          // Style du texte
          ctx.save();
          ctx.font = 'bold 14px Arial';
          ctx.fillStyle = '#fff';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';

          // Ombre pour meilleure lisibilitÃ©
          ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
          ctx.shadowBlur = 3;
          ctx.shadowOffsetX = 1;
          ctx.shadowOffsetY = 1;

          // Afficher le pourcentage
          ctx.fillText(`${percentage}%`, x, y);
          ctx.restore();
        });
      }
    };

    this.adminDashboardCharts.quotesStatus = new Chart(canvas, {
      type: 'doughnut',
      data: {
        labels: chartLabels,
        datasets: [{
          data: data,
          backgroundColor: backgroundColors,
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              font: {
                size: 12
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      },
      plugins: [percentagePlugin]
    });
  }

  /**
   * CrÃ©e le graphique Line d'Ã©volution du CA sur les 6 derniers mois.
   *
   * Calcule le chiffre d'affaires mensuel en additionnant les totaux TTC
   * des factures payÃ©es pour chaque mois.
   *
   * FonctionnalitÃ©s :
   * - Axe X : 6 derniers mois (format "jan. 2025")
   * - Axe Y : CA en euros (commence Ã  0)
   * - Plugin personnalisÃ© affichant les valeurs â‚¬ au-dessus des points
   * - Courbe lissÃ©e (tension: 0.4)
   * - Zone remplie sous la courbe (semi-transparent)
   * - Points stylisÃ©s (vert, bordure blanche)
   *
   * @public
   * @param {Array&lt;Object>} invoices - Liste complÃ¨te des factures
   * @returns {void}
   *
   * @example
   * this.createRevenueChart(invoices);
   * // â†’ Graphique ligne crÃ©Ã© sur #chart-revenue
   * // â†’ StockÃ© dans this.adminDashboardCharts.revenue
   */
  createRevenueChart = (invoices) => {
    const canvas = document.getElementById('chart-revenue');
    if (!canvas) return;

    // Calculer les 6 derniers mois
    const months = [];
    const revenueData = [];
    const now = new Date();

    for (let i = 5; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const monthName = date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' });
      months.push(monthName);

      // Calculer le CA pour ce mois (factures payÃ©es)
      const monthRevenue = invoices
        .filter(inv => {
          if (inv.status !== 'payÃ©e') return false;
          const paymentDate = inv.paymentDate ? new Date(inv.paymentDate) : null;
          if (!paymentDate) return false;
          return paymentDate.getMonth() === date.getMonth() &amp;&amp;
                 paymentDate.getFullYear() === date.getFullYear();
        })
        .reduce((sum, inv) => sum + (inv.totals?.totalTTC || 0), 0);

      revenueData.push(monthRevenue);
    }

    // Plugin pour afficher les valeurs sur le graphique de ligne
    const revenueValuesPlugin = {
      id: 'revenueValues',
      afterDatasetDraw(chart) {
        const { ctx } = chart;
        chart.getDatasetMeta(0).data.forEach((datapoint, index) => {
          const value = chart.data.datasets[0].data[index];

          // Ne pas afficher si la valeur est 0
          if (value === 0) return;

          ctx.save();
          ctx.font = 'bold 11px Arial';
          ctx.fillStyle = '#198754';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom';

          // Afficher la valeur au-dessus du point
          ctx.fillText(`${value.toFixed(0)}â‚¬`, datapoint.x, datapoint.y - 8);
          ctx.restore();
        });
      }
    };

    this.adminDashboardCharts.revenue = new Chart(canvas, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          label: 'CA (â‚¬)',
          data: revenueData,
          borderColor: '#198754',
          backgroundColor: 'rgba(25, 135, 84, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#198754',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `CA: ${context.parsed.y.toFixed(2)} â‚¬`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toFixed(0) + ' â‚¬';
              }
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      },
      plugins: [revenueValuesPlugin]
    });
  }

  /**
   * Analyse les donnÃ©es des produits depuis les devis et factures pour gÃ©nÃ©rer des statistiques
   *
   * ALGORITHME:
   * 1. Parcourt les devis acceptÃ©s/facturÃ©s ET factures payÃ©es
   * 2. AgrÃ¨ge par produit (nom) et catÃ©gorie (type)
   * 3. Calcule quantitÃ©s vendues + CA par produit
   * 4. Compare mois actuel vs mois prÃ©cÃ©dent pour identifier tendances
   * 5. GÃ©nÃ¨re donnÃ©es pour graphiques "Top Produits" et "RÃ©partition CatÃ©gories"
   *
   * @param {Array} quotes - Liste des devis (seuls acceptÃ©/facturÃ© sont comptÃ©s)
   * @param {Array} invoices - Liste des factures (seules payÃ©es sont comptÃ©es)
   * @returns {Object} {currentData, previousData, categoryData} - DonnÃ©es agrÃ©gÃ©es par produit et catÃ©gorie
   *
   * @example
   * const {currentData, previousData, categoryData} = analyzeProductData(quotes, invoices);
   * // currentData = {"Parpaing 20x20": {quantity: 1500, revenue: 4500, ...}}
   * // categoryData = {"MaÃ§onnerie": {revenue: 12000, quantity: 2000}}
   */
  analyzeProductData = (quotes, invoices) => {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    // Mois prÃ©cÃ©dent
    const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
    const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;

    const currentData = {};
    const previousData = {};
    const categoryData = {};

    // Fonction pour ajouter un produit aux stats
    const addProduct = (item, quantity, date, targetData) => {
      // Support des deux structures possibles (item direct ou item.material)
      const material = item.material || item;
      const productName = material.name || material.nom || material.designation || '';
      if (!productName) return;

      const category = material.type || material.categorie || 'Autre';
      const price = material.price || material.prixUnitaireHT || material.prix || 0;
      const revenue = quantity * price;

      // Ajouter aux produits
      if (!targetData[productName]) {
        targetData[productName] = {
          name: productName,
          category: category,
          quantity: 0,
          revenue: 0,
          material: material
        };
      }

      targetData[productName].quantity += quantity;
      targetData[productName].revenue += revenue;

      // Ajouter aux catÃ©gories
      if (!categoryData[category]) {
        categoryData[category] = {
          name: category,
          revenue: 0,
          quantity: 0
        };
      }
      categoryData[category].revenue += revenue;
      categoryData[category].quantity += quantity;
    };

    // Analyser les devis (acceptÃ©s et facturÃ©s seulement)
    quotes.forEach(quote => {
      if (!quote.items || !Array.isArray(quote.items)) return;
      if (quote.status !== 'acceptÃ©' &amp;&amp; quote.status !== 'facturÃ©') return;

      const date = quote.date ? new Date(quote.date) : null;
      if (!date) return;

      const month = date.getMonth();
      const year = date.getFullYear();

      quote.items.forEach(item => {
        const qty = item.quantity || item.quantite || 1;
        if (month === currentMonth &amp;&amp; year === currentYear) {
          addProduct(item, qty, date, currentData);
        } else if (month === prevMonth &amp;&amp; year === prevYear) {
          addProduct(item, qty, date, previousData);
        }
      });
    });

    // Analyser les factures (payÃ©es seulement)
    invoices.forEach(invoice => {
      if (!invoice.items || !Array.isArray(invoice.items)) return;
      if (invoice.status !== 'payÃ©e' &amp;&amp; invoice.status !== 'PayÃ©e') return;

      const paymentDate = invoice.paymentDate ? new Date(invoice.paymentDate) : null;
      if (!paymentDate) return;

      const month = paymentDate.getMonth();
      const year = paymentDate.getFullYear();

      invoice.items.forEach(item => {
        const qty = item.quantity || item.quantite || 1;
        if (month === currentMonth &amp;&amp; year === currentYear) {
          addProduct(item, qty, paymentDate, currentData);
        } else if (month === prevMonth &amp;&amp; year === prevYear) {
          addProduct(item, qty, paymentDate, previousData);
        }
      });
    });

    return { currentData, previousData, categoryData };
  }

  /**
   * CrÃ©e le graphique Bar horizontal du Top 20 des produits par CA.
   *
   * Affiche les 20 produits les plus vendus du mois en cours,
   * triÃ©s par chiffre d'affaires dÃ©croissant.
   *
   * FonctionnalitÃ©s :
   * - Barres horizontales (indexAxis: 'y')
   * - Couleur bleu Bootstrap
   * - Plugin personnalisÃ© affichant les valeurs â‚¬ Ã  droite des barres
   * - Tooltip affichant CA + quantitÃ©
   * - Noms de produits tronquÃ©s Ã  30 caractÃ¨res
   * - clearRect() si aucune donnÃ©e
   *
   * @public
   * @param {Object} productData - DonnÃ©es agrÃ©gÃ©es par produit
   * @param {string} productData.name - Nom du produit
   * @param {number} productData.revenue - CA total du produit
   * @param {number} productData.quantity - QuantitÃ© vendue
   * @returns {void}
   *
   * @example
   * const { currentData } = this.analyzeProductData(quotes, invoices);
   * this.createTopProductsChart(currentData);
   * // â†’ Graphique barres horizontales crÃ©Ã© sur #chart-top-products
   */
  createTopProductsChart = (productData) => {
    const canvas = document.getElementById('chart-top-products');
    if (!canvas) return;

    // DÃ©truire l'ancien graphique s'il existe
    if (this.adminDashboardCharts.topProducts) {
      this.adminDashboardCharts.topProducts.destroy();
    }

    // Trier les produits par CA et prendre le top 20
    const sortedProducts = Object.values(productData)
      .sort((a, b) => b.revenue - a.revenue)
      .slice(0, 20);

    if (sortedProducts.length === 0) {
      canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
      return;
    }

    const labels = sortedProducts.map(p => p.name.length > 30 ? p.name.substring(0, 30) + '...' : p.name);
    const revenues = sortedProducts.map(p => p.revenue);
    const quantities = sortedProducts.map(p => p.quantity);

    // Plugin pour afficher les valeurs Ã  la fin des barres
    const topProductsValuesPlugin = {
      id: 'topProductsValues',
      afterDatasetDraw(chart) {
        const { ctx } = chart;
        chart.getDatasetMeta(0).data.forEach((bar, index) => {
          const value = chart.data.datasets[0].data[index];

          ctx.save();
          ctx.font = 'bold 10px Arial';
          ctx.fillStyle = '#0d6efd';
          ctx.textAlign = 'left';
          ctx.textBaseline = 'middle';

          // Afficher la valeur Ã  la fin de la barre
          ctx.fillText(`${value.toFixed(0)}â‚¬`, bar.x + 5, bar.y);
          ctx.restore();
        });
      }
    };

    this.adminDashboardCharts.topProducts = new Chart(canvas, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'CA (â‚¬)',
          data: revenues,
          backgroundColor: 'rgba(13, 110, 253, 0.7)',
          borderColor: 'rgba(13, 110, 253, 1)',
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const index = context.dataIndex;
                return [
                  `CA: ${context.parsed.x.toFixed(2)} â‚¬`,
                  `QuantitÃ©: ${quantities[index]}`
                ];
              }
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toFixed(0) + ' â‚¬';
              }
            }
          }
        }
      },
      plugins: [topProductsValuesPlugin]
    });
  }

  /**
   * CrÃ©e le graphique Doughnut de performance par catÃ©gorie de matÃ©riaux.
   *
   * Affiche la rÃ©partition du chiffre d'affaires par type de matÃ©riau
   * (MaÃ§onnerie, Plomberie, Ã‰lectricitÃ©, etc.).
   *
   * FonctionnalitÃ©s :
   * - Palette de 8 couleurs prÃ©dÃ©finies
   * - Plugin personnalisÃ© affichant les pourcentages sur les segments (si >= 5%)
   * - Tooltip affichant catÃ©gorie, CA â‚¬ et pourcentage
   * - LÃ©gende en bas
   * - clearRect() si aucune donnÃ©e
   *
   * @public
   * @param {Object} categoryData - DonnÃ©es agrÃ©gÃ©es par catÃ©gorie
   * @param {string} categoryData.name - Nom de la catÃ©gorie
   * @param {number} categoryData.revenue - CA total de la catÃ©gorie
   * @param {number} categoryData.quantity - QuantitÃ© vendue
   * @returns {void}
   *
   * @example
   * const { categoryData } = this.analyzeProductData(quotes, invoices);
   * this.createCategoriesChart(categoryData);
   * // â†’ Graphique doughnut crÃ©Ã© sur #chart-categories
   */
  createCategoriesChart = (categoryData) => {
    const canvas = document.getElementById('chart-categories');
    if (!canvas) return;

    // DÃ©truire l'ancien graphique s'il existe
    if (this.adminDashboardCharts.categories) {
      this.adminDashboardCharts.categories.destroy();
    }

    const categories = Object.values(categoryData);

    if (categories.length === 0) {
      canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
      return;
    }

    const labels = categories.map(c => c.name);
    const revenues = categories.map(c => c.revenue);

    // Palette de couleurs
    const colors = [
      'rgba(13, 110, 253, 0.7)',   // Bleu
      'rgba(25, 135, 84, 0.7)',    // Vert
      'rgba(220, 53, 69, 0.7)',    // Rouge
      'rgba(255, 193, 7, 0.7)',    // Jaune
      'rgba(13, 202, 240, 0.7)',   // Cyan
      'rgba(108, 117, 125, 0.7)',  // Gris
      'rgba(102, 16, 242, 0.7)',   // Violet
      'rgba(255, 99, 71, 0.7)'     // Orange
    ];

    // Plugin pour afficher les pourcentages sur le graphique
    const categoryPercentagePlugin = {
      id: 'categoryPercentages',
      afterDatasetDraw(chart) {
        const { ctx, data } = chart;
        const dataset = data.datasets[0];
        const total = dataset.data.reduce((a, b) => a + b, 0);

        if (total === 0) return;

        chart.getDatasetMeta(0).data.forEach((arc, index) => {
          const value = dataset.data[index];
          const percentage = ((value / total) * 100).toFixed(1);

          // Ne pas afficher si le pourcentage est trop petit
          if (percentage &lt; 5) return;

          // Position du texte (centre de l'arc)
          const { x, y } = arc.tooltipPosition();

          // Style du texte
          ctx.save();
          ctx.font = 'bold 12px Arial';
          ctx.fillStyle = '#fff';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';

          // Ombre pour meilleure lisibilitÃ©
          ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
          ctx.shadowBlur = 3;
          ctx.shadowOffsetX = 1;
          ctx.shadowOffsetY = 1;

          // Afficher le pourcentage
          ctx.fillText(`${percentage}%`, x, y);
          ctx.restore();
        });
      }
    };

    this.adminDashboardCharts.categories = new Chart(canvas, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: revenues,
          backgroundColor: colors,
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                size: 11
              },
              padding: 10
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${label}: ${value.toFixed(2)} â‚¬ (${percentage}%)`;
              }
            }
          }
        }
      },
      plugins: [categoryPercentagePlugin]
    });
  }

  /**
   * Affiche les produits en tendance (hausse/baisse) en comparant mois actuel vs mois prÃ©cÃ©dent
   *
   * LOGIQUE DE DÃ‰TECTION DES TENDANCES:
   * - Hausse: Variation > +5% OU nouveau produit avec CA > 0
   * - Baisse: Variation &lt; -5% OU produit disparu (0 ventes)
   * - Calcul: ((CA actuel - CA prÃ©cÃ©dent) / CA prÃ©cÃ©dent) Ã— 100
   *
   * SEUILS:
   * - Variation significative: Â±5%
   * - Affichage limitÃ© au Top 5 hausse + Top 5 baisse
   *
   * @param {Object} currentData - DonnÃ©es produits du mois actuel {productName: {revenue, quantity}}
   * @param {Object} previousData - DonnÃ©es produits du mois prÃ©cÃ©dent
   * @displays Affiche dans #trending-up-products et #trending-down-products
   */
  displayTrendingProducts = (currentData, previousData) => {
    const trendingUp = [];
    const trendingDown = [];

    // Calculer les variations pour chaque produit
    Object.keys(currentData).forEach(productName => {
      const current = currentData[productName];
      const previous = previousData[productName];

      if (!previous) {
        // Nouveau produit ce mois
        if (current.revenue > 0) {
          trendingUp.push({
            name: productName,
            current: current.revenue,
            previous: 0,
            change: 100,
            isNew: true
          });
        }
      } else {
        // Produit existant : calculer la variation
        const change = previous.revenue > 0
          ? ((current.revenue - previous.revenue) / previous.revenue) * 100
          : 0;

        if (change > 5) {
          trendingUp.push({
            name: productName,
            current: current.revenue,
            previous: previous.revenue,
            change: change,
            isNew: false
          });
        } else if (change &lt; -5) {
          trendingDown.push({
            name: productName,
            current: current.revenue,
            previous: previous.revenue,
            change: Math.abs(change),
            isNew: false
          });
        }
      }
    });

    // Chercher les produits disparus
    Object.keys(previousData).forEach(productName => {
      if (!currentData[productName]) {
        trendingDown.push({
          name: productName,
          current: 0,
          previous: previousData[productName].revenue,
          change: 100,
          isNew: false,
          disappeared: true
        });
      }
    });

    // Trier par variation et prendre le top 5
    trendingUp.sort((a, b) => b.change - a.change);
    trendingDown.sort((a, b) => b.change - a.change);

    // Afficher les produits en hausse
    const upContainer = document.getElementById('trending-up-products');
    if (upContainer) {
      if (trendingUp.length === 0) {
        upContainer.innerHTML = '&lt;div class="text-muted text-center py-3">Aucune hausse significative&lt;/div>';
      } else {
        let html = '';
        trendingUp.slice(0, 5).forEach(product => {
          const recommendation = this.generateRecommendation(product, 'up');
          const productName = TextFormatter.escapeHtml(product.name);
          const safeRecommendation = recommendation ? TextFormatter.escapeHtml(recommendation) : '';
          html += `
          &lt;div class="list-group-item">
            &lt;div class="d-flex justify-content-between align-items-start">
              &lt;div>
                &lt;strong>${productName}&lt;/strong>
                ${product.isNew ? '&lt;span class="badge bg-success ms-2">NOUVEAU&lt;/span>' : ''}
                &lt;div class="small text-muted mt-1">
                  ${product.isNew ? 'Nouveau produit' : `CA: ${product.current.toFixed(2)} â‚¬ (vs ${product.previous.toFixed(2)} â‚¬)`}
                &lt;/div>
                ${safeRecommendation ? `&lt;div class="small text-primary mt-2">&lt;i class="fas fa-lightbulb">&lt;/i> ${safeRecommendation}&lt;/div>` : ''}
              &lt;/div>
              &lt;span class="badge bg-success fs-6">
                &lt;i class="fas fa-arrow-up">&lt;/i> ${product.change.toFixed(0)}%
              &lt;/span>
            &lt;/div>
          &lt;/div>
        `;
        });
        upContainer.innerHTML = html;
      }
    }

    // Afficher les produits en baisse
    const downContainer = document.getElementById('trending-down-products');
    if (downContainer) {
      if (trendingDown.length === 0) {
        downContainer.innerHTML = '&lt;div class="text-muted text-center py-3">Aucune baisse significative&lt;/div>';
      } else {
        let html = '';
        trendingDown.slice(0, 5).forEach(product => {
          const recommendation = this.generateRecommendation(product, 'down');
          const productName = TextFormatter.escapeHtml(product.name);
          const safeRecommendation = recommendation ? TextFormatter.escapeHtml(recommendation) : '';
          html += `
          &lt;div class="list-group-item">
            &lt;div class="d-flex justify-content-between align-items-start">
              &lt;div>
                &lt;strong>${productName}&lt;/strong>
                ${product.disappeared ? '&lt;span class="badge bg-danger ms-2">DISPARU&lt;/span>' : ''}
                &lt;div class="small text-muted mt-1">
                  ${product.disappeared ? 'Plus vendu ce mois' : `CA: ${product.current.toFixed(2)} â‚¬ (vs ${product.previous.toFixed(2)} â‚¬)`}
                &lt;/div>
                ${safeRecommendation ? `&lt;div class="small text-warning mt-2">&lt;i class="fas fa-exclamation-triangle">&lt;/i> ${safeRecommendation}&lt;/div>` : ''}
              &lt;/div>
              &lt;span class="badge bg-danger fs-6">
                &lt;i class="fas fa-arrow-down">&lt;/i> ${product.change.toFixed(0)}%
              &lt;/span>
            &lt;/div>
          &lt;/div>
        `;
        });
        downContainer.innerHTML = html;
      }
    }
  }

  /**
   * GÃ©nÃ¨re des recommandations intelligentes basÃ©es sur les tendances produits.
   *
   * Analyse le type de tendance (hausse/baisse) et l'ampleur de la variation
   * pour suggÃ©rer des actions concrÃ¨tes aux administrateurs.
   *
   * Recommandations en hausse :
   * - Nouveau produit â†’ Mise en avant page d'accueil
   * - Variation > 50% â†’ VÃ©rifier stocks + promotion croisÃ©e
   * - Variation > 20% â†’ Mise en avant auprÃ¨s des vendeurs
   * - Variation > 5% â†’ Continuer le suivi
   *
   * Recommandations en baisse :
   * - Produit disparu â†’ URGENT : EnquÃªter auprÃ¨s des vendeurs
   * - Variation > 50% â†’ Action requise : prix/qualitÃ©/concurrence
   * - Variation > 30% â†’ Interviewer vendeurs pour comprendre freins
   * - Variation > 5% â†’ Surveiller l'Ã©volution
   *
   * @public
   * @param {Object} product - Objet produit avec donnÃ©es de tendance
   * @param {string} product.name - Nom du produit
   * @param {number} product.current - CA mois actuel
   * @param {number} product.previous - CA mois prÃ©cÃ©dent
   * @param {number} product.change - % de variation
   * @param {boolean} [product.isNew] - true si nouveau produit
   * @param {boolean} [product.disappeared] - true si produit disparu
   * @param {'up'|'down'} trend - Type de tendance ('up' = hausse, 'down' = baisse)
   * @returns {string|null} Texte de recommandation ou null
   *
   * @example
   * const recommendation = this.generateRecommendation(
   *   { name: "Parpaing", current: 5000, previous: 3000, change: 66.7 },
   *   'up'
   * );
   * // â†’ "Forte demande ! VÃ©rifier les stocks et envisager une promotion croisÃ©e."
   */
  generateRecommendation = (product, trend) => {
    if (trend === 'up') {
      if (product.isNew) {
        return 'Mettre en avant sur la page d\'accueil - Nouveau produit qui dÃ©colle !';
      } else if (product.change > 50) {
        return 'Forte demande ! VÃ©rifier les stocks et envisager une promotion croisÃ©e.';
      } else if (product.change > 20) {
        return 'Bon potentiel - ConsidÃ©rer une mise en avant auprÃ¨s des vendeurs.';
      } else {
        return 'Tendance positive - Continuer le suivi.';
      }
    } else if (trend === 'down') {
      if (product.disappeared) {
        return 'URGENT : EnquÃªter auprÃ¨s des vendeurs - Pourquoi ce produit n\'est plus vendu ?';
      } else if (product.change > 50) {
        return 'Chute importante ! Action requise : VÃ©rifier prix, qualitÃ©, concurrence.';
      } else if (product.change > 30) {
        return 'Baisse prÃ©occupante - Interviewer les vendeurs pour comprendre les freins.';
      } else {
        return 'LÃ©ger dÃ©clin - Surveiller l\'Ã©volution le mois prochain.';
      }
    }

    return null;
  }

  // ==========================================
  // STATISTIQUES AVANCÃ‰ES
  // ==========================================

  /**
   * Calcule les statistiques de rentabilitÃ© par client
   * @param {Array} invoices - Liste des factures
   * @returns {Array} Top 10 clients par CA
   */
  getClientProfitability = async () => {
    try {
      const invoices = await window.electronAPI.invoke('list-invoices');
      const clientStats = {};

      invoices.filter(inv => inv.status === 'payÃ©e').forEach(inv => {
        const clientName = inv.clientName || 'Client inconnu';
        if (!clientStats[clientName]) {
          clientStats[clientName] = { ca: 0, count: 0, avgTicket: 0 };
        }
        clientStats[clientName].ca += inv.totals?.totalTTC || 0;
        clientStats[clientName].count++;
      });

      return Object.entries(clientStats)
        .map(([name, stats]) => ({
          name,
          ca: stats.ca,
          count: stats.count,
          avgTicket: stats.count > 0 ? stats.ca / stats.count : 0
        }))
        .sort((a, b) => b.ca - a.ca)
        .slice(0, 10);
    } catch (error) {
      this.error('Erreur getClientProfitability:', error);
      return [];
    }
  }

  /**
   * Affiche le Top 10 clients et crÃ©e le graphique
   * @async
   * @returns {Promise&lt;void>}
   */
  displayTopClients = async () => {
    try {
      const topClients = await this.getClientProfitability();

      // Afficher la liste
      const listContainer = document.getElementById('top-clients-list');
      if (listContainer) {
        if (topClients.length === 0) {
          listContainer.innerHTML = '&lt;div class="text-muted text-center py-3">Aucune donnÃ©e client&lt;/div>';
        } else {
          listContainer.innerHTML = topClients.map((client, index) => `
            &lt;div class="list-group-item d-flex justify-content-between align-items-center">
              &lt;div>
                &lt;span class="badge bg-primary me-2">#${index + 1}&lt;/span>
                &lt;strong>${TextFormatter.escapeHtml(client.name)}&lt;/strong>
                &lt;div class="small text-muted">${client.count} facture(s) â€¢ Panier moyen: ${client.avgTicket.toFixed(2)} â‚¬&lt;/div>
              &lt;/div>
              &lt;span class="badge bg-success fs-6">${client.ca.toFixed(2)} â‚¬&lt;/span>
            &lt;/div>
          `).join('');
        }
      }

      // CrÃ©er le graphique
      this.createTopClientsChart(topClients);

    } catch (error) {
      this.error('Error displaying top clients:', error);
    }
  }

  /**
   * CrÃ©e le graphique doughnut des top clients
   * @param {Array} topClients - Top 10 clients par CA
   */
  createTopClientsChart = (topClients) => {
    const canvas = document.getElementById('chart-top-clients');
    if (!canvas) return;

    if (this.adminDashboardCharts.topClients) {
      this.adminDashboardCharts.topClients.destroy();
    }

    if (topClients.length === 0) {
      canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
      return;
    }

    const labels = topClients.slice(0, 8).map(c => c.name.length > 15 ? c.name.substring(0, 15) + '...' : c.name);
    const data = topClients.slice(0, 8).map(c => c.ca);

    const colors = [
      '#0d6efd', '#198754', '#dc3545', '#ffc107',
      '#0dcaf0', '#6c757d', '#6610f2', '#fd7e14'
    ];

    this.adminDashboardCharts.topClients = new Chart(canvas, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: colors,
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { font: { size: 10 }, padding: 8 }
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const pct = ((context.parsed / total) * 100).toFixed(1);
                return `${context.label}: ${context.parsed.toFixed(2)} â‚¬ (${pct}%)`;
              }
            }
          }
        }
      }
    });
  }

  /**
   * Calcule les prÃ©visions de CA basÃ©es sur la tendance
   * @returns {Object} PrÃ©vision CA mois suivant
   */
  getRevenueForecast = async () => {
    try {
      const invoices = await window.electronAPI.invoke('list-invoices');
      const now = new Date();
      const monthlyCA = [];

      for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const ca = invoices
          .filter(inv => {
            if (inv.status !== 'payÃ©e') return false;
            const payDate = inv.paymentDate ? new Date(inv.paymentDate) : null;
            return payDate &amp;&amp; payDate.getMonth() === date.getMonth() &amp;&amp; payDate.getFullYear() === date.getFullYear();
          })
          .reduce((sum, inv) => sum + (inv.totals?.totalTTC || 0), 0);
        monthlyCA.push(ca);
      }

      // Moyenne mobile simple
      const avg = monthlyCA.reduce((a, b) => a + b, 0) / monthlyCA.length;
      const trend = monthlyCA.length >= 2 ? (monthlyCA[monthlyCA.length - 1] - monthlyCA[0]) / monthlyCA.length : 0;
      const forecast = Math.max(0, avg + trend);

      return {
        forecast: Math.round(forecast),
        trend: trend > 0 ? 'hausse' : trend &lt; 0 ? 'baisse' : 'stable',
        confidence: monthlyCA.filter(ca => ca > 0).length >= 3 ? 'haute' : 'faible'
      };
    } catch (error) {
      this.error('Erreur getRevenueForecast:', error);
      return { forecast: 0, trend: 'stable', confidence: 'faible' };
    }
  }

  /**
   * Analyse dÃ©taillÃ©e des marges
   * @returns {Object} Statistiques des marges
   */
  getMarginAnalysis = async () => {
    try {
      const quotes = await window.electronAPI.invoke('list-saved-quotes');
      const acceptedQuotes = quotes.filter(q => ['acceptÃ©', 'facturÃ©'].includes(q.status));

      let totalHT = 0;
      let totalCost = 0;
      const marginsByType = {};

      acceptedQuotes.forEach(q => {
        (q.items || []).forEach(item => {
          const ht = (item.prixUnitaireHT || 0) * (item.quantite || 1);
          const cost = (item.prixAchat || item.prixUnitaireHT * 0.7) * (item.quantite || 1);
          totalHT += ht;
          totalCost += cost;

          const type = item.type || 'Autre';
          if (!marginsByType[type]) marginsByType[type] = { ht: 0, cost: 0 };
          marginsByType[type].ht += ht;
          marginsByType[type].cost += cost;
        });
      });

      const globalMargin = totalHT > 0 ? ((totalHT - totalCost) / totalHT * 100) : 0;

      return {
        globalMargin: globalMargin.toFixed(1),
        totalHT: Math.round(totalHT),
        totalProfit: Math.round(totalHT - totalCost),
        byType: Object.entries(marginsByType).map(([type, data]) => ({
          type,
          margin: data.ht > 0 ? ((data.ht - data.cost) / data.ht * 100).toFixed(1) : 0
        })).sort((a, b) => b.margin - a.margin)
      };
    } catch (error) {
      this.error('Erreur getMarginAnalysis:', error);
      return { globalMargin: 0, totalHT: 0, totalProfit: 0, byType: [] };
    }
  }

  // ==========================================
  // SYNCHRONISATION AVEC SCOPE GLOBAL
  // ==========================================

  /**
   * Configure la synchronisation bidirectionnelle entre les propriÃ©tÃ©s du module
   * et les variables globales window.* pour compatibilitÃ© avec le code legacy.
   *
   * Utilise Object.defineProperty() pour crÃ©er des getters/setters ES6 qui
   * assurent une synchronisation automatique et transparente.
   *
   * Variables synchronisÃ©es :
   * - window.materialSearchHistory â†” this.materialSearchHistory
   * - window.adminDashboardCharts â†” this.adminDashboardCharts
   *
   * Cette approche permet de maintenir la compatibilitÃ© avec le code existant
   * qui accÃ¨de directement aux variables globales, tout en utilisant des propriÃ©tÃ©s
   * d'instance modernes dans le module.
   *
   * @private
   * @returns {void}
   *
   * @example
   * // Le code legacy peut toujours utiliser :
   * window.materialSearchHistory.push(newSearch);
   * // â†’ Automatiquement synchronisÃ© avec this.materialSearchHistory
   *
   * @example
   * // Le module utilise :
   * this.adminDashboardCharts.revenue = newChart;
   * // â†’ Automatiquement synchronisÃ© avec window.adminDashboardCharts.revenue
   */
  syncGlobalVariables() {
    // CrÃ©er des getters/setters pour synchroniser automatiquement
    Object.defineProperty(window, 'materialSearchHistory', {
      get: () => this.materialSearchHistory,
      set: (value) => {
        this.materialSearchHistory = value;
      }
    });

    Object.defineProperty(window, 'adminDashboardCharts', {
      get: () => this.adminDashboardCharts,
      set: (value) => {
        this.adminDashboardCharts = value;
      }
    });
  }
}

export default DashboardModule;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
