

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> modules/quotes/QuotesModule.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule.html">DashboardModule</a></li><li><a href="module-DataCache.html">DataCache</a></li><li><a href="module-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule.html">FECModule</a></li><li><a href="module-FollowUpModule.html">FollowUpModule</a></li><li><a href="module-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-KeyboardShortcutsModule.html">KeyboardShortcutsModule</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-MLService.html">MLService</a></li><li><a href="module-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-NotificationSystem.html">NotificationSystem</a></li><li><a href="module-NotificationSystemV2.html">NotificationSystemV2</a></li><li><a href="module-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-TourModule.html">TourModule</a></li><li><a href="module-UtilitiesModule.html">UtilitiesModule</a></li><li><a href="module-calculations.html">calculations</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-formatters.html">formatters</a></li><li><a href="module-helpers.html">helpers</a></li></ul><h3>Classes</h3><ul><li><a href="BaseModule.html">BaseModule</a></li><li><a href="BulkActionsManager.html">BulkActionsManager</a></li><li><a href="CacheKeys.html">CacheKeys</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="LoadingStateManager.html">LoadingStateManager</a></li><li><a href="ModalHelper.html">ModalHelper</a></li><li><a href="PaginationManager.html">PaginationManager</a></li><li><a href="ServerValidator.html">ServerValidator</a></li><li><a href="StateManager.html">StateManager</a></li><li><a href="TabRefreshManager.html">TabRefreshManager</a></li><li><a href="UndoRedoManager.html">UndoRedoManager</a></li><li><a href="module-AboutModule-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule-DashboardModule.html">DashboardModule</a></li><li><a href="module-ExportModule-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule-FECModule.html">FECModule</a></li><li><a href="module-ImportModule-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-Logger-Logger.html">Logger</a></li><li><a href="module-Logger-ModuleLogger.html">ModuleLogger</a></li><li><a href="module-MaterialsModule-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-PDFModule-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-UtilitiesModule-UtilitiesModule.html">UtilitiesModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#emitSync">emitSync</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#validateBeforeAddToQuote">validateBeforeAddToQuote</a></li><li><a href="global.html#validateBeforeExport">validateBeforeExport</a></li><li><a href="global.html#validateBeforeSaveMaterial">validateBeforeSaveMaterial</a></li><li><a href="global.html#validateBeforeSendEmail">validateBeforeSendEmail</a></li><li><a href="global.html#validateHeaderConfig">validateHeaderConfig</a></li><li><a href="global.html#validatePasswordChange">validatePasswordChange</a></li><li><a href="global.html#validateSMTPConfig">validateSMTPConfig</a></li><li><a href="global.html#waitFor">waitFor</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>modules/quotes/QuotesModule.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * ========================================
 * QUOTES MODULE - Gestion des devis
 * ========================================
 *
 * Module de gestion compl√®te du cycle de vie des devis pour l'application AutoCalc OptiDevis.
 * G√®re la cr√©ation, modification, sauvegarde, chargement, duplication, suppression, changement
 * de statut, impression et conversion en facture des devis.
 *
 * Architecture :
 * Le module orchestre toutes les op√©rations li√©es aux devis et g√®re les permissions
 * selon le mode utilisateur (Admin vs Vendeur/Conseil).
 *
 * Cycle de vie d'un devis :
 * 1. **Brouillon** - Devis en cours de r√©daction
 * 2. **En attente** - Devis soumis pour validation (Vendeur ‚Üí Admin)
 * 3. **Valid√©** - Devis approuv√© et envoy√© au client (Admin uniquement)
 * 4. **Accept√©** - Devis sign√© par le client (Admin uniquement)
 * 5. **Factur√©** - Facture cr√©√©e depuis le devis accept√© (Admin uniquement)
 * 6. **Refus√©** - Devis rejet√© (Admin uniquement)
 *
 * Workflow principal - Sauvegarde d'un devis :
 * 1. Utilisateur clique "Sauvegarder le devis"
 * 2. V√©rification : devis non vide
 * 3. Modal s'affiche avec nom sugg√©r√©
 * 4. Utilisateur saisit/valide le nom
 * 5. Synchronisation clientInfo depuis formulaire
 * 6. Calcul des totaux (HT, TVA, TTC)
 * 7. Appel IPC 'save-quote' avec authToken + donn√©es
 * 8. Si succ√®s : notification + ID du devis stock√©
 *
 * Workflow principal - Chargement d'un devis :
 * 1. Utilisateur clique "Charger" sur un devis
 * 2. Si devis en cours : demander confirmation (modal)
 * 3. Appel IPC 'load-saved-quote' avec ID
 * 4. V√©rification : devis factur√© ‚Üí refus chargement (lecture seule)
 * 5. Restauration : clientInfo, quoteItems, headerConfig
 * 6. Mise √† jour date ‚Üí aujourd'hui
 * 7. Remplissage du formulaire client
 * 8. Restauration de la remise
 * 9. Rafra√Æchissement du tableau
 * 10. Si accept√© : verrouiller les champs (lecture seule)
 *
 * Workflow principal - Changement de statut :
 * 1. Utilisateur clique "Changer le statut"
 * 2. Chargement du devis pour obtenir statut actuel
 * 3. Modal avec select de statut
 * 4. **Permissions Vendeur/Conseil** : uniquement brouillon ‚Üí en_attente
 * 5. **Permissions Admin** : toutes les transitions autoris√©es
 * 6. Si accept√© : afficher champ date de signature
 * 7. Utilisateur s√©lectionne nouveau statut
 * 8. Validation des transitions autoris√©es
 * 9. Appel IPC 'update-quote-status' avec authToken + payload
 * 10. Rafra√Æchissement des listes + dashboard
 *
 * Workflow principal - Conversion en facture :
 * 1. **Admin uniquement** - V√©rification isAuthenticatedThisSession
 * 2. Utilisateur clique "Facturer" sur un devis accept√©
 * 3. V√©rifications : statut = accept√©, pas d√©j√† factur√©
 * 4. Modal de confirmation avec r√©cap (nom, client, total TTC)
 * 5. Utilisateur confirme
 * 6. Appel IPC 'create-invoice-from-quote' avec authToken + quoteId
 * 7. Si succ√®s : cr√©ation facture + maj statut devis ‚Üí factur√©
 * 8. Rafra√Æchissement listes devis + factures
 *
 * Syst√®me de permissions :
 * - **Mode Vendeur/Conseil** (window.isGuestMode = true) :
 *   - Peut : cr√©er, sauvegarder, charger, dupliquer, supprimer devis
 *   - Peut : passer statut brouillon ‚Üí en_attente uniquement
 *   - Ne peut pas : valider, accepter, refuser, facturer
 *   - Ne peut pas : imprimer (sauf devis valid√©)
 *
 * - **Mode Admin** (window.isAuthenticatedThisSession = true) :
 *   - Peut : toutes les op√©rations
 *   - Peut : toutes les transitions de statut
 *   - Peut : cr√©er factures depuis devis accept√©s
 *   - Peut : imprimer tous les devis
 *
 * Transitions de statut autoris√©es :
 * - brouillon ‚Üí en_attente, refus√©
 * - en_attente ‚Üí valid√©, refus√©
 * - valid√© ‚Üí accept√©, refus√©
 * - accept√© ‚Üí factur√©
 * - refus√© ‚Üí (aucune transition)
 * - factur√© ‚Üí (aucune transition)
 *
 * Verrouillage des devis :
 * - **Devis accept√©** : champs verrouill√©s (lecture seule) jusqu'√† d√©verrouillage manuel
 * - **Devis factur√©** : verrouill√© d√©finitivement (impossible de charger pour modifier)
 * - Actions autoris√©es sur devis verrouill√©s : Imprimer, Dupliquer, Supprimer
 *
 * Compatibilit√© avec legacy code :
 * - Expos√© via window.quoteItems, window.clientInfo, window.headerConfig
 * - Synchronisation bidirectionnelle avec variables globales
 * - Fonctions expos√©es au scope global via exposeToGlobal()
 *
 * √âv√©nements √©mis :
 * - 'quotes:initialized' - Module initialis√©
 * - (Pas d'autres √©v√©nements d√©finis explicitement, mais les op√©rations d√©clenchent des mises √† jour UI)
 *
 * Canaux IPC utilis√©s :
 * - 'save-quote' - Sauvegarder un devis (n√©cessite authToken)
 * - 'list-saved-quotes' - Lister tous les devis
 * - 'load-saved-quote' - Charger un devis par ID
 * - 'delete-saved-quote' - Supprimer un devis (n√©cessite authToken)
 * - 'update-quote-status' - Changer le statut d'un devis (n√©cessite authToken)
 * - 'create-invoice-from-quote' - Cr√©er une facture depuis un devis accept√© (n√©cessite authToken)
 *
 * Int√©grations :
 * - InvoicesModule : Cr√©ation de factures depuis devis accept√©s
 * - QuoteBuilderModule : Construction des articles du devis
 * - DashboardModule : Affichage des devis en attente (vendeur)
 * - PDFModule : Impression des devis
 *
 * @module QuotesModule
 * @extends BaseModule
 * @version 2.0.0
 * @author AutoCalc OptiDevis
 */

import BaseModule from '../../core/BaseModule.js';
import NotificationSystem from '../../shared/ui/NotificationSystem.js';
import { calculateQuantity } from '../../shared/utils/calculations.js';
import BulkActionsManager from '../../shared/bulk/BulkActionsManager.js';

class QuotesModule extends BaseModule {
  /**
   * Cr√©e une instance du module Quotes.
   *
   * @param {StateManager} state - Gestionnaire d'√©tat global
   * @param {EventBus} eventBus - Bus d'√©v√©nements pour communication inter-modules
   */
  constructor(state, eventBus) {
    super('quotes', state, eventBus);

    /**
     * Articles du devis en cours.
     * Chaque article contient : {id, name, quantity, priceHT, tva, priceTTC, ...}
     * Synchronis√© avec window.quoteItems pour compatibilit√© legacy.
     *
     * @type {Array&lt;Object>}
     * @private
     */
    this.quoteItems = [];

    /**
     * Informations client du devis en cours.
     * Synchronis√© avec les champs du formulaire client.
     *
     * @type {Object}
     * @private
     * @property {string} name - Nom du client
     * @property {string} phone - T√©l√©phone du client
     * @property {string} email - Email du client
     * @property {string} address - Adresse du client
     * @property {string} quoteDate - Date du devis (YYYY-MM-DD)
     * @property {string} issuer - √âmetteur du devis
     */
    this.clientInfo = {};

    /**
     * Configuration de l'en-t√™te du devis (logo, etc.).
     * Synchronis√© avec window.headerConfig.
     *
     * @type {Object}
     * @private
     */
    this.headerConfig = {};

    /**
     * ID du devis actuellement charg√©.
     * null si aucun devis n'est charg√© (nouveau devis vierge).
     *
     * @type {string|null}
     * @private
     */
    this.currentQuoteId = null;

    /**
     * Date de cr√©ation du devis actuellement charg√© (ISO string).
     *
     * @type {string|null}
     * @private
     */
    this.currentQuoteCreatedAt = null;

    /**
     * Nom du devis actuellement charg√©.
     *
     * @type {string|null}
     * @private
     */
    this.currentQuoteName = null;

    /**
     * Statut du devis actuellement charg√©.
     * Valeurs possibles : 'brouillon', 'en_attente', 'valid√©', 'accept√©', 'refus√©', 'factur√©'
     *
     * @type {string}
     * @private
     * @default 'brouillon'
     */
    this.currentQuoteStatus = 'brouillon';

    /**
     * ID du devis en attente de chargement (utilis√© pour le modal de confirmation).
     * Stock√© temporairement quand l'utilisateur veut charger un devis alors qu'un autre est en cours.
     *
     * @type {string|null}
     * @private
     */
    this.pendingQuoteToLoad = null;

    /**
     * ID du devis en attente de suppression (utilis√© pour le modal de confirmation).
     *
     * @type {string|null}
     * @private
     */
    this.quoteToDeleteId = null;

    /**
     * Nom du devis en attente de suppression (pour affichage dans le modal).
     *
     * @type {string|null}
     * @private
     */
    this.quoteToDeleteName = null;

    /**
     * Objet devis pour lequel on change le statut (utilis√© pour le modal de changement de statut).
     *
     * @type {Object|null}
     * @private
     */
    this.currentQuoteForStatus = null;

    /**
     * Objet devis pour lequel on cr√©e une facture (utilis√© pour le modal de facturation).
     *
     * @type {Object|null}
     * @private
     */
    this.currentQuoteForInvoice = null;

    /**
     * Configuration de pagination pour le tableau des devis.
     * @type {Object}
     * @private
     */
    this.pagination = {
      currentPage: 1,
      itemsPerPage: 25,
      totalItems: 0,
      totalPages: 0
    };

    /**
     * Gestionnaire des op√©rations bulk (s√©lection multiple).
     *
     * @type {BulkActionsManager}
     * @private
     */
    this.bulkActions = new BulkActionsManager({
      moduleName: 'quotes',
      tableId: 'quotes-table-body',
      checkboxClass: 'quote-bulk-checkbox',
      selectAllId: 'quotes-select-all',
      bulkActionsId: 'quotes-bulk-actions',
      undoRedoManager: window.undoRedoManager,
      onDeleteCallback: this.bulkDeleteQuotes.bind(this),
      onExportCallback: this.bulkExportQuotes.bind(this)
    });
  }

  /**
   * Initialise le module Quotes.
   *
   * Workflow d'initialisation :
   * 1. R√©cup√©rer quoteItems existants depuis window ou state
   * 2. Synchroniser avec window.quoteItems pour compatibilit√©
   * 3. Attacher les event listeners (boutons, onglets, recherche)
   * 4. Exposer les fonctions au scope global (compatibilit√© legacy)
   * 5. √âmettre l'√©v√©nement 'quotes:initialized'
   *
   * @async
   * @returns {Promise&lt;void>}
   *
   * @example
   * const quotesModule = new QuotesModule(state, eventBus);
   * await quotesModule.init();
   * // ‚Üí Module initialis√©, devis charg√©s, listeners actifs
   */
  async init() {
    this.log('Initializing Quotes Module...');

    // R√©cup√©rer quoteItems depuis le state ou window pour compatibilit√©
    const existingQuoteItems = window.quoteItems || this.state.get('quoteItems') || [];
    this.quoteItems = existingQuoteItems;

    // Exposer au scope global pour compatibilit√©
    window.quoteItems = this.quoteItems;

    // Attacher les event listeners
    this.attachEventListeners();

    // Exposer les fonctions globales
    this.exposeToGlobal({
      saveQuoteManually: this.saveQuoteManually,
      showSaveQuoteModal: this.showSaveQuoteModal,
      loadSavedQuote: this.loadSavedQuote,
      proceedLoadSavedQuote: this.proceedLoadSavedQuote,
      duplicateQuote: this.duplicateQuote,
      createNewQuote: this.createNewQuote,
      loadQuotesInTab: this.loadQuotesInTab,
      showSavedQuotesModal: this.showSavedQuotesModal,
      renderQuoteRow: this.renderQuoteRow,
      renderQuoteRowForTab: this.renderQuoteRowForTab,
      deleteSavedQuote: this.deleteSavedQuote,
      askDeleteSavedQuote: this.askDeleteSavedQuote,
      askChangeQuoteStatus: this.askChangeQuoteStatus,
      confirmChangeQuoteStatus: this.confirmChangeQuoteStatus,
      askCreateInvoice: this.askCreateInvoice,
      confirmCreateInvoice: this.confirmCreateInvoice,
      printQuoteFromList: this.printQuoteFromList,
      setQuoteFieldsLocked: this.setQuoteFieldsLocked,
      refreshSavedQuotesTable: this.refreshSavedQuotesTable,
      getQuoteStatusBadge: this.getQuoteStatusBadge
    });

    // Exposer l'instance du module pour les m√©thodes de pagination
    window.quotesModule = this;

    // üÜï Enregistrer l'onglet Devis pour auto-refresh
    this.registerTabRefresh();

    // üÜï Enregistrer les commandes Command Palette (quand pr√™t)
    if (window.CommandPalette) {
      this.registerCommands();
    } else {
      // Attendre que Command Palette soit pr√™t
      this.events.on('commandpalette:ready', () => {
        this.registerCommands();
      });
    }

    // Initialiser le gestionnaire des op√©rations bulk
    this.bulkActions.initialize();

    this.log('Quotes Module initialized successfully');
    this.emitEvent('initialized');
  }

  /**
   * üÜï Enregistre l'onglet Devis pour auto-refresh automatique.
   *
   * @private
   * @returns {void}
   */
  registerTabRefresh() {
    if (!window.TabRefreshManager) {
      this.warn('TabRefreshManager not available - tab auto-refresh disabled');
      return;
    }

    // Onglet "Devis"
    window.TabRefreshManager.registerTab('quotes-tab', async (force) => {
      this.log('üîÑ Auto-refreshing Quotes...');
      await this.loadQuotesInTab();
    }, {
      ttl: 30000, // 30 secondes
      label: 'Devis'
    });

    this.log('‚úÖ Tab auto-refresh registered');
  }

  /**
   * üÜï Enregistre les commandes Command Palette pour le module Quotes.
   *
   * @private
   */
  registerCommands() {
    if (!window.CommandPalette) return;

    // Cr√©er un devis
    window.CommandPalette.registerCommand('quotes-create', {
      label: '‚ú® Cr√©er un nouveau devis',
      keywords: ['cr√©er', 'nouveau', 'devis', 'quote'],
      category: 'Devis',
      icon: '‚ú®',
      priority: 15,
      action: () => document.getElementById('new-quote-tab')?.click()
    });

    // Voir les devis
    window.CommandPalette.registerCommand('quotes-list', {
      label: 'üìã Voir tous les devis',
      keywords: ['devis', 'liste', 'quotes', 'voir', 'tous'],
      category: 'Devis',
      icon: 'üìã',
      priority: 12,
      action: () => document.getElementById('quotes-tab')?.click()
    });

    // Sauvegarder le devis en cours
    window.CommandPalette.registerCommand('quotes-save-current', {
      label: 'üíæ Sauvegarder le devis en cours',
      keywords: ['sauvegarder', 'save', 'devis', 'enregistrer'],
      category: 'Devis',
      icon: 'üíæ',
      priority: 10,
      condition: (ctx) => ctx.activeTab === 'new-quote-tab',
      action: () => window.showSaveQuoteModal?.()
    });

    this.log('‚úÖ Command Palette commands registered');
  }

  /**
   * Attache les event listeners aux boutons de gestion des devis.
   *
   * Listeners attach√©s :
   * - Bouton "Sauvegarder le devis" ‚Üí showSaveQuoteModal()
   * - Bouton "R√©cup√©rer devis" ‚Üí showSavedQuotesModal()
   * - Bouton "Vider le devis" ‚Üí window.askClearQuote()
   * - Bouton "Confirmer chargement" ‚Üí proceedLoadSavedQuote()
   * - Ouverture onglet "Devis" ‚Üí loadQuotesInTab()
   * - Champ de recherche (onglet Devis) ‚Üí loadQuotesInTab() avec filtrage
   * - Filtre de statut (onglet Devis) ‚Üí loadQuotesInTab() avec filtrage
   * - Bouton "Rafra√Æchir" (onglet Devis) ‚Üí loadQuotesInTab()
   *
   * @private
   * @returns {void}
   */
  attachEventListeners() {
    // Bouton "Sauvegarder le devis"
    this.addDOMListener('#save-quote-btn', 'click', () => {
      this.showSaveQuoteModal();
    });

    // Bouton "R√©cup√©rer devis"
    this.addDOMListener('#load-quote-btn', 'click', () => {
      this.showSavedQuotesModal();
    });

    // Bouton "Vider le devis"
    this.addDOMListener('#clear-quote-btn', 'click', () => {
      window.askClearQuote();
    });

    // Bouton "Changer le statut" (page principale)
    this.addDOMListener('#change-current-quote-status-btn', 'click', () => {
      if (window.currentQuoteId) {
        this.askChangeQuoteStatus(window.currentQuoteId);
      } else {
        NotificationSystem.warning('Aucun devis charg√©');
      }
    });

    // Bouton de confirmation de chargement de devis
    this.addDOMListener('#confirmLoadQuoteBtn', 'click', () => {
      if (this.pendingQuoteToLoad) {
        this.proceedLoadSavedQuote(this.pendingQuoteToLoad);
      }
    });

    // Bouton de confirmation de changement de statut
    this.addDOMListener('#confirmChangeStatusBtn', 'click', () => {
      this.confirmChangeQuoteStatus();
    });

    // Bouton de confirmation de suppression de devis
    this.addDOMListener('#confirmDeleteSavedQuoteBtn', 'click', () => {
      this.deleteSavedQuote();
    });

    // Bouton de confirmation de cr√©ation de facture
    this.addDOMListener('#confirmCreateInvoiceBtn', 'click', () => {
      console.log('[QuotesModule] confirmCreateInvoiceBtn clicked!');
      console.log('[QuotesModule] this:', this);
      console.log('[QuotesModule] this.confirmCreateInvoice:', this.confirmCreateInvoice);
      if (typeof this.confirmCreateInvoice === 'function') {
        this.confirmCreateInvoice();
      } else {
        console.error('[QuotesModule] confirmCreateInvoice n\'est pas une fonction!');
      }
    });

    // Bouton de confirmation de sauvegarde de devis
    this.addDOMListener('#confirmSaveQuoteBtn', 'click', () => {
      const quoteName = this.getValue('#save-quote-name');
      if (quoteName &amp;&amp; quoteName.trim()) {
        this.saveQuoteManually(quoteName.trim(), window.currentQuoteId || null);
        // Fermer le modal
        const modalElement = this.getElement('#saveQuoteModal');
        if (modalElement) {
          const modal = bootstrap.Modal.getInstance(modalElement);
          if (modal) modal.hide();
          modalElement.setAttribute('inert', '');
        }
      } else {
        NotificationSystem.error('Veuillez saisir un nom pour le devis');
      }
    });

    // Bouton de confirmation de d√©verrouillage de devis
    this.addDOMListener('#confirmUnlockQuoteBtn', 'click', () => {
      // R√©cup√©rer l'ID du devis √† d√©verrouiller (stock√© dans le modal ou variable globale)
      const quoteIdToUnlock = this.getElement('#quoteIdToUnlock')?.value || window.currentQuoteId;
      if (quoteIdToUnlock) {
        this.proceedLoadSavedQuote(quoteIdToUnlock, true); // true = forcer le d√©verrouillage
        // Fermer le modal
        const modalElement = this.getElement('#unlockQuoteModal');
        if (modalElement) {
          const modal = bootstrap.Modal.getInstance(modalElement);
          if (modal) modal.hide();
          modalElement.setAttribute('inert', '');
        }
      }
    });

    // Charger les devis quand l'onglet "Devis" est affich√©
    const quotesTab = this.getElement('#quotes-tab');
    if (quotesTab) {
      quotesTab.addEventListener('shown.bs.tab', () => {
        this.loadQuotesInTab();
      });
    }

    // Champ de recherche dans l'onglet Devis
    this.addDOMListener('#quotes-search-input', 'input', async (e) => {
      const statusFilter = this.getElement('#quotes-status-filter')?.value || '';
      await this.loadQuotesInTab(e.target.value, statusFilter);
    });

    // Filtre de statut dans l'onglet Devis
    this.addDOMListener('#quotes-status-filter', 'change', async (e) => {
      const searchText = this.getElement('#quotes-search-input')?.value || '';
      await this.loadQuotesInTab(searchText, e.target.value);
    });

    // Bouton Rafra√Æchir dans l'onglet Devis
    this.addDOMListener('#refresh-quotes-btn', 'click', async () => {
      const searchText = this.getElement('#quotes-search-input')?.value || '';
      const statusFilter = this.getElement('#quotes-status-filter')?.value || '';
      await this.loadQuotesInTab(searchText, statusFilter);
    });

    // Pagination - S√©lecteur items par page
    const itemsPerPageSelect = this.getElement('#quotes-items-per-page');
    if (itemsPerPageSelect) {
      itemsPerPageSelect.addEventListener('change', (e) => {
        this.pagination.itemsPerPage = parseInt(e.target.value);
        this.pagination.currentPage = 1; // Reset to first page
        const searchText = this.getElement('#quotes-search-input')?.value || '';
        const statusFilter = this.getElement('#quotes-status-filter')?.value || '';
        this.loadQuotesInTab(searchText, statusFilter);
      });
    }

    this.log('Event listeners attached for Quotes Module');
  }

  // ==========================================
  // QUOTE PERSISTENCE
  // ==========================================

  /**
   * Sauvegarde un devis manuellement.
   *
   * Workflow :
   * 1. Synchroniser clientInfo depuis le formulaire
   * 2. R√©cup√©rer authToken (Vendeur/Conseil autoris√©)
   * 3. Valider : nom non vide, devis non vide (‚â•1 article)
   * 4. Calculer les totaux (HT, TVA, TTC)
   * 5. Pr√©parer les donn√©es (id, name, createdAt, clientInfo, quoteItems, headerConfig, discount, totals)
   * 6. Appeler IPC 'save-quote' avec authToken + donn√©es
   * 7. Si succ√®s : notification + retour {success: true, id}
   * 8. Si √©chec : notification erreur + retour {success: false}
   *
   * Note : Si existingId fourni, le devis est mis √† jour (conserve createdAt).
   * Sinon, un nouveau devis est cr√©√© avec nouvel ID et date de cr√©ation.
   *
   * @async
   * @param {string} quoteName - Nom du devis
   * @param {string|null} [existingId=null] - ID du devis existant (pour modification)
   * @returns {Promise&lt;Object>} R√©sultat {success: boolean, id?: string}
   *
   * @example
   * const result = await quotesModule.saveQuoteManually('Devis Client ABC', null);
   * if (result.success) {
   *   console.log('Devis sauvegard√© avec ID:', result.id);
   * }
   */
  saveQuoteManually = async (quoteName, existingId = null) => {
    try {
      // Synchroniser clientInfo avec les champs du formulaire
      this.syncClientInfoFromForm();

      // Mode Vendeur/Conseil autoris√© pour sauvegarder
      const authToken = this.getAuthToken();

      // Validation
      if (!quoteName || quoteName.trim() === '') {
        NotificationSystem.error('Veuillez saisir un nom pour le devis');
        return { success: false };
      }

      if (window.quoteItems.length === 0) {
        NotificationSystem.error('Le devis est vide. Ajoutez au moins un article.');
        return { success: false };
      }

      // Calculer les totaux
      // Calculer les totaux de base
      let totals = this.calculateQuoteTotals();

      // Appliquer la remise aux totaux
      const discountPercent = parseFloat(document.getElementById('quote-discount')?.value || 0);
      if (discountPercent > 0) {
        const totalHTBeforeDiscount = totals.totalHT;
        const discountAmount = (totals.totalHT * discountPercent) / 100;
        const discountFactor = 1 - (discountPercent / 100);

        totals = {
          totalHT: parseFloat((totals.totalHT - discountAmount).toFixed(2)),
          totalTVA: parseFloat((totals.totalTVA * discountFactor).toFixed(2)),
          totalTTC: parseFloat((totals.totalHT - discountAmount + totals.totalTVA * discountFactor).toFixed(2)),
          discount: discountPercent,
          discountAmount: parseFloat(discountAmount.toFixed(2)),
          totalHTBeforeDiscount: parseFloat(totalHTBeforeDiscount.toFixed(2))
        };
      } else {
        totals.discount = 0;
        totals.discountAmount = 0;
        totals.totalHTBeforeDiscount = totals.totalHT;
      }

      // Pr√©parer les donn√©es
      const quoteData = {
        id: existingId || window.currentQuoteId || `quote_${Date.now()}`,
        name: quoteName.trim(),
        createdAt: (existingId || window.currentQuoteId)
          ? (window.currentQuoteCreatedAt || undefined)
          : new Date().toISOString(),
        clientInfo: { ...window.clientInfo },
        quoteItems: [...window.quoteItems],
        // headerConfig retir√© - doit toujours √™tre charg√© depuis la config actuelle, pas sauvegard√© avec le devis
        discount: discountPercent,
        totals: totals
      };

      const result = await this.invoke('save-quote', authToken, quoteData);

      if (!result) {
        throw new Error('Aucune r√©ponse du serveur');
      }

      if (result.success) {
        NotificationSystem.success(`Devis "${quoteName}" sauvegard√© avec succ√®s`);
        return { success: true, id: result.id };
      } else {
        throw new Error(result.message || 'Erreur lors de la sauvegarde du devis.');
      }
    } catch (error) {
      console.error('Erreur sauvegarde devis:', error);
      NotificationSystem.error(`√âchec de la sauvegarde : ${error.message}`);
      return { success: false };
    }
  };

  /**
   * Affiche le modal de sauvegarde de devis.
   *
   * Workflow :
   * 1. V√©rifier que le devis n'est pas vide (‚â•1 article)
   * 2. Si vide : notification erreur + arr√™t
   * 3. G√©n√©rer un nom sugg√©r√© :
   *    - Si devis charg√© : nom original (window.currentQuoteName)
   *    - Sinon : "Devis {Client} - {Date}" ou "Devis {Date}"
   * 4. Pr√©-remplir le champ nom dans le modal
   * 5. Afficher le modal Bootstrap
   *
   * L'utilisateur peut ensuite modifier le nom et confirmer la sauvegarde.
   *
   * @returns {void}
   *
   * @example
   * quotesModule.showSaveQuoteModal();
   * // ‚Üí Modal s'affiche avec nom sugg√©r√© "Devis Client XYZ - 15/01/2025"
   */
  showSaveQuoteModal = () => {
    // V√©rifier que le devis n'est pas vide
    if (window.quoteItems.length === 0) {
      NotificationSystem.error('Le devis est vide. Ajoutez au moins un article avant de sauvegarder.');
      return;
    }

    // Pr√©-remplir avec le nom original du devis s'il existe, sinon sugg√©rer un nouveau nom
    const suggestedName = window.currentQuoteName || (window.clientInfo.name
      ? `Devis ${window.clientInfo.name} - ${new Date().toLocaleDateString('fr-FR')}`
      : `Devis ${new Date().toLocaleDateString('fr-FR')}`);

    document.getElementById('save-quote-name').value = suggestedName;

    // Afficher le modal
    const modalElement = document.getElementById('saveQuoteModal');
    if (modalElement) modalElement.removeAttribute('inert');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
  };

  // ==========================================
  // QUOTE LISTING
  // ==========================================

  /**
   * G√©n√®re le HTML pour une ligne de devis dans le tableau du modal "Devis sauvegard√©s".
   *
   * LOGIQUE COMPLEXE DES BOUTONS :
   * - Devis factur√©/accept√© ‚Üí Lecture seule (Imprimer + Dupliquer uniquement)
   * - Devis modifiable ‚Üí Charger + Dupliquer + actions selon r√¥le
   * - Mode Vendeur ‚Üí Acc√®s limit√© (seulement brouillon ‚Üí en_attente)
   * - Mode Admin ‚Üí Acc√®s complet + bouton Facturer si accept√©
   *
   * Badges et indicateurs :
   * - Badge "R√©cent" (vert) si modifi√© dans les derni√®res 24h
   * - Badge de statut (couleur selon statut)
   * - Temps relatif ("Il y a 2h", "Il y a 3j")
   *
   * Boutons selon statut :
   * - **Factur√© ou Accept√©** : Imprimer, Dupliquer
   * - **Valid√©** : Statut (Admin), Imprimer, Dupliquer
   * - **Brouillon ou En attente** : Charger, Statut, Dupliquer
   * - **Admin uniquement** : Bouton Facturer (si accept√© et pas encore factur√©)
   * - **Tous** : Bouton Supprimer
   *
   * @param {Object} quote - Objet devis avec propri√©t√©s suivantes
   * @param {string} quote.id - ID du devis
   * @param {string} quote.name - Nom du devis
   * @param {string} quote.clientName - Nom du client
   * @param {string} quote.status - Statut du devis
   * @param {number} quote.itemsCount - Nombre d'articles
   * @param {number} quote.totalTTC - Total TTC
   * @param {string} quote.modifiedAt - Date de modification (ISO string)
   * @param {string} [quote.invoiceId] - ID de la facture associ√©e (si factur√©)
   * @returns {string} HTML de la ligne &lt;tr> avec badges de statut et boutons contextuels
   *
   * @example
   * const quote = {
   *   id: 'quote_123',
   *   name: 'Devis Client ABC',
   *   clientName: 'ABC Corp',
   *   status: 'accept√©',
   *   itemsCount: 5,
   *   totalTTC: 1500.00,
   *   modifiedAt: '2025-01-15T10:30:00Z'
   * };
   * const html = quotesModule.renderQuoteRow(quote);
   * // ‚Üí &lt;tr>...badges, boutons...&lt;/tr>
   */
  renderQuoteRow = (quote) => {
    // Badge "R√©cent" si modifi√© dans les derni√®res 24h
    const modifiedDate = new Date(quote.modifiedAt);
    const now = new Date();
    const hoursSinceModif = (now - modifiedDate) / (1000 * 60 * 60);
    const isRecent = hoursSinceModif &lt; 24;
    const recentBadge = isRecent ? '&lt;span class="badge bg-success ms-2">R√©cent&lt;/span>' : '';

    // Temps relatif
    const relativeTime = hoursSinceModif &lt; 1
      ? 'Il y a quelques minutes'
      : hoursSinceModif &lt; 24
        ? `Il y a ${Math.floor(hoursSinceModif)}h`
        : `Il y a ${Math.floor(hoursSinceModif / 24)}j`;

    const rowClass = isRecent ? 'table-success' : '';

    // Statut du devis
    const status = quote.status || 'brouillon';
    const statusBadge = window.getQuoteStatusBadge(status);
    const isInvoiced = status === 'factur√©';
    const isAccepted = status === 'accept√©';

    // Boutons d'action en fonction du statut et du mode
    let actionButtons = '';

    // Devis factur√© ou accept√© : seulement Imprimer et Dupliquer (lecture seule)
    if (isInvoiced || isAccepted) {
      actionButtons += `&lt;button class="btn btn-primary btn-icon" onclick="printQuoteFromList('${quote.id}')" data-bs-toggle="tooltip" title="Imprimer">&lt;i class="fas fa-print">&lt;/i>&lt;/button>`;
      actionButtons += `&lt;button class="btn btn-info btn-icon" onclick="duplicateQuote('${quote.id}')" data-bs-toggle="tooltip" title="Dupliquer">&lt;i class="fas fa-copy">&lt;/i>&lt;/button>`;
    } else {
      // Devis modifiable : Charger et Dupliquer
      actionButtons += `&lt;button class="btn btn-primary btn-icon" onclick="loadSavedQuote('${quote.id}')" data-bs-toggle="tooltip" title="Charger">&lt;i class="fas fa-folder-open">&lt;/i>&lt;/button>`;
      actionButtons += `&lt;button class="btn btn-info btn-icon" onclick="duplicateQuote('${quote.id}')" data-bs-toggle="tooltip" title="Dupliquer">&lt;i class="fas fa-copy">&lt;/i>&lt;/button>`;

      // Mode Vendeur : ajouter bouton "Imprimer" pour les devis "valid√©"
      if (window.isGuestMode &amp;&amp; status === 'valid√©') {
        actionButtons += `&lt;button class="btn btn-success btn-icon" onclick="printQuoteFromList('${quote.id}')" data-bs-toggle="tooltip" title="Imprimer">&lt;i class="fas fa-print">&lt;/i>&lt;/button>`;
      }

      // Bouton "Statut" :
      // - Admin : toujours visible pour les devis non factur√©s et non accept√©s
      // - Vendeur : uniquement si le devis est en "brouillon" (car ils peuvent seulement passer brouillon ‚Üí en_attente)
      if (!window.isGuestMode || status === 'brouillon') {
        actionButtons += `&lt;button class="btn btn-warning btn-icon" onclick="askChangeQuoteStatus('${quote.id}')" data-bs-toggle="tooltip" title="Changer le statut">&lt;i class="fas fa-exchange-alt">&lt;/i>&lt;/button>`;
      }
    }

    // Boutons r√©serv√©s aux admins uniquement
    if (!window.isGuestMode) {
      // Bouton "Cr√©er facture" seulement si statut = accept√© et pas d√©j√† factur√©
      const hasInvoice = this.hasValidInvoiceId(quote.invoiceId);
      if (status === 'accept√©' &amp;&amp; !hasInvoice) {
        actionButtons += `&lt;button class="btn btn-success btn-icon" onclick="askCreateInvoice('${quote.id}')" data-bs-toggle="tooltip" title="Facturer">&lt;i class="fas fa-file-invoice-dollar">&lt;/i>&lt;/button>`;
      }
    }

    actionButtons += `&lt;button class="btn btn-danger btn-icon" onclick="askDeleteSavedQuote('${quote.id}', '${this.escapeHtml(quote.name)}')" data-bs-toggle="tooltip" title="Supprimer">&lt;i class="fas fa-trash-alt">&lt;/i>&lt;/button>`;

    return `
      &lt;tr class="${rowClass}">
        &lt;td>${this.escapeHtml(quote.name)}${recentBadge}&lt;/td>
        &lt;td>${this.escapeHtml(quote.clientName)}&lt;/td>
        &lt;td>${statusBadge}&lt;/td>
        &lt;td>${quote.itemsCount}&lt;/td>
        &lt;td>${this.formatCurrency(quote.totalTTC)}&lt;/td>
        &lt;td>${this.formatDate(quote.modifiedAt)} &lt;small class="text-muted">(${relativeTime})&lt;/small>&lt;/td>
        &lt;td>
          ${actionButtons}
        &lt;/td>
      &lt;/tr>
    `;
  };

  /**
   * G√©n√®re une ligne de tableau pour l'onglet Devis.
   *
   * Identique √† renderQuoteRow() mais pour l'onglet "Devis" (au lieu du modal).
   * Affiche une colonne suppl√©mentaire : Date de cr√©ation.
   *
   * @param {Object} quote - Objet devis (voir renderQuoteRow pour d√©tails)
   * @returns {string} HTML de la ligne &lt;tr> avec badges de statut et boutons contextuels
   *
   * @see renderQuoteRow
   */
  renderQuoteRowForTab = (quote) => {
    // Badge "R√©cent" si modifi√© dans les derni√®res 24h
    const modifiedDate = new Date(quote.modifiedAt);
    const now = new Date();
    const hoursSinceModif = (now - modifiedDate) / (1000 * 60 * 60);
    const isRecent = hoursSinceModif &lt; 24;
    const recentBadge = isRecent ? '&lt;span class="badge bg-success ms-2">R√©cent&lt;/span>' : '';

    // Temps relatif
    const relativeTime = hoursSinceModif &lt; 1
      ? 'Il y a quelques minutes'
      : hoursSinceModif &lt; 24
        ? `Il y a ${Math.floor(hoursSinceModif)}h`
        : `Il y a ${Math.floor(hoursSinceModif / 24)}j`;

    const rowClass = isRecent ? 'table-success' : '';

    // Statut du devis
    const status = quote.status || 'brouillon';
    const statusBadge = window.getQuoteStatusBadge(status);
    const isInvoiced = status === 'factur√©';

    // Boutons d'action en fonction du statut et du mode
    let actionButtons = '';

    if (isInvoiced || status === 'accept√©') {
      // Factur√© ou Accept√© : IMPRIMER + DUPLIQUER + SUPPRIMER
      actionButtons += `&lt;button class="btn btn-primary btn-icon" onclick="printQuoteFromList('${quote.id}')" data-bs-toggle="tooltip" title="Imprimer">&lt;i class="fas fa-print">&lt;/i>&lt;/button>`;
      actionButtons += `&lt;button class="btn btn-info btn-icon" onclick="duplicateQuote('${quote.id}')" data-bs-toggle="tooltip" title="Dupliquer">&lt;i class="fas fa-copy">&lt;/i>&lt;/button>`;
    } else if (status === 'valid√©') {
      // Valid√© : STATUT (admin only) + IMPRIMER + DUPLIQUER + SUPPRIMER (non-modifiable)
      if (!window.isGuestMode) {
        actionButtons += `&lt;button class="btn btn-warning btn-icon" onclick="askChangeQuoteStatus('${quote.id}')" data-bs-toggle="tooltip" title="Changer le statut">&lt;i class="fas fa-exchange-alt">&lt;/i>&lt;/button>`;
      }
      actionButtons += `&lt;button class="btn btn-primary btn-icon" onclick="printQuoteFromList('${quote.id}')" data-bs-toggle="tooltip" title="Imprimer">&lt;i class="fas fa-print">&lt;/i>&lt;/button>`;
      actionButtons += `&lt;button class="btn btn-info btn-icon" onclick="duplicateQuote('${quote.id}')" data-bs-toggle="tooltip" title="Dupliquer">&lt;i class="fas fa-copy">&lt;/i>&lt;/button>`;
    } else {
      // Brouillon ou En attente : MODIFIER + STATUT + DUPLIQUER + SUPPRIMER
      actionButtons += `&lt;button class="btn btn-primary btn-icon" onclick="loadSavedQuote('${quote.id}')" data-bs-toggle="tooltip" title="Modifier">&lt;i class="fas fa-edit">&lt;/i>&lt;/button>`;
      if (!window.isGuestMode || status === 'brouillon') {
        actionButtons += `&lt;button class="btn btn-warning btn-icon" onclick="askChangeQuoteStatus('${quote.id}')" data-bs-toggle="tooltip" title="Changer le statut">&lt;i class="fas fa-exchange-alt">&lt;/i>&lt;/button>`;
      }
      actionButtons += `&lt;button class="btn btn-info btn-icon" onclick="duplicateQuote('${quote.id}')" data-bs-toggle="tooltip" title="Dupliquer">&lt;i class="fas fa-copy">&lt;/i>&lt;/button>`;
    }

    // Boutons r√©serv√©s aux admins uniquement
    if (!window.isGuestMode) {
      const hasInvoice = this.hasValidInvoiceId(quote.invoiceId);
      if (status === 'accept√©' &amp;&amp; !hasInvoice) {
        actionButtons += `&lt;button class="btn btn-success btn-icon" onclick="askCreateInvoice('${quote.id}')" data-bs-toggle="tooltip" title="Facturer">&lt;i class="fas fa-file-invoice-dollar">&lt;/i>&lt;/button>`;
      }
    }

    actionButtons += `&lt;button class="btn btn-danger btn-icon" onclick="askDeleteSavedQuote('${quote.id}', '${this.escapeHtml(quote.name)}')" data-bs-toggle="tooltip" title="Supprimer">&lt;i class="fas fa-trash-alt">&lt;/i>&lt;/button>`;

    return `
      &lt;tr class="${rowClass}">
        &lt;td>
          &lt;input type="checkbox" class="form-check-input quote-bulk-checkbox" data-id="${quote.id}">
        &lt;/td>
        &lt;td>${this.escapeHtml(quote.name)}${recentBadge}&lt;/td>
        &lt;td>${this.escapeHtml(quote.clientName)}&lt;/td>
        &lt;td>${statusBadge}&lt;/td>
        &lt;td>${quote.itemsCount}&lt;/td>
        &lt;td>${this.formatCurrency(quote.totalTTC)}&lt;/td>
        &lt;td>${this.formatDate(quote.createdAt)}&lt;/td>
        &lt;td>${this.formatDate(quote.modifiedAt)} &lt;small class="text-muted">(${relativeTime})&lt;/small>&lt;/td>
        &lt;td>
          ${actionButtons}
        &lt;/td>
      &lt;/tr>
    `;
  };

  /**
   * Charge les devis dans l'onglet Devis avec filtrage optionnel.
   *
   * Workflow :
   * 1. Appeler IPC 'list-saved-quotes' pour r√©cup√©rer tous les devis
   * 2. Appliquer filtres de recherche (nom ou client, insensible √† la casse)
   * 3. Appliquer filtre de statut (exact)
   * 4. Si aucun devis : afficher message "Aucun devis trouv√©"
   * 5. Sinon : g√©n√©rer HTML avec renderQuoteRowForTab() pour chaque devis
   * 6. Injecter dans le tbody de la table
   *
   * @async
   * @param {string} [searchText=''] - Texte de recherche (nom ou client)
   * @param {string} [statusFilter=''] - Filtre de statut ('brouillon', 'en_attente', etc.)
   * @returns {Promise&lt;void>}
   *
   * @example
   * // Charger tous les devis
   * await quotesModule.loadQuotesInTab();
   *
   * @example
   * // Charger uniquement les devis en attente contenant "ABC"
   * await quotesModule.loadQuotesInTab('ABC', 'en_attente');
   */
  loadQuotesInTab = async (searchText = '', statusFilter = '') => {
    try {
      const result = await this.invoke('list-saved-quotes');

      if (!result.success) {
        NotificationSystem.error('Erreur lors du chargement des devis');
        return;
      }

      let quotes = result.quotes || [];
      this.allQuotes = quotes; // Sauvegarder tous les devis pour le comptage
      const tableBody = document.getElementById('quotes-table-body');

      console.log(`[DEBUG loadQuotesInTab] isGuestMode = ${window.isGuestMode}, Nombre de devis = ${quotes.length}`);

      // Appliquer les filtres
      if (searchText) {
        const search = searchText.toLowerCase();
        quotes = quotes.filter(q =>
          (q.name &amp;&amp; q.name.toLowerCase().includes(search)) ||
          (q.clientName &amp;&amp; q.clientName.toLowerCase().includes(search))
        );
      }

      if (statusFilter) {
        quotes = quotes.filter(q => (q.status || 'brouillon') === statusFilter);
      }

      // Mettre √† jour les infos de pagination
      this.pagination.totalItems = quotes.length;
      this.pagination.totalPages = Math.ceil(quotes.length / this.pagination.itemsPerPage);

      // S'assurer que currentPage est dans les limites
      if (this.pagination.currentPage > this.pagination.totalPages) {
        this.pagination.currentPage = this.pagination.totalPages || 1;
      }

      // Calculer les indices de d√©but et fin pour la page actuelle
      const startIndex = (this.pagination.currentPage - 1) * this.pagination.itemsPerPage;
      const endIndex = startIndex + this.pagination.itemsPerPage;
      const paginatedQuotes = quotes.slice(startIndex, endIndex);

      if (quotes.length === 0) {
        tableBody.innerHTML = '&lt;tr>&lt;td colspan="9" class="text-center">Aucun devis trouv√©&lt;/td>&lt;/tr>';
      } else {
        tableBody.innerHTML = paginatedQuotes.map(this.renderQuoteRowForTab).join('');
      }

      console.log(`‚úÖ [DEBUG] Populated table with ${paginatedQuotes.length}/${quotes.length} devis (page ${this.pagination.currentPage}/${this.pagination.totalPages})`);

      // Mettre √† jour les compteurs dans le filtre de statut
      this.updateStatusFilterCounts();

      // Mettre √† jour les contr√¥les de pagination
      this.updatePaginationControls(quotes.length, paginatedQuotes);
    } catch (error) {
      console.error('Erreur chargement devis:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  /**
   * Met √† jour les compteurs dans le menu d√©roulant de filtrage par statut.
   * Compte le nombre de devis pour chaque statut et met √† jour les labels des options.
   */
  updateStatusFilterCounts() {
    if (!this.allQuotes) return;

    // Compter les devis par statut
    const counts = {
      'brouillon': 0,
      'en_attente': 0,
      'valid√©': 0,
      'accept√©': 0,
      'factur√©': 0,
      'refus√©': 0
    };

    this.allQuotes.forEach(quote => {
      const status = quote.status || 'brouillon';
      if (counts[status] !== undefined) {
        counts[status]++;
      }
    });

    // Mettre √† jour les labels des options
    const filterSelect = document.getElementById('quotes-status-filter');
    if (filterSelect) {
      const options = filterSelect.querySelectorAll('option');
      options.forEach(option => {
        const value = option.value;
        if (value === '') {
          const total = Object.values(counts).reduce((sum, count) => sum + count, 0);
          option.textContent = `Tous les statuts (${total})`;
        } else if (counts[value] !== undefined) {
          const label = option.textContent.split('(')[0].trim();
          option.textContent = `${label} (${counts[value]})`;
        }
      });
    }
  }

  /**
   * Affiche le modal de gestion des devis sauvegard√©s.
   *
   * Workflow :
   * 1. Appeler IPC 'list-saved-quotes' pour r√©cup√©rer tous les devis
   * 2. Si aucun devis : afficher message "Aucun devis sauvegard√©"
   * 3. Sinon : g√©n√©rer HTML avec renderQuoteRow() pour chaque devis
   * 4. Injecter dans le tbody de la table
   * 5. Afficher le modal Bootstrap
   *
   * @async
   * @returns {Promise&lt;void>}
   *
   * @example
   * await quotesModule.showSavedQuotesModal();
   * // ‚Üí Modal s'affiche avec la liste de tous les devis
   */
  showSavedQuotesModal = async () => {
    try {
      const result = await this.invoke('list-saved-quotes');

      if (!result.success) {
        NotificationSystem.error('Erreur lors du chargement des devis');
        return;
      }

      const quotes = result.quotes || [];
      const tableBody = document.getElementById('saved-quotes-table-body');

      console.log(`[DEBUG showSavedQuotesModal] isGuestMode = ${window.isGuestMode}, Nombre de devis = ${quotes.length}`);

      if (quotes.length === 0) {
        tableBody.innerHTML = '&lt;tr>&lt;td colspan="7" class="text-center">Aucun devis sauvegard√©&lt;/td>&lt;/tr>';
      } else {
        tableBody.innerHTML = quotes.map(this.renderQuoteRow).join('');
      }

      // Afficher le modal
      const modalElement = document.getElementById('savedQuotesModal');
      if (modalElement) modalElement.removeAttribute('inert');
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    } catch (error) {
      console.error('Erreur affichage devis:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  /**
   * Rafra√Æchit uniquement le tableau des devis du modal sans fermer/rouvrir le modal.
   *
   * Utilis√© apr√®s une modification (suppression, changement de statut, cr√©ation de facture)
   * pour mettre √† jour la liste sans perturber l'utilisateur.
   *
   * Workflow :
   * 1. Appeler IPC 'list-saved-quotes'
   * 2. R√©g√©n√©rer le HTML de la table
   * 3. Injecter dans le tbody (le modal reste ouvert)
   *
   * @async
   * @returns {Promise&lt;void>}
   */
  refreshSavedQuotesTable = async () => {
    try {
      const result = await this.invoke('list-saved-quotes');

      if (!result.success) {
        NotificationSystem.error('Erreur lors du chargement des devis');
        return;
      }

      const quotes = result.quotes || [];
      const tableBody = document.getElementById('saved-quotes-table-body');

      console.log(`[DEBUG refreshSavedQuotesTable] isGuestMode = ${window.isGuestMode}, Nombre de devis = ${quotes.length}`);

      if (quotes.length === 0) {
        tableBody.innerHTML = '&lt;tr>&lt;td colspan="7" class="text-center">Aucun devis sauvegard√©&lt;/td>&lt;/tr>';
      } else {
        tableBody.innerHTML = quotes.map(this.renderQuoteRow).join('');
      }
    } catch (error) {
      console.error('Erreur rafra√Æchissement tableau:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  // ==========================================
  // QUOTE LOADING
  // ==========================================

  /**
   * Charge un devis sauvegard√© (avec confirmation si devis en cours).
   *
   * Workflow :
   * 1. V√©rifier si un devis est en cours (window.quoteItems.length > 0)
   * 2. Si oui : stocker quoteId dans this.pendingQuoteToLoad
   * 3. Afficher modal de confirmation "√âcraser le devis en cours ?"
   * 4. Si non : appeler directement proceedLoadSavedQuote()
   *
   * L'utilisateur peut ensuite confirmer (‚Üí proceedLoadSavedQuote) ou annuler.
   *
   * @async
   * @param {string} quoteId - ID du devis √† charger
   * @returns {Promise&lt;void>}
   *
   * @example
   * await quotesModule.loadSavedQuote('quote_123');
   * // ‚Üí Modal de confirmation si devis en cours, sinon chargement direct
   */
  loadSavedQuote = async (quoteId) => {
    try {
      // V√©rifier si le devis actuel a des modifications non sauvegard√©es
      if (window.quoteItems.length > 0) {
        // Stocker l'ID du devis √† charger
        this.pendingQuoteToLoad = quoteId;

        // Afficher le modal de confirmation
        const confirmModalElement = document.getElementById('loadQuoteConfirmModal');
        if (confirmModalElement) confirmModalElement.removeAttribute('inert');
        const confirmModal = new bootstrap.Modal(confirmModalElement);
        confirmModal.show();
        return;
      }

      // Si pas de devis en cours, charger directement
      await this.proceedLoadSavedQuote(quoteId);
    } catch (error) {
      console.error('Erreur chargement devis:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  /**
   * Proc√®de au chargement effectif du devis (apr√®s confirmation ou directement).
   *
   * Workflow :
   * 1. Appeler IPC 'load-saved-quote' avec quoteId
   * 2. V√©rifier : si statut = factur√© ‚Üí refus + notification (lecture seule)
   * 3. Stocker ID, nom, date cr√©ation, statut dans window.*
   * 4. Restaurer clientInfo, quoteItems depuis le devis
   * 5. Mettre √† jour la date du devis ‚Üí aujourd'hui
   * 6. Remplir tous les champs du formulaire client
   * 7. Restaurer la remise si elle existe
   * 8. Rafra√Æchir le tableau des articles (window.updateQuoteTable)
   * 9. Fermer les modals (confirmation + liste)
   * 10. Afficher bouton "Changer le statut"
   * 11. Si statut = accept√© : verrouiller les champs (setQuoteFieldsLocked)
   * 12. Notification de succ√®s ou avertissement (si accept√©)
   * 13. R√©initialiser this.pendingQuoteToLoad
   *
   * @async
   * @param {string} quoteId - ID du devis √† charger
   * @returns {Promise&lt;void>}
   *
   * @example
   * await quotesModule.proceedLoadSavedQuote('quote_123');
   * // ‚Üí Devis charg√©, formulaire rempli, tableau rafra√Æchi
   */
  proceedLoadSavedQuote = async (quoteId) => {
    try {
      const result = await this.invoke('load-saved-quote', quoteId);

      if (!result.success) {
        NotificationSystem.error('Erreur lors du chargement du devis');
        return;
      }

      const quote = result.quote;

      // Bloquer le chargement des devis factur√©s (lecture seule)
      if (quote.status === 'factur√©') {
        NotificationSystem.warning('Ce devis est factur√© et ne peut plus √™tre modifi√©. Utilisez "Imprimer" ou "Dupliquer".');
        return;
      }

      // Stocker l'ID, le nom, la date de cr√©ation et le statut du devis
      window.currentQuoteId = quote.id;
      window.currentQuoteName = quote.name;
      window.currentQuoteCreatedAt = quote.createdAt;
      window.currentQuoteStatus = quote.status || 'brouillon';

      // Restaurer les donn√©es
      window.clientInfo = { ...quote.clientInfo };
      window.quoteItems = [...quote.quoteItems];

      // Mettre √† jour la date √† aujourd'hui
      const today = new Date().toISOString().split('T')[0];
      window.clientInfo.quoteDate = today;

      // Remplir les champs du formulaire
      document.getElementById('client-name').value = window.clientInfo.name || '';
      document.getElementById('client-phone').value = window.clientInfo.phone || '';
      document.getElementById('client-email').value = window.clientInfo.email || '';
      document.getElementById('client-address').value = window.clientInfo.address || '';
      document.getElementById('quote-issuer').value = window.clientInfo.issuer || '';
      document.getElementById('quote-date').value = today;

      // Restaurer la remise (0 si non d√©finie)
      const discountSelect = document.getElementById('quote-discount');
      if (discountSelect) {
        discountSelect.value = quote.discount !== undefined ? quote.discount : 0;
      }

      // Mettre √† jour l'affichage
      if (typeof window.updateQuoteTable === 'function') {
        window.updateQuoteTable();
      }

      // Fermer les modals
      const confirmModalElement = document.getElementById('loadQuoteConfirmModal');
      const confirmModal = bootstrap.Modal.getInstance(confirmModalElement);
      if (confirmModal) {
        confirmModal.hide();
        if (confirmModalElement) confirmModalElement.setAttribute('inert', '');
      }

      const modalElement = document.getElementById('savedQuotesModal');
      const modal = bootstrap.Modal.getInstance(modalElement);
      if (modal) modal.hide();
      if (modalElement) modalElement.setAttribute('inert', '');

      // Afficher le bouton "Changer le statut" car un devis est maintenant charg√©
      const changeStatusBtn = document.getElementById('change-current-quote-status-btn');
      if (changeStatusBtn) changeStatusBtn.style.display = 'inline-block';

      // Si le devis est accept√©, bloquer les champs et afficher un message
      if (window.currentQuoteStatus === 'accept√©') {
        this.setQuoteFieldsLocked(true);
        NotificationSystem.warning(`Devis "${quote.name}" charg√© (SIGN√â - lecture seule). Utilisez le bouton rouge pour d√©verrouiller.`);
      } else {
        this.setQuoteFieldsLocked(false);
        NotificationSystem.success(`Devis "${quote.name}" charg√© avec succ√®s`);
      }

      // R√©initialiser la variable
      this.pendingQuoteToLoad = null;
    } catch (error) {
      console.error('Erreur chargement devis:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
      this.pendingQuoteToLoad = null;
    }
  };

  // ==========================================
  // QUOTE DUPLICATION
  // ==========================================

  /**
   * Duplique un devis existant.
   *
   * Workflow :
   * 1. R√©cup√©rer authToken (Vendeur/Conseil autoris√©)
   * 2. Charger le devis √† dupliquer via IPC 'load-saved-quote'
   * 3. Cr√©er une copie avec nouveau nom : "{nom original} - Copie"
   * 4. Recalculer les totaux si manquants
   * 5. Sauvegarder la copie via IPC 'save-quote' (nouveau ID, nouvelle date)
   * 6. Si succ√®s : notification + rafra√Æchir les listes (modal + onglet)
   *
   * Note : Toutes les donn√©es sont copi√©es (clientInfo, quoteItems, totals, headerConfig)
   * sauf l'ID et les dates qui sont r√©g√©n√©r√©s.
   *
   * @async
   * @param {string} quoteId - ID du devis √† dupliquer
   * @returns {Promise&lt;void>}
   *
   * @example
   * await quotesModule.duplicateQuote('quote_123');
   * // ‚Üí Nouveau devis cr√©√© "Devis Client ABC - Copie"
   */
  duplicateQuote = async (quoteId) => {
    try {
      // Mode Vendeur/Conseil autoris√© pour dupliquer
      const authToken = this.getAuthToken();

      // Charger le devis √† dupliquer
      const result = await this.invoke('load-saved-quote', quoteId);

      if (!result.success) {
        NotificationSystem.error('Erreur lors du chargement du devis');
        return;
      }

      const originalQuote = result.quote;

      // Cr√©er une copie avec nouveau nom
      const newQuoteName = `${originalQuote.name} - Copie`;

      // Recalculer les totaux si manquants
      let totals = originalQuote.totals;
      if (!totals &amp;&amp; originalQuote.quoteItems &amp;&amp; originalQuote.quoteItems.length > 0) {
        const totalHT = originalQuote.quoteItems.reduce((sum, item) => sum + (parseFloat(item.priceHT) || 0), 0);
        const totalTVA = originalQuote.quoteItems.reduce((sum, item) => sum + (parseFloat(item.tva) || 0), 0);
        const totalTTC = originalQuote.quoteItems.reduce((sum, item) => sum + (parseFloat(item.priceTTC) || 0), 0);
        totals = { totalHT, totalTVA, totalTTC };
      }

      // Sauvegarder la copie (inclure totals et headerConfig)
      const savePayload = {
        name: newQuoteName,
        clientInfo: { ...originalQuote.clientInfo },
        quoteItems: [...originalQuote.quoteItems],
        totals: totals
        // headerConfig retir√© - doit toujours √™tre charg√© depuis la config actuelle
      };

      const saveResult = await this.invoke('save-quote', authToken, savePayload);

      if (saveResult.success) {
        NotificationSystem.success(`Devis dupliqu√© : "${newQuoteName}"`);
        // Rafra√Æchir la liste du modal
        await this.refreshSavedQuotesTable();

        // Rafra√Æchir aussi l'onglet Devis si on est dessus
        if (document.getElementById('quotes-tab').classList.contains('active')) {
          await this.loadQuotesInTab();
        }
      } else {
        NotificationSystem.error('Erreur lors de la duplication');
      }

    } catch (error) {
      console.error('Erreur duplication devis:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  // ==========================================
  // CREATE NEW QUOTE
  // ==========================================

  /**
   * Cr√©e un nouveau devis vierge.
   *
   * Workflow :
   * 1. Vider window.quoteItems (tableau d'articles)
   * 2. R√©initialiser window.clientInfo (nom, t√©l√©phone, email, adresse, √©metteur vides)
   * 3. D√©finir la date du devis ‚Üí aujourd'hui
   * 4. R√©initialiser le formulaire client (form.reset())
   * 5. D√©finir la date dans l'input date
   * 6. Rafra√Æchir le tableau des articles (window.updateQuoteTable)
   * 7. Notification info "Nouveau devis cr√©√©"
   *
   * @returns {void}
   *
   * @example
   * quotesModule.createNewQuote();
   * // ‚Üí Nouveau devis vierge, pr√™t √† √™tre rempli
   */
  createNewQuote = () => {
    try {
      console.log('[createNewQuote] Cr√©ation d\'un nouveau devis');

      // R√©initialiser les donn√©es
      window.quoteItems = [];
      window.clientInfo = {
        name: '',
        phone: '',
        email: '',
        address: '',
        quoteDate: new Date().toISOString().split('T')[0],
        issuer: ''
      };

      // R√©initialiser le formulaire
      const form = document.getElementById('client-form');
      if (form) {
        form.reset();
        // D√©finir la date du jour
        const dateInput = form.querySelector('input[type="date"]');
        if (dateInput) {
          dateInput.value = window.clientInfo.quoteDate;
        }
      }

      // Rafra√Æchir le tableau
      if (typeof window.updateQuoteTable === 'function') {
        window.updateQuoteTable();
      }

      NotificationSystem.info('Nouveau devis cr√©√©');
      console.log('[createNewQuote] Devis vierge initialis√©');

    } catch (error) {
      console.error('[createNewQuote] Erreur:', error);
      NotificationSystem.error('Erreur lors de la cr√©ation du devis');
    }
  };

  // ==========================================
  // QUOTE DELETION
  // ==========================================

  /**
   * Demande confirmation avant suppression d'un devis.
   *
   * Workflow :
   * 1. Stocker quoteId dans this.quoteToDeleteId
   * 2. Stocker quoteName dans this.quoteToDeleteName
   * 3. Mettre √† jour le texte du modal avec le nom du devis
   * 4. Afficher le modal Bootstrap de confirmation
   *
   * L'utilisateur peut ensuite confirmer (‚Üí deleteSavedQuote) ou annuler.
   *
   * @param {string} quoteId - ID du devis √† supprimer
   * @param {string} quoteName - Nom du devis (pour affichage dans le modal)
   * @returns {void}
   *
   * @example
   * quotesModule.askDeleteSavedQuote('quote_123', 'Devis Client ABC');
   * // ‚Üí Modal de confirmation s'affiche : "Supprimer 'Devis Client ABC' ?"
   */
  askDeleteSavedQuote = (quoteId, quoteName) => {
    this.quoteToDeleteId = quoteId;
    this.quoteToDeleteName = quoteName;

    document.getElementById('delete-quote-name').textContent = quoteName;

    const modalElement = document.getElementById('deleteSavedQuoteModal');
    if (modalElement) modalElement.removeAttribute('inert');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
  };

  /**
   * Supprime un devis sauvegard√© apr√®s confirmation.
   *
   * Workflow :
   * 1. R√©cup√©rer authToken (Vendeur/Conseil autoris√©)
   * 2. V√©rifier que this.quoteToDeleteId est d√©fini
   * 3. Appeler IPC 'delete-saved-quote' avec authToken + quoteId
   * 4. Si succ√®s :
   *    - Notification de succ√®s
   *    - D√©placer le focus vers le modal de liste (pour accessibilit√©)
   *    - Fermer le modal de confirmation
   *    - Attendre 300ms
   *    - Rafra√Æchir uniquement le tableau (refreshSavedQuotesTable)
   *    - Rafra√Æchir aussi l'onglet Devis si actif
   * 5. R√©initialiser this.quoteToDeleteId et this.quoteToDeleteName
   *
   * @async
   * @returns {Promise&lt;void>}
   *
   * @example
   * // Utilisateur confirme la suppression
   * await quotesModule.deleteSavedQuote();
   * // ‚Üí Devis supprim√©, listes rafra√Æchies, modal de confirmation ferm√©
   */
  deleteSavedQuote = async () => {
    try {
      // Mode Vendeur/Conseil autoris√© pour supprimer
      const authToken = this.getAuthToken();

      if (!this.quoteToDeleteId) return;

      const result = await this.invoke('delete-saved-quote', authToken, this.quoteToDeleteId);

      if (result.success) {
        NotificationSystem.success(`Devis "${this.quoteToDeleteName}" supprim√©`);

        // Fermer le modal de confirmation
        const deleteModalElement = document.getElementById('deleteSavedQuoteModal');
        const deleteModal = bootstrap.Modal.getInstance(deleteModalElement);

        // D√©placer le focus vers le modal de liste AVANT de fermer
        const savedQuotesModalElement = document.getElementById('savedQuotesModal');
        if (savedQuotesModalElement) {
          // Trouver un √©l√©ment focusable dans le modal de liste
          const closeButton = savedQuotesModalElement.querySelector('.btn-close');
          if (closeButton) closeButton.focus();
        }

        if (deleteModal) deleteModal.hide();
        if (deleteModalElement) deleteModalElement.setAttribute('inert', '');

        // Attendre un court d√©lai pour s'assurer que le modal est ferm√©
        setTimeout(async () => {
          // Rafra√Æchir uniquement le tableau sans fermer/rouvrir le modal de liste
          await this.refreshSavedQuotesTable();

          // Rafra√Æchir aussi l'onglet Devis si on est dessus
          if (document.getElementById('quotes-tab').classList.contains('active')) {
            await this.loadQuotesInTab();
          }
        }, 300);
      } else {
        NotificationSystem.error('Erreur lors de la suppression');
      }

      this.quoteToDeleteId = null;
      this.quoteToDeleteName = null;
    } catch (error) {
      console.error('Erreur suppression devis:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  // ==========================================
  // QUOTE STATUS MANAGEMENT
  // ==========================================

  /**
   * Demande le changement de statut d'un devis.
   *
   * Workflow :
   * 1. R√©cup√©rer authToken (Vendeur/Conseil autoris√© pour brouillon ‚Üí en_attente uniquement)
   * 2. Charger le devis via IPC 'load-saved-quote' pour obtenir le statut actuel
   * 3. Stocker le devis dans this.currentQuoteForStatus
   * 4. Remplir le modal :
   *    - Nom du devis
   *    - Statut actuel (badge format√©)
   *    - Select de nouveau statut
   * 5. **Gestion des permissions** :
   *    - **Vendeur** : pr√©-s√©lectionner "en_attente", d√©sactiver toutes les autres options
   *    - **Admin** : pr√©-s√©lectionner statut actuel, d√©sactiver les transitions non autoris√©es
   * 6. Si statut actuel = accept√© : afficher champ date de signature
   * 7. Afficher le modal Bootstrap
   *
   * Transitions autoris√©es (voir canTransitionTo) :
   * - brouillon ‚Üí en_attente, refus√©
   * - en_attente ‚Üí valid√©, refus√©
   * - valid√© ‚Üí accept√©, refus√©
   * - accept√© ‚Üí factur√©
   *
   * @async
   * @param {string} quoteId - ID du devis dont on veut changer le statut
   * @returns {Promise&lt;void>}
   *
   * @example
   * await quotesModule.askChangeQuoteStatus('quote_123');
   * // ‚Üí Modal s'affiche avec select de statut (permissions appliqu√©es)
   */
  askChangeQuoteStatus = async (quoteId) => {
    try {
      const authToken = this.getAuthToken();
      // Mode Vendeur/Conseil autoris√© pour passage en "en_attente" uniquement

      // Charger le devis pour obtenir ses informations
      const result = await this.invoke('load-saved-quote', quoteId);

      if (!result.success) {
        NotificationSystem.error('Erreur lors du chargement du devis');
        return;
      }

      const quote = result.quote;
      this.currentQuoteForStatus = quote;

      // Remplir le modal
      document.getElementById('status-quote-name').textContent = quote.name;
      document.getElementById('status-current').textContent = window.getQuoteStatusBadge(quote.status || 'brouillon').replace(/&lt;[^>]*>/g, '');

      const statusSelect = document.getElementById('new-status-select');
      const currentStatus = quote.status || 'brouillon';

      // En mode Vendeur : pr√©-s√©lectionner "en_attente" directement
      // En mode Admin : pr√©-s√©lectionner le statut actuel
      if (window.isGuestMode &amp;&amp; currentStatus === 'brouillon') {
        statusSelect.value = 'en_attente';
      } else {
        statusSelect.value = currentStatus;
      }

      // D√©sactiver les options de statut non autoris√©es
      Array.from(statusSelect.options).forEach(option => {
        const targetStatus = option.value;

        // En mode Vendeur/Conseil : seule transition "brouillon" ‚Üí "en_attente" autoris√©e
        if (window.isGuestMode) {
          // Autoriser uniquement: brouillon ‚Üí en_attente (pas de "garder le m√™me statut")
          const isAllowedTransition = (currentStatus === 'brouillon' &amp;&amp; targetStatus === 'en_attente');

          if (!isAllowedTransition) {
            option.disabled = true;
            option.style.color = '#ccc';
          } else {
            option.disabled = false;
            option.style.color = '';
          }
        } else {
          // En mode Admin : v√©rifier les transitions normales
          if (!this.canTransitionTo(currentStatus, targetStatus) &amp;&amp; targetStatus !== currentStatus) {
            option.disabled = true;
            option.style.color = '#ccc';
          } else {
            option.disabled = false;
            option.style.color = '';
          }
        }
      });

      // Afficher/masquer le champ date de signature
      const signatureDateContainer = document.getElementById('signature-date-container');
      if (quote.status === 'accept√©') {
        signatureDateContainer.style.display = 'block';
        document.getElementById('signature-date-input').value = quote.signatureDate ? new Date(quote.signatureDate).toISOString().split('T')[0] : '';
      } else {
        signatureDateContainer.style.display = 'none';
      }

      // Afficher le modal
      const modalElement = document.getElementById('changeQuoteStatusModal');
      if (modalElement) modalElement.removeAttribute('inert');
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    } catch (error) {
      console.error('Erreur ouverture modal statut:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  /**
   * Confirme le changement de statut d'un devis.
   *
   * Workflow :
   * 1. R√©cup√©rer authToken
   * 2. V√©rifier que this.currentQuoteForStatus est d√©fini
   * 3. R√©cup√©rer le nouveau statut depuis le select
   * 4. **Validation des permissions Vendeur** :
   *    - Si mode Vendeur : v√©rifier statut actuel = brouillon ET nouveau statut = en_attente
   *    - Sinon : erreur + arr√™t
   * 5. Pr√©parer les donn√©es additionnelles :
   *    - Si nouveau statut = accept√© : inclure date de signature
   * 6. Appeler IPC 'update-quote-status' avec authToken + {quoteId, status, additionalData}
   * 7. Si succ√®s :
   *    - Notification de succ√®s
   *    - Fermer le modal
   *    - Attendre 300ms
   *    - Rafra√Æchir les listes (modal + onglet)
   *    - Mettre √† jour dashboard vendeur si mode Vendeur (window.updateVendeurPendingQuotes)
   * 8. R√©initialiser this.currentQuoteForStatus
   *
   * @async
   * @returns {Promise&lt;void>}
   *
   * @example
   * // Utilisateur confirme le changement de statut
   * await quotesModule.confirmChangeQuoteStatus();
   * // ‚Üí Statut mis √† jour, listes rafra√Æchies
   */
  confirmChangeQuoteStatus = async () => {
    try {
      const authToken = this.getAuthToken();

      if (!this.currentQuoteForStatus) return;

      const newStatus = document.getElementById('new-status-select').value;
      const currentStatus = this.currentQuoteForStatus.status || 'brouillon';

      // En mode Vendeur/Conseil : autoriser uniquement "brouillon" ‚Üí "en_attente"
      if (window.isGuestMode) {
        console.log('[DEBUG] Mode Vendeur - Statut actuel:', currentStatus, '- Nouveau statut:', newStatus);
        if (currentStatus !== 'brouillon') {
          NotificationSystem.error('En mode Vendeur/Conseil, vous ne pouvez modifier que les devis en brouillon');
          console.error('[DEBUG] Rejet: statut actuel n\'est pas brouillon');
          return;
        }
        if (newStatus !== 'en_attente') {
          NotificationSystem.error('En mode Vendeur/Conseil, vous ne pouvez passer les devis qu\'en statut "en attente"');
          console.error('[DEBUG] Rejet: nouveau statut n\'est pas en_attente');
          return;
        }
      }

      const additionalData = {};

      // Si statut = accept√©, inclure la date de signature
      if (newStatus === 'accept√©') {
        const signatureDate = document.getElementById('signature-date-input').value;
        if (signatureDate) {
          additionalData.signatureDate = new Date(signatureDate).toISOString();
        }
      }

      // Appeler l'IPC pour changer le statut
      const payload = {
        quoteId: this.currentQuoteForStatus.id,
        status: newStatus,
        additionalData
      };
      console.log('[DEBUG] Appel update-quote-status avec:', { authToken, payload });

      const result = await this.invoke('update-quote-status', authToken, payload);

      console.log('[DEBUG] R√©sultat update-quote-status:', result);

      if (result.success) {
        NotificationSystem.success(`Statut mis √† jour : ${newStatus}`);

        // Fermer le modal
        const modalElement = document.getElementById('changeQuoteStatusModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) modal.hide();
        if (modalElement) modalElement.setAttribute('inert', '');

        // Rafra√Æchir la liste
        setTimeout(async () => {
          await this.refreshSavedQuotesTable();

          // Rafra√Æchir aussi l'onglet Devis si on est dessus
          if (document.getElementById('quotes-tab').classList.contains('active')) {
            await this.loadQuotesInTab();
          }

          // Mettre √† jour le dashboard vendeur si n√©cessaire
          if (window.isGuestMode &amp;&amp; typeof window.updateVendeurPendingQuotes === 'function') {
            await window.updateVendeurPendingQuotes();
          }
        }, 300);
      } else {
        console.error('[DEBUG] √âchec update-quote-status. R√©sultat:', result);
        NotificationSystem.error(`Erreur lors de la mise √† jour du statut${result.error ? ': ' + result.error : ''}`);
      }

      this.currentQuoteForStatus = null;
    } catch (error) {
      console.error('Erreur changement statut:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  // ==========================================
  // QUOTE TO INVOICE CONVERSION
  // ==========================================

  /**
   * Demande la cr√©ation d'une facture depuis un devis accept√©.
   *
   * **ADMIN UNIQUEMENT** - Mode Administrateur requis.
   *
   * Workflow :
   * 1. V√©rifier l'authentification admin (window.isAuthenticatedThisSession)
   * 2. Si non authentifi√© : notification + arr√™t
   * 3. Charger le devis via IPC 'load-saved-quote'
   * 4. Stocker le devis dans this.currentQuoteForInvoice
   * 5. **V√©rifications** :
   *    - Statut doit √™tre "accept√©" (sinon erreur)
   *    - Pas d√©j√† factur√© (v√©rifier invoiceId via hasValidInvoiceId)
   * 6. Remplir le modal de confirmation :
   *    - Nom du devis
   *    - Nom du client
   *    - Total TTC
   * 7. Afficher le modal Bootstrap
   *
   * L'utilisateur peut ensuite confirmer (‚Üí confirmCreateInvoice) ou annuler.
   *
   * @async
   * @param {string} quoteId - ID du devis accept√© √† facturer
   * @returns {Promise&lt;void>}
   *
   * @example
   * await quotesModule.askCreateInvoice('quote_123');
   * // ‚Üí Modal de confirmation s'affiche avec r√©cap du devis
   */
  askCreateInvoice = async (quoteId) => {
    try {
      console.log('[DEBUG askCreateInvoice] quoteId re√ßu:', quoteId);
      console.log('[DEBUG askCreateInvoice] typeof quoteId:', typeof quoteId);

      // V√©rifier l'authentification admin
      if (!window.isAuthenticatedThisSession) {
        console.warn('[DEBUG askCreateInvoice] Pas authentifi√©!');
        NotificationSystem.warning('Mode Administrateur requis pour cr√©er une facture');
        return;
      }

      // Charger le devis
      console.log('[DEBUG] Appel load-saved-quote avec ID:', quoteId);
      const result = await this.invoke('load-saved-quote', quoteId);
      console.log('[DEBUG] R√©sultat load-saved-quote:', result);

      if (!result.success) {
        console.error('[DEBUG] √âCHEC du chargement:', result.message);
        NotificationSystem.error(`Devis non trouv√©: ${result.message || 'erreur inconnue'}`);
        return;
      }

      const quote = result.quote;
      console.log('[DEBUG askCreateInvoice] Quote charg√©, stockage dans this.currentQuoteForInvoice');
      this.currentQuoteForInvoice = quote;
      console.log('[DEBUG askCreateInvoice] this.currentQuoteForInvoice apr√®s assignation:', this.currentQuoteForInvoice);

      console.log('[DEBUG] Quote charg√©:', {
        name: quote.name,
        status: quote.status,
        invoiceId: quote.invoiceId,
        hasClientInfo: !!quote.clientInfo,
        hasTotals: !!quote.totals
      });

      // V√©rifier que le statut est bien "accept√©"
      if (quote.status !== 'accept√©') {
        console.error('[DEBUG] Statut invalide:', quote.status);
        NotificationSystem.error('Seuls les devis accept√©s peuvent √™tre factur√©s');
        return;
      }

      // V√©rifier qu'il n'a pas d√©j√† √©t√© factur√© (attention au string "null")
      if (this.hasValidInvoiceId(quote.invoiceId)) {
        console.error('Devis d√©j√† factur√©, invoiceId:', quote.invoiceId);
        NotificationSystem.error('Ce devis a d√©j√† √©t√© factur√©');
        return;
      }

      console.log('[DEBUG] Toutes les v√©rifications OK, affichage du modal');

      // Remplir le modal
      document.getElementById('invoice-quote-name').textContent = quote.name;
      document.getElementById('invoice-client-name').textContent = quote.clientInfo.name;
      document.getElementById('invoice-total-ttc').textContent = this.formatCurrency(quote.totals.totalTTC);

      // Afficher le modal
      const modalElement = document.getElementById('createInvoiceModal');
      if (modalElement) modalElement.removeAttribute('inert');
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    } catch (error) {
      console.error('Erreur ouverture modal facture:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  /**
   * Confirme la cr√©ation de la facture depuis un devis accept√©.
   *
   * Workflow :
   * 1. R√©cup√©rer authToken
   * 2. V√©rifier qu'il existe (sinon erreur)
   * 3. V√©rifier que this.currentQuoteForInvoice est d√©fini
   * 4. Appeler IPC 'create-invoice-from-quote' avec authToken + quoteId
   * 5. Si succ√®s :
   *    - Notification de succ√®s avec num√©ro de facture
   *    - Fermer le modal
   *    - Attendre 300ms
   *    - Rafra√Æchir les listes de devis (modal + onglet)
   *    - Rafra√Æchir la liste des factures si on est sur cet onglet
   * 6. R√©initialiser this.currentQuoteForInvoice
   *
   * Note : Le backend cr√©e automatiquement la facture et met √† jour
   * le statut du devis ‚Üí factur√© + stocke l'invoiceId.
   *
   * @async
   * @returns {Promise&lt;void>}
   *
   * @example
   * // Utilisateur confirme la cr√©ation de facture
   * await quotesModule.confirmCreateInvoice();
   * // ‚Üí Facture cr√©√©e, statut devis ‚Üí factur√©, listes rafra√Æchies
   */
  confirmCreateInvoice = async () => {
    try {
      const authToken = this.getAuthToken();
      if (!authToken) {
        NotificationSystem.error('Vous devez √™tre connect√© pour cr√©er une facture');
        return;
      }

      console.log('[DEBUG confirmCreateInvoice] currentQuoteForInvoice:', this.currentQuoteForInvoice);
      if (!this.currentQuoteForInvoice) {
        console.error('[DEBUG confirmCreateInvoice] currentQuoteForInvoice est vide!');
        NotificationSystem.error('Aucun devis s√©lectionn√© pour la facturation');
        return;
      }

      console.log('[DEBUG confirmCreateInvoice] Cr√©ation facture pour quote:', this.currentQuoteForInvoice.id);

      // Appeler l'IPC pour cr√©er la facture (passer authToken puis l'ID)
      const result = await this.invoke('create-invoice-from-quote', authToken, this.currentQuoteForInvoice.id);

      console.log('[DEBUG] R√©sultat cr√©ation facture:', result);

      if (result.success) {
        NotificationSystem.success(`Facture ${result.invoice.number} cr√©√©e avec succ√®s`);

        // Fermer le modal
        const modalElement = document.getElementById('createInvoiceModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) modal.hide();
        if (modalElement) modalElement.setAttribute('inert', '');

        // Rafra√Æchir les listes
        setTimeout(async () => {
          await this.refreshSavedQuotesTable();

          // Rafra√Æchir aussi l'onglet Devis si on est dessus
          if (document.getElementById('quotes-tab').classList.contains('active')) {
            await this.loadQuotesInTab();
          }

          // Rafra√Æchir aussi la liste des factures si on est sur cet onglet
          if (document.getElementById('invoices-tab').classList.contains('active') &amp;&amp; typeof window.loadInvoices === 'function') {
            await window.loadInvoices();
          }
        }, 300);
      } else {
        NotificationSystem.error(result.message || 'Erreur lors de la cr√©ation de la facture');
      }

      this.currentQuoteForInvoice = null;
    } catch (error) {
      console.error('Erreur cr√©ation facture:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  // ==========================================
  // QUOTE PRINTING
  // ==========================================

  /**
   * Imprime un devis depuis la liste sans le charger dans l'interface.
   *
   * **Utilis√© principalement pour les devis factur√©s ou accept√©s (lecture seule).**
   *
   * Workflow :
   * 1. Charger le devis via IPC 'load-saved-quote'
   * 2. **Sauvegarder** les variables globales actuelles :
   *    - window.quoteItems, window.clientInfo, window.headerConfig
   *    - Valeurs des champs HTML du formulaire client
   * 3. **Charger temporairement** les donn√©es du devis :
   *    - Copier quoteItems, clientInfo dans window.*
   *    - Remplir les champs HTML avec les valeurs du devis
   * 4. Appeler window.printQuote() pour g√©n√©rer et imprimer le PDF
   * 5. **Restaurer** les variables globales et champs HTML
   * 6. Rafra√Æchir le tableau (window.updateQuoteTable)
   *
   * Gr√¢ce √† cette m√©thode, l'utilisateur peut imprimer un devis sans perturber
   * le devis actuellement en cours de modification dans l'interface.
   *
   * @async
   * @param {string} quoteId - ID du devis √† imprimer
   * @returns {Promise&lt;void>}
   *
   * @example
   * await quotesModule.printQuoteFromList('quote_123');
   * // ‚Üí Devis imprim√©, interface non modifi√©e
   */
  printQuoteFromList = async (quoteId) => {
    try {
      // Charger le devis
      const result = await this.invoke('load-saved-quote', quoteId);

      if (!result.success) {
        NotificationSystem.error('Erreur lors du chargement du devis');
        return;
      }

      const quote = result.quote;

      // Sauvegarder les variables globales actuelles
      const savedQuoteItems = [...window.quoteItems];
      const savedClientInfo = { ...window.clientInfo };
      const savedHeaderConfig = { ...window.headerConfig };

      // Sauvegarder les valeurs des champs HTML
      const savedHtmlFields = {
        'client-name': document.getElementById('client-name').value,
        'client-phone': document.getElementById('client-phone').value,
        'client-email': document.getElementById('client-email').value,
        'client-address': document.getElementById('client-address').value,
        'quote-issuer': document.getElementById('quote-issuer').value,
        'quote-date': document.getElementById('quote-date').value,
        'quote-discount': document.getElementById('quote-discount')?.value || '0'
      };

      try {
        // Charger temporairement les donn√©es du devis
        window.quoteItems = [...quote.quoteItems];
        window.clientInfo = { ...quote.clientInfo };
        // headerConfig reste le m√™me (config actuelle de l'entreprise)

        // Remplir temporairement les champs HTML pour la validation
        document.getElementById('client-name').value = window.clientInfo.name || '';
        document.getElementById('client-phone').value = window.clientInfo.phone || '';
        document.getElementById('client-email').value = window.clientInfo.email || '';
        document.getElementById('client-address').value = window.clientInfo.address || '';
        document.getElementById('quote-issuer').value = window.clientInfo.issuer || '';
        document.getElementById('quote-date').value = window.clientInfo.quoteDate || '';

        // Restaurer la remise (0 si non d√©finie)
        const discountSelect = document.getElementById('quote-discount');
        if (discountSelect) {
          discountSelect.value = quote.discount !== undefined ? quote.discount : 0;
        }

        // Appeler la fonction d'impression
        if (typeof window.printQuote === 'function') {
          await window.printQuote();
        }

      } finally {
        // Restaurer les variables globales
        window.quoteItems = savedQuoteItems;
        window.clientInfo = savedClientInfo;
        window.headerConfig = savedHeaderConfig;

        // Restaurer les champs HTML
        document.getElementById('client-name').value = savedHtmlFields['client-name'];
        document.getElementById('client-phone').value = savedHtmlFields['client-phone'];
        document.getElementById('client-email').value = savedHtmlFields['client-email'];
        document.getElementById('client-address').value = savedHtmlFields['client-address'];
        document.getElementById('quote-issuer').value = savedHtmlFields['quote-issuer'];
        document.getElementById('quote-date').value = savedHtmlFields['quote-date'];
        const discountSelectRestore = document.getElementById('quote-discount');
        if (discountSelectRestore) {
          discountSelectRestore.value = savedHtmlFields['quote-discount'];
        }

        // Restaurer l'affichage du tableau
        if (typeof window.updateQuoteTable === 'function') {
          window.updateQuoteTable();
        }
      }

    } catch (error) {
      console.error('Erreur impression devis:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  // ==========================================
  // QUOTE LOCK/UNLOCK
  // ==========================================

  /**
   * Verrouille ou d√©verrouille les champs du devis.
   *
   * **Utilis√© pour les devis accept√©s (sign√©s) afin de les rendre lecture seule.**
   *
   * Champs verrouill√©s :
   * - Formulaire client : nom, t√©l√©phone, email, adresse, date, √©metteur
   * - Remise
   * - Boutons d'action : ajouter article, ajout rapide, sauvegarder
   * - Boutons de modification/suppression dans le tableau des articles
   *
   * Champs toujours actifs (m√™me verrouill√©s) :
   * - Bouton "R√©cup√©rer Devis"
   * - Bouton "Vider Devis"
   *
   * Styles appliqu√©s quand verrouill√© :
   * - Champs : backgroundColor = #f5f5f5, cursor = not-allowed
   * - Boutons : opacity = 0.5, cursor = not-allowed
   *
   * @param {boolean} locked - true pour verrouiller, false pour d√©verrouiller
   * @returns {void}
   *
   * @example
   * // Verrouiller le devis (devis accept√© charg√©)
   * quotesModule.setQuoteFieldsLocked(true);
   * // ‚Üí Tous les champs sont en lecture seule
   *
   * @example
   * // D√©verrouiller le devis
   * quotesModule.setQuoteFieldsLocked(false);
   * // ‚Üí Tous les champs sont modifiables
   */
  setQuoteFieldsLocked = (locked) => {
    // Champs clients et remise
    const clientFields = ['client-name', 'client-phone', 'client-email', 'client-address', 'quote-date', 'quote-issuer', 'quote-discount'];
    clientFields.forEach(id => {
      const field = document.getElementById(id);
      if (field) {
        field.disabled = locked;
        if (locked) {
          field.style.backgroundColor = '#f5f5f5';
          field.style.cursor = 'not-allowed';
        } else {
          field.style.backgroundColor = '';
          field.style.cursor = '';
        }
      }
    });

    // Boutons d'action (sauf "R√©cup√©rer Devis" et "Vider Devis" qui doivent toujours rester actifs)
    const actionButtons = [
      'add-item-btn',
      'quick-add-btn',
      'save-quote-btn'
    ];
    actionButtons.forEach(id => {
      const btn = document.getElementById(id);
      if (btn) {
        btn.disabled = locked;
        if (locked) {
          btn.style.opacity = '0.5';
          btn.style.cursor = 'not-allowed';
        } else {
          btn.style.opacity = '';
          btn.style.cursor = '';
        }
      }
    });

    // D√©sactiver les boutons de suppression et modification dans le tableau
    const editButtons = document.querySelectorAll('.edit-item-btn, .delete-item-btn');
    editButtons.forEach(btn => {
      btn.disabled = locked;
      if (locked) {
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      } else {
        btn.style.opacity = '';
        btn.style.cursor = '';
      }
    });
  };

  // ==========================================
  // HELPER FUNCTIONS
  // ==========================================

  /**
   * Synchronise window.clientInfo avec les champs du formulaire.
   *
   * Lit tous les champs du formulaire client et met √† jour l'objet clientInfo.
   * Appel√© avant chaque sauvegarde de devis pour s'assurer que les derni√®res
   * modifications du formulaire sont bien captur√©es.
   *
   * Champs synchronis√©s :
   * - name (nom du client)
   * - phone (t√©l√©phone)
   * - email (email)
   * - address (adresse)
   * - quoteDate (date du devis, par d√©faut aujourd'hui)
   * - issuer (√©metteur du devis)
   *
   * @private
   * @returns {void}
   */
  syncClientInfoFromForm() {
    window.clientInfo.name = document.getElementById('client-name')?.value || '';
    window.clientInfo.phone = document.getElementById('client-phone')?.value || '';
    window.clientInfo.email = document.getElementById('client-email')?.value || '';
    window.clientInfo.address = document.getElementById('client-address')?.value || '';
    window.clientInfo.quoteDate = document.getElementById('quote-date')?.value || new Date().toISOString().split('T')[0];
    window.clientInfo.issuer = document.getElementById('quote-issuer')?.value || '';
  }

  /**
   * Calcule les totaux du devis (HT, TVA, TTC).
   *
   * Additionne tous les articles du devis (window.quoteItems) pour calculer :
   * - Total HT : somme des priceHT de tous les articles
   * - Total TVA : somme des tva de tous les articles
   * - Total TTC : somme des priceTTC de tous les articles
   *
   * Les montants sont arrondis √† 2 d√©cimales.
   *
   * @private
   * @returns {Object} Totaux calcul√©s
   * @returns {number} returns.totalHT - Total hors taxes
   * @returns {number} returns.totalTVA - Total de la TVA
   * @returns {number} returns.totalTTC - Total toutes taxes comprises
   *
   * @example
   * const totals = quotesModule.calculateQuoteTotals();
   * // ‚Üí {totalHT: 1000.00, totalTVA: 200.00, totalTTC: 1200.00}
   */
  calculateQuoteTotals() {
    let totalHT = 0;
    let totalTVA = 0;
    let totalTTC = 0;

    window.quoteItems.forEach(item => {
      totalHT += item.priceHT || 0;
      totalTVA += item.tva || 0;
      totalTTC += item.priceTTC || 0;
    });

    return {
      totalHT: parseFloat(totalHT.toFixed(2)),
      totalTVA: parseFloat(totalTVA.toFixed(2)),
      totalTTC: parseFloat(totalTTC.toFixed(2))
    };
  }

  /**
   * R√©cup√®re le token d'authentification depuis window.sessionToken.
   *
   * Le sessionToken est d√©fini apr√®s connexion en mode Admin.
   * En mode Vendeur/Conseil, le token peut √™tre null ou undefined
   * mais certaines op√©rations sont autoris√©es sans token.
   *
   * @private
   * @returns {string|null} Token d'authentification ou null
   */
  getAuthToken() {
    return window.sessionToken || null;
  }

  /**
   * Retourne le badge HTML Bootstrap pour un statut de devis.
   *
   * Statuts support√©s (avec couleurs) :
   * - **brouillon** ‚Üí Gris (bg-secondary)
   * - **en_attente** ‚Üí Jaune (bg-warning text-dark)
   * - **valid√©** ‚Üí Bleu (bg-primary)
   * - **accept√©** ‚Üí Vert (bg-success)
   * - **refus√©** ‚Üí Rouge (bg-danger)
   * - **factur√©** ‚Üí Cyan (bg-info)
   *
   * Anciens statuts (compatibilit√©) :
   * - envoy√© ‚Üí affich√© comme "Valid√©"
   * - sign√© ‚Üí affich√© comme "Accept√©"
   * - abandonn√© ‚Üí affich√© comme "Refus√©"
   * - expir√© ‚Üí affich√© comme "Refus√©"
   *
   * @param {string} status - Statut du devis
   * @returns {string} HTML du badge &lt;span class="badge ...">Label&lt;/span>
   *
   * @example
   * const badge = quotesModule.getQuoteStatusBadge('accept√©');
   * // ‚Üí '&lt;span class="badge bg-success">Accept√©&lt;/span>'
   */
  getQuoteStatusBadge = (status) => {
    const statusConfig = {
      'brouillon': { label: 'Brouillon', class: 'bg-secondary' },
      'en_attente': { label: 'En attente', class: 'bg-warning text-dark' },
      'valid√©': { label: 'Valid√©', class: 'bg-primary' },
      'accept√©': { label: 'Accept√©', class: 'bg-success' },
      'refus√©': { label: 'Refus√©', class: 'bg-danger' },
      'factur√©': { label: 'Factur√©', class: 'bg-info' },
      // Anciens statuts (pour compatibilit√© avec les devis existants)
      'envoy√©': { label: 'Valid√©', class: 'bg-primary' },
      'sign√©': { label: 'Accept√©', class: 'bg-success' },
      'abandonn√©': { label: 'Refus√©', class: 'bg-danger' },
      'expir√©': { label: 'Refus√©', class: 'bg-danger' }
    };

    const config = statusConfig[status] || { label: status, class: 'bg-secondary' };
    return `&lt;span class="badge ${config.class}">${config.label}&lt;/span>`;
  };

  /**
   * V√©rifie si un invoiceId est valide.
   *
   * Un invoiceId est consid√©r√© valide s'il n'est pas :
   * - null
   * - undefined
   * - la cha√Æne "null" (cas de s√©rialisation JSON incorrecte)
   *
   * Utilis√© pour v√©rifier si un devis a d√©j√† √©t√© factur√© avant d'autoriser
   * la cr√©ation d'une nouvelle facture.
   *
   * @param {*} invoiceId - ID de facture √† v√©rifier
   * @returns {boolean} true si l'ID est valide, false sinon
   *
   * @example
   * quotesModule.hasValidInvoiceId('invoice_123'); // ‚Üí true
   * quotesModule.hasValidInvoiceId(null); // ‚Üí false
   * quotesModule.hasValidInvoiceId('null'); // ‚Üí false
   * quotesModule.hasValidInvoiceId(undefined); // ‚Üí false
   */
  hasValidInvoiceId(invoiceId) {
    return invoiceId &amp;&amp; invoiceId !== 'null' &amp;&amp; invoiceId !== null &amp;&amp; invoiceId !== undefined;
  }

  /**
   * V√©rifie si une transition de statut est autoris√©e.
   *
   * R√®gles de transition (workflow m√©tier) :
   * - **brouillon** ‚Üí en_attente, refus√©
   * - **en_attente** ‚Üí valid√©, refus√©
   * - **valid√©** ‚Üí accept√©, refus√©
   * - **accept√©** ‚Üí factur√©
   * - **refus√©** ‚Üí (aucune transition possible)
   * - **factur√©** ‚Üí (aucune transition possible)
   *
   * Note : En mode Vendeur/Conseil, seule la transition brouillon ‚Üí en_attente
   * est autoris√©e (v√©rifi√©e dans confirmChangeQuoteStatus).
   *
   * @param {string} currentStatus - Statut actuel du devis
   * @param {string} newStatus - Nouveau statut souhait√©
   * @returns {boolean} true si la transition est autoris√©e, false sinon
   *
   * @example
   * quotesModule.canTransitionTo('brouillon', 'en_attente'); // ‚Üí true
   * quotesModule.canTransitionTo('brouillon', 'factur√©'); // ‚Üí false
   * quotesModule.canTransitionTo('factur√©', 'accept√©'); // ‚Üí false
   */
  canTransitionTo(currentStatus, newStatus) {
    const ALLOWED_STATUS_TRANSITIONS = {
      'brouillon': ['en_attente', 'refus√©'],
      'en_attente': ['valid√©', 'refus√©'],
      'valid√©': ['accept√©', 'refus√©'],
      'accept√©': ['factur√©'],
      'refus√©': [],
      'factur√©': []
    };

    const allowed = ALLOWED_STATUS_TRANSITIONS[currentStatus] || [];
    return allowed.includes(newStatus);
  }

  /**
   * √âchappe les caract√®res HTML pour pr√©venir les attaques XSS.
   *
   * Remplace les caract√®res sp√©ciaux HTML par leurs entit√©s :
   * - &amp; ‚Üí &amp;amp;
   * - &lt; ‚Üí &amp;lt;
   * - > ‚Üí &amp;gt;
   * - " ‚Üí &amp;quot;
   * - ' ‚Üí &amp;#039;
   * - / ‚Üí &amp;#x2F;
   *
   * @param {string} text - Texte √† √©chapper
   * @returns {string} Texte √©chapp√© s√©curis√© pour insertion HTML
   *
   * @example
   * quotesModule.escapeHtml('&lt;script>alert("XSS")&lt;/script>');
   * // ‚Üí '&amp;lt;script&amp;gt;alert(&amp;quot;XSS&amp;quot;)&amp;lt;&amp;#x2F;script&amp;gt;'
   */
  escapeHtml(text) {
    if (!text) return '';
    return String(text)
      .replace(/&amp;/g, '&amp;amp;')
      .replace(/&lt;/g, '&amp;lt;')
      .replace(/>/g, '&amp;gt;')
      .replace(/"/g, '&amp;quot;')
      .replace(/'/g, '&amp;#039;')
      .replace(/\//g, '&amp;#x2F;');
  }

  /**
   * Formate une date ISO au format fran√ßais (JJ/MM/AAAA).
   *
   * @param {string} dateString - Date au format ISO (YYYY-MM-DDTHH:mm:ss.sssZ)
   * @returns {string} Date format√©e (DD/MM/YYYY) ou cha√Æne originale si erreur
   *
   * @example
   * quotesModule.formatDate('2025-01-15T10:30:00Z');
   * // ‚Üí '15/01/2025'
   */
  formatDate(dateString) {
    if (!dateString) return '';
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;

      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    } catch (e) {
      return dateString;
    }
  }

  // ==========================================
  // PAGINATION
  // ==========================================

  /**
   * Change de page dans la pagination.
   * @param {number} direction - Direction: -1 pour pr√©c√©dent, 1 pour suivant
   * @private
   */
  changePage(direction) {
    const newPage = this.pagination.currentPage + direction;
    if (newPage >= 1 &amp;&amp; newPage &lt;= this.pagination.totalPages) {
      this.pagination.currentPage = newPage;
      const searchText = this.getElement('#quotes-search-input')?.value || '';
      const statusFilter = this.getElement('#quotes-status-filter')?.value || '';
      this.loadQuotesInTab(searchText, statusFilter);
    }
  }

  /**
   * Va √† une page sp√©cifique.
   * @param {number} pageNumber - Num√©ro de page (1-indexed)
   * @private
   */
  goToPage(pageNumber) {
    if (pageNumber >= 1 &amp;&amp; pageNumber &lt;= this.pagination.totalPages) {
      this.pagination.currentPage = pageNumber;
      const searchText = this.getElement('#quotes-search-input')?.value || '';
      const statusFilter = this.getElement('#quotes-status-filter')?.value || '';
      this.loadQuotesInTab(searchText, statusFilter);
    }
  }

  /**
   * Met √† jour les contr√¥les de pagination (info et boutons).
   * @param {number} totalItems - Nombre total d'items
   * @param {Array} displayedItems - Items affich√©s sur la page actuelle
   * @private
   */
  updatePaginationControls(totalItems, displayedItems) {
    // Mettre √† jour le texte d'information
    const paginationInfo = this.getElement('#quotes-pagination-info');
    if (paginationInfo) {
      if (totalItems === 0) {
        paginationInfo.textContent = 'Aucun devis';
      } else {
        const startIndex = (this.pagination.currentPage - 1) * this.pagination.itemsPerPage + 1;
        const endIndex = startIndex + displayedItems.length - 1;
        paginationInfo.textContent = `Affichage ${startIndex}-${endIndex} sur ${totalItems} devis`;
      }
    }

    // Mettre √† jour les boutons de pagination
    const paginationControls = this.getElement('#quotes-pagination-controls');
    if (paginationControls &amp;&amp; totalItems > 0) {
      const prevDisabled = this.pagination.currentPage === 1 ? 'disabled' : '';
      const nextDisabled = this.pagination.currentPage === this.pagination.totalPages ? 'disabled' : '';

      // G√©n√©rer les num√©ros de page (max 5 pages visibles)
      const pageNumbers = this.generatePageNumbers();

      paginationControls.innerHTML = `
        &lt;button class="btn btn-sm btn-outline-primary" ${prevDisabled} onclick="window.quotesModule.changePage(-1)">
          &lt;i class="fas fa-chevron-left">&lt;/i> Pr√©c√©dent
        &lt;/button>
        ${pageNumbers.map(page => {
          if (page === '...') {
            return '&lt;span class="mx-1">...&lt;/span>';
          }
          const active = page === this.pagination.currentPage ? 'btn-primary' : 'btn-outline-primary';
          return `&lt;button class="btn btn-sm ${active}" onclick="window.quotesModule.goToPage(${page})">${page}&lt;/button>`;
        }).join('')}
        &lt;button class="btn btn-sm btn-outline-primary" ${nextDisabled} onclick="window.quotesModule.changePage(1)">
          Suivant &lt;i class="fas fa-chevron-right">&lt;/i>
        &lt;/button>
      `;
    } else if (paginationControls) {
      paginationControls.innerHTML = '';
    }
  }

  /**
   * G√©n√®re les num√©ros de page √† afficher (max 5 pages visibles avec ellipses).
   * @returns {Array} - Array de num√©ros de page et ellipses
   * @private
   */
  generatePageNumbers() {
    const pages = [];
    const total = this.pagination.totalPages;
    const current = this.pagination.currentPage;

    if (total &lt;= 7) {
      // Afficher toutes les pages si &lt;= 7
      for (let i = 1; i &lt;= total; i++) {
        pages.push(i);
      }
    } else {
      // Toujours afficher la premi√®re page
      pages.push(1);

      if (current > 3) {
        pages.push('...');
      }

      // Pages autour de la page actuelle
      const start = Math.max(2, current - 1);
      const end = Math.min(total - 1, current + 1);

      for (let i = start; i &lt;= end; i++) {
        pages.push(i);
      }

      if (current &lt; total - 2) {
        pages.push('...');
      }

      // Toujours afficher la derni√®re page
      pages.push(total);
    }

    return pages;
  }

  /**
   * Supprime plusieurs devis en masse (op√©ration bulk).
   *
   * Workflow :
   * 1. R√©cup√©rer authToken (Vendeur/Conseil autoris√©)
   * 2. Pour chaque quoteId dans le tableau :
   *    - Appeler IPC 'delete-saved-quote' avec authToken + quoteId
   * 3. Si succ√®s : notification + rafra√Æchissement de la liste
   *
   * @async
   * @param {Array&lt;string>} quoteIds - Tableau des IDs des devis √† supprimer
   * @returns {Promise&lt;void>}
   *
   * @example
   * await quotesModule.bulkDeleteQuotes(['quote_123', 'quote_456']);
   * // ‚Üí Devis supprim√©s, notification affich√©e, liste rafra√Æchie
   */
  async bulkDeleteQuotes(quoteIds) {
    try {
      const authToken = this.getAuthToken();

      let successCount = 0;
      let errorCount = 0;

      for (const quoteId of quoteIds) {
        try {
          const result = await this.invoke('delete-saved-quote', authToken, quoteId);
          if (result.success) {
            successCount++;
          } else {
            errorCount++;
          }
        } catch (error) {
          this.logError('Erreur lors de la suppression du devis', error);
          errorCount++;
        }
      }

      if (successCount > 0) {
        NotificationSystem.success(`${successCount} devis supprim√©(s) avec succ√®s`);

        // Rafra√Æchir l'onglet Devis si actif
        if (document.getElementById('quotes-tab').classList.contains('active')) {
          await this.loadQuotesInTab();
        }
      }

      if (errorCount > 0) {
        NotificationSystem.error(`${errorCount} devis n'ont pas pu √™tre supprim√©s`);
      }

      // R√©initialiser les s√©lections
      if (this.bulkActions) {
        this.bulkActions.clearSelection();
      }
    } catch (error) {
      this.logError('Erreur lors de la suppression en masse', error);
      NotificationSystem.error('Erreur lors de la suppression en masse');
    }
  }

  /**
   * Exporte plusieurs devis en masse au format CSV.
   *
   * Workflow :
   * 1. Pour chaque quoteId :
   *    - Charger les donn√©es compl√®tes du devis
   * 2. G√©n√©rer un fichier CSV avec tous les devis s√©lectionn√©s
   * 3. T√©l√©charger le fichier CSV
   *
   * @async
   * @param {Array&lt;string>} quoteIds - Tableau des IDs des devis √† exporter
   * @returns {Promise&lt;void>}
   *
   * @example
   * await quotesModule.bulkExportQuotes(['quote_123', 'quote_456']);
   * // ‚Üí Fichier CSV t√©l√©charg√© avec les 2 devis
   */
  async bulkExportQuotes(quoteIds) {
    try {
      const quotes = [];

      for (const quoteId of quoteIds) {
        try {
          const result = await this.invoke('load-saved-quote', quoteId);
          if (result.success &amp;&amp; result.quote) {
            quotes.push(result.quote);
          }
        } catch (error) {
          this.logError('Erreur lors du chargement du devis pour export', error);
        }
      }

      if (quotes.length === 0) {
        NotificationSystem.error('Aucun devis √† exporter');
        return;
      }

      // G√©n√©rer le CSV
      const csv = this.generateCSV(quotes);

      // Cr√©er un blob et t√©l√©charger
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);

      const timestamp = new Date().toISOString().split('T')[0];
      link.setAttribute('href', url);
      link.setAttribute('download', `devis_export_${timestamp}.csv`);
      link.style.visibility = 'hidden';

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      NotificationSystem.success(`${quotes.length} devis export√©(s) avec succ√®s`);

      // R√©initialiser les s√©lections
      if (this.bulkActions) {
        this.bulkActions.clearSelection();
      }
    } catch (error) {
      this.logError('Erreur lors de l\'export en masse', error);
      NotificationSystem.error('Erreur lors de l\'export en masse');
    }
  }

  /**
   * G√©n√®re un fichier CSV √† partir d'un tableau de devis.
   *
   * Format CSV :
   * - S√©parateur : point-virgule (;)
   * - Encodage : UTF-8
   * - Colonnes : Nom, Client, Statut, Date de cr√©ation, Date de modification, Total HT, Total TVA, Total TTC, Nombre d'articles
   *
   * @param {Array&lt;Object>} quotes - Tableau des devis √† exporter
   * @returns {string} Contenu CSV
   *
   * @example
   * const csv = quotesModule.generateCSV([quote1, quote2]);
   * // ‚Üí "Nom;Client;Statut;Date de cr√©ation;..."
   */
  generateCSV(quotes) {
    if (!quotes || !Array.isArray(quotes) || quotes.length === 0) {
      return 'Nom du devis;Client;T√©l√©phone;Email;Adresse;Statut;Date de cr√©ation;Date de modification;Total HT;Total TVA;Total TTC;Nombre d\'articles;√âmetteur';
    }

    // En-t√™tes CSV
    const headers = [
      'Nom du devis',
      'Client',
      'T√©l√©phone',
      'Email',
      'Adresse',
      'Statut',
      'Date de cr√©ation',
      'Date de modification',
      'Total HT',
      'Total TVA',
      'Total TTC',
      'Nombre d\'articles',
      '√âmetteur'
    ];

    // Construire les lignes CSV
    const rows = quotes.map(quote => {
      const clientInfo = quote.clientInfo || {};
      const items = quote.items || [];
      const totals = this.calculateTotalsForItems(items);

      return [
        this.escapeCsvValue(quote.name || ''),
        this.escapeCsvValue(clientInfo.name || ''),
        this.escapeCsvValue(clientInfo.phone || ''),
        this.escapeCsvValue(clientInfo.email || ''),
        this.escapeCsvValue(clientInfo.address || ''),
        this.escapeCsvValue(quote.status || 'brouillon'),
        this.formatDate(quote.createdAt),
        this.formatDate(quote.updatedAt),
        totals.totalHT.toFixed(2),
        totals.totalTVA.toFixed(2),
        totals.totalTTC.toFixed(2),
        items.length,
        this.escapeCsvValue(clientInfo.issuer || '')
      ].join(';');
    });

    // Combiner en-t√™tes et lignes
    return [headers.join(';'), ...rows].join('\n');
  }

  /**
   * √âchappe une valeur pour l'inclure dans un CSV.
   * Encadre par des guillemets si la valeur contient des caract√®res sp√©ciaux.
   *
   * @param {string} value - Valeur √† √©chapper
   * @returns {string} Valeur √©chapp√©e
   * @private
   */
  escapeCsvValue(value) {
    if (!value) return '';

    // Convertir en string
    const str = String(value);

    // Si contient des caract√®res sp√©ciaux, encadrer de guillemets et doubler les guillemets internes
    if (str.includes(';') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
      return `"${str.replace(/"/g, '""')}"`;
    }

    return str;
  }

  /**
   * Formate une date ISO en format fran√ßais (DD/MM/YYYY).
   *
   * @param {string} isoDate - Date au format ISO
   * @returns {string} Date format√©e ou cha√Æne vide
   * @private
   */
  formatDate(isoDate) {
    if (!isoDate) return '';

    try {
      const date = new Date(isoDate);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    } catch (error) {
      return '';
    }
  }

  /**
   * Calcule les totaux d'un devis (HT, TVA, TTC) √† partir d'un tableau d'items.
   * Utilis√© pour l'export CSV des bulk operations.
   *
   * @param {Array&lt;Object>} items - Articles du devis
   * @returns {Object} Totaux {totalHT, totalTVA, totalTTC}
   * @private
   */
  calculateTotalsForItems(items) {
    let totalHT = 0;
    let totalTVA = 0;
    let totalTTC = 0;

    // V√©rifier que items est un tableau valide
    if (!items || !Array.isArray(items)) {
      return { totalHT: 0, totalTVA: 0, totalTTC: 0 };
    }

    items.forEach(item => {
      const priceHT = parseFloat(item.priceHT) || 0;
      const quantity = parseFloat(item.quantity) || 0;
      const tva = parseFloat(item.tva) || 0;

      const itemTotalHT = priceHT * quantity;
      const itemTVA = itemTotalHT * (tva / 100);
      const itemTotalTTC = itemTotalHT + itemTVA;

      totalHT += itemTotalHT;
      totalTVA += itemTVA;
      totalTTC += itemTotalTTC;
    });

    return {
      totalHT,
      totalTVA,
      totalTTC
    };
  }

  /**
   * Formate un montant en devise fran√ßaise (EUR).
   *
   * Utilise l'API Intl.NumberFormat pour un formatage localis√©.
   * Format : 1 234,56 ‚Ç¨
   *
   * @param {number} amount - Montant √† formater
   * @returns {string} Montant format√© avec symbole ‚Ç¨ ou '0,00 ‚Ç¨' si invalide
   *
   * @example
   * quotesModule.formatCurrency(1234.56);
   * // ‚Üí '1 234,56 ‚Ç¨'
   *
   * @example
   * quotesModule.formatCurrency(null);
   * // ‚Üí '0,00 ‚Ç¨'
   */
  formatCurrency(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) return '0,00 ‚Ç¨';
    return new Intl.NumberFormat('fr-FR', {
      style: 'currency',
      currency: 'EUR'
    }).format(amount);
  }
}

export default QuotesModule;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
