

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> modules/invoices/InvoicesModule.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule.html">DashboardModule</a></li><li><a href="module-DataCache.html">DataCache</a></li><li><a href="module-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule.html">FECModule</a></li><li><a href="module-FollowUpModule.html">FollowUpModule</a></li><li><a href="module-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-KeyboardShortcutsModule.html">KeyboardShortcutsModule</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-MLService.html">MLService</a></li><li><a href="module-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-NotificationSystem.html">NotificationSystem</a></li><li><a href="module-NotificationSystemV2.html">NotificationSystemV2</a></li><li><a href="module-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-TourModule.html">TourModule</a></li><li><a href="module-UtilitiesModule.html">UtilitiesModule</a></li><li><a href="module-calculations.html">calculations</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-formatters.html">formatters</a></li><li><a href="module-helpers.html">helpers</a></li></ul><h3>Classes</h3><ul><li><a href="BaseModule.html">BaseModule</a></li><li><a href="BulkActionsManager.html">BulkActionsManager</a></li><li><a href="CacheKeys.html">CacheKeys</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="LoadingStateManager.html">LoadingStateManager</a></li><li><a href="ModalHelper.html">ModalHelper</a></li><li><a href="PaginationManager.html">PaginationManager</a></li><li><a href="ServerValidator.html">ServerValidator</a></li><li><a href="StateManager.html">StateManager</a></li><li><a href="TabRefreshManager.html">TabRefreshManager</a></li><li><a href="UndoRedoManager.html">UndoRedoManager</a></li><li><a href="module-AboutModule-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule-DashboardModule.html">DashboardModule</a></li><li><a href="module-ExportModule-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule-FECModule.html">FECModule</a></li><li><a href="module-ImportModule-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-Logger-Logger.html">Logger</a></li><li><a href="module-Logger-ModuleLogger.html">ModuleLogger</a></li><li><a href="module-MaterialsModule-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-PDFModule-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-UtilitiesModule-UtilitiesModule.html">UtilitiesModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#emitSync">emitSync</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#validateBeforeAddToQuote">validateBeforeAddToQuote</a></li><li><a href="global.html#validateBeforeExport">validateBeforeExport</a></li><li><a href="global.html#validateBeforeSaveMaterial">validateBeforeSaveMaterial</a></li><li><a href="global.html#validateBeforeSendEmail">validateBeforeSendEmail</a></li><li><a href="global.html#validateHeaderConfig">validateHeaderConfig</a></li><li><a href="global.html#validatePasswordChange">validatePasswordChange</a></li><li><a href="global.html#validateSMTPConfig">validateSMTPConfig</a></li><li><a href="global.html#waitFor">waitFor</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>modules/invoices/InvoicesModule.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * ========================================
 * INVOICES MODULE - Gestion des factures
 * ========================================
 *
 * Module de gestion complÃ¨te du cycle de vie des factures pour l'application AutoCalc OptiDevis.
 * GÃ¨re la crÃ©ation depuis devis acceptÃ©s, l'affichage, le filtrage, les paiements, la suppression,
 * l'export PDF, l'impression et l'envoi par email.
 *
 * Architecture :
 * Le module orchestre toutes les opÃ©rations liÃ©es aux factures avec gestion des permissions
 * (Admin uniquement pour la plupart des opÃ©rations).
 *
 * Cycle de vie d'une facture :
 * 1. **CrÃ©ation** - GÃ©nÃ©rÃ©e depuis un devis acceptÃ© (Admin uniquement)
 * 2. **Ã€ payer** - Facture Ã©mise, en attente de paiement (statut par dÃ©faut)
 * 3. **Ã‰chue** - Date d'Ã©chÃ©ance dÃ©passÃ©e (calculÃ© automatiquement)
 * 4. **PayÃ©e** - Paiement reÃ§u et enregistrÃ© (Admin uniquement)
 * 5. **Litige** - Contestation ou problÃ¨me de paiement (Admin uniquement)
 * 6. **AnnulÃ©e** - Facture annulÃ©e (Admin uniquement)
 *
 * Workflow principal - CrÃ©ation depuis devis :
 * 1. Utilisateur clique "Facturer" sur un devis acceptÃ© (Admin uniquement)
 * 2. VÃ©rifications :
 *    - Mode Admin (window.isAuthenticatedThisSession)
 *    - Statut devis = acceptÃ©
 *    - Pas dÃ©jÃ  facturÃ© (invoiceId vide/null)
 * 3. Modal de confirmation avec rÃ©cap (nom devis, client, total TTC)
 * 4. Utilisateur confirme
 * 5. Appel IPC 'create-invoice-from-quote' avec authToken + quoteId
 * 6. GÃ©nÃ©ration facture par le backend :
 *    - NumÃ©ro unique (FAC-YYYYMMDD-XXXX)
 *    - Date Ã©mission = aujourd'hui
 *    - Date Ã©chÃ©ance = Ã©mission + 30 jours (paramÃ©trable)
 *    - Copie des donnÃ©es du devis (client, articles, totaux)
 *    - Statut initial = Ã _payer
 * 7. Mise Ã  jour devis : statut â†’ facturÃ©, invoiceId stockÃ©
 * 8. RafraÃ®chissement listes (devis + factures)
 * 9. Notification succÃ¨s avec numÃ©ro de facture
 *
 * Workflow principal - Marquer comme payÃ©e :
 * 1. Utilisateur clique "Marquer comme payÃ©e" (Admin uniquement)
 * 2. Modal s'affiche avec formulaire :
 *    - Date de paiement (par dÃ©faut aujourd'hui)
 *    - MÃ©thode de paiement (virement, chÃ¨que, espÃ¨ces, carte, autre)
 *    - Notes optionnelles
 * 3. Utilisateur remplit et confirme
 * 4. Appel IPC 'mark-invoice-paid' avec authToken + {invoiceId, paymentDate, paymentMethod, notes}
 * 5. Mise Ã  jour facture : statut â†’ payÃ©e, infos paiement stockÃ©es
 * 6. RafraÃ®chissement liste factures
 * 7. Notification succÃ¨s
 *
 * Workflow principal - Export PDF :
 * 1. Utilisateur clique "Exporter PDF" sur une facture
 * 2. Chargement de la facture via IPC 'load-invoice'
 * 3. GÃ©nÃ©ration du PDF via window.generateInvoicePDFDocument()
 * 4. TÃ©lÃ©chargement automatique : facture_{numÃ©ro}_{client}.pdf
 * 5. Notification succÃ¨s
 *
 * Workflow principal - Envoi par email :
 * 1. Utilisateur clique "Envoyer par Email" (Admin uniquement)
 * 2. VÃ©rifications :
 *    - Email client renseignÃ©
 *    - Mode Admin
 * 3. Chargement de la facture
 * 4. GÃ©nÃ©ration du PDF
 * 5. Conversion en base64
 * 6. Appel IPC 'send-email' avec :
 *    - to: email client
 *    - subject: "Facture {numÃ©ro}"
 *    - body: message standard
 *    - attachmentName: facture_{numÃ©ro}.pdf
 *    - attachmentData: base64
 * 7. Notification succÃ¨s ou erreur
 *
 * SystÃ¨me de permissions :
 * - **Mode Vendeur/Conseil** :
 *   - Peut : consulter la liste des factures
 *   - Ne peut pas : crÃ©er, modifier, supprimer, envoyer
 *
 * - **Mode Admin** (window.isAuthenticatedThisSession = true) :
 *   - Peut : toutes les opÃ©rations
 *   - Peut : crÃ©er depuis devis acceptÃ©s
 *   - Peut : marquer comme payÃ©e
 *   - Peut : supprimer
 *   - Peut : envoyer par email
 *
 * Statuts de factures :
 * - **Ã _payer** â†’ Jaune (bg-warning) - Facture Ã©mise, en attente
 * - **Ã©chue** â†’ Rouge (bg-danger) - Date d'Ã©chÃ©ance dÃ©passÃ©e
 * - **payÃ©e** â†’ Vert (bg-success) - Paiement reÃ§u
 * - **litige** â†’ Rouge (bg-danger) - Contestation
 * - **annulÃ©e** â†’ Gris (bg-secondary) - Facture annulÃ©e
 *
 * Actions selon statut :
 * - **Ã€ payer / Ã‰chue** : Exporter PDF, Imprimer, Envoyer email, Marquer payÃ©e, Supprimer
 * - **PayÃ©e** : Exporter PDF, Imprimer, Supprimer
 * - **Litige** : Exporter PDF, Imprimer, Envoyer email, Supprimer
 * - **AnnulÃ©e** : Exporter PDF, Supprimer
 *
 * Ã‰vÃ©nements Ã©mis :
 * - 'invoices:created' - Facture crÃ©Ã©e
 * - 'invoices:loaded' - Factures chargÃ©es
 * - 'invoices:paid' - Facture marquÃ©e payÃ©e
 * - 'invoices:deleted' - Facture supprimÃ©e
 * - 'invoices:exported' - PDF exportÃ©
 * - 'invoices:printed' - Facture imprimÃ©e
 * - 'invoices:emailed' - Email envoyÃ©
 *
 * Canaux IPC utilisÃ©s :
 * - 'load-saved-quote' - Charger un devis (pour crÃ©ation facture)
 * - 'create-invoice-from-quote' - CrÃ©er facture depuis devis (nÃ©cessite authToken)
 * - 'list-invoices' - Lister toutes les factures
 * - 'load-invoice' - Charger une facture par ID
 * - 'mark-invoice-paid' - Marquer comme payÃ©e (nÃ©cessite authToken)
 * - 'delete-invoice' - Supprimer une facture (nÃ©cessite authToken)
 * - 'print-pdf' - Imprimer un PDF
 * - 'send-email' - Envoyer un email avec piÃ¨ce jointe (nÃ©cessite authToken)
 *
 * IntÃ©grations :
 * - QuotesModule : CrÃ©ation de factures depuis devis acceptÃ©s
 * - PDFModule : GÃ©nÃ©ration de documents PDF (via window.generateInvoicePDFDocument)
 * - EmailModule : Envoi d'emails avec piÃ¨ces jointes
 *
 * @module InvoicesModule
 * @extends BaseModule
 * @version 2.0.0
 * @author AutoCalc OptiDevis
 */

import BaseModule from '../../core/BaseModule.js';
import NotificationSystem from '../../shared/ui/NotificationSystem.js';
import { logger } from '../../shared/utils/helpers.js';
import { CurrencyFormatter, DateFormatter, TextFormatter } from '../../shared/utils/formatters.js';
import BulkActionsManager from '../../shared/bulk/BulkActionsManager.js';

class InvoicesModule extends BaseModule {
  /**
   * CrÃ©e une instance du module Invoices.
   *
   * @param {StateManager} state - Gestionnaire d'Ã©tat global
   * @param {EventBus} eventBus - Bus d'Ã©vÃ©nements pour communication inter-modules
   */
  constructor(state, eventBus) {
    super('invoices', state, eventBus);

    /**
     * Cache local des factures chargÃ©es depuis le backend.
     *
     * @type {Array&lt;Object>}
     * @private
     * @property {string} id - ID unique de la facture
     * @property {string} number - NumÃ©ro de facture (ex: FAC-20250115-0001)
     * @property {string} quoteId - ID du devis source
     * @property {string} quoteName - Nom du devis source
     * @property {Object} clientInfo - Informations client
     * @property {Array&lt;Object>} items - Articles de la facture
     * @property {Object} totals - Totaux {totalHT, totalTVA, totalTTC}
     * @property {string} issueDate - Date d'Ã©mission (ISO string)
     * @property {string} dueDate - Date d'Ã©chÃ©ance (ISO string)
     * @property {string} status - Statut ('Ã _payer', 'Ã©chue', 'payÃ©e', 'litige', 'annulÃ©e')
     * @property {string} [paymentDate] - Date de paiement (si payÃ©e)
     * @property {string} [paymentMethod] - MÃ©thode de paiement (si payÃ©e)
     * @property {string} [paymentNotes] - Notes de paiement (si payÃ©e)
     */
    this.invoices = [];

    /**
     * Devis en cours de transformation en facture.
     * UtilisÃ© pour stocker le devis lors du workflow de crÃ©ation de facture.
     *
     * @type {Object|null}
     * @private
     */
    this.currentQuoteForInvoice = null;

    /**
     * Facture en cours de marquage comme payÃ©e.
     * UtilisÃ© pour stocker la facture lors du workflow de paiement.
     *
     * @type {Object|null}
     * @private
     */
    this.currentInvoiceForPayment = null;

    /**
     * Facture en attente de suppression.
     * StockÃ©e lors de la demande de confirmation (askDeleteInvoice).
     *
     * @type {Object|null}
     * @private
     * @property {string} id - ID de la facture
     * @property {string} number - NumÃ©ro de la facture (pour affichage)
     */
    this.invoiceToDelete = null;

    /**
     * Configuration des statuts de factures.
     * DÃ©finit les labels et classes Bootstrap pour chaque statut.
     *
     * @type {Object&lt;string, Object>}
     * @private
     * @property {Object} Ã _payer - Facture Ã  payer
     * @property {Object} Ã©chue - Facture Ã©chue
     * @property {Object} payÃ©e - Facture payÃ©e
     * @property {Object} litige - Facture en litige
     * @property {Object} annulÃ©e - Facture annulÃ©e
     */
    this.statusConfig = {
      'Ã _payer': { label: 'Ã€ payer', class: 'bg-warning text-dark' },
      'Ã©chue': { label: 'Ã‰chue', class: 'bg-danger' },
      'payÃ©e': { label: 'PayÃ©e', class: 'bg-success' },
      'litige': { label: 'Litige', class: 'bg-danger' },
      'annulÃ©e': { label: 'AnnulÃ©e', class: 'bg-secondary' }
    };

    /**
     * Configuration de la pagination.
     *
     * @type {Object}
     * @private
     * @property {number} currentPage - Page actuelle (1-indexed)
     * @property {number} itemsPerPage - Nombre d'Ã©lÃ©ments par page
     * @property {number} totalItems - Nombre total d'Ã©lÃ©ments
     * @property {number} totalPages - Nombre total de pages
     */
    this.pagination = {
      currentPage: 1,
      itemsPerPage: 25,
      totalItems: 0,
      totalPages: 0
    };

    /**
     * Gestionnaire des opÃ©rations bulk (sÃ©lection multiple).
     *
     * @type {BulkActionsManager}
     * @private
     */
    this.bulkActions = new BulkActionsManager({
      moduleName: 'invoices',
      tableId: 'invoices-table-body',
      checkboxClass: 'invoice-bulk-checkbox',
      selectAllId: 'invoices-select-all',
      bulkActionsId: 'invoices-bulk-actions',
      undoRedoManager: window.undoRedoManager,
      onDeleteCallback: this.bulkDeleteInvoices.bind(this),
      onExportCallback: this.bulkExportInvoices.bind(this)
    });

    this.log('InvoicesModule instantiated');
  }

  /**
   * Initialise le module Invoices.
   *
   * Workflow d'initialisation :
   * 1. Attacher les event listeners (onglet, recherche, filtres)
   * 2. Exposer les fonctions au scope global (compatibilitÃ© legacy)
   * 3. Marquer le module comme initialisÃ©
   *
   * Fonctions exposÃ©es :
   * - askCreateInvoice, confirmCreateInvoice
   * - loadInvoices
   * - askMarkInvoicePaid, confirmMarkInvoicePaid
   * - askDeleteInvoice, confirmDeleteInvoice
   * - exportInvoicePDF, printInvoice, sendInvoiceEmail
   * - getInvoiceStatusBadge
   *
   * @async
   * @returns {Promise&lt;void>}
   * @throws {Error} Si l'initialisation Ã©choue
   *
   * @example
   * const invoicesModule = new InvoicesModule(state, eventBus);
   * await invoicesModule.init();
   * // â†’ Module initialisÃ©, listeners actifs, fonctions globales exposÃ©es
   */
  async init() {
    try {
      this.log('Initializing InvoicesModule...');

      // Attacher les event listeners
      this.attachEventListeners();

      // Exposer les fonctions au scope global
      // NOTE: askCreateInvoice et confirmCreateInvoice ne sont PAS exposÃ©es ici
      // car elles sont dÃ©jÃ  exposÃ©es par QuotesModule pour gÃ©rer la crÃ©ation
      // de factures depuis l'onglet Devis. Les exposer ici causerait un conflit.
      this.exposeToGlobal({
        loadInvoices: this.loadInvoices,
        askMarkInvoicePaid: this.askMarkInvoicePaid,
        confirmMarkInvoicePaid: this.confirmMarkInvoicePaid,
        askDeleteInvoice: this.askDeleteInvoice,
        confirmDeleteInvoice: this.confirmDeleteInvoice,
        exportInvoicePDF: this.exportInvoicePDF,
        printInvoice: this.printInvoice,
        sendInvoiceEmail: this.sendInvoiceEmail,
        getInvoiceStatusBadge: this.getInvoiceStatusBadge
      });

      // Exposer l'instance du module pour les mÃ©thodes de pagination
      window.invoicesModule = this;

      // Initialiser BulkActionsManager
      this.bulkActions.initialize();

      // ðŸ†• Enregistrer l'onglet Factures pour auto-refresh
      this.registerTabRefresh();

      // ðŸ†• Enregistrer les commandes Command Palette (quand prÃªt)
      if (window.CommandPalette) {
        this.registerCommands();
      } else {
        // Attendre que Command Palette soit prÃªt
        this.events.on('commandpalette:ready', () => {
          this.registerCommands();
        });
      }

      this.initialized = true;
      this.log('InvoicesModule initialized successfully');

    } catch (error) {
      this.error('Error initializing InvoicesModule:', error);
      throw error;
    }
  }

  /**
   * ðŸ†• Enregistre l'onglet Factures pour auto-refresh automatique.
   *
   * @private
   * @returns {void}
   */
  registerTabRefresh() {
    if (!window.TabRefreshManager) {
      this.warn('TabRefreshManager not available - tab auto-refresh disabled');
      return;
    }

    // Onglet "Factures"
    window.TabRefreshManager.registerTab('invoices-tab', async (force) => {
      this.log('ðŸ”„ Auto-refreshing Invoices...');
      await this.loadInvoicesTab();
    }, {
      ttl: 30000, // 30 secondes
      label: 'Factures'
    });

    this.log('âœ… Tab auto-refresh registered');
  }

  /**
   * ðŸ†• Enregistre les commandes Command Palette pour le module Invoices.
   *
   * @private
   */
  registerCommands() {
    if (!window.CommandPalette) return;

    // Voir factures
    window.CommandPalette.registerCommand('invoices-list', {
      label: 'ðŸ’° Voir toutes les factures',
      keywords: ['factures', 'invoices', 'liste', 'voir', 'tous'],
      category: 'Factures',
      icon: 'ðŸ’°',
      priority: 12,
      action: () => document.getElementById('invoices-tab')?.click()
    });

    // Factures impayÃ©es
    window.CommandPalette.registerCommand('invoices-unpaid', {
      label: 'âš ï¸ Factures impayÃ©es',
      keywords: ['factures', 'impayÃ©es', 'unpaid', 'en attente', 'retard'],
      category: 'Factures',
      icon: 'âš ï¸',
      priority: 10,
      action: () => {
        document.getElementById('invoices-tab')?.click();
        window.NotificationSystem?.info('Filtrez par statut "Non payÃ©e"');
      }
    });

    this.log('âœ… Command Palette commands registered');
  }

  /**
   * Attache les event listeners DOM.
   *
   * Listeners attachÃ©s :
   * - Ouverture onglet "Factures" â†’ loadInvoices() (lazy loading)
   * - Bouton "Actualiser" â†’ loadInvoices() avec filtres actifs
   * - Champ de recherche â†’ loadInvoices() avec filtrage texte
   * - Filtre de statut â†’ loadInvoices() avec filtrage statut
   *
   * Note : Les factures ne sont chargÃ©es que lorsque l'onglet est affichÃ©
   * pour optimiser les performances (lazy loading).
   *
   * @private
   * @returns {void}
   */
  attachEventListeners() {
    // Lazy loading : charger les listeners quand l'onglet Factures est affichÃ©
    const invoicesTab = this.getElement('#invoices-tab');
    if (invoicesTab) {
      invoicesTab.addEventListener('shown.bs.tab', async () => {
        await this.loadInvoices();
      });
    }

    // Bouton actualiser
    this.addDOMListener('#refresh-invoices-btn', 'click', async () => {
      const searchText = this.getValue('#invoices-search-input') || '';
      const statusFilter = this.getValue('#invoices-status-filter') || '';
      await this.loadInvoices(searchText, statusFilter);
    });

    // Champ de recherche
    this.addDOMListener('#invoices-search-input', 'input', async (e) => {
      const statusFilter = this.getValue('#invoices-status-filter') || '';
      await this.loadInvoices(e.target.value, statusFilter);
    });

    // Filtre de statut
    this.addDOMListener('#invoices-status-filter', 'change', async (e) => {
      const searchText = this.getValue('#invoices-search-input') || '';
      await this.loadInvoices(searchText, e.target.value);
    });

    // Bouton de confirmation de suppression de facture
    this.addDOMListener('#confirmDeleteInvoiceBtn', 'click', () => {
      this.confirmDeleteInvoice();
    });

    // Bouton de confirmation de paiement de facture
    this.addDOMListener('#confirmMarkInvoicePaidBtn', 'click', () => {
      this.confirmMarkInvoicePaid();
    });

    // Listener pour le changement de nombre d'items par page
    const itemsPerPageSelect = this.getElement('#invoices-items-per-page');
    if (itemsPerPageSelect) {
      itemsPerPageSelect.addEventListener('change', (e) => {
        this.pagination.itemsPerPage = parseInt(e.target.value);
        this.pagination.currentPage = 1; // Reset to first page
        const searchText = this.getValue('#invoices-search-input') || '';
        const statusFilter = this.getValue('#invoices-status-filter') || '';
        this.loadInvoices(searchText, statusFilter);
      });
    }
  }

  // ==========================================
  // CRÃ‰ATION DE FACTURE DEPUIS DEVIS
  // ==========================================

  /**
   * Demande la crÃ©ation d'une facture depuis un devis acceptÃ©.
   *
   * **ADMIN UNIQUEMENT** - NÃ©cessite l'authentification Admin.
   *
   * Workflow :
   * 1. VÃ©rifier l'authentification Admin (isAuthenticated)
   * 2. Si non authentifiÃ© : notification + arrÃªt
   * 3. Charger le devis via IPC 'load-saved-quote'
   * 4. Stocker le devis dans this.currentQuoteForInvoice
   * 5. **VÃ©rifications** :
   *    - Statut doit Ãªtre "acceptÃ©" (sinon erreur)
   *    - Pas dÃ©jÃ  facturÃ© (vÃ©rifier invoiceId via hasValidInvoiceId)
   * 6. Remplir le modal de confirmation :
   *    - Nom du devis
   *    - Nom du client
   *    - Total TTC (formatÃ© en devise)
   * 7. Afficher le modal Bootstrap
   *
   * L'utilisateur peut ensuite confirmer (â†’ confirmCreateInvoice) ou annuler.
   *
   * @async
   * @param {string} quoteId - ID du devis acceptÃ© Ã  transformer en facture
   * @returns {Promise&lt;void>}
   *
   * @example
   * await invoicesModule.askCreateInvoice('quote_123');
   * // â†’ Modal de confirmation s'affiche avec rÃ©cap du devis
   */
  askCreateInvoice = async (quoteId) => {
    try {
      this.log('askCreateInvoice called with quoteId:', quoteId);

      // VÃ©rifier l'authentification admin
      if (!this.isAuthenticated()) {
        NotificationSystem.warning('Mode Administrateur requis pour crÃ©er une facture');
        return;
      }

      // Charger le devis
      const result = await this.invoke('load-saved-quote', quoteId);
      this.log('Quote loading result:', result);

      if (!result.success) {
        this.error('Failed to load quote:', result.message);
        NotificationSystem.error(`Devis non trouvÃ©: ${result.message || 'erreur inconnue'}`);
        return;
      }

      const quote = result.quote;
      this.currentQuoteForInvoice = quote;

      this.log('Quote loaded:', {
        name: quote.name,
        status: quote.status,
        invoiceId: quote.invoiceId,
        hasClientInfo: !!quote.clientInfo,
        hasTotals: !!quote.totals
      });

      // VÃ©rifier que le statut est bien "acceptÃ©"
      if (quote.status !== 'acceptÃ©') {
        this.error('Invalid status:', quote.status);
        NotificationSystem.error('Seuls les devis acceptÃ©s peuvent Ãªtre facturÃ©s');
        return;
      }

      // VÃ©rifier qu'il n'a pas dÃ©jÃ  Ã©tÃ© facturÃ©
      if (this.hasValidInvoiceId(quote.invoiceId)) {
        this.error('Quote already invoiced, invoiceId:', quote.invoiceId);
        NotificationSystem.error('Ce devis a dÃ©jÃ  Ã©tÃ© facturÃ©');
        return;
      }

      this.log('All checks OK, showing modal');

      // Remplir le modal
      this.setValue('#invoice-quote-name', quote.name);
      const clientNameEl = this.getElement('#invoice-client-name');
      if (clientNameEl) clientNameEl.textContent = quote.clientInfo.name;
      const totalTTCEl = this.getElement('#invoice-total-ttc');
      if (totalTTCEl) totalTTCEl.textContent = CurrencyFormatter.format(quote.totals.totalTTC);

      // Afficher le modal
      const modalElement = this.getElement('#createInvoiceModal');
      if (modalElement) {
        modalElement.removeAttribute('inert');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
    } catch (error) {
      this.error('Error opening invoice modal:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  /**
   * Confirme la crÃ©ation de la facture depuis un devis acceptÃ©.
   *
   * Workflow :
   * 1. RÃ©cupÃ©rer authToken (getSessionToken)
   * 2. VÃ©rifier qu'il existe (sinon erreur)
   * 3. VÃ©rifier que this.currentQuoteForInvoice est dÃ©fini
   * 4. Appeler IPC 'create-invoice-from-quote' avec authToken + quoteId
   * 5. Si succÃ¨s :
   *    - Notification de succÃ¨s avec numÃ©ro de facture
   *    - Fermer le modal
   *    - Ã‰mettre Ã©vÃ©nement 'invoices:created'
   *    - Attendre 300ms
   *    - RafraÃ®chir liste des devis (refreshSavedQuotesTable)
   *    - RafraÃ®chir onglet Devis si actif (loadQuotesInTab)
   *    - RafraÃ®chir liste des factures si actif (loadInvoices)
   * 6. RÃ©initialiser this.currentQuoteForInvoice
   *
   * Note : Le backend crÃ©e automatiquement la facture avec :
   * - NumÃ©ro unique (FAC-YYYYMMDD-XXXX)
   * - Date Ã©mission = aujourd'hui
   * - Date Ã©chÃ©ance = Ã©mission + 30 jours
   * - Statut = Ã _payer
   * - Mise Ã  jour du devis : statut â†’ facturÃ©, invoiceId stockÃ©
   *
   * @async
   * @returns {Promise&lt;void>}
   *
   * @fires invoices:created - Ã‰mis quand la facture est crÃ©Ã©e avec succÃ¨s
   *
   * @example
   * // Utilisateur confirme la crÃ©ation de facture
   * await invoicesModule.confirmCreateInvoice();
   * // â†’ Facture crÃ©Ã©e, devis mis Ã  jour, listes rafraÃ®chies
   */
  confirmCreateInvoice = async () => {
    try {
      const authToken = this.getSessionToken();
      if (!authToken) {
        NotificationSystem.error('Vous devez Ãªtre connectÃ© pour crÃ©er une facture');
        return;
      }

      if (!this.currentQuoteForInvoice) return;

      this.log('Creating invoice for quote:', this.currentQuoteForInvoice.id);

      // Appeler l'IPC pour crÃ©er la facture
      const result = await this.invoke('create-invoice-from-quote', authToken, this.currentQuoteForInvoice.id);

      this.log('Invoice creation result:', result);

      if (result.success) {
        NotificationSystem.success(`Facture ${result.invoice.number} crÃ©Ã©e avec succÃ¨s`);

        // Fermer le modal
        const modalElement = this.getElement('#createInvoiceModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) modal.hide();
        if (modalElement) modalElement.setAttribute('inert', '');

        // Ã‰mettre Ã©vÃ©nement
        this.emitEvent('created', result.invoice);

        // RafraÃ®chir les listes
        setTimeout(async () => {
          // RafraÃ®chir la liste des devis sauvegardÃ©s
          if (typeof window.refreshSavedQuotesTable === 'function') {
            await window.refreshSavedQuotesTable();
          }

          // RafraÃ®chir l'onglet Devis si actif
          const quotesTab = this.getElement('#quotes-tab');
          if (quotesTab &amp;&amp; quotesTab.classList.contains('active')) {
            if (typeof window.loadQuotesInTab === 'function') {
              await window.loadQuotesInTab();
            }
          }

          // RafraÃ®chir la liste des factures si actif
          const invoicesTab = this.getElement('#invoices-tab');
          if (invoicesTab &amp;&amp; invoicesTab.classList.contains('active')) {
            await this.loadInvoices();
          }
        }, 300);
      } else {
        NotificationSystem.error(result.message || 'Erreur lors de la crÃ©ation de la facture');
      }

      this.currentQuoteForInvoice = null;
    } catch (error) {
      this.error('Error creating invoice:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  /**
   * VÃ©rifie si un invoiceId est valide.
   *
   * Un invoiceId est considÃ©rÃ© valide s'il n'est pas :
   * - null
   * - undefined
   * - la chaÃ®ne "null" (cas de sÃ©rialisation JSON incorrecte)
   * - chaÃ®ne vide ''
   *
   * UtilisÃ© pour vÃ©rifier si un devis a dÃ©jÃ  Ã©tÃ© facturÃ© avant d'autoriser
   * la crÃ©ation d'une nouvelle facture.
   *
   * @param {*} invoiceId - ID de facture Ã  vÃ©rifier
   * @returns {boolean} true si l'ID est valide, false sinon
   *
   * @example
   * invoicesModule.hasValidInvoiceId('invoice_123'); // â†’ true
   * invoicesModule.hasValidInvoiceId(null); // â†’ false
   * invoicesModule.hasValidInvoiceId('null'); // â†’ false
   * invoicesModule.hasValidInvoiceId(''); // â†’ false
   */
  hasValidInvoiceId(invoiceId) {
    return invoiceId &amp;&amp; invoiceId !== 'null' &amp;&amp; invoiceId !== '';
  }

  // ==========================================
  // LISTE ET AFFICHAGE
  // ==========================================

  /**
   * Charge et affiche la liste des factures avec filtrage optionnel.
   *
   * Workflow :
   * 1. Appeler IPC 'list-invoices' pour rÃ©cupÃ©rer toutes les factures
   * 2. Stocker dans this.invoices
   * 3. Appliquer filtres de recherche (numÃ©ro, client, nom devis, insensible Ã  la casse)
   * 4. Appliquer filtre de statut (exact)
   * 5. Si aucune facture : afficher message "Aucune facture trouvÃ©e"
   * 6. Sinon : gÃ©nÃ©rer HTML avec renderInvoiceRow() pour chaque facture
   * 7. Injecter dans le tbody de la table
   * 8. Ã‰mettre Ã©vÃ©nement 'invoices:loaded'
   *
   * @async
   * @param {string} [searchText=''] - Texte de recherche (numÃ©ro, client, devis)
   * @param {string} [statusFilter=''] - Filtre de statut ('Ã _payer', 'Ã©chue', etc.)
   * @returns {Promise&lt;void>}
   *
   * @fires invoices:loaded - Ã‰mis quand les factures sont chargÃ©es avec succÃ¨s
   *
   * @example
   * // Charger toutes les factures
   * await invoicesModule.loadInvoices();
   *
   * @example
   * // Charger uniquement les factures Ã©chues contenant "Dupont"
   * await invoicesModule.loadInvoices('Dupont', 'Ã©chue');
   */
  loadInvoices = async (searchText = '', statusFilter = '') => {
    try {
      const result = await this.invoke('list-invoices');

      if (!result.success) {
        NotificationSystem.error('Erreur lors du chargement des factures');
        return;
      }

      let invoices = result.invoices || [];
      this.invoices = invoices;

      const tableBody = this.getElement('#invoices-table-body');
      if (!tableBody) {
        this.log('Invoices table body not found');
        return;
      }

      // Appliquer les filtres
      if (searchText) {
        const search = searchText.toLowerCase();
        invoices = invoices.filter(inv =>
          (inv.number &amp;&amp; inv.number.toLowerCase().includes(search)) ||
          (inv.clientInfo &amp;&amp; inv.clientInfo.name &amp;&amp; inv.clientInfo.name.toLowerCase().includes(search)) ||
          (inv.quoteName &amp;&amp; inv.quoteName.toLowerCase().includes(search))
        );
      }

      if (statusFilter) {
        invoices = invoices.filter(inv => (inv.status || 'Ã _payer') === statusFilter);
      }

      // Mettre Ã  jour les infos de pagination
      this.pagination.totalItems = invoices.length;
      this.pagination.totalPages = Math.ceil(invoices.length / this.pagination.itemsPerPage);

      // S'assurer que currentPage est dans les limites
      if (this.pagination.currentPage > this.pagination.totalPages) {
        this.pagination.currentPage = this.pagination.totalPages || 1;
      }

      // Calculer les indices de dÃ©but et fin pour la page actuelle
      const startIndex = (this.pagination.currentPage - 1) * this.pagination.itemsPerPage;
      const endIndex = startIndex + this.pagination.itemsPerPage;
      const paginatedInvoices = invoices.slice(startIndex, endIndex);

      // Afficher les rÃ©sultats
      if (invoices.length === 0) {
        tableBody.innerHTML = '&lt;tr>&lt;td colspan="9" class="text-center">Aucune facture trouvÃ©e&lt;/td>&lt;/tr>';
      } else {
        tableBody.innerHTML = paginatedInvoices.map(invoice => this.renderInvoiceRow(invoice)).join('');
      }

      // Mettre Ã  jour les contrÃ´les de pagination
      this.updatePaginationControls(invoices.length, paginatedInvoices);

      // Mettre Ã  jour les compteurs dans le filtre de statut
      this.updateStatusFilterCounts();

      // Ã‰mettre Ã©vÃ©nement
      this.emitEvent('loaded', paginatedInvoices);

      this.log(`Invoices loaded: ${paginatedInvoices.length}/${invoices.length} items (page ${this.pagination.currentPage}/${this.pagination.totalPages})`);
    } catch (error) {
      this.error('Error loading invoices:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  /**
   * Met Ã  jour les compteurs dans le menu dÃ©roulant de filtrage par statut.
   * Compte le nombre de factures pour chaque statut et met Ã  jour les labels des options.
   */
  updateStatusFilterCounts() {
    if (!this.invoices) return;

    // Compter les factures par statut
    const counts = {
      'Ã _payer': 0,
      'payÃ©e': 0
    };

    this.invoices.forEach(invoice => {
      const status = invoice.status || 'Ã _payer';
      if (counts[status] !== undefined) {
        counts[status]++;
      }
    });

    // Mettre Ã  jour les labels des options
    const filterSelect = document.getElementById('invoices-status-filter');
    if (filterSelect) {
      const options = filterSelect.querySelectorAll('option');
      options.forEach(option => {
        const value = option.value;
        if (value === 'Ã _payer') {
          option.textContent = `Ã€ payer (${counts['Ã _payer']})`;
        } else if (value === 'payÃ©e') {
          option.textContent = `PayÃ©e (${counts['payÃ©e']})`;
        } else if (value === '') {
          const total = counts['Ã _payer'] + counts['payÃ©e'];
          option.textContent = `Tous les statuts (${total})`;
        }
      });
    }
  }

  /**
   * GÃ©nÃ¨re le HTML d'une ligne de facture pour le tableau.
   *
   * Colonnes affichÃ©es :
   * - NumÃ©ro de facture (gras)
   * - Nom du devis source
   * - Nom du client
   * - Date d'Ã©mission (format franÃ§ais)
   * - Date d'Ã©chÃ©ance (format franÃ§ais)
   * - Total TTC (formatÃ© en devise)
   * - Badge de statut (couleur selon statut)
   * - Boutons d'action (selon statut)
   *
   * Boutons selon statut :
   * - **Ã€ payer / Ã‰chue** : Export PDF, Imprimer, Envoyer email, Marquer payÃ©e, Supprimer
   * - **PayÃ©e** : Export PDF, Imprimer, Supprimer
   * - **Litige** : Export PDF, Imprimer, Envoyer email, Supprimer
   * - **AnnulÃ©e** : Export PDF, Supprimer
   *
   * @param {Object} invoice - DonnÃ©es de la facture
   * @param {string} invoice.id - ID de la facture
   * @param {string} invoice.number - NumÃ©ro de facture
   * @param {string} invoice.quoteName - Nom du devis source
   * @param {Object} invoice.clientInfo - Informations client
   * @param {string} invoice.issueDate - Date d'Ã©mission (ISO string)
   * @param {string} invoice.dueDate - Date d'Ã©chÃ©ance (ISO string)
   * @param {Object} invoice.totals - Totaux {totalHT, totalTVA, totalTTC}
   * @param {string} invoice.status - Statut de la facture
   * @returns {string} HTML de la ligne &lt;tr> avec donnÃ©es et boutons
   *
   * @example
   * const invoice = {
   *   id: 'invoice_123',
   *   number: 'FAC-20250115-0001',
   *   quoteName: 'Devis Client ABC',
   *   clientInfo: { name: 'ABC Corp' },
   *   issueDate: '2025-01-15T00:00:00Z',
   *   dueDate: '2025-02-14T00:00:00Z',
   *   totals: { totalTTC: 1500.00 },
   *   status: 'Ã _payer'
   * };
   * const html = invoicesModule.renderInvoiceRow(invoice);
   * // â†’ &lt;tr>...donnÃ©es et boutons...&lt;/tr>
   */
  renderInvoiceRow(invoice) {
    const status = invoice.status || 'Ã _payer';
    const statusBadge = this.getInvoiceStatusBadge(status);

    // Boutons d'action
    let actionButtons = `
      &lt;button class="btn btn-primary btn-icon" onclick="exportInvoicePDF('${invoice.id}')" data-bs-toggle="tooltip" title="Exporter PDF">&lt;i class="fas fa-file-pdf">&lt;/i>&lt;/button>
    `;

    // Bouton imprimer (pas pour factures annulÃ©es)
    if (!['annulÃ©e'].includes(status)) {
      actionButtons += `&lt;button class="btn btn-primary btn-icon" onclick="printInvoice('${invoice.id}')" data-bs-toggle="tooltip" title="Imprimer">&lt;i class="fas fa-print">&lt;/i>&lt;/button>`;
    }

    // Bouton envoyer (pour factures Ã  payer, Ã©chues ou en litige)
    if (['Ã _payer', 'Ã©chue', 'litige'].includes(status)) {
      actionButtons += `&lt;button class="btn btn-warning btn-icon" onclick="sendInvoiceEmail('${invoice.id}')" data-bs-toggle="tooltip" title="Envoyer par Email">&lt;i class="fas fa-envelope">&lt;/i>&lt;/button>`;
    }

    // Bouton marquer payÃ©e (pour factures Ã  payer ou Ã©chues)
    if (['Ã _payer', 'Ã©chue'].includes(status)) {
      actionButtons += `&lt;button class="btn btn-success btn-icon" onclick="askMarkInvoicePaid('${invoice.id}')" data-bs-toggle="tooltip" title="Marquer comme payÃ©e">&lt;i class="fas fa-check-circle">&lt;/i>&lt;/button>`;
    }

    // Bouton supprimer (toujours disponible, avec confirmation)
    actionButtons += `&lt;button class="btn btn-danger btn-icon" onclick="askDeleteInvoice('${invoice.id}', '${TextFormatter.escapeHtml(invoice.number)}')" data-bs-toggle="tooltip" title="Supprimer">&lt;i class="fas fa-trash-alt">&lt;/i>&lt;/button>`;

    return `
      &lt;tr>
        &lt;td>
          &lt;input type="checkbox" class="form-check-input invoice-bulk-checkbox" data-id="${invoice.id}">
        &lt;/td>
        &lt;td>&lt;strong>${TextFormatter.escapeHtml(invoice.number)}&lt;/strong>&lt;/td>
        &lt;td>${TextFormatter.escapeHtml(invoice.quoteName)}&lt;/td>
        &lt;td>${TextFormatter.escapeHtml(invoice.clientInfo.name)}&lt;/td>
        &lt;td>${DateFormatter.toFrench(invoice.issueDate)}&lt;/td>
        &lt;td>${DateFormatter.toFrench(invoice.dueDate)}&lt;/td>
        &lt;td>${CurrencyFormatter.format(invoice.totals.totalTTC)}&lt;/td>
        &lt;td>${statusBadge}&lt;/td>
        &lt;td>
          ${actionButtons}
        &lt;/td>
      &lt;/tr>
    `;
  }

  /**
   * Retourne le badge HTML Bootstrap pour un statut de facture.
   *
   * Statuts supportÃ©s (avec couleurs) :
   * - **Ã _payer** â†’ Jaune (bg-warning text-dark)
   * - **Ã©chue** â†’ Rouge (bg-danger)
   * - **payÃ©e** â†’ Vert (bg-success)
   * - **litige** â†’ Rouge (bg-danger)
   * - **annulÃ©e** â†’ Gris (bg-secondary)
   *
   * @param {string} status - Statut de la facture
   * @returns {string} HTML du badge &lt;span class="badge ...">Label&lt;/span>
   *
   * @example
   * const badge = invoicesModule.getInvoiceStatusBadge('payÃ©e');
   * // â†’ '&lt;span class="badge bg-success">PayÃ©e&lt;/span>'
   */
  getInvoiceStatusBadge = (status) => {
    const config = this.statusConfig[status] || { label: status, class: 'bg-secondary' };
    return `&lt;span class="badge ${config.class}">${config.label}&lt;/span>`;
  };

  // ==========================================
  // GESTION DES PAIEMENTS
  // ==========================================

  /**
   * Demande le marquage d'une facture comme payÃ©e.
   *
   * **ADMIN UNIQUEMENT** - NÃ©cessite l'authentification Admin.
   *
   * Workflow :
   * 1. VÃ©rifier l'authentification Admin (isAuthenticated)
   * 2. Si non authentifiÃ© : notification + arrÃªt
   * 3. Charger la liste des factures via IPC 'list-invoices'
   * 4. Trouver la facture par ID
   * 5. Si non trouvÃ©e : notification erreur + arrÃªt
   * 6. Stocker la facture dans this.currentInvoiceForPayment
   * 7. Remplir le modal de paiement :
   *    - NumÃ©ro de facture
   *    - Date de paiement (par dÃ©faut aujourd'hui)
   *    - MÃ©thode de paiement (par dÃ©faut "virement")
   *    - Notes (vide)
   * 8. Afficher le modal Bootstrap
   *
   * L'utilisateur peut ensuite remplir le formulaire et confirmer (â†’ confirmMarkInvoicePaid) ou annuler.
   *
   * @async
   * @param {string} invoiceId - ID de la facture Ã  marquer comme payÃ©e
   * @returns {Promise&lt;void>}
   *
   * @example
   * await invoicesModule.askMarkInvoicePaid('invoice_123');
   * // â†’ Modal s'affiche avec formulaire de paiement
   */
  askMarkInvoicePaid = async (invoiceId) => {
    try {
      // VÃ©rifier l'authentification admin
      if (!this.isAuthenticated()) {
        NotificationSystem.warning('Mode Administrateur requis pour marquer une facture comme payÃ©e');
        return;
      }

      // Charger la facture pour obtenir ses informations
      const result = await this.invoke('list-invoices');

      if (!result.success) {
        NotificationSystem.error('Erreur lors du chargement de la facture');
        return;
      }

      const invoice = result.invoices.find(inv => inv.id === invoiceId);
      if (!invoice) {
        NotificationSystem.error('Facture introuvable');
        return;
      }

      this.currentInvoiceForPayment = invoice;

      // Remplir le modal
      const paidInvoiceNumberEl = this.getElement('#paid-invoice-number');
      if (paidInvoiceNumberEl) paidInvoiceNumberEl.textContent = invoice.number;

      this.setValue('#payment-date-input', new Date().toISOString().split('T')[0]);
      this.setValue('#payment-method-select', 'virement');
      this.setValue('#payment-notes-input', '');

      // Afficher le modal
      const modalElement = this.getElement('#markInvoicePaidModal');
      if (modalElement) {
        modalElement.removeAttribute('inert');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
    } catch (error) {
      this.error('Error opening payment modal:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  /**
   * Confirme le marquage de la facture comme payÃ©e.
   *
   * Workflow :
   * 1. RÃ©cupÃ©rer authToken (getSessionToken)
   * 2. VÃ©rifier qu'il existe (sinon erreur)
   * 3. VÃ©rifier que this.currentInvoiceForPayment est dÃ©fini
   * 4. RÃ©cupÃ©rer les valeurs du formulaire :
   *    - Date de paiement (obligatoire)
   *    - MÃ©thode de paiement (virement, chÃ¨que, espÃ¨ces, carte, autre)
   *    - Notes (optionnel)
   * 5. Valider la date de paiement (non vide)
   * 6. Appeler IPC 'mark-invoice-paid' avec authToken + {invoiceId, paymentDate, paymentMethod, notes}
   * 7. Si succÃ¨s :
   *    - Notification de succÃ¨s
   *    - Fermer le modal
   *    - Ã‰mettre Ã©vÃ©nement 'invoices:paid'
   *    - Attendre 300ms
   *    - RafraÃ®chir la liste des factures
   * 8. RÃ©initialiser this.currentInvoiceForPayment
   *
   * @async
   * @returns {Promise&lt;void>}
   *
   * @fires invoices:paid - Ã‰mis quand la facture est marquÃ©e comme payÃ©e avec succÃ¨s
   *
   * @example
   * // Utilisateur remplit le formulaire et confirme
   * await invoicesModule.confirmMarkInvoicePaid();
   * // â†’ Facture marquÃ©e payÃ©e, liste rafraÃ®chie
   */
  confirmMarkInvoicePaid = async () => {
    try {
      const authToken = this.getSessionToken();
      if (!authToken) {
        NotificationSystem.error('Vous devez Ãªtre connectÃ© pour marquer une facture comme payÃ©e');
        return;
      }

      if (!this.currentInvoiceForPayment) return;

      const paymentDate = this.getValue('#payment-date-input');
      const paymentMethod = this.getValue('#payment-method-select');
      const notes = this.getValue('#payment-notes-input');

      if (!paymentDate) {
        NotificationSystem.error('Veuillez saisir la date de paiement');
        return;
      }

      // ðŸ”„ Sauvegarder l'Ã©tat avant pour Undo/Redo
      const invoiceCopy = { ...this.currentInvoiceForPayment };
      const paymentData = {
        invoiceId: this.currentInvoiceForPayment.id,
        paymentDate: new Date(paymentDate).toISOString(),
        paymentMethod,
        notes
      };

      // Appeler l'IPC pour marquer comme payÃ©e
      const result = await this.invoke('mark-invoice-paid', authToken, paymentData);

      if (result.success) {
        NotificationSystem.success(`Facture ${this.currentInvoiceForPayment.number} marquÃ©e comme payÃ©e`);

        // ðŸ”„ Enregistrer l'action Undo/Redo
        if (window.UndoRedoManager) {
          window.UndoRedoManager.record({
            type: 'INVOICE_MARK_PAID',
            description: `Marquage facture ${invoiceCopy.number} comme payÃ©e`,
            undo: async () => {
              // Remettre la facture comme non payÃ©e
              await this.invoke('mark-invoice-unpaid', authToken, invoiceCopy.id);
              await this.loadInvoices();
            },
            redo: async () => {
              // Remettre comme payÃ©e
              await this.invoke('mark-invoice-paid', authToken, paymentData);
              await this.loadInvoices();
            }
          });
        }

        // Fermer le modal
        const modalElement = this.getElement('#markInvoicePaidModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) modal.hide();
        if (modalElement) modalElement.setAttribute('inert', '');

        // Ã‰mettre Ã©vÃ©nement
        this.emitEvent('paid', this.currentInvoiceForPayment);

        // RafraÃ®chir la liste
        setTimeout(async () => {
          await this.loadInvoices();
        }, 300);
      } else {
        NotificationSystem.error('Erreur lors de la mise Ã  jour de la facture');
      }

      this.currentInvoiceForPayment = null;
    } catch (error) {
      this.error('Error marking invoice as paid:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  // ==========================================
  // SUPPRESSION DE FACTURES
  // ==========================================

  /**
   * Demande confirmation avant de supprimer une facture.
   *
   * Workflow :
   * 1. Stocker {id, number} dans this.invoiceToDelete
   * 2. Mettre Ã  jour le texte du modal avec le numÃ©ro de facture
   * 3. Afficher le modal Bootstrap de confirmation
   *
   * L'utilisateur peut ensuite confirmer (â†’ confirmDeleteInvoice) ou annuler.
   *
   * @param {string} invoiceId - ID de la facture Ã  supprimer
   * @param {string} invoiceNumber - NumÃ©ro de la facture (pour affichage dans le modal)
   * @returns {void}
   *
   * @example
   * invoicesModule.askDeleteInvoice('invoice_123', 'FAC-20250115-0001');
   * // â†’ Modal de confirmation s'affiche : "Supprimer 'FAC-20250115-0001' ?"
   */
  askDeleteInvoice = (invoiceId, invoiceNumber) => {
    this.invoiceToDelete = { id: invoiceId, number: invoiceNumber };

    const deleteInvoiceNumberEl = this.getElement('#delete-invoice-number');
    if (deleteInvoiceNumberEl) deleteInvoiceNumberEl.textContent = invoiceNumber;

    const modalElement = this.getElement('#deleteInvoiceModal');
    if (modalElement) {
      modalElement.removeAttribute('inert');
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    }
  };

  /**
   * Confirme et supprime la facture.
   *
   * Workflow :
   * 1. RÃ©cupÃ©rer authToken (getSessionToken)
   * 2. VÃ©rifier qu'il existe (sinon erreur)
   * 3. VÃ©rifier que this.invoiceToDelete est dÃ©fini
   * 4. Appeler IPC 'delete-invoice' avec authToken + invoiceId
   * 5. Si succÃ¨s :
   *    - Notification de succÃ¨s
   *    - Fermer le modal
   *    - Ã‰mettre Ã©vÃ©nement 'invoices:deleted'
   *    - Attendre 300ms
   *    - RafraÃ®chir la liste des factures
   * 6. RÃ©initialiser this.invoiceToDelete
   *
   * @async
   * @returns {Promise&lt;void>}
   *
   * @fires invoices:deleted - Ã‰mis quand la facture est supprimÃ©e avec succÃ¨s
   *
   * @example
   * // Utilisateur confirme la suppression
   * await invoicesModule.confirmDeleteInvoice();
   * // â†’ Facture supprimÃ©e, liste rafraÃ®chie
   */
  confirmDeleteInvoice = async () => {
    try {
      const authToken = this.getSessionToken();
      if (!authToken) {
        NotificationSystem.error('Vous devez Ãªtre connectÃ© pour supprimer une facture');
        return;
      }

      if (!this.invoiceToDelete) return;

      // ðŸ”„ Sauvegarder la facture pour Undo/Redo
      const invoiceCopy = { ...this.invoiceToDelete };

      const result = await this.invoke('delete-invoice', authToken, this.invoiceToDelete.id);

      if (result.success) {
        NotificationSystem.success(`Facture ${this.invoiceToDelete.number} supprimÃ©e`);

        // ðŸ”„ Enregistrer l'action Undo/Redo
        if (window.UndoRedoManager) {
          window.UndoRedoManager.record({
            type: 'INVOICE_DELETE',
            description: `Suppression facture ${invoiceCopy.number}`,
            undo: async () => {
              // Restaurer la facture (via create-invoice avec donnÃ©es existantes)
              await this.invoke('create-invoice', authToken, {
                quoteId: invoiceCopy.quoteId,
                invoiceData: invoiceCopy
              });
              await this.loadInvoices();
            },
            redo: async () => {
              await this.invoke('delete-invoice', authToken, invoiceCopy.id);
              await this.loadInvoices();
            }
          });
        }

        // Fermer le modal
        const modalElement = this.getElement('#deleteInvoiceModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) modal.hide();
        if (modalElement) modalElement.setAttribute('inert', '');

        // Ã‰mettre Ã©vÃ©nement
        this.emitEvent('deleted', this.invoiceToDelete.id);

        // RafraÃ®chir la liste
        setTimeout(async () => {
          await this.loadInvoices();
        }, 300);
      } else {
        NotificationSystem.error('Erreur lors de la suppression');
      }

      this.invoiceToDelete = null;
    } catch (error) {
      this.error('Error deleting invoice:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  // ==========================================
  // EXPORT / IMPRESSION / EMAIL
  // ==========================================

  /**
   * Exporte une facture en PDF.
   *
   * Workflow :
   * 1. Charger la facture via IPC 'load-invoice'
   * 2. Si erreur : notification + arrÃªt
   * 3. GÃ©nÃ©rer le PDF via window.generateInvoicePDFDocument(invoice)
   * 4. Si fonction non disponible : notification erreur + arrÃªt
   * 5. TÃ©lÃ©charger le fichier : facture_{numÃ©ro}_{client}.pdf
   * 6. Notification de succÃ¨s
   * 7. Ã‰mettre Ã©vÃ©nement 'invoices:exported'
   *
   * Utilise la fonction existante window.generateInvoicePDFDocument pour
   * garantir la compatibilitÃ© avec le reste de l'application.
   *
   * @async
   * @param {string} invoiceId - ID de la facture Ã  exporter
   * @returns {Promise&lt;void>}
   *
   * @fires invoices:exported - Ã‰mis quand le PDF est exportÃ© avec succÃ¨s
   *
   * @example
   * await invoicesModule.exportInvoicePDF('invoice_123');
   * // â†’ Fichier "facture_FAC-20250115-0001_ABC_Corp.pdf" tÃ©lÃ©chargÃ©
   */
  exportInvoicePDF = async (invoiceId) => {
    try {
      const result = await this.invoke('load-invoice', invoiceId);
      if (!result.success) {
        NotificationSystem.error('Impossible de charger la facture');
        return;
      }

      const invoice = result.invoice;

      // Utiliser la fonction existante (wrapper pour compatibilitÃ©)
      if (typeof window.generateInvoicePDFDocument === 'function') {
        const doc = await window.generateInvoicePDFDocument(invoice);
        if (!doc) return;

        const filename = `facture_${invoice.number}_${invoice.clientInfo.name || 'client'}.pdf`;
        doc.save(filename);
        NotificationSystem.success('Facture PDF exportÃ©e avec succÃ¨s');

        // Ã‰mettre Ã©vÃ©nement
        this.emitEvent('exported', invoiceId);
      } else {
        NotificationSystem.error('Fonction de gÃ©nÃ©ration PDF non disponible');
      }
    } catch (error) {
      this.error('Error exporting invoice PDF:', error);
      NotificationSystem.error(`Erreur export PDF : ${error.message}`);
    }
  };

  /**
   * Imprime une facture.
   *
   * Workflow :
   * 1. Charger la facture via IPC 'load-invoice'
   * 2. Si erreur : notification + arrÃªt
   * 3. GÃ©nÃ©rer le PDF via window.generateInvoicePDFDocument(invoice)
   * 4. Si fonction non disponible : notification erreur + arrÃªt
   * 5. Extraire les donnÃ©es base64 du PDF
   * 6. Appeler IPC 'print-pdf' avec les donnÃ©es base64
   * 7. Si succÃ¨s : notification + Ã©vÃ©nement 'invoices:printed'
   * 8. Si Ã©chec : notification erreur
   *
   * @async
   * @param {string} invoiceId - ID de la facture Ã  imprimer
   * @returns {Promise&lt;void>}
   *
   * @fires invoices:printed - Ã‰mis quand l'impression est lancÃ©e avec succÃ¨s
   *
   * @example
   * await invoicesModule.printInvoice('invoice_123');
   * // â†’ Impression lancÃ©e
   */
  printInvoice = async (invoiceId) => {
    try {
      const result = await this.invoke('load-invoice', invoiceId);
      if (!result.success) {
        NotificationSystem.error('Impossible de charger la facture');
        return;
      }

      const invoice = result.invoice;

      // Utiliser la fonction existante (wrapper pour compatibilitÃ©)
      if (typeof window.generateInvoicePDFDocument === 'function') {
        const doc = await window.generateInvoicePDFDocument(invoice);
        if (!doc) return;

        const pdfBase64 = doc.output('datauristring').split(',')[1];
        const printResult = await this.invoke('print-pdf', pdfBase64);

        if (printResult.success) {
          NotificationSystem.success('Impression lancÃ©e');

          // Ã‰mettre Ã©vÃ©nement
          this.emitEvent('printed', invoiceId);
        } else {
          NotificationSystem.error('Erreur lors de l\'impression');
        }
      } else {
        NotificationSystem.error('Fonction de gÃ©nÃ©ration PDF non disponible');
      }
    } catch (error) {
      this.error('Error printing invoice:', error);
      NotificationSystem.error(`Erreur impression : ${error.message}`);
    }
  };

  /**
   * Envoie une facture par email au client.
   *
   * **ADMIN UNIQUEMENT** - NÃ©cessite authToken.
   *
   * Workflow :
   * 1. RÃ©cupÃ©rer authToken (getSessionToken)
   * 2. Si non authentifiÃ© : notification erreur + arrÃªt
   * 3. Charger la facture via IPC 'load-invoice'
   * 4. Si erreur : notification + arrÃªt
   * 5. VÃ©rifier que l'email client est renseignÃ©
   * 6. Si non renseignÃ© : notification erreur + arrÃªt
   * 7. GÃ©nÃ©rer le PDF via window.generateInvoicePDFDocument(invoice)
   * 8. Si fonction non disponible : notification erreur + arrÃªt
   * 9. Convertir le PDF en Blob
   * 10. Lire le Blob en base64 via FileReader
   * 11. PrÃ©parer les donnÃ©es email :
   *     - to: email du client
   *     - subject: "Facture {numÃ©ro}"
   *     - body: message standard
   *     - attachmentName: facture_{numÃ©ro}.pdf
   *     - attachmentData: base64
   * 12. Appeler IPC 'send-email' avec authToken + emailData
   * 13. Si succÃ¨s : notification + Ã©vÃ©nement 'invoices:emailed'
   * 14. Si Ã©chec : notification erreur
   *
   * @async
   * @param {string} invoiceId - ID de la facture Ã  envoyer
   * @returns {Promise&lt;void>}
   *
   * @fires invoices:emailed - Ã‰mis quand l'email est envoyÃ© avec succÃ¨s
   *
   * @example
   * await invoicesModule.sendInvoiceEmail('invoice_123');
   * // â†’ Email envoyÃ© Ã  client@example.com avec facture en piÃ¨ce jointe
   */
  sendInvoiceEmail = async (invoiceId) => {
    const authToken = this.getSessionToken();
    if (!authToken) {
      NotificationSystem.error('Vous devez Ãªtre connectÃ© pour envoyer un email');
      return;
    }

    try {
      const result = await this.invoke('load-invoice', invoiceId);
      if (!result.success) {
        NotificationSystem.error('Impossible de charger la facture');
        return;
      }

      const invoice = result.invoice;

      if (!invoice.clientInfo.email) {
        NotificationSystem.error('Email client non renseignÃ©');
        return;
      }

      // Utiliser la fonction existante (wrapper pour compatibilitÃ©)
      if (typeof window.generateInvoicePDFDocument === 'function') {
        const doc = await window.generateInvoicePDFDocument(invoice);
        if (!doc) return;

        const pdfBlob = doc.output('blob');
        const reader = new FileReader();

        reader.onloadend = async () => {
          try {
            const base64Data = reader.result.split(',')[1];

            const emailData = {
              to: invoice.clientInfo.email,
              subject: `Facture ${invoice.number}`,
              body: `Bonjour,\n\nVeuillez trouver ci-joint la facture ${invoice.number}.\n\nCordialement`,
              attachmentName: `facture_${invoice.number}.pdf`,
              attachmentData: base64Data
            };

            const sendResult = await this.invoke('send-email', authToken, emailData);

            if (sendResult.success) {
              NotificationSystem.success('Email envoyÃ© avec succÃ¨s');

              // Ã‰mettre Ã©vÃ©nement
              this.emitEvent('emailed', invoiceId);
            } else {
              NotificationSystem.error(`Erreur envoi email: ${sendResult.message}`);
            }
          } catch (error) {
            this.error('Error sending email:', error);
            NotificationSystem.error(`Erreur envoi email : ${error.message}`);
          }
        };

        reader.readAsDataURL(pdfBlob);
      } else {
        NotificationSystem.error('Fonction de gÃ©nÃ©ration PDF non disponible');
      }
    } catch (error) {
      this.error('Error sending invoice email:', error);
      NotificationSystem.error(`Erreur envoi email : ${error.message}`);
    }
  };

  // ==========================================
  // PAGINATION
  // ==========================================

  /**
   * Change de page (prÃ©cÃ©dent/suivant).
   * @param {number} direction - Direction (-1 pour prÃ©cÃ©dent, +1 pour suivant)
   * @private
   */
  changePage(direction) {
    const newPage = this.pagination.currentPage + direction;
    if (newPage >= 1 &amp;&amp; newPage &lt;= this.pagination.totalPages) {
      this.pagination.currentPage = newPage;
      const searchText = this.getValue('#invoices-search-input') || '';
      const statusFilter = this.getValue('#invoices-status-filter') || '';
      this.loadInvoices(searchText, statusFilter);
    }
  }

  /**
   * Va Ã  une page spÃ©cifique.
   * @param {number} pageNumber - NumÃ©ro de page (1-indexed)
   * @private
   */
  goToPage(pageNumber) {
    if (pageNumber >= 1 &amp;&amp; pageNumber &lt;= this.pagination.totalPages) {
      this.pagination.currentPage = pageNumber;
      const searchText = this.getValue('#invoices-search-input') || '';
      const statusFilter = this.getValue('#invoices-status-filter') || '';
      this.loadInvoices(searchText, statusFilter);
    }
  }

  /**
   * Met Ã  jour les contrÃ´les de pagination (info et boutons).
   * @param {number} totalItems - Nombre total d'items
   * @param {Array} displayedItems - Items affichÃ©s sur la page actuelle
   * @private
   */
  updatePaginationControls(totalItems, displayedItems) {
    // Mettre Ã  jour l'info de pagination
    const paginationInfo = this.getElement('#invoices-pagination-info');
    if (paginationInfo) {
      if (totalItems === 0) {
        paginationInfo.textContent = 'Aucune facture';
      } else {
        const startIndex = (this.pagination.currentPage - 1) * this.pagination.itemsPerPage + 1;
        const endIndex = startIndex + displayedItems.length - 1;
        paginationInfo.textContent = `Affichage ${startIndex}-${endIndex} sur ${totalItems} factures`;
      }
    }

    // Mettre Ã  jour les boutons de pagination
    const paginationControls = this.getElement('#invoices-pagination-controls');
    if (paginationControls &amp;&amp; totalItems > 0) {
      const prevDisabled = this.pagination.currentPage === 1 ? 'disabled' : '';
      const nextDisabled = this.pagination.currentPage === this.pagination.totalPages ? 'disabled' : '';

      // GÃ©nÃ©rer les numÃ©ros de page (max 5 pages visibles)
      const pageNumbers = this.generatePageNumbers();

      paginationControls.innerHTML = `
        &lt;button class="btn btn-sm btn-outline-primary" ${prevDisabled} onclick="window.invoicesModule.changePage(-1)">
          &lt;i class="fas fa-chevron-left">&lt;/i> PrÃ©cÃ©dent
        &lt;/button>
        ${pageNumbers.map(page => {
          if (page === '...') {
            return '&lt;span class="mx-1">...&lt;/span>';
          }
          const active = page === this.pagination.currentPage ? 'btn-primary' : 'btn-outline-primary';
          return `&lt;button class="btn btn-sm ${active}" onclick="window.invoicesModule.goToPage(${page})">${page}&lt;/button>`;
        }).join('')}
        &lt;button class="btn btn-sm btn-outline-primary" ${nextDisabled} onclick="window.invoicesModule.changePage(1)">
          Suivant &lt;i class="fas fa-chevron-right">&lt;/i>
        &lt;/button>
      `;
    } else if (paginationControls) {
      paginationControls.innerHTML = '';
    }
  }

  /**
   * GÃ©nÃ¨re les numÃ©ros de page Ã  afficher (max 5 pages visibles avec ellipses).
   * @returns {Array} - Array de numÃ©ros de page et ellipses
   * @private
   */
  generatePageNumbers() {
    const pages = [];
    const total = this.pagination.totalPages;
    const current = this.pagination.currentPage;

    if (total &lt;= 7) {
      // Afficher toutes les pages si &lt;= 7
      for (let i = 1; i &lt;= total; i++) {
        pages.push(i);
      }
    } else {
      // Toujours afficher la premiÃ¨re page
      pages.push(1);

      if (current > 3) {
        pages.push('...');
      }

      // Afficher les pages autour de la page courante
      const start = Math.max(2, current - 1);
      const end = Math.min(total - 1, current + 1);

      for (let i = start; i &lt;= end; i++) {
        pages.push(i);
      }

      if (current &lt; total - 2) {
        pages.push('...');
      }

      // Toujours afficher la derniÃ¨re page
      pages.push(total);
    }

    return pages;
  }

  // ==========================================
  // OPÃ‰RATIONS BULK (SÃ‰LECTION MULTIPLE)
  // ==========================================

  /**
   * Supprime plusieurs factures en une seule opÃ©ration.
   *
   * **ADMIN UNIQUEMENT** - NÃ©cessite authToken.
   *
   * Workflow :
   * 1. VÃ©rifier l'authentification Admin (getSessionToken)
   * 2. Si non authentifiÃ© : erreur + arrÃªt
   * 3. Pour chaque invoiceId :
   *    - Appeler IPC 'delete-invoice' avec authToken + invoiceId
   * 4. Collecter les succÃ¨s et Ã©checs
   * 5. Si succÃ¨s : notification + rafraÃ®chir liste
   * 6. Retourner les rÃ©sultats pour Undo/Redo
   *
   * @async
   * @param {Array&lt;string>} invoiceIds - Liste des IDs de factures Ã  supprimer
   * @returns {Promise&lt;Object>} RÃ©sultat de l'opÃ©ration {deletedItems, undoCallback, redoCallback}
   *
   * @example
   * await invoicesModule.bulkDeleteInvoices(['invoice_123', 'invoice_456']);
   * // â†’ 2 factures supprimÃ©es
   */
  bulkDeleteInvoices = async (invoiceIds) => {
    try {
      const authToken = this.getSessionToken();
      if (!authToken) {
        NotificationSystem.error('Vous devez Ãªtre connectÃ© pour supprimer des factures');
        throw new Error('Not authenticated');
      }

      const deletedItems = [];
      const failedItems = [];

      // Sauvegarder les factures avant suppression pour Undo
      const invoicesToDelete = this.invoices.filter(inv => invoiceIds.includes(inv.id));

      // Supprimer chaque facture
      for (const invoiceId of invoiceIds) {
        try {
          const result = await this.invoke('delete-invoice', authToken, invoiceId);
          if (result.success) {
            deletedItems.push(invoiceId);
          } else {
            failedItems.push(invoiceId);
          }
        } catch (error) {
          this.error(`Error deleting invoice ${invoiceId}:`, error);
          failedItems.push(invoiceId);
        }
      }

      // Notification selon le rÃ©sultat
      if (deletedItems.length > 0) {
        NotificationSystem.success(`${deletedItems.length} facture(s) supprimÃ©e(s) avec succÃ¨s`);

        // Ã‰mettre Ã©vÃ©nement
        this.emitEvent('bulk-deleted', deletedItems);

        // RafraÃ®chir la liste
        setTimeout(async () => {
          await this.loadInvoices();
        }, 300);
      }

      if (failedItems.length > 0) {
        NotificationSystem.warning(`${failedItems.length} facture(s) n'ont pas pu Ãªtre supprimÃ©e(s)`);
      }

      // Retourner les rÃ©sultats pour Undo/Redo
      return {
        deletedItems: invoicesToDelete,
        undoCallback: async () => {
          // Restaurer les factures supprimÃ©es
          for (const invoice of invoicesToDelete) {
            await this.invoke('create-invoice', authToken, {
              quoteId: invoice.quoteId,
              invoiceData: invoice
            });
          }
          await this.loadInvoices();
        },
        redoCallback: async () => {
          // Re-supprimer les factures
          for (const invoiceId of deletedItems) {
            await this.invoke('delete-invoice', authToken, invoiceId);
          }
          await this.loadInvoices();
        }
      };

    } catch (error) {
      this.error('Error in bulkDeleteInvoices:', error);
      NotificationSystem.error(`Erreur lors de la suppression groupÃ©e : ${error.message}`);
      throw error;
    }
  };

  /**
   * Exporte plusieurs factures en CSV.
   *
   * Workflow :
   * 1. Filtrer les factures sÃ©lectionnÃ©es depuis this.invoices
   * 2. GÃ©nÃ©rer un fichier CSV avec generateCSV()
   * 3. TÃ©lÃ©charger le fichier : factures_export_YYYYMMDD.csv
   * 4. Notification de succÃ¨s
   * 5. Ã‰mettre Ã©vÃ©nement 'invoices:bulk-exported'
   *
   * @async
   * @param {Array&lt;string>} invoiceIds - Liste des IDs de factures Ã  exporter
   * @returns {Promise&lt;void>}
   *
   * @example
   * await invoicesModule.bulkExportInvoices(['invoice_123', 'invoice_456']);
   * // â†’ Fichier "factures_export_20250115.csv" tÃ©lÃ©chargÃ©
   */
  bulkExportInvoices = async (invoiceIds) => {
    try {
      // Filtrer les factures Ã  exporter
      const invoicesToExport = this.invoices.filter(inv => invoiceIds.includes(inv.id));

      if (invoicesToExport.length === 0) {
        NotificationSystem.warning('Aucune facture Ã  exporter');
        return;
      }

      // GÃ©nÃ©rer le CSV
      const csvContent = this.generateCSV(invoicesToExport);

      // CrÃ©er un Blob et tÃ©lÃ©charger
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);

      const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
      link.setAttribute('href', url);
      link.setAttribute('download', `factures_export_${today}.csv`);
      link.style.visibility = 'hidden';

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      NotificationSystem.success(`${invoicesToExport.length} facture(s) exportÃ©e(s) en CSV`);

      // Ã‰mettre Ã©vÃ©nement
      this.emitEvent('bulk-exported', invoiceIds);

    } catch (error) {
      this.error('Error in bulkExportInvoices:', error);
      NotificationSystem.error(`Erreur lors de l'export CSV : ${error.message}`);
    }
  };

  /**
   * GÃ©nÃ¨re le contenu CSV pour une liste de factures.
   *
   * Format CSV :
   * - SÃ©parateur : point-virgule (;)
   * - Encodage : UTF-8 avec BOM
   * - Colonnes : NÂ° Facture, Devis associÃ©, Client, Date Ã©mission, Date Ã©chÃ©ance, Montant HT, TVA, Montant TTC, Statut
   *
   * @param {Array&lt;Object>} invoices - Liste des factures Ã  exporter
   * @returns {string} Contenu CSV avec BOM UTF-8
   *
   * @example
   * const csv = invoicesModule.generateCSV([invoice1, invoice2]);
   * // â†’ "\uFEFFNÂ° Facture;Devis associÃ©;Client;..."
   */
  generateCSV(invoices) {
    if (!invoices || !Array.isArray(invoices) || invoices.length === 0) {
      return 'NÂ° Facture;Devis associÃ©;Client;Date Ã©mission;Date Ã©chÃ©ance;Montant HT;TVA;Montant TTC;Statut;MÃ©thode de paiement;Date de paiement';
    }

    // BOM UTF-8 pour Excel
    const BOM = '\uFEFF';

    // En-tÃªtes
    const headers = [
      'NÂ° Facture',
      'Devis associÃ©',
      'Client',
      'Date Ã©mission',
      'Date Ã©chÃ©ance',
      'Montant HT',
      'TVA',
      'Montant TTC',
      'Statut',
      'MÃ©thode de paiement',
      'Date de paiement'
    ];

    // Lignes de donnÃ©es
    const rows = invoices.map(invoice => {
      const status = invoice.status || 'Ã _payer';
      const statusLabel = this.statusConfig[status]?.label || status;

      return [
        `"${invoice.number || ''}"`,
        `"${invoice.quoteName || ''}"`,
        `"${invoice.clientInfo?.name || ''}"`,
        DateFormatter.toFrench(invoice.issueDate),
        DateFormatter.toFrench(invoice.dueDate),
        `"${invoice.totals?.totalHT?.toFixed(2) || '0.00'}"`,
        `"${invoice.totals?.totalTVA?.toFixed(2) || '0.00'}"`,
        `"${invoice.totals?.totalTTC?.toFixed(2) || '0.00'}"`,
        `"${statusLabel}"`,
        `"${invoice.paymentMethod || ''}"`,
        invoice.paymentDate ? DateFormatter.toFrench(invoice.paymentDate) : ''
      ].join(';');
    });

    // Assembler le CSV
    const csvContent = BOM + headers.join(';') + '\n' + rows.join('\n');

    return csvContent;
  }
}

export default InvoicesModule;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
