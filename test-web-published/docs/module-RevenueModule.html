<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> RevenueModule</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule.html">DashboardModule</a></li><li><a href="module-DataCache.html">DataCache</a></li><li><a href="module-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule.html">FECModule</a></li><li><a href="module-FollowUpModule.html">FollowUpModule</a></li><li><a href="module-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-KeyboardShortcutsModule.html">KeyboardShortcutsModule</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-MLService.html">MLService</a></li><li><a href="module-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-NotificationSystem.html">NotificationSystem</a></li><li><a href="module-NotificationSystemV2.html">NotificationSystemV2</a></li><li><a href="module-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-TourModule.html">TourModule</a></li><li><a href="module-UtilitiesModule.html">UtilitiesModule</a></li><li><a href="module-calculations.html">calculations</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-formatters.html">formatters</a></li><li><a href="module-helpers.html">helpers</a></li></ul><h3>Classes</h3><ul><li><a href="BaseModule.html">BaseModule</a></li><li><a href="BulkActionsManager.html">BulkActionsManager</a></li><li><a href="CacheKeys.html">CacheKeys</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="LoadingStateManager.html">LoadingStateManager</a></li><li><a href="ModalHelper.html">ModalHelper</a></li><li><a href="PaginationManager.html">PaginationManager</a></li><li><a href="ServerValidator.html">ServerValidator</a></li><li><a href="StateManager.html">StateManager</a></li><li><a href="TabRefreshManager.html">TabRefreshManager</a></li><li><a href="UndoRedoManager.html">UndoRedoManager</a></li><li><a href="module-AboutModule-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule-DashboardModule.html">DashboardModule</a></li><li><a href="module-ExportModule-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule-FECModule.html">FECModule</a></li><li><a href="module-ImportModule-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-Logger-Logger.html">Logger</a></li><li><a href="module-Logger-ModuleLogger.html">ModuleLogger</a></li><li><a href="module-MaterialsModule-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-PDFModule-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-UtilitiesModule-UtilitiesModule.html">UtilitiesModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#emitSync">emitSync</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#validateBeforeAddToQuote">validateBeforeAddToQuote</a></li><li><a href="global.html#validateBeforeExport">validateBeforeExport</a></li><li><a href="global.html#validateBeforeSaveMaterial">validateBeforeSaveMaterial</a></li><li><a href="global.html#validateBeforeSendEmail">validateBeforeSendEmail</a></li><li><a href="global.html#validateHeaderConfig">validateHeaderConfig</a></li><li><a href="global.html#validatePasswordChange">validatePasswordChange</a></li><li><a href="global.html#validateSMTPConfig">validateSMTPConfig</a></li><li><a href="global.html#waitFor">waitFor</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Module</p>
                    <h1>RevenueModule</h1>
                </header>
                




<section>

<header>
    
        
            
        
    
</header>

<article>
    <div class="container-overview">
    
        
            <div class="description"><h1>========================================
REVENUE MODULE - Chiffre d'affaires et rentabilité</h1>
<p>Module de gestion du chiffre d'affaires (CA) et de la rentabilité pour AutoCalc OptiDevis.
Permet le suivi mensuel du CA, l'analyse de rentabilité avec marges et taux de marque,
la génération de rapports PDF et l'export Excel.</p>
<p>Architecture :
Le module gère le CA et la rentabilité avec :</p>
<ul>
<li><strong>CA mensuel</strong> : Calcul automatique basé sur factures payées (paymentDate)</li>
<li><strong>Historique 12 mois</strong> : Graphique Chart.js en barres avec évolution</li>
<li><strong>KPIs de rentabilité</strong> : Marge moyenne, marge totale, taux de marque, couverture données</li>
<li><strong>Rapports PDF</strong> : Génération de rapports mensuels détaillés avec jsPDF</li>
<li><strong>Exports Excel</strong> : CA mensuel et rentabilité détaillée avec XLSX.js</li>
<li><strong>Dashboards</strong> : 3 KPIs CA + 4 KPIs rentabilité affichés dans l'UI</li>
</ul>
<h1>==========================================
CHIFFRE D'AFFAIRES (CA)</h1>
<p><strong>Définition CA</strong> :</p>
<ul>
<li>Somme des factures payées (status = 'payée')</li>
<li>Date de référence : paymentDate (pas invoiceDate)</li>
<li>Montant : totalTTC (TTC = HT + TVA)</li>
</ul>
<p><strong>Calcul mensuel</strong> :</p>
<ul>
<li>Regroupement par année-mois (ex: &quot;2025-01&quot;)</li>
<li>Pour chaque mois : totalHT, totalTVA, totalTTC, count (nombre factures)</li>
<li>Tri par ordre décroissant (mois le plus récent en premier)</li>
</ul>
<p><strong>Période affichée</strong> :</p>
<ul>
<li>12 derniers mois glissants (rolling 12 months)</li>
<li>Exemple en janvier 2025 : février 2024 → janvier 2025</li>
</ul>
<h1>==========================================
KPIs CHIFFRE D'AFFAIRES</h1>
<p><strong>1. CA Mois en Cours</strong> (#revenue-current-month) :</p>
<ul>
<li>Somme totalTTC des factures payées du mois actuel</li>
<li>Exemple : &quot;12 450,00 €&quot;</li>
<li>Période : 1er jour du mois → dernier jour du mois (#revenue-current-period)</li>
</ul>
<p><strong>2. Nombre de Factures</strong> (#revenue-invoices-count) :</p>
<ul>
<li>Nombre de factures payées dans le mois en cours</li>
<li>Exemple : &quot;24&quot;</li>
</ul>
<p><strong>3. CA Mois Dernier</strong> (#revenue-last-month) :</p>
<ul>
<li>Somme totalTTC du mois précédent (M-1)</li>
<li>Exemple : &quot;10 800,00 €&quot;</li>
<li>Période : 1er jour M-1 → dernier jour M-1 (#revenue-last-period)</li>
</ul>
<p><strong>4. Évolution</strong> (#revenue-evolution) :</p>
<ul>
<li>Variation % entre mois actuel et mois précédent</li>
<li>Formule : ((CA_actuel - CA_précédent) / CA_précédent) × 100</li>
<li>Couleur : Vert si ≥0%, Rouge si &lt;0%</li>
<li>Exemple : &quot;+15.3%&quot; (vert) ou &quot;-8.2%&quot; (rouge)</li>
</ul>
<h1>==========================================
RENTABILITÉ</h1>
<p><strong>Prérequis pour calculs de rentabilité</strong> :</p>
<ul>
<li>Champ &quot;purchaseCost&quot; (coût d'achat HT) renseigné dans les matériaux</li>
<li>Factures payées du mois en cours avec quoteItems</li>
<li>Structure : invoice.quoteItems[].material.purchaseCost</li>
</ul>
<p><strong>Formules de rentabilité</strong> :</p>
<p><strong>Marge par article</strong> :</p>
<ul>
<li>Marge (€) = Prix Vente HT - (Coût Achat HT × Quantité)</li>
<li>Marge (%) = (Marge / Prix Vente HT) × 100</li>
</ul>
<p><strong>Taux de Marque</strong> :</p>
<ul>
<li>Coefficient multiplicateur = Prix Vente HT / Coût Achat Total</li>
<li>Exemple : ×2.5 signifie que le prix de vente est 2,5× le coût d'achat</li>
</ul>
<p><strong>Couverture Données</strong> :</p>
<ul>
<li>% articles avec coût d'achat renseigné</li>
<li>Couverture = (Articles avec coût / Total articles) × 100</li>
<li>Indique la fiabilité des calculs de rentabilité</li>
</ul>
<h1>==========================================
KPIs RENTABILITÉ</h1>
<p><strong>1. Marge Moyenne</strong> (#profitability-avg-margin) :</p>
<ul>
<li>Marge moyenne en % sur tous les articles du mois</li>
<li>Couleur : Vert ≥30%, Orange ≥15%, Rouge &lt;15%</li>
<li>Détail : &quot;Sur X articles&quot; (#profitability-avg-margin-detail)</li>
</ul>
<p><strong>2. Marge Totale</strong> (#profitability-total-margin) :</p>
<ul>
<li>Somme des marges en euros (€)</li>
<li>Couleur : Vert si &gt;0, Rouge si ≤0</li>
<li>Détail : &quot;Ce mois-ci&quot; (#profitability-total-margin-detail)</li>
</ul>
<p><strong>3. Couverture Données</strong> (#profitability-data-coverage) :</p>
<ul>
<li>% articles avec coût d'achat (0-100%)</li>
<li>Couleur : Vert ≥80%, Orange ≥50%, Jaune &lt;50%</li>
<li>Détail : &quot;X / Y articles&quot; (#profitability-coverage-detail)</li>
</ul>
<p><strong>4. Taux de Marque</strong> (#profitability-markup-rate) :</p>
<ul>
<li>Coefficient multiplicateur (ex: ×2.15)</li>
<li>Couleur : Vert ≥2.0, Orange ≥1.5, Rouge &lt;1.5</li>
<li>Détail : &quot;Coefficient multiplicateur&quot; (#profitability-markup-detail)</li>
</ul>
<h1>==========================================
GRAPHIQUE CHART.JS</h1>
<p><strong>Graphique CA Mensuel</strong> (#chart-monthly-revenue) :</p>
<ul>
<li>Type : Barres (Chart.js type: 'bar')</li>
<li>Données : 12 derniers mois glissants</li>
<li>Axe X : Mois (ex: &quot;jan. 2025&quot;, &quot;fév. 2025&quot;)</li>
<li>Axe Y : CA TTC en euros</li>
<li>Couleur : Bootstrap primary (rgba(13, 110, 253, 0.7))</li>
<li>Options : responsive, beginAtZero, tooltip personnalisé</li>
</ul>
<p><strong>Tooltip personnalisé</strong> :</p>
<ul>
<li>Format : &quot;CA: 12450.00 €&quot;</li>
<li>Affiche le montant exact au survol</li>
</ul>
<p><strong>Gestion instance Chart</strong> :</p>
<ul>
<li>Stockage dans this.monthlyRevenueChart</li>
<li>Destruction avant recréation (évite fuites mémoire)</li>
<li>Synchronisation avec window.monthlyRevenueChart</li>
</ul>
<h1>==========================================
TABLEAU HISTORIQUE</h1>
<p><strong>Tableau CA Mensuel</strong> (#revenue-history-table) :</p>
<ul>
<li>8 colonnes :
<ol>
<li>Mois (ex: &quot;Janvier 2025&quot;)</li>
<li>Période (ex: &quot;1 - 31 janv.&quot;)</li>
<li>Nb Factures</li>
<li>CA HT (€)</li>
<li>TVA (€)</li>
<li>CA TTC (€)</li>
<li>Évolution vs mois précédent (% avec icône ↗/↘)</li>
<li>Actions (bouton &quot;Imprimer&quot; pour rapport PDF)</li>
</ol>
</li>
</ul>
<p><strong>Tri</strong> : Ordre décroissant (mois le plus récent en haut)</p>
<p><strong>Calcul évolution</strong> :</p>
<ul>
<li>Évolution = ((CA_mois - CA_mois_précédent) / CA_mois_précédent) × 100</li>
<li>Icône : ↗ (vert) si positif, ↘ (rouge) si négatif</li>
<li>Première ligne : &quot;-&quot; (pas de mois précédent)</li>
</ul>
<h1>==========================================
RAPPORTS PDF MENSUELS</h1>
<p><strong>Rapport mensuel</strong> (printMonthReport) :</p>
<ul>
<li>Génération avec jsPDF (orientation portrait, A4)</li>
<li>Contenu :
<ul>
<li>En-tête : &quot;Rapport CA Mensuel&quot; + nom du mois</li>
<li>Résumé : Nb factures, CA HT, TVA, CA TTC</li>
<li>Tableau détaillé : Liste toutes les factures du mois</li>
<li>Totaux : Récapitulatif HT/TVA/TTC</li>
<li>Pied de page : Date/heure de génération</li>
</ul>
</li>
</ul>
<p><strong>Structure tableau PDF</strong> :</p>
<ul>
<li>4 colonnes : N° Facture, Date paiement, Client, Montant TTC</li>
<li>Pagination automatique si &gt;270mm (nouvelle page)</li>
<li>Limitation texte : 20 car pour facture, 30 car pour client</li>
</ul>
<p><strong>Sauvegarde</strong> :</p>
<ul>
<li>Nom fichier : rapport-ca-YYYY-MM.pdf (ex: rapport-ca-2025-01.pdf)</li>
<li>Boîte de dialogue native Electron (save-pdf IPC)</li>
<li>Notification succès avec chemin complet</li>
</ul>
<h1>==========================================
EXPORTS EXCEL</h1>
<p><strong>Export CA Mensuel</strong> (exportRevenueToExcel) :</p>
<ul>
<li>Bibliothèque : XLSX.js (SheetJS)</li>
<li>Feuille unique : &quot;CA Mensuel&quot;</li>
<li>Colonnes : Mois, Année, Nb Factures, CA HT, TVA, CA TTC</li>
<li>Tri : Décroissant (mois récent en haut)</li>
<li>Largeurs colonnes : Optimisées pour lisibilité</li>
<li>Nom fichier : ca-mensuel-YYYY-MM.xlsx</li>
</ul>
<p><strong>Export Rentabilité</strong> (exportProfitabilityToExcel) :</p>
<ul>
<li>2 feuilles :
<ol>
<li>&quot;Rentabilité&quot; : Détail par article/facture
<ul>
<li>10 colonnes : N° Facture, Client, Date, Article, Quantité, Prix Vente HT, Coût Achat HT, Marge €, Marge %, Taux de Marque</li>
</ul>
</li>
<li>&quot;Synthèse&quot; : KPIs globaux
<ul>
<li>Marge moyenne, Marge totale, Couverture, Taux de marque, etc.</li>
</ul>
</li>
</ol>
</li>
<li>Gestion N/A : Articles sans coût d'achat affichent &quot;N/A&quot;</li>
<li>Nom fichier : rentabilite-YYYY-MM.xlsx</li>
</ul>
<p><strong>Sauvegarde Excel</strong> :</p>
<ul>
<li>Génération base64 : XLSX.write(..., type: 'base64')</li>
<li>Boîte de dialogue Electron (save-excel IPC)</li>
<li>Notification succès avec chemin</li>
</ul>
<h1>==========================================
IPC CHANNELS (ELECTRON)</h1>
<p><strong>list-invoices</strong> :</p>
<ul>
<li>Retour : { success, invoices: [...] }</li>
<li>Utilisé pour charger toutes les factures</li>
</ul>
<p><strong>get-materials</strong> :</p>
<ul>
<li>Retour : { success, data: [...] }</li>
<li>Utilisé pour récupérer purchaseCost des matériaux</li>
</ul>
<p><strong>save-pdf</strong> :</p>
<ul>
<li>Paramètres : { base64, filename, title }</li>
<li>Retour : { success, path, message }</li>
<li>Sauvegarde rapport PDF mensuel</li>
</ul>
<p><strong>save-excel</strong> :</p>
<ul>
<li>Paramètres : { base64, filename, title }</li>
<li>Retour : { success, path, message }</li>
<li>Sauvegarde fichier Excel</li>
</ul>
<h1>==========================================
INTÉGRATIONS</h1>
<ul>
<li><strong>InvoicesModule</strong> : Données sources (factures avec quoteItems)</li>
<li><strong>MaterialsModule</strong> : purchaseCost pour calculs de rentabilité</li>
<li><strong>Chart.js v3+</strong> : Graphique barres CA mensuel</li>
<li><strong>jsPDF + jsPDF-autotable</strong> : Génération rapports PDF</li>
<li><strong>XLSX.js (SheetJS)</strong> : Exports Excel</li>
<li><strong>NotificationSystem</strong> : Feedback utilisateur</li>
<li><strong>Bootstrap 5.3.3</strong> : UI (badges, cards, tables)</li>
</ul>
<h1>==========================================
ÉVÉNEMENTS</h1>
<p><strong>Tab click</strong> (#revenue-tab) :</p>
<ul>
<li>Déclenche loadRevenueData() après 100ms</li>
<li>Rafraîchit toutes les données CA et rentabilité</li>
</ul></div>
        

        
            














<dl class="details">

    
    <dt class="tag-version">Version:</dt>
    <dd class="tag-version"><ul class="dummy"><li>2.0.0</li></ul></dd>
    

    

    

    

    

    

    

    

    
    <dt class="tag-author">Author:</dt>
    <dd class="tag-author">
        <ul>
            <li>AutoCalc OptiDevis</li>
        </ul>
    </dd>
    

    

    

    
    

    

    

    
        <p class="tag-source">
            <a href="modules_revenue_RevenueModule.js.html" class="button">View Source</a>
            <span>
                <a href="modules_revenue_RevenueModule.js.html">modules/revenue/RevenueModule.js</a>, <a href="modules_revenue_RevenueModule.js.html#line1">line 1</a>
            </span>
        </p>
    
</dl>






















        
    
    </div>
    
    
        <h3 class="subsection-title">Extends</h3>

        


    <ul>
        <li><a href="BaseModule.html">BaseModule</a></li>
    </ul>


    

    

    
        <h3 class="subsection-title">Classes</h3>

        <dl>
            <dt><a href="module-RevenueModule-RevenueModule.html">RevenueModule</a></dt>
            <dd></dd>
        </dl>
    

    

    

    

    

    

    

    
</article>

</section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>