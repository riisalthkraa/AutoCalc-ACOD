

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> modules/quickadd/QuickAddModule.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule.html">DashboardModule</a></li><li><a href="module-DataCache.html">DataCache</a></li><li><a href="module-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule.html">FECModule</a></li><li><a href="module-FollowUpModule.html">FollowUpModule</a></li><li><a href="module-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-KeyboardShortcutsModule.html">KeyboardShortcutsModule</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-MLService.html">MLService</a></li><li><a href="module-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-NotificationSystem.html">NotificationSystem</a></li><li><a href="module-NotificationSystemV2.html">NotificationSystemV2</a></li><li><a href="module-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-TourModule.html">TourModule</a></li><li><a href="module-UtilitiesModule.html">UtilitiesModule</a></li><li><a href="module-calculations.html">calculations</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-formatters.html">formatters</a></li><li><a href="module-helpers.html">helpers</a></li></ul><h3>Classes</h3><ul><li><a href="BaseModule.html">BaseModule</a></li><li><a href="BulkActionsManager.html">BulkActionsManager</a></li><li><a href="CacheKeys.html">CacheKeys</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="LoadingStateManager.html">LoadingStateManager</a></li><li><a href="ModalHelper.html">ModalHelper</a></li><li><a href="PaginationManager.html">PaginationManager</a></li><li><a href="ServerValidator.html">ServerValidator</a></li><li><a href="StateManager.html">StateManager</a></li><li><a href="TabRefreshManager.html">TabRefreshManager</a></li><li><a href="UndoRedoManager.html">UndoRedoManager</a></li><li><a href="module-AboutModule-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule-DashboardModule.html">DashboardModule</a></li><li><a href="module-ExportModule-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule-FECModule.html">FECModule</a></li><li><a href="module-ImportModule-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-Logger-Logger.html">Logger</a></li><li><a href="module-Logger-ModuleLogger.html">ModuleLogger</a></li><li><a href="module-MaterialsModule-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-PDFModule-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-UtilitiesModule-UtilitiesModule.html">UtilitiesModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#emitSync">emitSync</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#validateBeforeAddToQuote">validateBeforeAddToQuote</a></li><li><a href="global.html#validateBeforeExport">validateBeforeExport</a></li><li><a href="global.html#validateBeforeSaveMaterial">validateBeforeSaveMaterial</a></li><li><a href="global.html#validateBeforeSendEmail">validateBeforeSendEmail</a></li><li><a href="global.html#validateHeaderConfig">validateHeaderConfig</a></li><li><a href="global.html#validatePasswordChange">validatePasswordChange</a></li><li><a href="global.html#validateSMTPConfig">validateSMTPConfig</a></li><li><a href="global.html#waitFor">waitFor</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>modules/quickadd/QuickAddModule.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * ========================================
 * QUICK ADD MODULE - Ajout rapide au devis
 * ========================================
 *
 * Module d'ajout rapide de matÃ©riaux au devis pour AutoCalc OptiDevis.
 * Permet l'ajout ultra-rapide via syntaxe naturelle avec calculs automatiques.
 *
 * Architecture :
 * Le module gÃ¨re l'ajout rapide avec :
 * - **Syntaxe naturelle** : "50 parpaings", "75mÂ² plÃ¢tre", "10mÂ³ bÃ©ton"
 * - **Recherche fuzzy** : Algorithme multi-niveaux avec stop words
 * - **Calculs automatiques** : Conversion unitÃ©s â†’ quantitÃ©s (mÂ², mÂ³, m, /h)
 * - **Ajout direct** : MatÃ©riau ajoutÃ© Ã  window.quoteItems instantanÃ©ment
 * - **Suggestions** : Propositions si matÃ©riau introuvable
 *
 * ==========================================
 * SYNTAXE NATURELLE
 * ==========================================
 *
 * **Format gÃ©nÃ©ral** : `[quantitÃ©][unitÃ© optionnelle] [nom matÃ©riau]`
 *
 * **Exemples valides** :
 * - "50 parpaings" â†’ 50 unitÃ©s de parpaings
 * - "75mÂ² plÃ¢tre" â†’ Calcul auto piÃ¨ces selon piecesPerM2 ou coverage
 * - "10mÂ³ bÃ©ton" â†’ Calcul auto sacs selon density + unitWeight
 * - "25m cÃ¢ble Ã©lectrique" â†’ Calcul auto selon coverage linÃ©aire
 * - "8/h main d'oeuvre" â†’ 8 heures de main d'oeuvre
 *
 * **UnitÃ©s supportÃ©es** :
 * - mÂ² (surface)
 * - mÂ³ (volume)
 * - m (longueur)
 * - /h (heures)
 * - Aucune unitÃ© = unitÃ©s directes
 *
 * **Normalisation** :
 * - "m2" â†’ "mÂ²" (conversion automatique)
 * - "m3" â†’ "mÂ³" (conversion automatique)
 * - Virgule â†’ Point (25,5 â†’ 25.5)
 *
 * ==========================================
 * CALCULS AUTOMATIQUES
 * ==========================================
 *
 * **Surface (mÂ²)** :
 * - Si material.piecesPerM2 existe :
 *   - QuantitÃ© = surface Ã— piecesPerM2
 *   - Ex: 75mÂ² Ã— 10 pcs/mÂ² = 750 unitÃ©s
 * - Sinon si material.coverage existe :
 *   - QuantitÃ© = surface Ã· coverage
 *   - Ex: 75mÂ² Ã· 1.5mÂ²/unitÃ© = 50 unitÃ©s
 * - Sinon : QuantitÃ© = surface (pas de conversion)
 *
 * **Volume (mÂ³)** :
 * - Si material.coverage (mÂ³) existe :
 *   - QuantitÃ© = volume Ã· coverage
 *   - Ex: 10mÂ³ Ã· 0.5mÂ³/unitÃ© = 20 unitÃ©s
 * - Sinon si material.density + material.unitWeight existent :
 *   - Poids total = volume Ã— density
 *   - QuantitÃ© = poids total Ã· unitWeight
 *   - Ex: 10mÂ³ Ã— 1800kg/mÂ³ Ã· 25kg/sac = 720 sacs
 * - Sinon : QuantitÃ© = volume (pas de conversion)
 *
 * **Longueur (m)** :
 * - Si material.coverage (m) existe :
 *   - QuantitÃ© = longueur Ã· coverage
 *   - Ex: 25m Ã· 2.5m/unitÃ© = 10 unitÃ©s
 * - Sinon : QuantitÃ© = longueur
 *
 * **Heures (/h)** :
 * - QuantitÃ© = heures directes (pas de conversion)
 *
 * ==========================================
 * RECHERCHE FUZZY MULTI-NIVEAUX
 * ==========================================
 *
 * **Algorithme de recherche** (par ordre de prioritÃ©) :
 *
 * **Niveau 1 : Exacte** :
 * - Recherche exacte sur name ou reference
 * - Ex: "parpaing" trouve exactement "Parpaing"
 *
 * **Niveau 2 : Exacte nettoyÃ©e** :
 * - Recherche exacte aprÃ¨s suppression stop words
 * - Ex: "sac de ciment" â†’ "ciment" â†’ trouve "Ciment"
 *
 * **Niveau 3 : Partielle (contient)** :
 * - Recherche partielle sur name, reference, type
 * - Ex: "plat" trouve "PlÃ¢tre"
 *
 * **Niveau 4 : Partielle nettoyÃ©e** :
 * - Recherche partielle aprÃ¨s nettoyage
 * - Ex: "plaque de plÃ¢tre" â†’ "plÃ¢tre" â†’ trouve "PlÃ¢tre BA13"
 *
 * **Niveau 5 : Fuzzy (tous les mots)** :
 * - Tous les mots-clÃ©s doivent Ãªtre prÃ©sents
 * - Ex: "plaque plÃ¢tre" trouve "Plaque de plÃ¢tre BA13"
 *
 * **Niveau 6 : Permissif (au moins 1 mot)** :
 * - Au moins 1 mot-clÃ© prÃ©sent
 * - Ex: "plÃ¢tre" trouve n'importe quel matÃ©riau contenant "plÃ¢tre"
 *
 * **Stop Words** :
 * Mots ignorÃ©s lors de la recherche :
 * - Articles : de, le, la, les, un, une, des, du
 * - Contenants : sac, sacs, plaque, plaques, barre, barres, rouleau, rouleaux
 *
 * ==========================================
 * SUGGESTIONS
 * ==========================================
 *
 * **Affichage suggestions** :
 * - Si matÃ©riau introuvable â†’ affiche 3 suggestions
 * - Recherche partielle sur 3 premiers caractÃ¨res du terme nettoyÃ©
 * - Affichage via NotificationSystem.info "ðŸ’¡ Suggestions: X, Y, Z"
 *
 * **Exemple** :
 * - Utilisateur tape : "parpan" (erreur de frappe)
 * - Aucun matÃ©riau trouvÃ©
 * - Suggestions : "Parpaing 15cm, Parpaing 20cm, Parpaing creux"
 *
 * ==========================================
 * INTÃ‰GRATIONS
 * ==========================================
 *
 * - **QuoteBuilderModule** : Ajoute Ã  window.quoteItems directement
 * - **QuoteBuilderModule** : Appelle window.updateQuoteTable() pour rafraÃ®chir UI
 * - **MaterialsModule** : Utilise window.materials pour recherche
 * - **DashboardModule** : Appelle window.trackMaterialSearch() pour analytics
 * - **DashboardModule** : RafraÃ®chit window.loadVendeurDashboard() si onglet Accueil actif
 * - **NotificationSystem** : Feedback utilisateur (success, error, warning, info)
 *
 * ==========================================
 * Ã‰VÃ‰NEMENTS
 * ==========================================
 *
 * **Input #quickAddInput** :
 * - Touche Enter : Appelle processInput()
 *
 * **Bouton #quickAddBtn** :
 * - Click : Appelle processInput()
 *
 * @module QuickAddModule
 * @extends BaseModule
 * @version 2.6.5
 * @author AutoCalc OptiDevis
 */

import BaseModule from '../../core/BaseModule.js';

class QuickAddModule extends BaseModule {
  /**
   * CrÃ©e une instance du module QuickAdd.
   *
   * @param {StateManager} state - Gestionnaire d'Ã©tat global
   * @param {EventBus} eventBus - Bus d'Ã©vÃ©nements
   */
  constructor(state, eventBus) {
    super('QuickAddModule', state, eventBus);

    /**
     * RÃ©fÃ©rence Ã  l'input Quick Add (#quickAddInput).
     * @type {HTMLInputElement|null}
     * @private
     */
    this.input = null;

    /**
     * Ã‰tat d'activation du module (actuellement non utilisÃ©).
     * @type {boolean}
     * @private
     */
    this.isActive = false;
  }

  /**
   * Initialise le module QuickAdd.
   * Configure les event listeners sur l'input et le bouton.
   *
   * @async
   * @returns {Promise&lt;void>}
   */
  async init() {
    this.log('Initializing Quick Add Module...');

    this.input = document.getElementById('quickAddInput');

    if (!this.input) {
      this.log('Input Quick Add non trouvÃ©');
      return;
    }

    // Event listener sur la touche EntrÃ©e
    this.input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        this.processInput();
      }
    });

    // Event listener sur le bouton
    const btn = document.getElementById('quickAddBtn');
    if (btn) {
      btn.addEventListener('click', () => {
        this.processInput();
      });
    }

    this.log('Module Quick Add initialisÃ©');

    // Exposer les fonctions
    this.exposeToGlobal({
      quickAddProcessInput: this.processInput
    });
  }

  /**
   * Traite l'entrÃ©e utilisateur du Quick Add et ajoute le matÃ©riau au devis.
   * Parse la syntaxe naturelle, recherche le matÃ©riau, calcule la quantitÃ© et ajoute au devis.
   *
   * Syntaxe : `[quantitÃ©][unitÃ© optionnelle] [nom matÃ©riau]`
   *
   * Workflow :
   * 1. Normalisation input (m2â†’mÂ², m3â†’mÂ³, virguleâ†’point)
   * 2. Parse avec regex : /^(\d+(?:[.,]\d+)?)\s*(?:(mÂ²|mÂ³|m|\/h))?\s+(.+)$/i
   * 3. Si format invalide â†’ NotificationSystem.warning + return
   * 4. Recherche matÃ©riau via findMaterial() (fuzzy multi-niveaux)
   * 5. Si introuvable â†’ error + suggestMaterials() + return
   * 6. Calcul quantitÃ© via calculateQuantity() (conversions unitÃ©s)
   * 7. Ajout au devis via addToQuote()
   * 8. Vide input et refocus
   *
   * @public
   * @returns {void}
   * @fires NotificationSystem#warning Si format invalide
   * @fires NotificationSystem#error Si matÃ©riau introuvable
   * @fires NotificationSystem#info Si suggestions affichÃ©es
   *
   * @example
   * // Utilisateur tape "50 parpaings" et appuie Enter
   * processInput();
   * // â†’ Parse: 50 unitÃ©s, "parpaings"
   * // â†’ Trouve matÃ©riau "Parpaing"
   * // â†’ Calcule 50 unitÃ©s
   * // â†’ Ajoute au devis
   * // â†’ "âœ“ AjoutÃ©: 50 Parpaing (50 unitÃ©s)"
   *
   * @example
   * // Utilisateur tape "75mÂ² plÃ¢tre"
   * processInput();
   * // â†’ Parse: 75mÂ², "plÃ¢tre"
   * // â†’ Trouve "Plaque de plÃ¢tre BA13"
   * // â†’ Calcule 750 unitÃ©s (75mÂ² Ã— 10 pcs/mÂ²)
   * // â†’ Ajoute au devis
   */
  processInput = () => {
    let text = this.input.value.trim();

    if (!text) {
      return;
    }

    // Normaliser les unitÃ©s (m2 â†’ mÂ², m3 â†’ mÂ³)
    text = text.replace(/(\d)\s*m2\b/gi, '$1mÂ²');
    text = text.replace(/(\d)\s*m3\b/gi, '$1mÂ³');

    this.log(`Traitement: "${text}"`);

    // Pattern avec unitÃ© de mesure: [quantitÃ©][unitÃ©] [matÃ©riau]
    // Exemples: "75mÂ² plaque de plÃ¢tre", "10mÂ³ bÃ©ton", "50 parpaings"
    const patternWithUnit = /^(\d+(?:[.,]\d+)?)\s*(?:(mÂ²|mÂ³|m|\/h))?\s+(.+)$/i;
    const match = text.match(patternWithUnit);

    if (!match) {
      if (window.NotificationSystem) {
        window.NotificationSystem.warning('Format invalide. Exemples: "50 parpaings" ou "75mÂ² plÃ¢tre"');
      }
      return;
    }

    const inputValue = parseFloat(match[1].replace(',', '.'));
    const inputUnit = match[2] ? match[2].toLowerCase() : null;
    const materialName = match[3].trim().toLowerCase();

    this.log(`Recherche: ${inputValue}${inputUnit || ''} "${materialName}"`);

    // Rechercher le matÃ©riau dans la base
    const material = this.findMaterial(materialName);

    if (!material) {
      if (window.NotificationSystem) {
        window.NotificationSystem.error(`MatÃ©riau introuvable: "${materialName}"`);
      }
      this.suggestMaterials(materialName);
      return;
    }

    // Calculer la quantitÃ© d'unitÃ©s nÃ©cessaires
    const { quantity, calculation } = this.calculateQuantity(material, inputValue, inputUnit);

    if (quantity &lt;= 0) {
      if (window.NotificationSystem) {
        window.NotificationSystem.error('Impossible de calculer la quantitÃ© nÃ©cessaire');
      }
      return;
    }

    // Ajouter au devis
    this.addToQuote(material, quantity, calculation);

    // Vider l'input
    this.input.value = '';
    this.input.focus();
  }

  /**
   * Calcule la quantitÃ© d'unitÃ©s nÃ©cessaires selon l'unitÃ© saisie
   * GÃ¨re les conversions mÂ², mÂ³, m, /h â†’ unitÃ©s
   *
   * @param {Object} material - MatÃ©riau sÃ©lectionnÃ©
   * @param {number} inputValue - Valeur saisie
   * @param {string} inputUnit - UnitÃ© saisie (mÂ², mÂ³, m, /h, null)
   * @returns {Object} {quantity, calculation}
   */
  calculateQuantity = (material, inputValue, inputUnit) => {
    let quantity = inputValue;
    let calculation = `${inputValue} unitÃ©s`;

    // Si une unitÃ© est spÃ©cifiÃ©e, calculer le nombre d'unitÃ©s nÃ©cessaires
    if (inputUnit) {
      const materialUnit = material.unit?.toLowerCase();

      if (inputUnit === 'mÂ²') {
        if (material.piecesPerM2 &amp;&amp; material.piecesPerM2 > 0) {
          // Nombre de piÃ¨ces = surface Ã— piÃ¨ces par mÂ²
          quantity = Math.ceil(inputValue * material.piecesPerM2);
          calculation = `${inputValue}mÂ² (${material.piecesPerM2} pcs/mÂ²) = ${quantity} unitÃ©s`;
          this.log(`Calcul mÂ²: ${inputValue}mÂ² Ã— ${material.piecesPerM2} pcs/mÂ² = ${quantity} unitÃ©s`);
        } else if (material.coverage &amp;&amp; material.coverage > 0) {
          // Nombre d'unitÃ©s = surface Ã· couverture par unitÃ©
          quantity = Math.ceil(inputValue / material.coverage);
          calculation = `${inputValue}mÂ² Ã· ${material.coverage}mÂ²/unitÃ© = ${quantity} unitÃ©s`;
          this.log(`Calcul mÂ²: ${inputValue}mÂ² Ã· ${material.coverage}mÂ²/unitÃ© = ${quantity} unitÃ©s`);
        } else {
          // Pas de donnÃ©es de couverture, utiliser la valeur directe
          quantity = inputValue;
          calculation = `${inputValue}mÂ²`;
        }
      } else if (inputUnit === 'mÂ³') {
        if (material.coverage &amp;&amp; material.coverage > 0 &amp;&amp; materialUnit === 'mÂ³') {
          // Volume: nombre d'unitÃ©s = volume Ã· couverture par unitÃ©
          quantity = Math.ceil(inputValue / material.coverage);
          calculation = `${inputValue}mÂ³ Ã· ${material.coverage}mÂ³/unitÃ© = ${quantity} unitÃ©s`;
          this.log(`Calcul mÂ³: ${inputValue}mÂ³ Ã· ${material.coverage}mÂ³/unitÃ© = ${quantity} unitÃ©s`);
        } else if (material.density &amp;&amp; material.unitWeight) {
          // Calcul via densitÃ©: poids = volume Ã— densitÃ©, puis nombre de sacs
          const totalWeight = inputValue * material.density;
          quantity = Math.ceil(totalWeight / material.unitWeight);
          calculation = `${inputValue}mÂ³ Ã— ${material.density}kg/mÂ³ Ã· ${material.unitWeight}kg/sac = ${quantity} sacs`;
          this.log(`Calcul mÂ³: ${inputValue}mÂ³ Ã— ${material.density}kg/mÂ³ = ${totalWeight}kg Ã· ${material.unitWeight}kg = ${quantity} sacs`);
        } else {
          quantity = inputValue;
          calculation = `${inputValue}mÂ³`;
        }
      } else if (inputUnit === 'm') {
        if (material.coverage &amp;&amp; material.coverage > 0 &amp;&amp; materialUnit === 'm') {
          // Longueur: nombre d'unitÃ©s = longueur Ã· couverture par unitÃ©
          quantity = Math.ceil(inputValue / material.coverage);
          calculation = `${inputValue}m Ã· ${material.coverage}m/unitÃ© = ${quantity} unitÃ©s`;
          this.log(`Calcul m: ${inputValue}m Ã· ${material.coverage}m/unitÃ© = ${quantity} unitÃ©s`);
        } else {
          quantity = inputValue;
          calculation = `${inputValue}m`;
        }
      } else if (inputUnit === '/h') {
        // Heures: utiliser directement la valeur
        quantity = inputValue;
        calculation = `${inputValue}h`;
      }
    }

    return { quantity, calculation };
  }

  /**
   * Recherche un matÃ©riau avec algorithme fuzzy multi-niveaux.
   * Utilise 6 niveaux de recherche progressive du plus strict au plus permissif.
   *
   * StratÃ©gie de recherche (par ordre de prioritÃ©) :
   * 1. Exacte : name === term OU reference === term
   * 2. Exacte nettoyÃ©e : AprÃ¨s suppression stop words
   * 3. Partielle : name.includes(term) OU reference.includes(term) OU type.includes(term)
   * 4. Partielle nettoyÃ©e : AprÃ¨s suppression stop words
   * 5. Fuzzy : TOUS les mots-clÃ©s prÃ©sents (every)
   * 6. Permissive : AU MOINS 1 mot-clÃ© prÃ©sent (some)
   *
   * Stop words ignorÃ©s :
   * - Articles : de, le, la, les, un, une, des, du
   * - Contenants : sac, sacs, plaque, plaques, barre, barres, rouleau, rouleaux
   *
   * @public
   * @param {string} searchTerm - Terme de recherche saisi par l'utilisateur
   * @returns {Object|null} MatÃ©riau trouvÃ© ou null
   *
   * @example
   * // Recherche exacte
   * findMaterial("parpaing");
   * // â†’ Trouve "Parpaing" (niveau 1)
   *
   * @example
   * // Recherche avec stop words
   * findMaterial("sac de ciment");
   * // â†’ "sac" et "de" ignorÃ©s â†’ "ciment" â†’ Trouve "Ciment" (niveau 2)
   *
   * @example
   * // Recherche partielle
   * findMaterial("plat");
   * // â†’ Trouve "PlÃ¢tre" (niveau 3)
   */
  findMaterial = (searchTerm) => {
    const materials = this.state.get('materials') || window.materials || [];

    if (!materials || materials.length === 0) {
      this.log('Aucun matÃ©riau chargÃ©');
      return null;
    }

    const term = searchTerm.toLowerCase();

    // STOP WORDS - Mots Ã  ignorer dans la recherche
    const stopWords = [
      'de', 'le', 'la', 'les', 'un', 'une', 'des', 'du',
      'sac', 'sacs', 'plaque', 'plaques', 'barre', 'barres',
      'rouleau', 'rouleaux'
    ];

    // Nettoyer le terme de recherche
    const cleanedTerm = term
      .split(/\s+/)
      .filter(word => !stopWords.includes(word) &amp;&amp; word.length > 1)
      .join(' ');

    // 1. Recherche exacte d'abord
    let found = materials.find(m =>
      m.name.toLowerCase() === term ||
      m.reference?.toLowerCase() === term
    );

    if (found) return found;

    // 2. Recherche exacte avec terme nettoyÃ©
    found = materials.find(m =>
      m.name.toLowerCase() === cleanedTerm ||
      m.reference?.toLowerCase() === cleanedTerm
    );

    if (found) return found;

    // 3. Recherche partielle (contient) - terme original
    found = materials.find(m =>
      m.name.toLowerCase().includes(term) ||
      m.reference?.toLowerCase().includes(term) ||
      m.type?.toLowerCase().includes(term)
    );

    if (found) return found;

    // 4. Recherche partielle (contient) - terme nettoyÃ©
    if (cleanedTerm !== term) {
      found = materials.find(m =>
        m.name.toLowerCase().includes(cleanedTerm) ||
        m.reference?.toLowerCase().includes(cleanedTerm) ||
        m.type?.toLowerCase().includes(cleanedTerm)
      );

      if (found) return found;
    }

    // 5. Recherche fuzzy (mots sÃ©parÃ©s) - terme nettoyÃ©
    const words = cleanedTerm.split(/\s+/).filter(w => w.length > 1);
    if (words.length > 0) {
      found = materials.find(m => {
        const materialText = (m.name + ' ' + (m.reference || '') + ' ' + (m.type || '')).toLowerCase();
        return words.every(word => materialText.includes(word));
      });

      if (found) return found;
    }

    // 6. Recherche trÃ¨s permissive : au moins 1 mot clÃ© trouvÃ©
    if (words.length > 0) {
      found = materials.find(m => {
        const materialText = (m.name + ' ' + (m.reference || '') + ' ' + (m.type || '')).toLowerCase();
        return words.some(word => materialText.includes(word));
      });
    }

    return found;
  }

  /**
   * Ajoute un matÃ©riau au devis
   * @param {Object} material - MatÃ©riau Ã  ajouter
   * @param {number} quantity - QuantitÃ© calculÃ©e
   * @param {string} calculation - DÃ©tail du calcul
   */
  addToQuote = (material, quantity, calculation = null) => {
    // VÃ©rifier que quoteItems existe
    if (typeof window.quoteItems === 'undefined') {
      this.log('quoteItems non trouvÃ©');
      if (window.NotificationSystem) {
        window.NotificationSystem.error('Erreur: Impossible d\'ajouter au devis');
      }
      return;
    }

    // Validation: material valide avec propriÃ©tÃ©s requises
    if (!material || typeof material.price !== 'number') {
      this.log('Material invalide ou propriÃ©tÃ©s manquantes:', material);
      if (window.NotificationSystem) {
        window.NotificationSystem.error('Erreur: DonnÃ©es du matÃ©riau invalides');
      }
      return;
    }

    // Assurer que tvaRate est un nombre valide (dÃ©faut 0.20 si non dÃ©fini)
    // Supporte les deux formats: tva (20) et tvaRate (0.20)
    let tvaRate;
    if (typeof material.tvaRate === 'number' &amp;&amp; !isNaN(material.tvaRate)) {
      tvaRate = material.tvaRate;
    } else if (typeof material.tva === 'number' &amp;&amp; !isNaN(material.tva)) {
      tvaRate = material.tva / 100; // Convertir 20 en 0.20
    } else {
      tvaRate = 0.20; // DÃ©faut 20%
    }

    // Tracker la recherche pour le dashboard Vendeur
    if (typeof window.trackMaterialSearch === 'function') {
      window.trackMaterialSearch(material);
    }

    // Calculer les prix
    const priceHT = quantity * material.price / (1 + tvaRate);
    const priceTTC = quantity * material.price;
    const tva = priceTTC - priceHT;

    // Texte de calcul par dÃ©faut si non fourni
    const calculationText = calculation || `${quantity} unitÃ©s`;

    // Ajouter directement au devis
    window.quoteItems.push({
      material: material,
      clientRequest: `Quick Add`,
      quantity: quantity,
      calculation: calculationText,
      unitPriceHT: material.price / (1 + tvaRate),
      unitPriceTTC: material.price,
      priceHT: priceHT,
      priceTTC: priceTTC,
      tva: tva,
      totalHT: priceHT.toFixed(2),
      totalTVA: tva.toFixed(2),
      totalTTC: priceTTC.toFixed(2),
      tvaRate: `${(tvaRate * 100).toFixed(1)}%`
    });

    // Mettre Ã  jour l'affichage
    if (typeof window.updateQuoteTable === 'function') {
      window.updateQuoteTable();
    }

    // RafraÃ®chir le dashboard Vendeur si on est sur l'onglet Accueil
    if (typeof window.loadVendeurDashboard === 'function') {
      const accueilTab = document.getElementById('accueil');
      if (accueilTab &amp;&amp; accueilTab.classList.contains('active')) {
        setTimeout(() => {
          window.loadVendeurDashboard();
        }, 100);
      }
    }

    if (window.NotificationSystem) {
      window.NotificationSystem.success(`âœ“ AjoutÃ©: ${quantity} ${material.name} (${calculationText})`);
    }
    this.log(`AjoutÃ©: ${quantity} x ${material.name} - ${calculationText}`);
  }

  /**
   * SuggÃ¨re des matÃ©riaux proches du terme recherchÃ©
   * @param {string} searchTerm - Terme recherchÃ©
   */
  suggestMaterials = (searchTerm) => {
    const materials = this.state.get('materials') || window.materials || [];
    if (!materials || materials.length === 0) return;

    const term = searchTerm.toLowerCase();

    // Nettoyer le terme comme dans findMaterial
    const stopWords = [
      'de', 'le', 'la', 'les', 'un', 'une', 'des', 'du',
      'sac', 'sacs', 'plaque', 'plaques', 'barre', 'barres',
      'rouleau', 'rouleaux'
    ];
    const cleanedTerm = term
      .split(/\s+/)
      .filter(word => !stopWords.includes(word) &amp;&amp; word.length > 1)
      .join(' ');

    const searchTerm2 = cleanedTerm || term;

    const suggestions = materials
      .filter(m => {
        const text = (m.name + ' ' + (m.reference || '') + ' ' + (m.type || '')).toLowerCase();
        // Essayer avec les 3 premiÃ¨res lettres du terme nettoyÃ©
        return searchTerm2.length >= 3 &amp;&amp; text.includes(searchTerm2.substring(0, 3));
      })
      .slice(0, 3)
      .map(m => m.name);

    if (suggestions.length > 0 &amp;&amp; window.NotificationSystem) {
      window.NotificationSystem.info(`ðŸ’¡ Suggestions: ${suggestions.join(', ')}`);
    }
  }
}

export default QuickAddModule;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
