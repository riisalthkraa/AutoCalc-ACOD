

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> modules/auth/AuthModule.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule.html">DashboardModule</a></li><li><a href="module-DataCache.html">DataCache</a></li><li><a href="module-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule.html">FECModule</a></li><li><a href="module-FollowUpModule.html">FollowUpModule</a></li><li><a href="module-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-KeyboardShortcutsModule.html">KeyboardShortcutsModule</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-MLService.html">MLService</a></li><li><a href="module-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-NotificationSystem.html">NotificationSystem</a></li><li><a href="module-NotificationSystemV2.html">NotificationSystemV2</a></li><li><a href="module-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-TourModule.html">TourModule</a></li><li><a href="module-UtilitiesModule.html">UtilitiesModule</a></li><li><a href="module-calculations.html">calculations</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-formatters.html">formatters</a></li><li><a href="module-helpers.html">helpers</a></li></ul><h3>Classes</h3><ul><li><a href="BaseModule.html">BaseModule</a></li><li><a href="BulkActionsManager.html">BulkActionsManager</a></li><li><a href="CacheKeys.html">CacheKeys</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="LoadingStateManager.html">LoadingStateManager</a></li><li><a href="ModalHelper.html">ModalHelper</a></li><li><a href="PaginationManager.html">PaginationManager</a></li><li><a href="ServerValidator.html">ServerValidator</a></li><li><a href="StateManager.html">StateManager</a></li><li><a href="TabRefreshManager.html">TabRefreshManager</a></li><li><a href="UndoRedoManager.html">UndoRedoManager</a></li><li><a href="module-AboutModule-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule-DashboardModule.html">DashboardModule</a></li><li><a href="module-ExportModule-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule-FECModule.html">FECModule</a></li><li><a href="module-ImportModule-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-Logger-Logger.html">Logger</a></li><li><a href="module-Logger-ModuleLogger.html">ModuleLogger</a></li><li><a href="module-MaterialsModule-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-PDFModule-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-UtilitiesModule-UtilitiesModule.html">UtilitiesModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#emitSync">emitSync</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#validateBeforeAddToQuote">validateBeforeAddToQuote</a></li><li><a href="global.html#validateBeforeExport">validateBeforeExport</a></li><li><a href="global.html#validateBeforeSaveMaterial">validateBeforeSaveMaterial</a></li><li><a href="global.html#validateBeforeSendEmail">validateBeforeSendEmail</a></li><li><a href="global.html#validateHeaderConfig">validateHeaderConfig</a></li><li><a href="global.html#validatePasswordChange">validatePasswordChange</a></li><li><a href="global.html#validateSMTPConfig">validateSMTPConfig</a></li><li><a href="global.html#waitFor">waitFor</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>modules/auth/AuthModule.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * ========================================
 * AUTH MODULE - Gestion de l'authentification
 * ========================================
 *
 * Module de gestion de l'authentification et des permissions utilisateur.
 * G√®re le switch entre mode Administrateur (acc√®s complet) et mode
 * Vendeur/Conseil (lecture seule, fonctionnalit√©s limit√©es).
 *
 * Architecture :
 * - Authentification par mot de passe (admin uniquement)
 * - Gestion du token de session s√©curis√©
 * - Configuration dynamique de l'interface selon le mode
 * - D√©marrage s√©curis√© en mode Vendeur/Conseil
 * - Pas de persistance du mode admin (s√©curit√©)
 *
 * Responsabilit√©s :
 * - G√©rer les sessions utilisateur (login/logout)
 * - V√©rifier le mot de passe via IPC s√©curis√©
 * - G√©n√©rer et stocker le token de session
 * - Basculer entre mode Admin et mode Vendeur/Conseil
 * - Configurer l'interface selon les permissions (afficher/masquer onglets)
 * - Synchroniser l'√©tat d'authentification avec StateManager
 * - Exposer les variables globales pour compatibilit√© legacy
 *
 * Modes d'utilisation :
 *
 * **Mode Vendeur/Conseil** (par d√©faut au d√©marrage) :
 * - Acc√®s √† : Recherche, Catalogue, Construction devis, Accueil (dashboard vendeur)
 * - Masqu√© : Admin, Factures, Configuration, Templates, Fournisseurs, CA du Mois, Tableau de bord
 * - Permissions : Lecture seule, pas d'export PDF, pas d'envoi email
 * - S√©curit√© : Aucune authentification requise
 *
 * **Mode Administrateur** (apr√®s authentification) :
 * - Acc√®s √† : Tous les onglets
 * - Permissions : Lecture + √âcriture, Export PDF, Envoi email, Gestion compl√®te
 * - S√©curit√© : Mot de passe requis, token de session g√©n√©r√©
 * - Session : Non persist√©e, l'utilisateur doit se r√©authentifier √† chaque d√©marrage
 *
 * Workflow d'authentification :
 * ```
 * 1. D√©marrage app ‚Üí Mode Vendeur/Conseil automatique
 * 2. Utilisateur active le switch "Mode Admin"
 * 3. Modal de mot de passe s'affiche
 * 4. Utilisateur saisit le mot de passe
 * 5. V√©rification IPC 'verify-password'
 * 6. Si valide ‚Üí g√©n√©ration token + passage mode Admin
 * 7. Si invalide ‚Üí retour mode Vendeur/Conseil + notification erreur
 * 8. D√©sactivation switch ‚Üí retour mode Vendeur/Conseil + destruction token
 * ```
 *
 * S√©curit√© :
 * - Mot de passe hash√© avec bcrypt (backend)
 * - Token de session cryptographiquement s√©curis√©
 * - Pas de persistance du mode admin dans localStorage
 * - Nettoyage automatique du token lors de la d√©connexion
 * - Modal de mot de passe avec support Escape + Enter
 *
 * √âv√©nements √©mis :
 * - 'auth:login' - Connexion admin r√©ussie
 *   Payload: { mode: 'admin' }
 *
 * - 'auth:logout' - D√©connexion admin (retour vendeur)
 *   Payload: { mode: 'vendeur' }
 *
 * - 'auth:interface-updated' - Interface reconfigur√©e selon le mode
 *   Payload: { isGuestMode: boolean }
 *
 * √âv√©nements √©cout√©s :
 * - 'app:initialized' - Charge le dashboard vendeur apr√®s init compl√®te
 *
 * Canaux IPC utilis√©s :
 * - 'verify-password' - V√©rification du mot de passe admin
 *   Param√®tres: password (string)
 *   Retour: { success: boolean, sessionToken: string }
 *
 * @module AuthModule
 * @extends BaseModule
 * @version 1.0.0
 * @author Claude AI - AutoCalc OptiDevis Refactoring
 * @created 2024-10-XX
 */

import BaseModule from '../../core/BaseModule.js';
import NotificationSystem from '../../shared/ui/NotificationSystem.js';

class AuthModule extends BaseModule {
  /**
   * Constructeur du module d'authentification
   *
   * @param {StateManager} state - Gestionnaire d'√©tat global
   * @param {EventBus} eventBus - Bus d'√©v√©nements
   */
  constructor(state, eventBus) {
    super('auth', state, eventBus);

    /**
     * Flag indiquant si l'utilisateur est authentifi√© pour cette session
     * @type {boolean}
     * @private
     */
    this.isAuthenticatedThisSession = false;

    /**
     * Flag indiquant si l'utilisateur est en mode Vendeur/Conseil (invit√©)
     * @type {boolean}
     * @private
     */
    this.isGuestMode = true; // Toujours d√©marrer en mode Vendeur/Conseil

    /**
     * Token de session s√©curis√© g√©n√©r√© apr√®s authentification
     * @type {string|null}
     * @private
     */
    this.sessionToken = null;

    // ==========================================
    // R√âF√âRENCES AUX √âL√âMENTS DOM
    // ==========================================

    /**
     * Switch Bootstrap pour activer/d√©sactiver le mode admin
     * @type {HTMLElement|null}
     * @private
     */
    this.adminModeSwitch = null;

    /**
     * Label du switch affichant le mode actuel
     * @type {HTMLElement|null}
     * @private
     */
    this.adminModeSwitchLabel = null;

    /**
     * Instance du modal Bootstrap pour le mot de passe
     * @type {bootstrap.Modal|null}
     * @private
     */
    this.passwordModal = null;

    /**
     * √âl√©ment DOM du modal de mot de passe
     * @type {HTMLElement|null}
     * @private
     */
    this.passwordModalElement = null;

    /**
     * Champ input du mot de passe
     * @type {HTMLElement|null}
     * @private
     */
    this.passwordInput = null;

    this.log('AuthModule instantiated');
  }

  /**
   * Initialise le module d'authentification
   *
   * Workflow :
   * 1. R√©cup√®re les √©l√©ments DOM (switch, modal, input)
   * 2. Initialise le modal Bootstrap
   * 3. D√©marre en mode Vendeur/Conseil (s√©curit√©)
   * 4. Attache les event listeners
   * 5. Synchronise avec le StateManager
   * 6. Expose les fonctions globales (compatibilit√©)
   * 7. √âcoute l'√©v√©nement app:initialized
   *
   * @async
   * @returns {Promise&lt;void>}
   * @throws {Error} Si l'initialisation √©choue
   */
  async init() {
    try {
      this.log('Initializing AuthModule...');

      // ==========================================
      // 1. R√âCUP√âRER LES √âL√âMENTS DOM
      // ==========================================
      this.adminModeSwitch = this.getElement('#adminModeSwitch');
      this.adminModeSwitchLabel = this.getElement('#adminModeSwitchLabel');
      this.passwordModalElement = this.getElement('#passwordModal');
      this.passwordInput = this.getElement('#password-input');

      // Initialiser le modal Bootstrap
      if (this.passwordModalElement) {
        this.passwordModal = new bootstrap.Modal(this.passwordModalElement);
      }

      // ==========================================
      // 2. D√âMARRAGE S√âCURIS√â EN MODE VENDEUR
      // ==========================================
      this.startInVendeurMode();

      // ==========================================
      // 3. ATTACHER LES EVENT LISTENERS
      // ==========================================
      this.attachEventListeners();

      // ==========================================
      // 4. SYNCHRONISER AVEC STATEMANAGER
      // ==========================================
      this.syncWithState();

      // ==========================================
      // 5. EXPOSER AU SCOPE GLOBAL (COMPATIBILIT√â)
      // ==========================================
      this.exposeToGlobal({
        getAuthToken: this.getAuthToken,
        verifyPassword: this.verifyPassword,
        setupUserInterface: this.setupUserInterface,
        activateAccueilTab: this.activateAccueilTab,
        activateSearchTab: this.activateSearchTab
      });

      // Exposer aussi les variables au scope global pour compatibilit√©
      this.syncGlobalVariables();

      // ==========================================
      // 6. √âCOUTER L'√âV√âNEMENT APP:INITIALIZED
      // ==========================================
      // Charger le dashboard vendeur apr√®s que tous les modules soient pr√™ts
      this.events.on('app:initialized', () => {
        if (this.isGuestMode) {
          this.log('App initialized - Loading vendeur dashboard...');
          this.activateAccueilTab();
        }
      });

      this.initialized = true;
      this.log('AuthModule initialized successfully');

    } catch (error) {
      this.error('Error initializing AuthModule:', error);
      throw error;
    }
  }

  /**
   * D√©marre l'application en mode Vendeur/Conseil (s√©curit√© par d√©faut)
   *
   * S√©curit√© :
   * - Nettoie le localStorage du mode pr√©c√©dent
   * - Force le mode Vendeur/Conseil
   * - D√©sactive le switch admin
   * - R√©initialise le token de session
   *
   * @private
   */
  startInVendeurMode() {
    this.log('=== INITIALISATION MODE ===');

    // S√âCURIT√â : Nettoyer le localStorage du mode pr√©c√©dent
    localStorage.removeItem('userMode');

    // Toujours d√©marrer en mode Vendeur/Conseil
    this.isGuestMode = true;
    this.isAuthenticatedThisSession = false;
    this.sessionToken = null;

    // Mettre √† jour l'UI du switch
    if (this.adminModeSwitch) this.adminModeSwitch.checked = false;
    if (this.adminModeSwitchLabel) {
      this.adminModeSwitchLabel.textContent = 'üîí Mode: Vendeur/Conseil';
      this.adminModeSwitchLabel.classList.remove('text-success');
      this.adminModeSwitchLabel.classList.add('text-secondary');
    }

    // Configurer l'interface pour le mode Vendeur
    this.setupUserInterface();

    this.log('D√©marrage en mode Vendeur/Conseil (s√©curis√©)');
    this.log('isGuestMode =', this.isGuestMode);
    this.log('isAuthenticatedThisSession =', this.isAuthenticatedThisSession);
    this.log('===========================');
  }

  /**
   * Attache tous les event listeners DOM du module
   *
   * Listeners attach√©s :
   * - Switch admin mode (change)
   * - Bouton submit modal (click)
   * - Champ mot de passe (keydown Enter)
   * - Modal (keydown Escape)
   * - Modal (shown.bs.modal pour focus)
   * - Modal (hidden.bs.modal pour cleanup)
   *
   * @private
   */
  attachEventListeners() {
    // ==========================================
    // SWITCH MODE ADMIN / VENDEUR
    // ==========================================
    if (this.adminModeSwitch) {
      this.adminModeSwitch.addEventListener('change', async (e) => {
        this.log('Switch chang√© - Checked:', e.target.checked);

        if (e.target.checked) {
          // Activation du mode admin : demander le mot de passe
          this.log('Activation mode admin - Affichage modal mot de passe');
          this.showPasswordModal();
        } else {
          // D√©sactivation du mode admin : retour en mode Vendeur/Conseil
          this.log('D√©sactivation mode admin - Retour mode Vendeur/Conseil');
          this.switchToVendeurMode();
        }
      });
    } else {
      this.error('Switch admin mode introuvable !');
    }

    // ==========================================
    // BOUTON SUBMIT DU MODAL
    // ==========================================
    const passwordSubmitBtn = this.getElement('#password-submit-btn');
    if (passwordSubmitBtn) {
      passwordSubmitBtn.addEventListener('click', async () => {
        await this.handlePasswordSubmit();
      });
    }

    // ==========================================
    // TOUCHE ENTER DANS LE CHAMP MOT DE PASSE
    // ==========================================
    if (this.passwordInput) {
      this.passwordInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const submitBtn = this.getElement('#password-submit-btn');
          if (submitBtn) submitBtn.click();
        }
      });
    }

    // ==========================================
    // GESTION DU MODAL BOOTSTRAP
    // ==========================================
    if (this.passwordModalElement) {
      // Touche Escape pour fermer
      this.passwordModalElement.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          const modalInstance = bootstrap.Modal.getInstance(this.passwordModalElement);
          if (modalInstance) modalInstance.hide();
        }
      });

      // Focus automatique sur le champ mot de passe apr√®s ouverture
      this.passwordModalElement.addEventListener('shown.bs.modal', () => {
        if (this.passwordInput) {
          this.passwordInput.focus();
          this.passwordInput.select();
        }
      });

      // Cleanup lors de la fermeture du modal
      this.passwordModalElement.addEventListener('hidden.bs.modal', () => {
        this.handlePasswordModalHidden();
      });
    }
  }

  // ==========================================
  // GESTION DE L'AUTHENTIFICATION
  // ==========================================

  /**
   * R√©cup√®re le token de session actuel
   *
   * @returns {string|null} Token de session ou null si non authentifi√©
   *
   * @example
   * const token = authModule.getAuthToken();
   * if (token) {
   *   // Faire un appel IPC s√©curis√© avec le token
   *   await window.electron.invoke('secure-operation', { token });
   * }
   */
  getAuthToken() {
    return this.sessionToken;
  }

  /**
   * V√©rifie le mot de passe aupr√®s du backend (main process)
   * Utilise bcrypt pour le hashing c√¥t√© serveur
   *
   * Workflow :
   * 1. Appel IPC 'verify-password' avec le mot de passe en clair
   * 2. Backend hash le mot de passe et compare avec la base
   * 3. Si valide ‚Üí g√©n√©ration d'un token de session s√©curis√©
   * 4. Stockage du token dans localStorage et StateManager
   *
   * @param {string} password - Mot de passe √† v√©rifier (en clair)
   * @returns {Promise&lt;boolean>} true si le mot de passe est valide, false sinon
   *
   * @example
   * const isValid = await this.verifyPassword('monMotDePasse123');
   * if (isValid) {
   *   console.log('Authentification r√©ussie !');
   * }
   */
  async verifyPassword(password) {
    try {
      // Appel IPC s√©curis√© pour v√©rifier le mot de passe
      const result = await this.invoke('verify-password', password);

      if (result.success &amp;&amp; result.sessionToken) {
        // Stocker le token de session
        this.sessionToken = result.sessionToken;
        localStorage.setItem('sessionToken', this.sessionToken);
        this.log('[AUTH] Session cr√©√©e avec token');

        // Synchroniser avec StateManager
        this.state.set('sessionToken', this.sessionToken);
      }

      return result.success;
    } catch (error) {
      this.error('Erreur lors de la v√©rification du mot de passe:', error);
      NotificationSystem.error(`Erreur: ${error.message}`);
      return false;
    }
  }

  /**
   * Affiche le modal de mot de passe
   * Retire l'attribut 'inert' et affiche le modal Bootstrap
   *
   * @private
   */
  showPasswordModal() {
    if (this.passwordModalElement) {
      this.passwordModalElement.removeAttribute('inert');
      this.passwordModal.show();
    }
  }

  /**
   * G√®re la soumission du mot de passe
   *
   * Workflow :
   * 1. R√©cup√®re le mot de passe saisi
   * 2. Valide qu'il n'est pas vide
   * 3. V√©rifie le mot de passe via IPC
   * 4. Si valide ‚Üí active le mode admin + ferme le modal + notification succ√®s
   * 5. Si invalide ‚Üí efface le champ + notification erreur
   *
   * @private
   * @async
   * @returns {Promise&lt;void>}
   */
  async handlePasswordSubmit() {
    if (!this.passwordInput) return;

    // R√©cup√©rer et valider le mot de passe
    const password = this.passwordInput.value.trim();
    if (!password) {
      NotificationSystem.error('Veuillez saisir un mot de passe');
      return;
    }

    // V√©rifier le mot de passe
    const isValid = await this.verifyPassword(password);

    if (isValid) {
      // ==========================================
      // AUTHENTIFICATION R√âUSSIE
      // ==========================================

      // Mode Admin : acc√®s complet
      this.isAuthenticatedThisSession = true;
      this.isGuestMode = false;
      this.passwordInput.value = '';
      this.passwordModal.hide();

      // S√âCURIT√â : Ne plus persister le mode admin dans localStorage
      // L'utilisateur devra se r√©authentifier √† chaque d√©marrage

      // Configurer l'interface pour le mode admin
      this.setupUserInterface();
      this.activateAccueilTab();

      // Mettre √† jour le switch et son label
      if (this.adminModeSwitch) this.adminModeSwitch.checked = true;
      if (this.adminModeSwitchLabel) {
        this.adminModeSwitchLabel.textContent = 'üîì Mode: Administrateur';
        this.adminModeSwitchLabel.classList.remove('text-secondary');
        this.adminModeSwitchLabel.classList.add('text-success');
      }

      // Synchroniser avec StateManager
      this.syncWithState();

      // √âmettre √©v√©nement de connexion
      this.emitEvent('login', { mode: 'admin' });

      // Notification de succ√®s
      NotificationSystem.success('Mode Administrateur activ√©');
    } else {
      // ==========================================
      // AUTHENTIFICATION √âCHOU√âE
      // ==========================================

      NotificationSystem.error('Mot de passe incorrect');
      this.passwordInput.value = '';
    }
  }

  /**
   * G√®re la fermeture du modal de mot de passe
   *
   * Cleanup :
   * - Ajoute l'attribut 'inert' au modal
   * - Efface le champ mot de passe
   * - Si pas authentifi√© ‚Üí d√©sactive le switch + retour mode Vendeur
   *
   * @private
   */
  handlePasswordModalHidden() {
    // Ajouter l'attribut inert pour accessibilit√©
    if (this.passwordModalElement) {
      this.passwordModalElement.setAttribute('inert', '');
    }

    // Effacer le mot de passe
    if (this.passwordInput) {
      this.passwordInput.value = '';
    }

    // Si le modal se ferme sans authentification, d√©sactiver le switch
    if (!this.isAuthenticatedThisSession) {
      if (this.adminModeSwitch) this.adminModeSwitch.checked = false;
      this.isGuestMode = true;
      this.setupUserInterface();
    }
  }

  /**
   * Passe en mode Vendeur/Conseil (d√©connexion admin)
   *
   * Actions :
   * - R√©initialise les flags d'authentification
   * - D√©truit le token de session
   * - Nettoie le localStorage
   * - Reconfigure l'interface
   * - Active l'onglet Recherche
   * - √âmet l'√©v√©nement 'auth:logout'
   *
   * @private
   */
  switchToVendeurMode() {
    // R√©initialiser l'√©tat d'authentification
    this.isAuthenticatedThisSession = false;
    this.isGuestMode = true;
    this.sessionToken = null;

    // S√âCURIT√â : Nettoyer le token du localStorage
    localStorage.removeItem('sessionToken');

    // Reconfigurer l'interface pour le mode Vendeur
    this.setupUserInterface();

    // Exception : Admin ‚Üí Vendeur = onglet Recherche (pas Accueil)
    this.activateSearchTab();

    // Mettre √† jour le label du switch
    if (this.adminModeSwitchLabel) {
      this.adminModeSwitchLabel.textContent = 'üîí Mode: Vendeur/Conseil';
      this.adminModeSwitchLabel.classList.remove('text-success');
      this.adminModeSwitchLabel.classList.add('text-secondary');
    }

    // Synchroniser avec StateManager
    this.syncWithState();

    // √âmettre √©v√©nement de d√©connexion
    this.emitEvent('logout', { mode: 'vendeur' });

    // Notification
    NotificationSystem.info('Retour en mode Vendeur/Conseil');
  }

  // ==========================================
  // CONFIGURATION DE L'INTERFACE
  // ==========================================

  /**
   * Configure l'interface selon le mode actuel (Admin ou Vendeur/Conseil)
   *
   * Mode Vendeur/Conseil - Masque :
   * - Onglet Tableau de bord
   * - Onglet Admin
   * - Onglet Factures
   * - Onglet Configuration
   * - Onglet Templates
   * - Onglet Fournisseurs
   * - Onglet CA du Mois
   * - Boutons Export PDF, Imprimer, Envoyer email (dans l'onglet Devis)
   *
   * Mode Admin - Affiche :
   * - Tous les onglets
   * - Tous les boutons
   *
   * √âmet l'√©v√©nement 'auth:interface-updated' apr√®s reconfiguration
   *
   * @example
   * // Reconfigurer l'interface apr√®s changement de mode
   * this.setupUserInterface();
   */
  setupUserInterface() {
    // ==========================================
    // R√âCUP√âRER LES √âL√âMENTS DOM
    // ==========================================
    const adminTab = this.getElement('#admin-tab');
    const invoicesTab = this.getElement('#invoices-tab');
    const configTab = this.getElement('#config-tab');
    const templatesTabHeader = this.getElement('#templates-tab-header');
    const suppliersTabHeader = this.getElement('#suppliers-tab-header');
    const clientsTabHeader = this.getElement('#clients-tab-header');
    const dashboardTab = this.getElement('#dashboard-tab');
    const revenueTabHeader = this.getElement('#revenue-tab-header');

    // Boutons de l'onglet Devis r√©serv√©s aux admins
    const exportPdfBtn = this.getElement('#export-quote-btn');
    const printBtn = this.getElement('#print-quote-btn');
    const sendEmailBtn = this.getElement('#send-quote-btn');

    this.log('setupUserInterface - Mode Vendeur/Conseil:', this.isGuestMode);

    // ==========================================
    // MODE VENDEUR/CONSEIL : MASQUER LES ONGLETS ADMIN
    // ==========================================
    if (this.isGuestMode) {
      if (dashboardTab) {
        dashboardTab.parentElement.style.display = 'none';
        this.log('Onglet Tableau de bord masqu√©');
      }
      if (adminTab) {
        adminTab.parentElement.style.display = 'none';
        this.log('Onglet Admin masqu√©');
      }
      if (invoicesTab) {
        invoicesTab.parentElement.style.display = 'none';
        this.log('Onglet Factures masqu√©');
      }
      if (configTab) {
        configTab.parentElement.style.display = 'none';
        this.log('Onglet Config masqu√©');
      }
      if (templatesTabHeader) {
        templatesTabHeader.style.display = 'none';
        this.log('Onglet Templates masqu√©');
      }
      if (suppliersTabHeader) {
        suppliersTabHeader.style.display = 'none';
        this.log('Onglet Fournisseurs masqu√©');
      }
      if (clientsTabHeader) {
        clientsTabHeader.style.display = 'none';
        this.log('Onglet Clients masqu√©');
      }
      if (revenueTabHeader) {
        revenueTabHeader.style.display = 'none';
        this.log('Onglet CA du Mois masqu√©');
      }

      // Masquer les boutons admin dans l'onglet Devis
      if (exportPdfBtn) exportPdfBtn.style.display = 'none';
      if (printBtn) printBtn.style.display = 'none';
      if (sendEmailBtn) sendEmailBtn.style.display = 'none';
      this.log('Boutons Devis admin masqu√©s');
    }
    // ==========================================
    // MODE ADMIN : AFFICHER TOUS LES ONGLETS
    // ==========================================
    else {
      if (dashboardTab) {
        dashboardTab.parentElement.style.display = '';
        this.log('Onglet Tableau de bord affich√©');
      }
      if (adminTab) {
        adminTab.parentElement.style.display = '';
        this.log('Onglet Admin affich√©');
      }
      if (invoicesTab) {
        invoicesTab.parentElement.style.display = '';
        this.log('Onglet Factures affich√©');
      }
      if (configTab) {
        configTab.parentElement.style.display = '';
        this.log('Onglet Config affich√©');
      }
      if (templatesTabHeader) {
        templatesTabHeader.style.display = '';
        this.log('Onglet Templates affich√©');
      }
      if (suppliersTabHeader) {
        suppliersTabHeader.style.display = '';
        this.log('Onglet Fournisseurs affich√©');
      }
      if (clientsTabHeader) {
        clientsTabHeader.style.display = '';
        this.log('Onglet Clients affich√©');
      }
      if (revenueTabHeader) {
        revenueTabHeader.style.display = '';
        this.log('Onglet CA du Mois affich√©');
      }

      // Afficher les boutons admin dans l'onglet Devis
      if (exportPdfBtn) exportPdfBtn.style.display = '';
      if (printBtn) printBtn.style.display = '';
      if (sendEmailBtn) sendEmailBtn.style.display = '';
      this.log('Boutons Devis admin affich√©s');
    }

    // ==========================================
    // GESTION ONGLETS ACCUEIL / TABLEAU DE BORD
    // ==========================================
    const accueilTabHeader = this.getElement('#accueil-tab-header');
    const dashboardTabHeader = this.getElement('#dashboard-tab-header');

    if (this.isGuestMode) {
      // Mode Vendeur/Conseil : seul l'onglet Accueil est visible
      if (accueilTabHeader) {
        accueilTabHeader.style.display = '';
        this.log('Onglet Accueil affich√© pour mode Vendeur');
      }
      if (dashboardTabHeader) {
        dashboardTabHeader.style.display = 'none';
        this.log('Onglet Tableau de Bord masqu√© pour mode Vendeur');
      }

      // Charger les donn√©es du dashboard vendeur
      if (typeof window.loadVendeurDashboard === 'function') {
        window.loadVendeurDashboard();
      }
    } else {
      // Mode Admin : les deux onglets sont visibles
      if (accueilTabHeader) {
        accueilTabHeader.style.display = '';
        this.log('Onglet Accueil affich√© pour mode Admin');
      }
      if (dashboardTabHeader) {
        dashboardTabHeader.style.display = '';
        this.log('Onglet Tableau de Bord affich√© pour mode Admin');
      }

      // Charger les donn√©es du dashboard admin
      if (typeof window.loadAdminDashboard === 'function') {
        window.loadAdminDashboard();
      }
    }

    // √âmettre √©v√©nement de changement d'interface
    this.emitEvent('interface-updated', { isGuestMode: this.isGuestMode });
  }

  /**
   * Active l'onglet Accueil (dashboard vendeur)
   * D√©sactive tous les autres onglets
   *
   * Utilis√© :
   * - Au d√©marrage de l'application
   * - Apr√®s connexion admin
   * - Apr√®s que app:initialized soit √©mis
   */
  activateAccueilTab() {
    const accueilTab = this.getElement('#accueil-tab');
    const accueilPane = this.getElement('#accueil');

    if (!accueilTab || !accueilPane) {
      this.warn('[Accueil] Onglet Accueil introuvable');
      return;
    }

    // D√©sactiver tous les autres onglets
    this.getElements('.nav-link').forEach(tab => {
      tab.classList.remove('active');
    });
    this.getElements('.tab-pane').forEach(pane => {
      pane.classList.remove('show', 'active');
    });

    // Activer l'onglet Accueil
    accueilTab.classList.add('active');
    accueilPane.classList.add('show', 'active');

    this.log('[Accueil] Onglet Accueil activ√©');

    // Charger les donn√©es du dashboard vendeur
    if (typeof window.loadVendeurDashboard === 'function') {
      window.loadVendeurDashboard();
    }
  }

  /**
   * Active l'onglet Recherche
   * D√©sactive tous les autres onglets
   *
   * Utilis√© uniquement lors du passage Admin ‚Üí Vendeur en cours de session
   * (Exception : permet au vendeur de continuer sur l'onglet Recherche)
   */
  activateSearchTab() {
    const searchTab = this.getElement('#search-tab');
    const searchPane = this.getElement('#search');

    if (!searchTab || !searchPane) {
      this.warn('[Recherche] Onglet Recherche introuvable');
      return;
    }

    // D√©sactiver tous les autres onglets
    this.getElements('.nav-link').forEach(tab => {
      tab.classList.remove('active');
    });
    this.getElements('.tab-pane').forEach(pane => {
      pane.classList.remove('show', 'active');
    });

    // Activer l'onglet Recherche
    searchTab.classList.add('active');
    searchPane.classList.add('show', 'active');

    this.log('[Recherche] Onglet Recherche activ√©');
  }

  // ==========================================
  // SYNCHRONISATION AVEC STATE MANAGER
  // ==========================================

  /**
   * Synchronise l'√©tat local du module avec le StateManager global
   *
   * Propri√©t√©s synchronis√©es :
   * - isAuthenticatedThisSession
   * - isGuestMode
   * - sessionToken
   *
   * @private
   */
  syncWithState() {
    this.state.set('isAuthenticatedThisSession', this.isAuthenticatedThisSession);
    this.state.set('isGuestMode', this.isGuestMode);
    this.state.set('sessionToken', this.sessionToken);
  }

  /**
   * Expose les variables d'authentification au scope global pour compatibilit√© legacy
   *
   * Cr√©e des getters/setters sur window qui se synchronisent automatiquement
   * avec l'√©tat du module
   *
   * Variables expos√©es :
   * - window.isAuthenticatedThisSession
   * - window.isGuestMode
   * - window.sessionToken
   *
   * @private
   *
   * @example
   * // Dans un ancien code legacy
   * if (window.isGuestMode) {
   *   console.log('Mode vendeur actif');
   * }
   */
  syncGlobalVariables() {
    // Cr√©er des getters/setters pour synchroniser automatiquement

    Object.defineProperty(window, 'isAuthenticatedThisSession', {
      get: () => this.isAuthenticatedThisSession,
      set: (value) => {
        this.isAuthenticatedThisSession = value;
        this.syncWithState();
      }
    });

    Object.defineProperty(window, 'isGuestMode', {
      get: () => this.isGuestMode,
      set: (value) => {
        this.isGuestMode = value;
        this.syncWithState();
      }
    });

    Object.defineProperty(window, 'sessionToken', {
      get: () => this.sessionToken,
      set: (value) => {
        this.sessionToken = value;
        this.syncWithState();
      }
    });
  }

  // ==========================================
  // M√âTHODES UTILITAIRES
  // ==========================================

  /**
   * V√©rifie si l'utilisateur est authentifi√©
   *
   * @returns {boolean} true si authentifi√©, false sinon
   *
   * @example
   * if (authModule.isAuthenticated()) {
   *   // Autoriser l'op√©ration admin
   * }
   */
  isAuthenticated() {
    return this.isAuthenticatedThisSession;
  }

  /**
   * V√©rifie si l'utilisateur est en mode invit√© (Vendeur/Conseil)
   *
   * @returns {boolean} true si en mode invit√©, false sinon
   *
   * @example
   * if (authModule.isGuest()) {
   *   // Masquer les fonctionnalit√©s admin
   * }
   */
  isGuest() {
    return this.isGuestMode;
  }

  /**
   * V√©rifie si l'utilisateur est admin
   * (authentifi√© ET pas en mode invit√©)
   *
   * @returns {boolean} true si admin, false sinon
   *
   * @example
   * if (authModule.isAdmin()) {
   *   // Afficher toutes les fonctionnalit√©s
   * }
   */
  isAdmin() {
    return this.isAuthenticatedThisSession &amp;&amp; !this.isGuestMode;
  }
}

export default AuthModule;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
