

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> modules/fec/FECModule.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule.html">DashboardModule</a></li><li><a href="module-DataCache.html">DataCache</a></li><li><a href="module-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule.html">FECModule</a></li><li><a href="module-FollowUpModule.html">FollowUpModule</a></li><li><a href="module-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-KeyboardShortcutsModule.html">KeyboardShortcutsModule</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-MLService.html">MLService</a></li><li><a href="module-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-NotificationSystem.html">NotificationSystem</a></li><li><a href="module-NotificationSystemV2.html">NotificationSystemV2</a></li><li><a href="module-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-TourModule.html">TourModule</a></li><li><a href="module-UtilitiesModule.html">UtilitiesModule</a></li><li><a href="module-calculations.html">calculations</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-formatters.html">formatters</a></li><li><a href="module-helpers.html">helpers</a></li></ul><h3>Classes</h3><ul><li><a href="BaseModule.html">BaseModule</a></li><li><a href="BulkActionsManager.html">BulkActionsManager</a></li><li><a href="CacheKeys.html">CacheKeys</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="LoadingStateManager.html">LoadingStateManager</a></li><li><a href="ModalHelper.html">ModalHelper</a></li><li><a href="PaginationManager.html">PaginationManager</a></li><li><a href="ServerValidator.html">ServerValidator</a></li><li><a href="StateManager.html">StateManager</a></li><li><a href="TabRefreshManager.html">TabRefreshManager</a></li><li><a href="UndoRedoManager.html">UndoRedoManager</a></li><li><a href="module-AboutModule-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule-DashboardModule.html">DashboardModule</a></li><li><a href="module-ExportModule-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule-FECModule.html">FECModule</a></li><li><a href="module-ImportModule-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-Logger-Logger.html">Logger</a></li><li><a href="module-Logger-ModuleLogger.html">ModuleLogger</a></li><li><a href="module-MaterialsModule-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-PDFModule-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-UtilitiesModule-UtilitiesModule.html">UtilitiesModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#emitSync">emitSync</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#validateBeforeAddToQuote">validateBeforeAddToQuote</a></li><li><a href="global.html#validateBeforeExport">validateBeforeExport</a></li><li><a href="global.html#validateBeforeSaveMaterial">validateBeforeSaveMaterial</a></li><li><a href="global.html#validateBeforeSendEmail">validateBeforeSendEmail</a></li><li><a href="global.html#validateHeaderConfig">validateHeaderConfig</a></li><li><a href="global.html#validatePasswordChange">validatePasswordChange</a></li><li><a href="global.html#validateSMTPConfig">validateSMTPConfig</a></li><li><a href="global.html#waitFor">waitFor</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>modules/fec/FECModule.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * ========================================
 * FEC MODULE - Export comptable FEC
 * ========================================
 *
 * Module de gestion des exports au format FEC (Fichier des Écritures Comptables)
 * pour AutoCalc OptiDevis. Permet l'export comptable conforme à la législation française.
 *
 * Architecture :
 * Le module gère l'export FEC avec :
 * - **Sélection de période** : Date début et date fin via modal Bootstrap
 * - **Export factures** : Conversion des factures en écritures comptables FEC
 * - **Format FEC** : Fichier texte (.txt) avec séparateur pipe (|)
 * - **Téléchargement** : Génération Blob et téléchargement automatique
 * - **Conformité légale** : Format obligatoire pour l'administration fiscale française
 *
 * ==========================================
 * QU'EST-CE QUE LE FEC ?
 * ==========================================
 *
 * **FEC = Fichier des Écritures Comptables**
 *
 * **Contexte légal** :
 * - Article A47 A-1 du Livre des procédures fiscales (LPF)
 * - OBLIGATOIRE en France pour toutes les entreprises tenant une comptabilité informatisée
 * - Doit être fourni à l'administration fiscale lors d'un contrôle fiscal
 * - Format standardisé défini par l'arrêté du 29 juillet 2013
 *
 * **Qu'est-ce qu'un FEC contient ?**
 * - TOUTES les écritures comptables de l'exercice fiscal
 * - Journal des ventes (factures clients)
 * - Journal des achats (factures fournisseurs)
 * - Journal de banque (opérations bancaires)
 * - Journal des opérations diverses (OD)
 *
 * **Dans AutoCalc OptiDevis** :
 * - Export limité au journal des ventes (factures clients)
 * - Une ligne FEC par facture émise
 * - Période personnalisable (par défaut : année civile en cours)
 *
 * ==========================================
 * FORMAT FEC STANDARDISÉ
 * ==========================================
 *
 * **Structure du fichier** :
 * - Fichier texte (.txt)
 * - Encodage : UTF-8
 * - Séparateur : Pipe (|)
 * - En-tête : Noms de colonnes (18 colonnes)
 * - Corps : Une ligne par écriture comptable
 *
 * **18 colonnes obligatoires** :
 * 1. JournalCode : Code du journal (ex: "VE" pour Ventes)
 * 2. JournalLib : Libellé du journal (ex: "Journal des ventes")
 * 3. EcritureNum : Numéro de l'écriture (unique, ex: "VE001")
 * 4. EcritureDate : Date de l'écriture (YYYYMMDD, ex: "20250115")
 * 5. CompteNum : Numéro de compte (ex: "411001" pour client, "707000" pour vente)
 * 6. CompteLib : Libellé du compte (ex: "Client Dupont", "Ventes de marchandises")
 * 7. CompAuxNum : Numéro de compte auxiliaire (ex: code client)
 * 8. CompAuxLib : Libellé du compte auxiliaire (ex: nom client)
 * 9. PieceRef : Référence de la pièce (ex: "FAC-2025-001")
 * 10. PieceDate : Date de la pièce (YYYYMMDD)
 * 11. EcritureLib : Libellé de l'écriture (ex: "Facture FAC-2025-001 - Client Dupont")
 * 12. Debit : Montant au débit (format: 00.00)
 * 13. Credit : Montant au crédit (format: 00.00)
 * 14. EcritureLet : Lettrage (optionnel, vide si non lettré)
 * 15. DateLet : Date de lettrage (optionnel)
 * 16. ValidDate : Date de validation (YYYYMMDD)
 * 17. Montantdevise : Montant en devise (optionnel, vide si EUR)
 * 18. Idevise : Code devise (optionnel, vide si EUR)
 *
 * **Exemple d'écritures FEC pour une facture** :
 * ```
 * VE|Journal des ventes|VE001|20250115|411001|Client Dupont|C001|Dupont SA|FAC-2025-001|20250115|Facture FAC-2025-001|1200.00||||||
 * VE|Journal des ventes|VE001|20250115|707000|Ventes de marchandises|||FAC-2025-001|20250115|Facture FAC-2025-001||1000.00||||
 * VE|Journal des ventes|VE001|20250115|445710|TVA collectée|||FAC-2025-001|20250115|Facture FAC-2025-001||200.00||||
 * ```
 * → 3 lignes : Débit client (1200€) = Crédit ventes (1000€) + Crédit TVA (200€)
 *
 * ==========================================
 * WORKFLOW COMPLET - EXPORT FEC
 * ==========================================
 *
 * **Phase 1 : Ouverture du modal** (exportFEC)
 * 1. Utilisateur clique "Exporter FEC"
 * 2. Calcul des dates par défaut :
 *    - startDate : 1er janvier de l'année en cours
 *    - endDate : 31 décembre de l'année en cours
 * 3. Récupération modal #exportFECModal
 * 4. Pré-remplissage :
 *    - #fec-start-date = 1er janvier (YYYY-01-01)
 *    - #fec-end-date = 31 décembre (YYYY-12-31)
 * 5. Affichage modal via Bootstrap
 * 6. Émission événement 'export-modal-opened' avec { startDate, endDate }
 *
 * **Phase 2 : Confirmation et export** (confirmExportFEC)
 * 7. Utilisateur ajuste les dates si nécessaire et clique "Confirmer"
 * 8. Vérification authToken (réservé utilisateurs connectés)
 * 9. Récupération #fec-start-date et #fec-end-date
 * 10. Validation : Dates non vides (sinon error)
 * 11. Envoi IPC 'export-fec' avec authToken + { startDate, endDate }
 * 12. Backend :
 *     a. Récupère toutes les factures payées entre startDate et endDate
 *     b. Convertit chaque facture en écritures comptables FEC (3 lignes/facture)
 *     c. Génère fichier texte avec séparateur pipe
 *     d. Retourne { success, content, fileName, entriesCount }
 * 13. Si erreur → NotificationSystem.error + return
 * 14. Création Blob : new Blob([content], { type: 'text/plain;charset=utf-8' })
 * 15. Téléchargement automatique :
 *     - Création URL.createObjectURL(blob)
 *     - Création &lt;a> avec href=url et download=fileName
 *     - Clic automatique a.click()
 *     - Nettoyage : removeChild(a) + URL.revokeObjectURL(url)
 * 16. Fermeture modal #exportFECModal
 * 17. NotificationSystem.success "Export FEC réussi (X factures)"
 * 18. Émission événement 'export-completed' avec { fileName, entriesCount, startDate, endDate }
 *
 * ==========================================
 * MODAL BOOTSTRAP
 * ==========================================
 *
 * **Modal Export FEC** (#exportFECModal) :
 * - Titre : "Exporter FEC"
 * - Champs :
 *   - #fec-start-date : Input type="date" (date début période)
 *   - #fec-end-date : Input type="date" (date fin période)
 * - Boutons : "Confirmer", "Annuler"
 * - Action "Confirmer" : Appelle confirmExportFEC()
 *
 * **Valeurs par défaut** :
 * - Start : 1er janvier de l'année en cours (new Date(now.getFullYear(), 0, 1))
 * - End : 31 décembre de l'année en cours (new Date(now.getFullYear(), 11, 31))
 * - Format ISO : YYYY-MM-DD (ex: 2025-01-01)
 *
 * ==========================================
 * IPC CHANNEL (ELECTRON)
 * ==========================================
 *
 * **export-fec** :
 * - Paramètres : authToken, { startDate, endDate }
 * - Retour : { success: boolean, content: string, fileName: string, entriesCount: number, message?: string }
 * - Action :
 *   1. Filtre les factures entre startDate et endDate
 *   2. Convertit chaque facture en 3 lignes FEC (débit client, crédit vente, crédit TVA)
 *   3. Génère fichier texte avec en-tête + lignes FEC
 *   4. Retourne contenu + nom fichier (ex: "FEC_2025.txt")
 *
 * **Exemple de fileName généré** :
 * - FEC_2025.txt (si export année complète)
 * - FEC_2025-01-01_2025-03-31.txt (si période personnalisée)
 *
 * ==========================================
 * ÉVÉNEMENTS ÉMIS
 * ==========================================
 *
 * **EventBus interne** :
 * - 'export-modal-opened' : Après ouverture modal (avec { startDate, endDate })
 * - 'export-completed' : Après export réussi (avec { fileName, entriesCount, startDate, endDate })
 *
 * ==========================================
 * INTÉGRATIONS
 * ==========================================
 *
 * - **InvoicesModule** : Utilise les factures pour générer les écritures FEC
 * - **AuthModule** : Utilise window.getAuthToken() pour authentification
 * - **NotificationSystem** : Feedback utilisateur (success, error)
 * - **Bootstrap 5.3.3** : Modal de sélection de période
 * - **IPC Electron** : export-fec
 * - **Blob API** : Génération et téléchargement du fichier
 *
 * ==========================================
 * SÉCURITÉ &amp; VALIDATION
 * ==========================================
 *
 * **Authentification** :
 * - Export réservé aux utilisateurs connectés (vérification authToken)
 * - Protection IPC côté backend
 *
 * **Validation** :
 * - Dates non vides (sinon error "Veuillez sélectionner les dates")
 * - startDate &lt;= endDate (validation côté backend)
 *
 * **Nettoyage mémoire** :
 * - URL.revokeObjectURL(url) après téléchargement (évite fuite mémoire)
 * - removeChild(a) après clic (évite pollution DOM)
 *
 * ==========================================
 * CAS D'USAGE
 * ==========================================
 *
 * **Contrôle fiscal** :
 * - Admin reçoit notification de contrôle fiscal
 * - Admin clique "Exporter FEC"
 * - Sélectionne période de l'exercice fiscal (ex: 01/01/2024 au 31/12/2024)
 * - Télécharge FEC_2024.txt
 * - Fournit le fichier à l'administration fiscale
 *
 * **Transfert comptable** :
 * - Admin veut importer les ventes dans logiciel comptable (Sage, Cegid, EBP)
 * - Export FEC de la période
 * - Import du FEC dans le logiciel comptable
 * - Écritures automatiquement créées
 *
 * @module FECModule
 * @extends BaseModule
 * @version 2.0.0
 * @author AutoCalc OptiDevis
 */

import BaseModule from '../../core/BaseModule.js';
import NotificationSystem from '../../shared/ui/NotificationSystem.js';

class FECModule extends BaseModule {
  /**
   * Crée une instance du module FEC.
   *
   * @param {StateManager} state - Gestionnaire d'état global
   * @param {EventBus} eventBus - Bus d'événements
   */
  constructor(state, eventBus) {
    super('fec', state, eventBus);

    this.log('FECModule instantiated');
  }

  /**
   * Initialise le module FEC.
   * Expose les fonctions globales pour compatibilité.
   *
   * @async
   * @returns {Promise&lt;void>}
   * @throws {Error} Si l'initialisation échoue
   */
  async init() {
    try {
      this.log('Initializing FECModule...');

      // Attacher les event listeners
      this.attachEventListeners();

      // Exposer les fonctions au scope global
      this.exposeToGlobal({
        exportFEC: this.exportFEC,
        confirmExportFEC: this.confirmExportFEC
      });

      this.initialized = true;
      this.log('FECModule initialized successfully');

    } catch (error) {
      this.error('Error initializing FECModule:', error);
      throw error;
    }
  }

  /**
   * Attache les event listeners DOM.
   *
   * @private
   * @returns {void}
   */
  attachEventListeners() {
    // Bouton de confirmation d'export FEC
    this.addDOMListener('#confirmExportFECBtn', 'click', () => {
      this.confirmExportFEC();
    });
  }

  // ==========================================
  // EXPORT FEC
  // ==========================================

  /**
   * Ouvre le modal d'export FEC avec les dates par défaut (année civile en cours).
   * Pré-remplit les champs de date avec 1er janvier et 31 décembre de l'année en cours.
   *
   * Workflow :
   * 1. Calcule dates par défaut :
   *    - startDate : 1er janvier (new Date(now.getFullYear(), 0, 1))
   *    - endDate : 31 décembre (new Date(now.getFullYear(), 11, 31))
   * 2. Récupère #exportFECModal (si absent → error)
   * 3. Pré-remplit #fec-start-date et #fec-end-date au format ISO (YYYY-MM-DD)
   * 4. Affiche modal via Bootstrap
   * 5. Émet événement 'export-modal-opened' avec { startDate, endDate }
   *
   * @public
   * @returns {void}
   * @fires NotificationSystem#error Si modal introuvable
   * @fires EventBus#export-modal-opened Après ouverture (avec { startDate, endDate })
   *
   * @example
   * // Admin clique "Exporter FEC"
   * exportFEC();
   * // → Modal s'ouvre
   * // → Dates pré-remplies : 2025-01-01 à 2025-12-31
   */
  exportFEC = () => {
    try {
      this.log('Opening FEC export modal...');

      // Ouvrir le modal
      const exportFECModalElement = this.getElement('#exportFECModal');
      if (!exportFECModalElement) {
        NotificationSystem.error('Modal FEC introuvable');
        return;
      }

      // Initialiser les dates par défaut (année en cours)
      const now = new Date();
      const startOfYear = new Date(now.getFullYear(), 0, 1);
      const endOfYear = new Date(now.getFullYear(), 11, 31);

      const startDateInput = this.getElement('#fec-start-date');
      const endDateInput = this.getElement('#fec-end-date');

      if (startDateInput) {
        startDateInput.value = startOfYear.toISOString().split('T')[0];
      }
      if (endDateInput) {
        endDateInput.value = endOfYear.toISOString().split('T')[0];
      }

      const exportFECModal = new bootstrap.Modal(exportFECModalElement);
      exportFECModal.show();

      this.log('FEC export modal opened');
      this.emitEvent('export-modal-opened', { startDate: startOfYear, endDate: endOfYear });

    } catch (error) {
      this.error('Error opening FEC export modal:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };

  /**
   * Confirme et exécute l'export FEC avec les dates sélectionnées.
   * Génère le fichier FEC, le télécharge automatiquement et ferme le modal.
   *
   * Workflow complet : Voir en-tête du module "WORKFLOW COMPLET - EXPORT FEC"
   *
   * Étapes principales :
   * 1. Vérification authToken (si absent → error)
   * 2. Récupération #fec-start-date et #fec-end-date
   * 3. Validation : Dates non vides (sinon error)
   * 4. Envoi IPC 'export-fec' avec authToken + { startDate, endDate }
   * 5. Backend génère FEC avec toutes les factures de la période
   * 6. Si erreur → NotificationSystem.error + return
   * 7. Création Blob : new Blob([content], { type: 'text/plain;charset=utf-8' })
   * 8. Téléchargement automatique :
   *    - URL.createObjectURL(blob)
   *    - &lt;a href=url download=fileName>.click()
   *    - Nettoyage : removeChild + URL.revokeObjectURL
   * 9. Fermeture modal #exportFECModal
   * 10. NotificationSystem.success "Export FEC réussi (X factures)"
   * 11. Émet événement 'export-completed' avec { fileName, entriesCount, startDate, endDate }
   *
   * Format du fichier téléchargé :
   * - Nom : FEC_2025.txt ou FEC_2025-01-01_2025-03-31.txt
   * - Type : text/plain UTF-8
   * - Séparateur : Pipe (|)
   * - 18 colonnes par ligne
   * - 3 lignes par facture (débit client, crédit vente, crédit TVA)
   *
   * @public
   * @async
   * @returns {Promise&lt;void>}
   * @fires NotificationSystem#error Si non connecté, dates manquantes ou erreur IPC
   * @fires NotificationSystem#success Si export réussi
   * @fires EventBus#export-completed Après export réussi (avec { fileName, entriesCount, startDate, endDate })
   *
   * @example
   * // Admin clique "Confirmer" dans le modal (dates : 01/01/2025 au 31/12/2025)
   * await confirmExportFEC();
   * // → IPC 'export-fec' envoyé
   * // → Fichier FEC_2025.txt téléchargé
   * // → "Export FEC réussi (124 factures)"
   * // → Modal fermé
   */
  confirmExportFEC = async () => {
    try {
      this.log('Confirming FEC export...');

      // Utiliser la fonction globale getAuthToken() exposée par AuthModule
      const authToken = typeof window.getAuthToken === 'function' ? window.getAuthToken() : null;
      if (!authToken) {
        NotificationSystem.error('Vous devez être connecté pour exporter');
        return;
      }

      const startDate = this.getValue('#fec-start-date');
      const endDate = this.getValue('#fec-end-date');

      // Validation: dates non vides
      if (!startDate || !endDate) {
        NotificationSystem.error('Veuillez sélectionner les dates');
        return;
      }

      // Validation: dates valides
      const start = new Date(startDate);
      const end = new Date(endDate);

      if (isNaN(start.getTime()) || isNaN(end.getTime())) {
        NotificationSystem.error('Dates invalides');
        return;
      }

      // Validation: startDate &lt;= endDate
      if (start > end) {
        NotificationSystem.error('La date de début doit être antérieure ou égale à la date de fin');
        return;
      }

      this.log('Exporting FEC from', startDate, 'to', endDate);

      const result = await this.invoke('export-fec', authToken, {
        startDate,
        endDate
      });

      if (!result.success) {
        NotificationSystem.error(result.message || 'Erreur export');
        this.error('FEC export failed:', result.message);
        return;
      }

      // Télécharger le fichier
      const blob = new Blob([result.content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = result.fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Fermer le modal
      const exportFECModalElement = this.getElement('#exportFECModal');
      const exportFECModal = bootstrap.Modal.getInstance(exportFECModalElement);
      if (exportFECModal) exportFECModal.hide();

      NotificationSystem.success(`Export FEC réussi (${result.entriesCount} factures)`);
      this.log('FEC export successful:', result.entriesCount, 'entries');

      // Émettre événement
      this.emitEvent('export-completed', {
        fileName: result.fileName,
        entriesCount: result.entriesCount,
        startDate,
        endDate
      });

    } catch (error) {
      this.error('Error exporting FEC:', error);
      NotificationSystem.error(`Erreur : ${error.message}`);
    }
  };
}

export default FECModule;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
