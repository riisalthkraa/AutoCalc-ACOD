

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> shared/ui/TabRefreshManager.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule.html">DashboardModule</a></li><li><a href="module-DataCache.html">DataCache</a></li><li><a href="module-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule.html">FECModule</a></li><li><a href="module-FollowUpModule.html">FollowUpModule</a></li><li><a href="module-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-KeyboardShortcutsModule.html">KeyboardShortcutsModule</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-MLService.html">MLService</a></li><li><a href="module-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-NotificationSystem.html">NotificationSystem</a></li><li><a href="module-NotificationSystemV2.html">NotificationSystemV2</a></li><li><a href="module-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-TourModule.html">TourModule</a></li><li><a href="module-UtilitiesModule.html">UtilitiesModule</a></li><li><a href="module-calculations.html">calculations</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-formatters.html">formatters</a></li><li><a href="module-helpers.html">helpers</a></li></ul><h3>Classes</h3><ul><li><a href="BaseModule.html">BaseModule</a></li><li><a href="BulkActionsManager.html">BulkActionsManager</a></li><li><a href="CacheKeys.html">CacheKeys</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="LoadingStateManager.html">LoadingStateManager</a></li><li><a href="ModalHelper.html">ModalHelper</a></li><li><a href="PaginationManager.html">PaginationManager</a></li><li><a href="ServerValidator.html">ServerValidator</a></li><li><a href="StateManager.html">StateManager</a></li><li><a href="TabRefreshManager.html">TabRefreshManager</a></li><li><a href="UndoRedoManager.html">UndoRedoManager</a></li><li><a href="module-AboutModule-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule-DashboardModule.html">DashboardModule</a></li><li><a href="module-ExportModule-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule-FECModule.html">FECModule</a></li><li><a href="module-ImportModule-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-Logger-Logger.html">Logger</a></li><li><a href="module-Logger-ModuleLogger.html">ModuleLogger</a></li><li><a href="module-MaterialsModule-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-PDFModule-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-UtilitiesModule-UtilitiesModule.html">UtilitiesModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#emitSync">emitSync</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#validateBeforeAddToQuote">validateBeforeAddToQuote</a></li><li><a href="global.html#validateBeforeExport">validateBeforeExport</a></li><li><a href="global.html#validateBeforeSaveMaterial">validateBeforeSaveMaterial</a></li><li><a href="global.html#validateBeforeSendEmail">validateBeforeSendEmail</a></li><li><a href="global.html#validateHeaderConfig">validateHeaderConfig</a></li><li><a href="global.html#validatePasswordChange">validatePasswordChange</a></li><li><a href="global.html#validateSMTPConfig">validateSMTPConfig</a></li><li><a href="global.html#waitFor">waitFor</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>shared/ui/TabRefreshManager.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * TAB REFRESH MANAGER
 *
 * SystÃ¨me centralisÃ© de rafraÃ®chissement automatique des onglets.
 * Chaque module peut enregistrer une fonction de refresh qui sera appelÃ©e
 * automatiquement lorsque l'utilisateur ouvre l'onglet correspondant.
 *
 * Architecture:
 * - Detection automatique des Ã©vÃ©nements Bootstrap tab (shown.bs.tab)
 * - Throttling intelligent (Ã©vite refresh si &lt; 2s depuis dernier refresh)
 * - Support du cache avec TTL configurable par onglet
 * - Force refresh optionnel (bypass cache)
 *
 * @version 1.0.0
 * @author AutoCalc OptiDevis v3.0 - UX Phase 1
 *
 * @example
 * // Dans un module
 * TabRefreshManager.registerTab('dashboard-tab', async (force) => {
 *   await this.loadAdminDashboard(force);
 * }, { ttl: 30000 }); // Refresh si > 30s depuis dernier refresh
 */

class TabRefreshManager {
  constructor() {
    /** @type {Map&lt;string, TabRefreshConfig>} */
    this.tabs = new Map();

    /** @type {Map&lt;string, number>} */
    this.lastRefresh = new Map();

    /** @type {boolean} */
    this.initialized = false;

    /** @type {boolean} */
    this.debug = false;
  }

  /**
   * Active/dÃ©sactive le mode debug
   * @param {boolean} enabled
   */
  setDebug(enabled) {
    this.debug = enabled;
  }

  /**
   * Log debug
   * @private
   */
  log(...args) {
    if (this.debug) {
      console.log('[TabRefreshManager]', ...args);
    }
  }

  /**
   * Initialise le gestionnaire de rafraÃ®chissement des onglets.
   * Configure les event listeners sur tous les onglets Bootstrap.
   *
   * Ã€ appeler une seule fois au dÃ©marrage de l'application (dans app.js).
   *
   * @returns {void}
   *
   * @example
   * // Dans app.js aprÃ¨s initialisation des modules
   * TabRefreshManager.init();
   */
  init() {
    if (this.initialized) {
      console.warn('[TabRefreshManager] Already initialized');
      return;
    }

    this.log('Initializing TabRefreshManager...');

    // Trouver tous les onglets Bootstrap avec data-bs-toggle="tab"
    const tabElements = document.querySelectorAll('[data-bs-toggle="tab"]');

    tabElements.forEach(tabElement => {
      tabElement.addEventListener('shown.bs.tab', (event) => {
        const tabId = event.target.id;
        this.log(`Tab shown: ${tabId}`);
        this.refreshTab(tabId);
      });
    });

    this.initialized = true;
    this.log(`âœ… TabRefreshManager initialized - ${tabElements.length} tabs monitored`);
  }

  /**
   * Enregistre un onglet avec sa fonction de refresh.
   *
   * @param {string} tabId - ID de l'onglet (ex: "dashboard-tab")
   * @param {Function} refreshFunction - Fonction async Ã  appeler pour rafraÃ®chir (reÃ§oit force: boolean)
   * @param {Object} [options] - Options de configuration
   * @param {number} [options.ttl=30000] - DurÃ©e de vie du cache en ms (dÃ©faut: 30s)
   * @param {boolean} [options.alwaysRefresh=false] - Toujours rafraÃ®chir, ignorer le TTL
   * @param {string} [options.label] - Label pour les logs (dÃ©faut: tabId)
   * @returns {void}
   *
   * @example
   * // Refresh simple avec cache 30s
   * TabRefreshManager.registerTab('dashboard-tab', async () => {
   *   await dashboardModule.loadAdminDashboard();
   * });
   *
   * @example
   * // Refresh avec cache personnalisÃ© (2 minutes)
   * TabRefreshManager.registerTab('quotes-tab', async (force) => {
   *   await quotesModule.loadQuotes(force);
   * }, { ttl: 120000, label: 'Devis' });
   *
   * @example
   * // Toujours rafraÃ®chir (pas de cache)
   * TabRefreshManager.registerTab('revenue-tab', async () => {
   *   await revenueModule.loadRevenue();
   * }, { alwaysRefresh: true });
   */
  registerTab(tabId, refreshFunction, options = {}) {
    const config = {
      tabId,
      refreshFunction,
      ttl: options.ttl ?? 30000, // 30 secondes par dÃ©faut
      alwaysRefresh: options.alwaysRefresh ?? false,
      label: options.label ?? tabId
    };

    this.tabs.set(tabId, config);
    this.log(`âœ“ Tab registered: ${config.label} (TTL: ${config.ttl}ms, alwaysRefresh: ${config.alwaysRefresh})`);
  }

  /**
   * DÃ©senregistre un onglet
   * @param {string} tabId - ID de l'onglet
   */
  unregisterTab(tabId) {
    if (this.tabs.has(tabId)) {
      this.tabs.delete(tabId);
      this.lastRefresh.delete(tabId);
      this.log(`âœ“ Tab unregistered: ${tabId}`);
    }
  }

  /**
   * RafraÃ®chit un onglet si nÃ©cessaire (appelÃ© automatiquement par l'event listener).
   *
   * Logique intelligente:
   * 1. Si alwaysRefresh = true â†’ Refresh immÃ©diat
   * 2. Si lastRefresh &lt; TTL â†’ Skip (donnÃ©es encore fraÃ®ches)
   * 3. Sinon â†’ Refresh
   *
   * @private
   * @param {string} tabId - ID de l'onglet
   * @param {boolean} [force=false] - Forcer le refresh mÃªme si cache valide
   * @returns {Promise&lt;void>}
   */
  async refreshTab(tabId, force = false) {
    const config = this.tabs.get(tabId);

    if (!config) {
      // Onglet non enregistrÃ© = pas de refresh nÃ©cessaire
      return;
    }

    const now = Date.now();
    const lastRefreshTime = this.lastRefresh.get(tabId) || 0;
    const timeSinceLastRefresh = now - lastRefreshTime;

    // DÃ©cision: faut-il rafraÃ®chir ?
    const shouldRefresh = force || config.alwaysRefresh || timeSinceLastRefresh >= config.ttl;

    if (!shouldRefresh) {
      this.log(`â­ï¸  Skip refresh for ${config.label} (last refresh: ${Math.round(timeSinceLastRefresh / 1000)}s ago, TTL: ${config.ttl / 1000}s)`);
      return;
    }

    try {
      this.log(`ðŸ”„ Refreshing ${config.label}...`);
      const startTime = Date.now();

      await config.refreshFunction(force);

      const duration = Date.now() - startTime;
      this.lastRefresh.set(tabId, now);

      this.log(`âœ… ${config.label} refreshed in ${duration}ms`);

    } catch (error) {
      console.error(`[TabRefreshManager] Error refreshing ${config.label}:`, error);
    }
  }

  /**
   * Force le rafraÃ®chissement d'un onglet spÃ©cifique (bypass cache).
   * Utile aprÃ¨s une modification (ex: ajout de devis â†’ forcer refresh onglet Devis).
   *
   * @public
   * @param {string} tabId - ID de l'onglet Ã  rafraÃ®chir
   * @returns {Promise&lt;void>}
   *
   * @example
   * // AprÃ¨s crÃ©ation d'un devis, forcer le refresh de l'onglet Devis
   * await quotesModule.createQuote(quoteData);
   * await TabRefreshManager.forceRefresh('quotes-tab');
   */
  async forceRefresh(tabId) {
    this.log(`ðŸ”„ Force refresh requested for: ${tabId}`);
    await this.refreshTab(tabId, true);
  }

  /**
   * Force le rafraÃ®chissement de TOUS les onglets enregistrÃ©s.
   * Utile aprÃ¨s import de donnÃ©es, changement de configuration, etc.
   *
   * @public
   * @returns {Promise&lt;void>}
   *
   * @example
   * // AprÃ¨s import Excel de 500 matÃ©riaux
   * await importModule.importExcel(file);
   * await TabRefreshManager.forceRefreshAll();
   */
  async forceRefreshAll() {
    this.log('ðŸ”„ Force refresh ALL tabs...');
    const promises = Array.from(this.tabs.keys()).map(tabId => this.forceRefresh(tabId));
    await Promise.all(promises);
    this.log('âœ… All tabs refreshed');
  }

  /**
   * Invalide le cache d'un onglet spÃ©cifique (prochain focus = refresh garanti).
   * Plus lÃ©ger que forceRefresh() car n'exÃ©cute pas immÃ©diatement.
   *
   * @public
   * @param {string} tabId - ID de l'onglet
   *
   * @example
   * // AprÃ¨s suppression d'un matÃ©riau, invalider le cache Catalogue
   * materialsModule.deleteMaterial(id);
   * TabRefreshManager.invalidateCache('admin-tab');
   * // â†’ Prochain clic sur "Catalogue" â†’ refresh automatique
   */
  invalidateCache(tabId) {
    this.lastRefresh.delete(tabId);
    this.log(`ðŸ—‘ï¸  Cache invalidated for: ${tabId}`);
  }

  /**
   * Invalide le cache de TOUS les onglets.
   *
   * @public
   */
  invalidateAllCaches() {
    this.lastRefresh.clear();
    this.log('ðŸ—‘ï¸  All caches invalidated');
  }

  /**
   * Retourne les statistiques de refresh pour debug.
   *
   * @public
   * @returns {Object} Statistiques
   *
   * @example
   * const stats = TabRefreshManager.getStats();
   * console.log(`Tabs enregistrÃ©s: ${stats.totalTabs}`);
   * console.log('Derniers refresh:', stats.lastRefreshTimes);
   */
  getStats() {
    const stats = {
      totalTabs: this.tabs.size,
      registeredTabs: Array.from(this.tabs.keys()),
      lastRefreshTimes: {}
    };

    this.tabs.forEach((config, tabId) => {
      const lastTime = this.lastRefresh.get(tabId);
      stats.lastRefreshTimes[tabId] = {
        label: config.label,
        lastRefresh: lastTime ? new Date(lastTime).toLocaleTimeString() : 'Never',
        timeSinceRefresh: lastTime ? `${Math.round((Date.now() - lastTime) / 1000)}s ago` : 'N/A',
        ttl: `${config.ttl / 1000}s`,
        alwaysRefresh: config.alwaysRefresh
      };
    });

    return stats;
  }

  /**
   * Affiche les statistiques dans la console (utile pour debug).
   *
   * @public
   */
  printStats() {
    const stats = this.getStats();
    console.log('ðŸ“Š TabRefreshManager Stats:');
    console.table(stats.lastRefreshTimes);
  }
}

// Singleton
const tabRefreshManager = new TabRefreshManager();

// Exposer globalement
window.TabRefreshManager = tabRefreshManager;

export default tabRefreshManager;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
