

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> modules/about/AboutModule.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule.html">DashboardModule</a></li><li><a href="module-DataCache.html">DataCache</a></li><li><a href="module-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule.html">FECModule</a></li><li><a href="module-FollowUpModule.html">FollowUpModule</a></li><li><a href="module-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-KeyboardShortcutsModule.html">KeyboardShortcutsModule</a></li><li><a href="module-Logger.html">Logger</a></li><li><a href="module-MLService.html">MLService</a></li><li><a href="module-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-NotificationSystem.html">NotificationSystem</a></li><li><a href="module-NotificationSystemV2.html">NotificationSystemV2</a></li><li><a href="module-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-TourModule.html">TourModule</a></li><li><a href="module-UtilitiesModule.html">UtilitiesModule</a></li><li><a href="module-calculations.html">calculations</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-formatters.html">formatters</a></li><li><a href="module-helpers.html">helpers</a></li></ul><h3>Classes</h3><ul><li><a href="BaseModule.html">BaseModule</a></li><li><a href="BulkActionsManager.html">BulkActionsManager</a></li><li><a href="CacheKeys.html">CacheKeys</a></li><li><a href="EventBus.html">EventBus</a></li><li><a href="LoadingStateManager.html">LoadingStateManager</a></li><li><a href="ModalHelper.html">ModalHelper</a></li><li><a href="PaginationManager.html">PaginationManager</a></li><li><a href="ServerValidator.html">ServerValidator</a></li><li><a href="StateManager.html">StateManager</a></li><li><a href="TabRefreshManager.html">TabRefreshManager</a></li><li><a href="UndoRedoManager.html">UndoRedoManager</a></li><li><a href="module-AboutModule-AboutModule.html">AboutModule</a></li><li><a href="module-AuthModule-AuthModule.html">AuthModule</a></li><li><a href="module-BackupModule-BackupModule.html">BackupModule</a></li><li><a href="module-ClientsModule-ClientsModule.html">ClientsModule</a></li><li><a href="module-ConfigModule-ConfigModule.html">ConfigModule</a></li><li><a href="module-DashboardModule-DashboardModule.html">DashboardModule</a></li><li><a href="module-ExportModule-ExportModule.html">ExportModule</a></li><li><a href="module-FECModule-FECModule.html">FECModule</a></li><li><a href="module-ImportModule-ImportModule.html">ImportModule</a></li><li><a href="module-InvoicesModule-InvoicesModule.html">InvoicesModule</a></li><li><a href="module-Logger-Logger.html">Logger</a></li><li><a href="module-Logger-ModuleLogger.html">ModuleLogger</a></li><li><a href="module-MaterialsModule-MaterialsModule.html">MaterialsModule</a></li><li><a href="module-PDFModule-PDFModule.html">PDFModule</a></li><li><a href="module-QuickAddModule-QuickAddModule.html">QuickAddModule</a></li><li><a href="module-QuoteBuilderModule-QuoteBuilderModule.html">QuoteBuilderModule</a></li><li><a href="module-QuotesModule-QuotesModule.html">QuotesModule</a></li><li><a href="module-RevenueModule-RevenueModule.html">RevenueModule</a></li><li><a href="module-ScannerModule-ScannerModule.html">ScannerModule</a></li><li><a href="module-SuppliersModule-SuppliersModule.html">SuppliersModule</a></li><li><a href="module-TemplatesModule-TemplatesModule.html">TemplatesModule</a></li><li><a href="module-UtilitiesModule-UtilitiesModule.html">UtilitiesModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#crypto">crypto</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#emitSync">emitSync</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#validateBeforeAddToQuote">validateBeforeAddToQuote</a></li><li><a href="global.html#validateBeforeExport">validateBeforeExport</a></li><li><a href="global.html#validateBeforeSaveMaterial">validateBeforeSaveMaterial</a></li><li><a href="global.html#validateBeforeSendEmail">validateBeforeSendEmail</a></li><li><a href="global.html#validateHeaderConfig">validateHeaderConfig</a></li><li><a href="global.html#validatePasswordChange">validatePasswordChange</a></li><li><a href="global.html#validateSMTPConfig">validateSMTPConfig</a></li><li><a href="global.html#waitFor">waitFor</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>modules/about/AboutModule.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * ========================================
 * ABOUT MODULE - Gestion de l'onglet À propos et licence
 * ========================================
 *
 * Module de gestion de l'onglet "À propos" et de l'activation de licence.
 * Affiche les informations sur le logiciel et permet de gérer la licence.
 *
 * Architecture :
 * - Affichage du statut de la licence (trial/activé)
 * - Gestion du modal d'activation
 * - Validation de clé de licence
 * - Communication avec le backend via IPC
 *
 * Responsabilités :
 * - Charger et afficher le statut de la licence
 * - Gérer l'ouverture/fermeture du modal d'activation
 * - Valider et activer une clé de licence
 * - Actualiser l'affichage du statut
 * - Formater l'affichage du temps restant
 *
 * Workflow d'activation :
 * ```
 * 1. Utilisateur ouvre l'onglet "À propos"
 * 2. Le statut de la licence s'affiche automatiquement
 * 3. Utilisateur clique sur "Activer une licence"
 * 4. Modal s'ouvre avec le formulaire
 * 5. Utilisateur saisit la clé de licence
 * 6. Validation IPC 'activate-license'
 * 7. Si valide → activation + notification succès + fermeture modal
 * 8. Si invalide → message d'erreur dans le modal
 * ```
 *
 * Canaux IPC utilisés :
 * - 'get-license-status' - Récupération du statut de licence
 *   Retour: { isValid: boolean, daysRemaining: number, isActivated: boolean, activatedKey: string }
 *
 * - 'activate-license' - Activation d'une clé de licence
 *   Paramètres: licenseKey (string)
 *   Retour: { success: boolean, message: string }
 *
 * @module AboutModule
 * @extends BaseModule
 * @version 1.0.0
 * @author AutoCalc OptiDevis Development
 * @created 2025
 */

import BaseModule from '../../core/BaseModule.js';
import NotificationSystem from '../../shared/ui/NotificationSystem.js';

class AboutModule extends BaseModule {
  /**
   * Constructeur du module À propos
   *
   * @param {StateManager} state - Gestionnaire d'état global
   * @param {EventBus} eventBus - Bus d'événements
   */
  constructor(state, eventBus) {
    super('about', state, eventBus);

    /**
     * Instance du modal Bootstrap
     * @type {bootstrap.Modal|null}
     * @private
     */
    this.modal = null;

    /**
     * Statut actuel de la licence
     * @type {Object|null}
     * @private
     */
    this.licenseStatus = null;
  }

  /**
   * Initialise le module
   * Configure les écouteurs d'événements et charge le statut de licence
   */
  async init() {
    this.log('Initialisation du module About');

    try {
      // Initialiser le modal Bootstrap
      const modalElement = document.getElementById('licenseActivationModal');
      if (modalElement) {
        this.modal = new bootstrap.Modal(modalElement);
      }

      // Attacher les écouteurs d'événements
      this.attachEventListeners();

      // Écouter le clic sur l'onglet À propos
      const aboutTab = document.getElementById('about-tab');
      if (aboutTab) {
        aboutTab.addEventListener('shown.bs.tab', () => {
          this.loadLicenseStatus();
        });
      }

      this.log('Module About initialisé avec succès');
    } catch (error) {
      this.error('Erreur lors de l\'initialisation du module About:', error);
    }
  }

  /**
   * Attache les écouteurs d'événements aux éléments DOM
   * @private
   */
  attachEventListeners() {
    // Bouton "Activer une licence"
    const btnActivate = document.getElementById('btnActivateLicense');
    if (btnActivate) {
      btnActivate.addEventListener('click', () => this.openActivationModal());
    }

    // Bouton "Actualiser"
    const btnRefresh = document.getElementById('btnRefreshLicense');
    if (btnRefresh) {
      btnRefresh.addEventListener('click', () => this.loadLicenseStatus());
    }

    // Formulaire d'activation
    const form = document.getElementById('licenseActivationForm');
    if (form) {
      form.addEventListener('submit', (e) => this.handleActivation(e));
    }

    // Auto-formater la clé de licence
    const licenseInput = document.getElementById('licenseKeyInput');
    if (licenseInput) {
      licenseInput.addEventListener('input', (e) => this.formatLicenseKey(e));
    }
  }

  /**
   * Charge le statut de la licence depuis le backend
   * @async
   */
  async loadLicenseStatus() {
    this.log('Chargement du statut de la licence...');

    try {
      // Appel IPC pour récupérer le statut
      const status = await window.electron.invoke('get-license-status');
      this.licenseStatus = status;

      this.log('Statut de la licence reçu:', status);

      // Mettre à jour l'affichage
      this.updateLicenseDisplay(status);

      // Mettre à jour le modal si ouvert
      this.updateModalDisplay(status);
    } catch (error) {
      this.error('Erreur lors du chargement du statut de la licence:', error);
      NotificationSystem.show('Erreur lors du chargement de la licence', 'error');
    }
  }

  /**
   * Met à jour l'affichage du statut de licence dans l'onglet
   * @param {Object} status - Statut de la licence
   * @private
   */
  updateLicenseDisplay(status) {
    const card = document.getElementById('licenseStatusCard');
    const statusText = document.getElementById('licenseStatusText');
    const statusMessage = document.getElementById('licenseStatusMessage');
    const statusBadge = document.getElementById('licenseStatusBadge');
    const licenseType = document.getElementById('licenseType');
    const timeRemaining = document.getElementById('licenseTimeRemaining');
    const keyDisplay = document.getElementById('licenseKeyDisplay');
    const licenseKey = document.getElementById('licenseKey');

    if (!card) return;

    // Réinitialiser les classes
    card.className = 'alert';

    if (status.isActivated) {
      // Licence activée
      card.classList.add('alert-success');
      statusText.textContent = 'Licence Activée';
      statusMessage.textContent = 'Votre copie d\'AutoCalc OptiDevis est activée avec succès.';
      statusBadge.className = 'badge bg-success fs-6';
      statusBadge.innerHTML = '&lt;i class="fas fa-check-circle">&lt;/i> Activé';

      if (licenseType) licenseType.textContent = 'Licence Complète';
      if (timeRemaining) timeRemaining.textContent = 'Illimité';

      // Afficher la clé
      if (keyDisplay &amp;&amp; status.activatedKey) {
        keyDisplay.style.display = 'block';
        licenseKey.textContent = this.maskLicenseKey(status.activatedKey);
      }
    } else if (status.isValid) {
      // Période d'essai valide
      card.classList.add('alert-warning');
      statusText.textContent = 'Période d\'essai';
      statusMessage.textContent = `Vous disposez de ${status.daysRemaining} jour(s) d'essai gratuit.`;
      statusBadge.className = 'badge bg-warning text-dark fs-6';
      statusBadge.innerHTML = `&lt;i class="fas fa-clock">&lt;/i> ${status.daysRemaining} jours`;

      if (licenseType) licenseType.textContent = 'Trial';
      if (timeRemaining) timeRemaining.textContent = this.formatTimeRemaining(status.daysRemaining);

      if (keyDisplay) {
        keyDisplay.style.display = 'none';
      }
    } else {
      // Période d'essai expirée
      card.classList.add('alert-danger');
      statusText.textContent = 'Licence Expirée';
      statusMessage.textContent = 'Votre période d\'essai est terminée. Veuillez acheter une licence pour continuer.';
      statusBadge.className = 'badge bg-danger fs-6';
      statusBadge.innerHTML = '&lt;i class="fas fa-exclamation-triangle">&lt;/i> Expiré';

      if (licenseType) licenseType.textContent = 'Expiré';
      if (timeRemaining) timeRemaining.textContent = '0 jour';

      if (keyDisplay) {
        keyDisplay.style.display = 'none';
      }
    }
  }

  /**
   * Met à jour l'affichage dans le modal
   * @param {Object} status - Statut de la licence
   * @private
   */
  updateModalDisplay(status) {
    const modalType = document.getElementById('modalCurrentLicenseType');
    const modalTime = document.getElementById('modalCurrentTimeRemaining');

    if (!modalType || !modalTime) return;

    if (status.isActivated) {
      modalType.textContent = 'Licence Complète';
      modalTime.textContent = 'Activé';
    } else if (status.isValid) {
      modalType.textContent = 'Version d\'essai';
      modalTime.textContent = this.formatTimeRemaining(status.daysRemaining);
    } else {
      modalType.textContent = 'Version d\'essai expirée';
      modalTime.textContent = '0 jour';
    }
  }

  /**
   * Formate le temps restant en texte lisible
   * @param {number} days - Nombre de jours restants
   * @returns {string}
   * @private
   */
  formatTimeRemaining(days) {
    if (days &lt;= 0) return '0 jour';
    if (days === 1) return '1 jour';
    return `${days} jours`;
  }

  /**
   * Masque partiellement la clé de licence pour l'affichage
   * @param {string} key - Clé de licence complète
   * @returns {string}
   * @private
   */
  maskLicenseKey(key) {
    // Affiche seulement les 4 premiers et 4 derniers caractères
    if (!key || key.length &lt; 8) return key;

    const parts = key.split('-');
    if (parts.length === 5) {
      return `${parts[0]}-${parts[1]}-****-****-${parts[4]}`;
    }

    return key.substring(0, 4) + '****' + key.substring(key.length - 4);
  }

  /**
   * Ouvre le modal d'activation de licence
   */
  openActivationModal() {
    this.log('Ouverture du modal d\'activation');

    // Vider le champ de saisie
    const input = document.getElementById('licenseKeyInput');
    if (input) {
      input.value = '';
    }

    // Masquer le message de validation
    const validationMsg = document.getElementById('licenseValidationMessage');
    if (validationMsg) {
      validationMsg.classList.add('d-none');
    }

    // Ouvrir le modal
    if (this.modal) {
      this.modal.show();
    }
  }

  /**
   * Formate automatiquement la clé de licence pendant la saisie
   * @param {Event} e - Événement input
   * @private
   */
  formatLicenseKey(e) {
    const input = e.target;
    let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');

    // Format: AC-XXXX-XXXX-XXXX-XXXX
    const parts = [];
    if (value.length >= 2) {
      parts.push(value.substring(0, 2)); // AC
      value = value.substring(2);
    }

    while (value.length > 0) {
      parts.push(value.substring(0, 4));
      value = value.substring(4);
    }

    input.value = parts.join('-');
  }

  /**
   * Gère la soumission du formulaire d'activation
   * @param {Event} e - Événement submit
   * @async
   * @private
   */
  async handleActivation(e) {
    e.preventDefault();

    const input = document.getElementById('licenseKeyInput');
    const validationMsg = document.getElementById('licenseValidationMessage');
    const submitBtn = document.getElementById('btnSubmitLicense');

    if (!input || !validationMsg || !submitBtn) return;

    const licenseKey = input.value.trim();

    // Validation du format
    const pattern = /^AC-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
    if (!pattern.test(licenseKey)) {
      this.showValidationMessage(
        'Format de clé invalide. Utilisez le format AC-XXXX-XXXX-XXXX-XXXX',
        'error'
      );
      return;
    }

    // Désactiver le bouton pendant le traitement
    submitBtn.disabled = true;
    submitBtn.innerHTML = '&lt;i class="fas fa-spinner fa-spin">&lt;/i> Vérification...';

    try {
      this.log('Activation de la licence:', licenseKey);

      // Appel IPC pour activer la licence
      const result = await window.electron.invoke('activate-license', licenseKey);

      if (result.success) {
        // Succès
        this.showValidationMessage('Licence activée avec succès !', 'success');

        // Notification
        NotificationSystem.show('Licence activée avec succès', 'success');

        // Recharger le statut
        await this.loadLicenseStatus();

        // Débloquer tous les onglets si ils étaient bloqués
        if (typeof window.enableAllTabs === 'function') {
          window.enableAllTabs();
          this.log('Onglets débloqués après activation de licence');
        }

        // Fermer le modal après un court délai
        setTimeout(() => {
          if (this.modal) {
            this.modal.hide();
          }

          // Message de confirmation
          NotificationSystem.show(
            'Vous avez maintenant accès à toutes les fonctionnalités d\'AutoCalc OptiDevis !',
            'success',
            5000
          );
        }, 1500);
      } else {
        // Échec
        this.showValidationMessage(result.message || 'Clé de licence invalide', 'error');
      }
    } catch (error) {
      this.error('Erreur lors de l\'activation de la licence:', error);
      this.showValidationMessage('Erreur lors de l\'activation. Veuillez réessayer.', 'error');
    } finally {
      // Réactiver le bouton
      submitBtn.disabled = false;
      submitBtn.innerHTML = '&lt;i class="fas fa-check">&lt;/i> Valider la licence';
    }
  }

  /**
   * Affiche un message de validation dans le modal
   * @param {string} message - Message à afficher
   * @param {string} type - Type de message ('success' ou 'error')
   * @private
   */
  showValidationMessage(message, type) {
    const validationMsg = document.getElementById('licenseValidationMessage');
    if (!validationMsg) return;

    validationMsg.textContent = message;
    validationMsg.className = 'alert';

    if (type === 'success') {
      validationMsg.classList.add('alert-success');
    } else {
      validationMsg.classList.add('alert-danger');
    }

    validationMsg.classList.remove('d-none');
  }

  /**
   * Nettoie le module (appelé à la destruction)
   */
  cleanup() {
    this.log('Nettoyage du module About');

    // Fermer le modal si ouvert
    if (this.modal) {
      this.modal.hide();
      this.modal = null;
    }

    this.licenseStatus = null;
  }
}

export default AboutModule;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
